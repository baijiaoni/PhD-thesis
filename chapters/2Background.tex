Transfering bunches of particles from a synchrotron into specified buckets of another synchrotron has several underlying basic priciples. In Sec. 2.1, the basic priciples for the B2B transfer will be introduced. For FAIR, these priciples are realized based on the existing FAIR control system and LLRF system. So these two systems will be introduced in Sec. 2.2.  

\section {Introduction of the basic priciples for the B2B transfer}
The energy of the beam is same before and after the B2B transfer, so the energy of the source synchrotron must first of all match that of the target synchrotron. Principally speaking, every synchrotron has its independent RF system. Then the phase advance between the bunch and the bucket must be precisely controlled before the bunch is ejected. The process of achieving the detailed phase adjustment between two RF systems is termed ''RF synchronization''. For the correct bucket injection, the filled buckets and the bucket to be filled must be marked. The bunch fast extraction must happen exactly one ''time of flight'' before the required bucket of the target synchrotron passes the injection region. The injection kicker must kick when the bucket passes the injection region.  In this section, all of the B2B basic priciples will be explained.  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Energy match}

The bunch coordinates in the longitudinal phase plane of the source synchrotron, just before transfer, must be accurately controlled, according to the bucket to be filled. The target synchrotron has to center the bucket on the desired orbit~\footnote {Design orbit or injection orbit}, according to the energy of the bunch. This requirement guarantees the energy match between the bunch and bucket. The energy of a beam is determined by the 'magnetic rigidity', which is defined as the following:
\begin{equation}
	\label{eq:energy}
	B(t)\rho_0 =\frac{p(t)}{e}
\end{equation}
where p(t) is the magnitude of the particle momentum, e is the charge of the particle, B(t) is magnetic field, and $\rho_0$ is the bending radius of a particle immersed in a magnetic field B(t). The ratio of p(t) to e describes the 'stiffness’ of a beam, it can be considered as a measure of how much angular deflection results when a particle travels through a given magnetic field.

The bunch is transferred from the source to the target synchrotron with the same energy. So the beam has the same momentum and velocity for both synchrotrons. According to eq. ~\ref{eq:energy}, the magenetic rigidity of two synchrotrons must be matched:

\begin{equation}
	\label{eq:rigidity}
	B^{src}(t)\rho_0^{src} =\frac{p}{e}=B^{trg}(t)\rho_0^{trg}
\end{equation}

Where the superscript of the symbol denotes the synchrotron, ``src`` represents the source synchrotron and ``trg`` the target synchrotron.

Besides, the rf frequency of two synchrotrons must meet the following relation.
\begin{equation}
	\label{eq:velocity}
	C^{src}\frac{f_{rf}^{src}(t)}{h^{src}} = \beta c=C^{trg}\frac{f_{rf}^{trg}(t)}{h^{trg}}
\end{equation}

where C is the circumference of the synchrotron, h the harmonic number of the rf signal and $f_{rf}$ denotes the rf frequency at the harmonic number h, $\beta$  the fraction of the particle velocity to the lightspeed.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Loop freeze}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Phase difference between two RF systems}

For the RF synchronization between two synchrotrons, the prerequisite is to know the phase difference between two independent RF systems. 
  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{RF synchronization}

There are usually two methods available for the synchronization process. The synchronization is achieved by an azimuthal positioning of the bunch in the source synchrotron or the bucket in the target synchrotron. This is so-called ''phase shift method''. When two rf frequencies are slightly different, they are beating, perceived as periodic variations in phase difference, whose rate is the difference between the two frequencies. The synchronization is automatically achieved. This is so-called ''frequency beating method''. Both methods provide a time frame for the B2B transfer, within which a bunch could be transferred into a bucket with the center mismatch at least better than 1$^\circ$. The time frame is called the synchronization window. 

For both methods, the accompanying beam dynamics must be taken into consideration. Of the four variables, the revolution frequency f(t), B(t), p(t) and the orbit radius R(t), only two are independent.  This leads to four very useful differential relations. The momentum of particle is given by
\begin{equation}
\label{eq:momentum}
p(t)=e\rho_0 [\frac {R(t)}{R_0}]^{1/\alpha_p }B(t) 
\end{equation}

where $R_0$ is its nominal value; and $\alpha_p$, the momentum compaction factor. From eq. ~\ref{eq:momentum}, the first-order total differential of p(t) is given as

\begin{equation}
\label{eq:1st_momentum}
dp(t)=\frac{e\rho_0}{\alpha_p (R_0)^{1/\alpha_p}}B(t)R(t)^{1/\alpha_p-1}dR(t)+ e\rho_0 [\frac {R(t)}{R_0}]^{1/\alpha_p }B(t)dB(t) 
\end{equation}

Dividing both sides of eq. ~\ref{eq:1st_momentum} by p(t), we obtain
\begin{equation}
\label{eq:pRB}
\frac{dp(t)}{p(t)}={\gamma_t^2}\frac{\Delta{R}}{R}+\frac{\Delta{B}}{B} 
\end{equation}

Now, for circular accelerators, the following general relation holds
\begin{equation}
\label{eq:frequency}
f(t)=\frac{\upsilon(t)}{2\pi R(t)} 
\end{equation}
where $\upsilon(t)$ is its velocity. The total differential of f(t) is given by

\begin{equation}
\label{eq:1st_frequency}
df(t)=\frac{1}{2\pi}[\frac{d\upsilon(t)}{R(t)}- \frac{\upsilon(t)}{R^2(t)}dR(t)]
\end{equation}

Dividing both sides of eq. ~\ref{eq:1st_frequency} by f(t) yields
\begin{equation}
\label{eq:fvr}
\frac{df(t)}{f(t)}=\frac{d\upsilon(t)}{\upsilon(t)}- \frac{dR(t)}{R(t)}
\end{equation}

The fractional change in $\upsilon(t)$ is related to the fractional change in p(t):
\begin{equation}
\label{eq:pv}
\frac{dp(t)}{p(t)}=\gamma^2(t)\frac{d\upsilon(t)}{\upsilon(t)}
\end{equation}
where $\gamma(t)$  is the relativistic factor, which measures the total particle energy, E(t), in units of the particle rest energy, $E_0$. Solving $d\upsilon(t)/\upsilon(t)$ from eq. ~\ref{eq:pv} and substituting it into eq. ~\ref{eq:fvr} yields

\begin{equation}
\label{eq:fPR}
\frac{df(t)}{f(t)} ={\gamma^2(t)}\frac{dp(t)}{p(t)}-\frac{dR(t)}{R(t)} 
\end{equation}

Replacing dp(t)/p(t) in eq.~\ref{eq:fPR} with eq.~\ref{eq:pRB}, we have
\begin{equation}
\label{eq:fBR}
\frac{df(t)}{f(t)} ={\gamma^2(t)}\frac{dB(t)}{B(t)}+[\frac{\gamma_t^2}{\gamma^2(t)}-1]\frac{dR(t)}{R(t)} 
\end{equation}

where $\gamma_t$ is the transition gamma, which is related to $\alpha_p$ as $\gamma_t=1/\sqrt{\alpha_p}$. In the same way,solving dR(t)/R(t) from eq. ~\ref{eq:pRB} and substituting it into eq. ~\ref{eq:fPR}, we obtain
\begin{equation}
\label{eq:fPB}
\frac{df(t)}{f(t)} =(\frac{1}{\gamma^2(t)}-\frac{1}{\gamma_t^2}) \frac{dp(t)}{p(t)}+\frac{1}{\gamma_t^2}\frac{dB(t)}{B(t)} 
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Phase shift method}

Based on the phase difference, the rf system of the source or target or both synchrotrons are modulated away from their nominal value for a period of time and then modulated back so that the phase shift created by the frequency modulation could compensate for the expected phase difference. After the phase shift, the bunches of the source synchrotron are synchronized with random buckets of the target synchrotron. The phase shift process must be performed adiabatically for the longitudinal emittance to be preserved.

\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{phase_shift.png}
   \caption{The illustration of the phase shift method.}
   \label{phase_shift}
\end{figure}

Fig. 1 illustrates the phase shift method. The top and bottom RF signals are respectively from the source and target synchrotrons. For the phase shift method two RF signals are of the same frequency. The blue dots show the position of the bunches of the source synchrotron, the red dots correspond to the bucket positions of the target synchrotron. The compensation of the time-of-flight is not drawn here. The red dashed line shows the end of the phase shift process and the beginning of the synchronization window, drawn in yellow. After the phase shift, bunches match with the random buckets.  

A particular case of the B2B synchronization occurs, when the target synchrotron is empty, i.e. it did not capture any bunch yet, the phase shift can be done for the target synchrotron without adiabatical consideration (e.g. Phase jump is possible).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Now we analyze the rf frequency modulation of the phase shift from the the beam dynamics viewpoint.
\begin{itemize}
	\item Radial excursion and momentum shift due to rf frequency modulation

For the phase shift method, the magnetic field is not affected by the frequency modulation, so $\Delta{B}$ = 0. By substituting $\Delta{B}$ = 0 into eq. ~\ref{eq:fBR} and eq. ~\ref{eq:fPB}, we could get respectively the accompanying radial excursion and momentum shift    by the frequency modulation.

\begin{equation}
\label{eq:phaseR}
\frac{\Delta{f}}{f} =({\frac{\gamma_t^2}{\gamma^2}-1}) \frac{\Delta{R}}{R}
\end{equation}
and
\begin{equation}
\frac{\Delta{f}}{f} = (\frac{1}{\gamma^2}-\frac{1}{\gamma_t^2})\frac{\Delta{p}}{p}
\label{eq:phaseP}
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	\item Transverse dynamics analysis

The momentum spread ${\Delta{p}}/{p} \neq 0$ during the phase shift process causes chromaticity drift $\Delta{Q}$. $Q^`$is the chromaticity.

\begin{equation}
\Delta{Q} = Q^`\frac{\Delta{p}}{p}
\label{eq:chromaticity}
\end{equation} 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	\item Shift of synchronous phase

The synchronous phase deviates from $0^\circ$ during the frequency modulation. From the expression of the particle momentum, p(t), given in eq. ~\ref{eq:momentum}, the time derivative of p(t) can be written as
\begin{equation}
\frac {dp(t)}{dt} = \frac {e\rho_0B(t)}{\alpha_pR_0^{1/\alpha_p}}R(t)^{1/\alpha_p-1}\frac{dR(t)}{dt}+e\rho_0 (\frac {R(t)}{R_0})^{1/\alpha_p }\frac{dB(t)}{dt}
\label{eq:momentum/t}
\end{equation} 
Now, the relationship between the rate of change in momentum of a particle, dp(t)/dt,
and the force applied on it, F(t), is governed by Newton’s second law:
\begin{equation}
\frac {dp(t)}{dt} = F(t)
\label{eq:Newton}
\end{equation} 
F(t) is given by the product of the accelerating electric field, E(t), and the
charge of particle, e. Substituting dp(t)/dt given in eq. ~\ref{eq:momentum/t} and F(t) = eE(t) into eq.~\ref{eq:Newton}, we have
\begin{equation}
 \frac {e\rho_0B(t)}{\alpha_pR_0^{1/\alpha_p}}R(t)^{1/\alpha_p-1}\frac{dR(t)}{dt}+e\rho_0 (\frac {R(t)}{R_0})^{1/\alpha_p }\frac{dB(t)}{dt}=eE(t)
\label{eq:f=eq}
\end{equation} 

From this equation, we obtain the expression of energy gain in one turn,
\begin{equation}
2\pi R_0 [\frac {e\rho_0B(t)}{\alpha_pR_0^{1/\alpha_p}}R(t)^{1/\alpha_p-1}\frac{dR(t)}{dt}+e\rho_0 (\frac {R(t)}{R_0})^{1/\alpha_p }\frac{dB(t)}{dt}]=eV(t)sin[\phi_{s0}(t)+\Delta \phi_s(t)]
\label{eq:energy_cycle}
\end{equation} 
where V(t) is the RF accelerating voltage per turn; $\phi_{s0}$, the synchronous phase in the
operation with no frequency modulation; and $\Delta\phi_{s}(t)$, the change in the synchronous phase originating from the rf frequency modulation.

The magnetic field is not affected by the frequency change, we can assume dB(t)/dt = 0. Before the synchronizaiton, it is a stationary bucket with the synchronous phase $0^\circ$. Then, eq.~\ref{eq:energy_cycle} reduce to
\begin{equation}
2\pi R_0 [\frac {e\rho_0B(t)}{\alpha_pR_0^{1/\alpha_p}}R(t)^{1/\alpha_p-1}\frac{dR(t)}{dt}]=eV(t)sin[\Delta \phi_s(t)]
\label{eq:energy_cycle_noB}
\end{equation} 

Solving  $\Delta \phi_{s}(t)$  from eq.~\ref{eq:energy_cycle_noB}, we have
\begin{equation}
\Delta \phi_{s}(t)=sin^{-1}[{\frac{2\pi \rho_0 B}{\alpha_pV}(\frac{R(t)}{R_0})^{1/\alpha_p-1}\frac{dR(t)}{dt}}]
\label{eq:delta_phase}
\end{equation} 
From eq.~\ref{eq:delta_phase}, we know that $\Delta \phi_{s}(t)$ is only determined by dR(t)/dt during the frequency modulation.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\item Bucket area factor

At the flattop, the bucket is a stationary bucket with $\phi_{s0}(t)=0$. During the frequeny modulation process, the bucket becomes a running bucket with $\Delta\phi_s(t)\ne0$. The ratio of bucket areas of a running bucket to a stationary bucket is bucket area factor $\alpha(\Delta \phi_s)$. 
The bucket area factor could be estimated by ~\cite{lee_accelerator_2011}.
\begin{equation}
\alpha_b(\Delta\phi_s)\approx(1-sin(\Delta \phi_s))(1+sin(\Delta \phi_s))
\label{eq:buckt_area_factor}
\end{equation} 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\item Adiabaticity analysis

$\omega_s(t)$ is the small-amplitude synchrotron frequency given by
\begin{equation}
\omega_s(t) =[{-\frac{\eta(t)h\omega_{rev}^2(t)eV(t)cos{\phi_s(t)}}{2\pi\beta^2(t)E(t)}}]^{1/2}
\label{eq:synchfreq}
\end{equation} 

A process is called “adiabatic” when the RF parameters are changed slowly enough for the longitudinal emittance to be preserved. The condition that the parameters are slowly varying can be expressed by
\begin{equation}
\varepsilon=\frac{1}{\omega_s^2(t)}|\frac{d\omega_s(t)}{dt}| \ll 1
\label{eq:adiabaticity}
\end{equation} 

Compared with $\phi_s(t)$, all of the other variables change very slowly. $\phi_s(t)=\phi_{s0}(t)+\Delta\phi_s(t)$. From eq.~(\ref{eq:adiabaticity}) and eq.~(\ref{eq:synchfreq}), we can write the adiabaticity parameter $\varepsilon$, as follows~\cite{ezura_beam-dynamics_2008}:
\begin{equation}
\varepsilon \approx \frac{1}{2\omega_{s0}(t)}|tan\phi_{s}(t)\frac{d\phi_s(t)}{dt}|
\label{eq:derivation}
\end{equation} 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\item Constraints on the RF frequency modulation

From eq.~\ref{eq:derivation}, we can clearly see that $\phi_s(t)$ and $d\phi_s(t)/dt$ play deterministic roles for the adiabaticity when the frequency is modulated. Now let us deduce how the rf frequency modulation affects $\phi_s(t)$ and $d\phi_s(t)/dt$. From eq.~(\ref{eq:phaseR}), we could get the following equation.
\begin{equation}
\frac{dR(t)}{dt}(\frac{\gamma_t^2}{\gamma^2}-1)f_0=\frac{df(t)}{dt} R_0
\label{eq:RtoF}
\end{equation}


Substituting eq.~\ref{eq:RtoF} into eq.~\ref{eq:energy_cycle_noB}, we get
\begin{equation}
Vsin\phi_s=\frac{2\pi R_0 \rho B}{f_0(\frac{1}{\gamma}^2-\frac{1}{\gamma_t}^2)}[\frac{R(t)}{R_0}]^{(\frac{1}{\alpha_p}-1)}\frac{df(t)}{dt} 
\label{eq:bucketsizeF}
\end{equation}

Because $(R(t)-R_0)/R_0$ is about $10^{-4}$, $[1+\frac{\Delta R}{R_0}]^{(\frac{1}{\alpha_p}-1)}\approx 1$. We can get the realtion between df(t)/dt and $\phi_s$ from eq.~\ref{eq:bucketsizeF}.
\begin{equation}
Vsin\phi_s=\frac{2\pi R_0 \rho B}{f_0(\frac{1}{\gamma}^2-\frac{1}{\gamma_t}^2)}\frac{df(t)}{dt} 
\label{eq:dotf}
\end{equation}

From eq.~\ref{eq:buckt_area_factor}, we know that the bucket area factor is determined by the synchronous phase change $\Delta\phi_s$. Based on eq.~\ref{eq:dotf}, we know that df(t)/dt is important for the bucket size.

In oerder to get the relation between $d\phi_s(t)/dt$ and the frequency modulation, we get the time derivative of eq.~\ref{eq:dotf}

\begin{equation}
Vcos\phi_s\frac{d\phi_s}{dt}=\frac{2\pi R_0 \rho B}{f_0(\frac{1}{\gamma}^2-\frac{1}{\gamma_t}^2)}\frac{df(t)/dt}{dt} 
\label{eq:2dotf}
\end{equation}

Based on the adiabaticity eq.~(\ref{eq:derivation}), $d\phi_s(t)/ dt$ must be existing. So $\frac{df(t)/dt}{dt}$ must be existing. It means that df(t)/dt and $\phi_s(t)$ must be continuous. In a word, there are two constraits for the rf frequncy modulation.
\begin{itemize}
\item[-] The df(t)/dt of the rf frequency modulation must be small enough to guarantee the bucket size.
\item[-] The df(t)/dt of the rf frequency modulation must be continous to guarantee the continuous synchronous phase.
\end{itemize}

\end{itemize}
%%%%%%%%%%%%%%%%%%%%%%%%%%%------------------------------%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Frequency beating method}

The frequency beating method uses the effect of two RF signals of slightly different frequencies, perceived as periodic variations in phase difference whose rate is the difference between the two frequencies. The RF frequency of the source or the target or both synchrotrons is detuned long before the ejection, then the difference between the phase of the bunch and bucket is measured. Based on the measured phase, the synchronization is realized when the phase difference of the two RF frequencies corresponds to the ideal phase difference ($\Delta \theta = 0^\circ$). The $\Delta \theta$ is the mismatch between the bunch center and the corresponding bucket center. Because of the slightly different RF frequencies, a mismatch between the bunch and bucket centers exists. In principle, the B2B transfer requirement for FAIR allows a bunch to bucket center mismatch of $1^\circ$, which brings a symmetric time frame with respect to the time of the ideal phase difference, resulting in the maximum synchronization window for the frequency beating method, drawn in yellow, see Fig. ~\ref{frequency_beat}. The red dashed line shows the time for the expected phase difference.

\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{frequency_beating.png}
   \caption{The illustration of the frequency beating method.}
   \label{frequency_beat}
\end{figure}

The RF frequency is detuned at the end of the ramp. During the rf frequency detune process, the magnetic field and radius excursion react and the momentum is not affected for the energy match.

\begin {itemize}
\item Longitudinal dynamics analysis

Because the momentum is not affected by the frequency change, namely $\Delta$p = 0, the general relation between the radial excursion and RF frequency change eq.~(\ref{eq:fPR}) reduces to eq.~(\ref{eq:eq4}) and the general relation between the magnetic field change and RF frequency change eq.~(\ref{eq:pRB}) reduces to eq.~(\ref{eq:eq5}).

\begin{equation}
\frac{\Delta{f}}{f} = - \frac{\Delta{R}}{R}
\label{eq:eq4}
\end{equation}

\begin{equation}
\frac{\Delta{f}}{f} =  \frac{1}{{\gamma_t}^2}\times{\frac{\Delta{B}}{B}}
\label{eq:eq5}
\end{equation}
\end {itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%\subsubsection{Example of frequency beating method for SIS18 and SIS100 1 Seite}
%Because the circumference ratio of the large synchrotron to the small synchrotron is a perfect integer, the rf frequency at the flattop of SIS18 is same as that of SIS100. So the first step for the bunch to bucket transfer is the RF frequency de-tune. In order to realize the frequency beating between two synchrotrons, the RF frequency of the source synchrotron or the target synchrotron or both synchrotrons can be de-tuned. It means that the particles on the de-tuned synchrotron run at an average radius different by $\bigtriangleup$R from the designed orbit R. For the synchronization of the SIS18 and the SIS100, we will de-tune the RF frequency on the SIS18. The SIS18 operates with a cycle length of 520ms, harmonic number of 2 ( h = 2 ), and RF frequency of approximately 0.43 MHz at injection and approximately 1.57 MHz at ejection for the $U^{28+}$~\cite{SIS18}. During nominal operation, the SIS18 forms two bunches from the beam injected at 11.4 MeV/$\mu$ and accelerates them up to 200 MeV/$\mu$. From the SIS18, 4 batches, each of 2 bunches, are transferred at  maximum 10ms intervals to the SIS100. The harmonic number of the SIS100 is 10 and the SIS100 RF frequency is fixed at approximately 1.57 MHz during the
%injection period to simplify the RF control system and to avoid perturbing batches already transferred.
%
%  This RF frequency de-tune is done accompanying with the RF ramp. Accepting to decentre the orbit by 8mm for the SIS18~\cite{SIS18_man}: 
%
%\begin{equation}
%\frac{\bigtriangleup{R}}{R}\approx{2.4}{\times}10^{-4}\label{eq1}
%\end{equation}
%
%  We know the basic differential relations among the fractional change in the RF frequency f, the fractional change in the momentum p, the fractional change in the bending magnetic field B and the fractional change in the radius R as follows ~\cite{J-PARC}.
%
%
%\begin{equation}
%\label{eq:eq2}
%\frac{\Delta{f}}{f} ={\frac{1}{\gamma^2}}{\frac{\Delta{p}}{p}} - \frac{\Delta{R}}{R}
%\end{equation}
%
%\begin{equation}
%\frac{\Delta{f}}{f} = (\frac{1}{\gamma^2}-\frac{1}{\gamma_t^2})\frac{\Delta{p}}{p}+{\frac{1}{\gamma_t^2}}{\frac{\Delta{B}}{B}}
%\label{eq:eq3}
%\end{equation}
%
%
%where $\gamma$ is the relativistic factor, which measures the total particle energy, E, in
%units of the particle rest energy, $E_0$; $\gamma_t$ is the transition gamma; $\bigtriangleup{f}$ and  $\bigtriangleup{B}$ are the frequency and  bending magnetic field deviation for the frequency de-tune;  $\bigtriangleup{p}$ is the momentum deviation.
%
%In our case of the frequency beating method, we guarantee the extraction and injection energy always match, which means that the momentum is not affected by the frequency change, namely $\Delta$p = 0; then the general relation between the radial excursion and RF frequency change eq.~(\ref{eq:eq2}) reduces to eq.~(\ref{eq:eq4}) and the general relation between the magnetic field change and RF frequency change eq.~(\ref{eq:eq3}) reduces to eq.~(\ref{eq:eq5}).
%
%\begin{equation}
%\frac{\Delta{f}}{f} = - \frac{\Delta{R}}{R}
%\label{eq:eq4}
%\end{equation}
%
%\begin{equation}
%\frac{\Delta{f}}{f} =  \frac{1}{{\gamma_t}^2}\times{\frac{\Delta{B}}{B}}
%\label{eq:eq5}
%\end{equation}

%\subsubsubsection{Frequency beating method for SIS18 and ESR 2-3 Seiten}
%Because the circumference ratio of the ESR injection orbit to the SIS18 designed orbit is not a perfect integer, two synchrotrons begin beating automatically. He 


\subsection{Bucket label}
After the synchronization, the bunch is synchronized to an arbitrary RF bucket. For the proper injection, we must know which buckets are already filled and which buckets should be filled by next injection cycle. The fast extraction can only proceed when the required bucket comes. 
%The extraction must be correctly synchronized with respect to a reference signal at the following frequency, which is called bucket marker.
%\begin{equation}
%	\label{eq:bucket_label}
%	\frac{f_{rf}^{src}}{p} = \frac{f_{rf}^{trg}}{q}
%\end{equation}

\subsection{Synchronization of the extraction and injection kicker}
For the proper B2B transfer, the extraction and injection kickers must be synchronized with the beam.
 
\begin{itemize}
	\item Extraction kicker
		
Here we discuss that all bunches are extracted by one time extraction kick. The flattop is at least one revolution period. The fall time is not constrained. If there is no empty RF bucket of the ring, the rise time of the extraction kicker must be shorter than the bunch gap. If there is at least one empty RF bucket, the rise of the magnetic field could be achieved within the gap of the empty RF buckets. 

	\item Injectin kicker

For multi-batch injection, the rise time of the injection kicker must be shorter than the bunch gap. The flattop is determined by the length of the bunches to be injected. If all buckets must be filled, the fall time must be shorter than the bunch gap. If at least one bucket is kept empty, the fall of the magnetic field could be achieved within the gap of the empty RF buckets. If the ring needs only one time injection, the rise time is not constrained. The flattop determined by the length of the bunches to be injected. The fall time must be shorter than the bunch gap or the gap of the empty RF buckets. 

\end{itemize}

\subsection{Beam indication for the beam instrumentation}
In order to observe the beams and measure related parameters for accelerators and transfer lines, the beam instrumentation (\gls{BI}) equipments must be synchronized and triggered within the beam schedule. For the B2B transfer, the data acquisition for the beam instrumentation equipments should be triggered before the bunch is extracted. Sometimes they should not be triggered too early because of the limitation of sampling time. So a pre-trigger is necessary, which indicates that the bunch will be extracted/injected soon. 

\section{Infrastructures for the B2B transfer system}
For the FAIR accelerator complex, synchronization of the B2B transfer will be
realized by the FAIR control system and the Low-Level RF
(LLRF) system. For the synchronization of LLRF system, the GMT system is complemented and linked to the Bunchphase Timing System (BuTiS). 
\subsection{FAIR control system}
The \gls{FAIR} control system takes advantage of collaborations with CERN in using proven framework solutions like FESA, LSA, White Rabbit, etc. It consists of the equipment layer, middle layer and application layer. The equipment layer consists of equipment interfaces, GMT and software representations of the equipment
(FESA) Front-End System Architecture. The middle layer provides service functionality both to the equipment layer and the application layer through the IP control system network. LSA is used for the Settings Management. The application layer combines the applications for operators as GUI applications or command line tools. The application layer and the middle layer only request what the FAIR accelerator complex should do and transmit set values to the equipment layer. The actual beam production is controlled by the GMT. The GMT system is synchronized to BuTiS. The \gls{SM} supplies the schedule for the GMT by LSA.

\subsubsection{BuTiS}
Bunch Phase Timing System (BuTiS)~\cite{moritz_butisdevelopment_2006}~\cite{zipfel_recent_2011} serves as a campus-wide clocks distribution system with subnanosecond resolution and stability over distances of several hundred meters while maintaining 100ps per km timing stability. Two BuTiS reference clocks 10 MHz and 200 MHz and a trigger identification pulse at 100 kHz are generated centrally in the BuTiS center. A star-shaped optical fiber distribution network transfers these signals to BuTiS receivers all over the FAIR campus. A BuTiS receiver and a local reference synthesizer are installed in each supply room to produce the BuTiS reference clocks, which are in phase. For this purpose, a measurement setup in the BuTiS center continuously measures the optical signal transmission delay between the BuTiS center and the different BuTiS receivers. This measurement information is used to shift the phases of the signals generated in each local reference synthesizer for the delay compensation. The main task of BuTiS is the supply of the reference clock signals for \gls{glos:Rrf} in each rf supply rooms.

\subsubsection{GMT}
The GMT~\cite{beck_new_2012} is contained in the equipment layer. The main tasks of the GMT system are time synchronization of more than 2000 Front-End Controllers (\gls{FEC}) with nanosecond accuracy, distribution of timing messages and subsequent generation of real-time actions by the nodes of the timing system. The GMT consists of the Timing Master (\gls{TM}) and the White Rabbit (WR) timing network and integrates nodes. The timing master's interface to the upper layers, e.g. online schedule monitor, is modeled as a FESA device. The timing master is a logical device, containing the data master (\gls{DM}), the clock master (\gls{CM}) and the management master (\gls{MM}). The data master receives a schedule for the operation of the FAIR accelerator complex from the Settings Management and provides the real-time scheduler by broadcasting timing messages to the WR timing network, which will be received and executed by the corresponding node at the designated time. The clock master is a dedicated White Rabbit switch. It is the topmost switch layer of the WR timing network and provides the grandmaster clock and timestamps which are distributed to all other nodes in the timing network. The clock master derives its clock from the BuTiS clocks and timestamps distributed are phase locked to BuTiS clocks. The GMT could deliver BuTiS T0 and c2 clocks signals on any nodes and nodes are capable to timestamp clock edges. All active components including receiver nodes and switches are registered to the management master. The management master monitor and manage the active components of the GMT system.

\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{Timing_message.jpg}
   \caption{The format of the timing message.}
   \label{Timing_message}
\end{figure}
Fig. ~\ref{Timing_message} shows the format of the timing message. 
The timing message contains 
\begin{itemize}
	\item WB Addr (\SI{32}{bit}): Wishbone address to which on the node the data shall be written.
	\item Payload (\SI{256}{bit})
		\begin{itemize}
			\item EventID (\SI{64}{bit}): Index of the schedule step.
		\begin{itemize}
			\item Format ID (FID) (\SI{4}{bit}): Serves to distinguish between different formats of the timing message.
			\item Group ID (GID)(\SI{12}{bit}): Identifies a group of equipment, such as a synchrotron or a transfer line.
			\item Event No (EVTNO) (\SI{12}{bit}): Specifies a command to be executed.
			\item Sequence ID (SID) (\SI{12}{bit}): A sequence is analogous to the concept of a ``virtual accelerator``. 
			\item Beam Process ID (BPID) (\SI{14}{bit}): A beam process defines a process which must not be interrupted, e.g. a acceleration ramp. 
			\item Reserved (\SI{10}{bit})
		\end{itemize}
			\item Param (\SI{64}{bit}): An additional parameter with event specific meaning.
			\item TEF (\SI{32}{bit}): Timing Extension Field containing fine delay information and other data.
			\item Reserved (\SI{32}{bit}): 
			\item Timestamp (\SI{64}{bit}): In units of \SI{8}{\ns} clock cycles since 1 January 1970.
		\end{itemize}
\end{itemize}
A timing message is sent across the WR network, so it must be contained in the ethernet frame. An ethernet frame including one timing message has a length of \SI{110}{byte}, which is called the timing frame in this document.

\subsubsection{FESA}
The real-time front-end software architecture \gls{FESA}~\cite{hoffmann_fesafront-end_2008} is a framework used to fully integrate the large amount of front-end equipments into the FAIR accelerator control system. FESA was developed by CERN and has already been implemented into the CERN control system. FESA develops FESA classes, the equipment-type specific front-end software. For a specific type of equipments, a FESA class implementation accesses to the control interface of the equipments. The FESA class models the equipment as device, so the FESA output is called device class. One device class can instanciate several devices and thus generally handles several independent pieces of equipments.  FESA provides JAVA based graphical user interfaces (GUI) to design, deploy, instantiate and test the device classes. The FEC use FESA to implement generic and equipment specific functions in form of the device classes. Interaction with the equipment is synchronized with the GMT system. 

FESA (Frontend Software Architecture) is a framework developed at CERN and is now developed further in collaboration with GSI for the FAIR project. It is a toolbox to model abstract device objects where equipment’s process variables (sensors and actuators) are represented as properties. The specific equipment access is implemented in C++ by the developer and is linked by the toolchain
to the device model to build a so called FESA class (Fig. 4). Then, one or more FESA classes are linked to the run-time core to build an x86-Linux executable. The
FESA classes provide a uniform interface via the objectproperty model and a common middle-ware to the upper layers. The device properties are set and read using synchronous or asynchronous access methods (subscription). For time multiplexed operation of the accelerators, the FESA framework supports defining multiplexed properties. Before an accelerator schedule is started the setting properties of FESA classes are pre-supplied by LSA [6] for all scheduled beams with specific settings accordingly. At runtime, FESA’s real time software actions are triggered by timing events, the actual beam specific data is then selected based on information carried by the timing event message and send to the equipment. For the FAIR project the necessary interaction with the timing receiver is realized in a
lab-specific timing library of the FESA framework.


\subsubsection{SM}
The \gls{SM} is located in the middle layer of the control system. It supports off-line generation of synchrotron settings, sending these settings to all involved devices,
and programming the schedule of the timing system. The SM uses the LSA (LHC Software Architecture) framework, which originates at CERN and is now developed further in collaboration with GSI for the FAIR project. The settings management is based on a physics model for accelerator optics, parameter space and overall relations between parameters and between accelerators. A standardized API allows accessing data in a common way as basis for generic client applications for all accelerators. Using the LSA-API, trim-applications can coherently modify synchrotron settings. E.g. the service generates timing constraints (e.g. ramp curve) as well as the equipment’s data settings (e.g. field) for all devices derived from physics parameters (e.g. beam energy). For FAIR the framework is extended to model the overall schedule of all accelerators. Beams are described as Beam Production
Chains to allow a description from beam-source to beamtarget for settings organization and data correlation.

\subsection{LLRF system}
The FAIR low-level rf (\gls{LLRF})~\cite{klingbeil_new_2011} system shall be usable in the existing synchrotrons SIS18 and experimental storage ring (\gls{ESR}) as well as in the FAIR synchrotrons SIS100 and SIS300 and in the storage rings collector ring (\gls{CR}), new experimental storage ring (\gls{NESR}), and accumulator ring (\gls{RESR}).It supports fast ramp rates and large frequency span for the accleration of a variety of ion species, It supports different RF manipulations, including operation at different harmonic numbers, barrier bucket generation and bunch compression. 

Cavities are driven from a supply room by a Reference RF Signal. Fig.~\ref{local_cavity_syn} shows the typical cavity system with a Reference RF Signal. The cavity gets the RF signal from a local Cavity DDS (Direct Digital Synthesizer) unit, which receives RF Frequency Ramps from the Central Control System (\gls{CCS}). A \gls{DSP}-System (Digital Signal Processor) measures the phase between the Reference RF Signal and the gap voltage of the cavity. In the DSP system, a closed-loop control algorithm is implemented which generates frequency corrections for the local Cavity DDS. In this way, it is ensured that the phase of the gap voltage follows the phase of the reference RF signal. 
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{local_cavity_syn.png}
   \caption{Local Cavity Synchronization}
   \label{local_cavity_syn}
\end{figure}
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{ref_rf_dis.png}
   \caption{Reference RF Signal Distribution}
   \label{ref_rf_dis}
\end{figure}
The Reference RF Signal distribution shown in Fig.~\ref{ref_rf_dis} is located in each supply room. The virtual RF cavity is a virtual position in the synchrotron to which the Reference RF Signal corresponds. The Reference RF Signals in different supply rooms are synchronized by the BuTiS. BuTiS 200MHz and 100kHz clock signals are received by BuTiS receivers in different supply rooms in phase. In Fig.~\ref{ref_rf_dis}, a number of Group DDS units are located in each supply room, which are synchronized to BuTiS local reference. The Group DDS signals can be routed to the different cavity systems by a Switch Matrix. All cavities in a synchrotron could be providing with the same Group DDS signal. The cavities at different harmonic numbers could be realized by using Group DDS signals with different harmonic numbers. The Group DDS concept allows to synchronize a variety of cavities in a very flexible way. 

All the cavities of SIS18 are driven from one supply room. The SIS100 cavities will be gathered in three acceleration sections, each of them is driven by a dedicated supply room. 

\subsection{\gls{MPS} system}
emergency kick

\section{$U^{28+}$ beam from SIS18 to SIS100}

In this document, we use $U^{28+}$ B2B transfer from SIS18 to SIS100 as an example. So the supercycle of $U^{28+}$ beam of SIS18 and stacking of $U^{28+}$ beam of SIS100 are introduced in this section. 
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{SIS18-100-U28.jpg}
   \caption{$U^{28+}$ beam from SIS18 to SIS100}
   \label{SIS18-100-U28}
\end{figure}

In Fig.~\ref{ref_rf_dis}, SIS100 is operated at harmonic number 10, it holds 10 buckets in total, indicated by the row of ellipses in the lower part of the figure. SIS18 is operated at harmonic number 2. The beam is accumulated using four consecutive injections of two bunches each from SIS18 into different buckets. These four consecutive cycles are called super cycle. When the injection from SIS18 is completed, 8 neighb ouring buckets in SIS100 are filled. The bucket pattern is defined as the rules of the bucket filling. After that the complete beam of SIS100 is compressed in a single bunch at harmonic number 2.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\bibliography{main}
\bibliographystyle{plain}


