

This chapter concentrates on the realization and systematic investigation of the \gls{B2B} transfer system. In Sec. ~\ref{real_dyn}, both the phase shift and frequency beating synchronization methods are analyzed from the beam dynamic perspective. The characterization of the WR network is investigated for the B2B transfer, the calculation of the synchronization window, the flowcharts of the system and the corresponding timing constraints are presented in Sec. ~\ref{real_timing}. The B2B transfer system for FAIR focuses first of all on the transfer from the SIS18 to the SIS100, so the different trigger scenarios of the SIS18 extraction and SIS100 injection kickers are systematically investigated in Sec. ~\ref{real_kicker}. Besides, the test setup from the timing aspect is introduced and the test result is analyzed in Sec. ~\ref{real_test}. 

\section{Beam Dynamic Analysis of two Synchronization Methods for the B2B Transfer from SIS18 to SIS100}
\label{real_dyn}
This section analyzes the phase shift and frequency beating methods from the beam-dynamics perspective for the synchronization of the SIS18 with the SIS100. Because the most stringent requirement are from the lightest and heaviest ion species, the beam dynamics of the $H^+$ and $U^\mathit{28+}$ beams are analyzed.

The dispersion function, a lattice parameter, defines the local sensitivity of the beam trajectory to a relative energy error ~\cite{lee_accelerator_2011}. For the rf frequency modulation of the phase shift method, the dispersion function is reflected in the relative momentum shift. The maximum tolerable relative momentum shift is decided by the semi-aperture $X_D(s)$ required for the beam and the dispersion function $D(s)$.
\begin{equation}
		X_D(s)=D(s)\cdot \frac{\Delta p}{p}|_\mathit{\frac{\Delta B}{B}=0}
\end{equation}
The maximum tolerable relative momentum of the $H^{+}$ beam and that of the $U^\mathit{28+}$ beam of the SIS18 are the same by coincidence, $\Delta p/p_\mathit{\_max}=\pm0.008$, which is given by machine design. 

For the frequency beating method ($\Delta p/p=0$), the dispersion function is reflected in the relative bending magnetic field shift instead of the relative momentum shift. The maximum tolerable relative bending magnetic field shift is decided by the semi-aperture required for the beam and the dispersion function. 
\begin{equation}
		X_D(s)=-D(s)\cdot \frac{\Delta B}{B}|_\mathit{\frac{\Delta p}{p}=0}
\end{equation}
The maximum tolerable relative bending magnetic field shift of the $H^{+}$ beam and that of the $U^\mathit{28+}$ beam of the SIS18 are minus of their maximum tolerant relative momentum shift, namely $\Delta B/B_\mathit{\_max}=-\Delta p/p_\mathit{\_max}=\pm0.008$. The constraint on the displacement of the orbit length $\Delta L/L_\mathit{\_max}$ is obtained by 

\begin{eqnarray}
\frac{\Delta L}{L}=
\begin{cases}
\alpha_p \cdot\frac{\Delta p}{p} &\textit{Phase shift method}\cr
-\alpha_p \cdot\frac{\Delta B}{B} & \textit{Frequency beating method}\cr
\end{cases}
\end{eqnarray}


The reasonable bucket size of a running bucket is larger than $80\%$ of that of a stationary bucket, namely $\alpha_b(\phi_{s})\ge 80\%$. Due to the constraint of the bucket size, the synchronous phase must stay within the range between $-6.4^\circ$ and $+6.4^\circ$.

The acceptable range of the parameters accompanying with the frequency adjustment of the phase shift method for the SIS18 $H^{+}$ and $U^\mathit{28+}$ beams are summarized in Tab. ~\ref{dynamic_param} and that accompanying with the frequency adjustment of the frequency beating method are summarized in Tab. ~\ref{dynamic_param1}. $\alpha_p$ equals to 0.01 for the $H^+$ beam and 0.03 for the $U^\mathit{28+}$ beam \cite{liebermann_fair_2013}.  
\begin{table}[!htb]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Acceptable range of the parameters accompanying with the frequency adjustment of the phase shift method for the SIS18 $H^{+}$ and $U^\mathit{28+}$ beams}
\label{dynamic_param}
\begin{center}
    \begin{tabular}{ | c |c | c | c | c | c | c | c |}
    \hline
    $\Delta p/p_\mathit{\_max}$ & $\Delta L/L_\mathit{\_max}$ & $\alpha_b(\phi_{s})_\mathit{\_min}$ & $\phi_\mathit{s\_max}$  \\ \hline
       $\pm0.008$	& \tabincell{c}{$H^{+}$ $\pm0.80\cdot10^{-4}$\\$U^\mathit{28+}$ $\pm2.40\cdot10^{-4}$}  &  $80\%$ & $\pm6.4^\circ$ \\ \hline

    \end{tabular}
\end{center}
\end{table}
\begin{table}[!htb]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Acceptable range of the parameters accompanying with the frequency adjustment of the frequency beating method for the SIS18 $H^{+}$ and $U^\mathit{28+}$ beams}
\label{dynamic_param1}
\begin{center}
    \begin{tabular}{ | c | c |c | c | c | c | c | c | c |}
    \hline
  $\Delta B/B_\mathit{\_max}$ & $\Delta L/L_\mathit{\_max}$ &   $\alpha_b(\phi_{s})_\mathit{\_min}$ & $\phi_\mathit{s\_max}$   \\ \hline

	$\pm0.008$	&\tabincell{c}{$H^{+}$ $\pm0.80\cdot10^{-4}$\\$U^\mathit{28+}$ $\pm2.40\cdot10^{-4}$} &   $80\%$ & $\pm6.4^\circ$  \\ \hline
    \end{tabular}
\end{center}
\end{table}
%In this chapter, the circumference of SIS18 and SIS100 are denoted by $C^{SIS18}$ and $C^{SIS100}$, the revolution frequency by $f_{h=1}^{SIS18}$ and $f_{h=1}^{SIS100}$ and the rf frequency by $f_{h=2}^{SIS18}$ and $f_{h=10}^{SIS100}$. Since SIS18 and SIS100 harmonic number are 2 and 10, the relationship between the revolution and rf frequencies are $f_{h=2}^{SIS18}=2f_{h=1}^{SIS18}$ and $f_{h=10}^{SIS100}=10f_{h=1}^{SIS100}$. Since $C^{SIS100}$ is five times as long as $C^{SIS18}$, we could get the relation  $f_{h=1}^{SIS18}$=5$f_{h=1}^{SIS100}$ and $f_{h=10}^{SIS100}$=$f_{h=2}^{SIS18}$.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Beam Dynamics of the Phase Shift Method for $U^\mathit{28+}$}
The obtained phase shift $\Delta \phi$ is determined by the rf frequency modulation $\Delta f_{rf}$ and the duration of the frequency modulation $T$ (same as eq. ~\ref{phase1}). 
\begin{equation}
\Delta \phi= 2\pi \int_{t_0}^{t_0+T} \Delta f_{rf}(t)dt \label{phase_integration}
\end{equation}
In order to make the rf frequency modulation effective, the beam feedback loops on the rf system are switched off before the B2B transfer starts. There are a list of criteria for the rf frequency modulation for the longitudinal emittance to be preserved (see Sec. ~\ref{sec:requirement_phase_shift}).
\begin{itemize}
\item[-]
There exists a maximum rf frequency offset $\Delta f_\mathit{rf\_max}$, which comes from the constraint of $\Delta p/p_\mathit{\_max}$ in Tab. ~\ref{dynamic_param}. According to eq. ~\ref{eq:phaseP11}, $|\Delta f_\mathit{rf}| \le \SI{8.137}{kHz}$.
\item[-]
$|\frac{d\Delta f_{\mathit{rf}}}{dt}|$ must be continuous and small enough. Buckets must be big enough to capture bunches. From eq. ~\ref{eq:buckt_area_factor12} we know that the bucket area factor is in inverse proportion to $\frac{d\Delta f_{\mathit{rf}}}{dt}$. Hence, $|\frac{d\Delta f_{\mathit{rf}}}{dt}|$ must be small enough to guarantee the bucket size. $|\frac{d\Delta f_{\mathit{rf}}}{dt}|$ must be smaller than \SI{95}{Hz/ms} in order to guarantee the bucket area factor is larger than $80\%$. In addition, the synchronous phase must change continuously for the beam to follow. From eq. ~\ref{syn_phase} we know that $\frac{d\Delta f_{\mathit{rf}}}{dt}$ is proportional to the change in the synchronous phase. Hence, $|\frac{d\Delta f_{\mathit{rf}}}{dt}|$ must be continuous.
\item[-]
$|\frac{d^2\Delta f_{\mathit{rf}}}{dt^2}|$ must be small enough. From eq. ~\ref{eq:derivation} we know that the change rate of the synchronous phase must be slow enough for the beam to follow. If for instance the adiabaticity should be smaller than $1\cdot10^{-4}$, $|\frac{d^2\Delta f_{\mathit{rf}}}{dt^2}|$ must be smaller than \SI{70}{Hz/ms^2}.
\end{itemize}

According to these criteria, some rf frequency modulations are obviously ruled out of consideration. e.g. a trapezoid modulation and a triangular modulation, whose first derivatives are not continuous. The following three examples of rf frequency modulation are analyzed, which comply with the above mentioned criteria. The case (1) is a sinusoidal modulation and the amplitude is determined by the sinusoidal period, the case (2) is a parabolic modulation, which consists of three parabolas and two lines between every two parabolas, and the case (3) is also a parabolic modulation, including three parabolas. All three cases give the same phase shift, $\Delta \phi=\pi$, which is proved by substituting each form of $\Delta f_{rf}(t)$ into eq.~\ref{phase_integration} and performing integration. The phase shift is assumed to be achieved within \SI{7}{ms}, namely $T=\SI{7}{ms}$. Three rf frequency modulation cases are shown in Fig.~\ref{4case}. 

%Case (1)
%\begin{eqnarray}\label{case1}
%\Delta f(t)=
%\begin{cases}
%50(t-t_1), &t_1< t\le t_1+2ms\cr
%100, &t_1+2ms < t \le t_1+5ms \cr
%-50(t-t_1) + 7\cdot 50, &t_1+5ms < t\le t_1+7ms
%\end{cases}
%\end{eqnarray}
%
%Case (2)
%\begin{eqnarray}\label{case2}
%\Delta f(t)=
%\begin{cases}
%\frac {500}{3.5 \cdot 3.5}(t-t_1), &t_1< t\le t_1+3.5ms\cr
%-\frac {500}{3.5 \cdot 3.5}(t-t_1) +7
%\cdot \frac {500}{3.5 \cdot 3.5}, &t_1+3.5ms < t \le t_1+7ms 
%\end{cases}
%\end{eqnarray}
%
%Case (3)
%\begin{eqnarray}\label{case3}
%\Delta f(t)=
%\frac {1000}{7 \cdot 2} (1-cos(\frac{2\pi}{7}\cdot (t-t_1)), &t_1 < t\le t_1+7ms
%\end{eqnarray}
%
%Case (4)
%\begin{eqnarray}\label{case4}
%\Delta f(t)=
%\begin{cases}
%30(t-t_1)^2, &t_1< t\le t_1+1ms\cr
%30+ 60((t-t_1)-1), &t_1+1ms< t\le t_1+2.5ms\cr
%30(5-((t-t_1)-3.5)^2), &t_1+2.5ms< t\le t_1+4.5ms\cr
%
%30+60(6-(t-t_1)), &t_1+4.5ms< t\le t_1+6ms\cr
%30(7-(t-t_1))^2, &t_1+6ms< t\le t_1+7ms
%\end{cases}
%\end{eqnarray}

%Case (1) 
%\begin{eqnarray}\Delta f_{rf}(t)=
%\begin{cases}
%50Hz/ms \cdot (t-t_0) &t_0+0<t\le t_0+2ms\cr  100Hz &t_0+2<t\le t_0+5ms \cr 100Hz-50Hz/ms \cdot (t-t_0) &t_0+5ms<t\le t_0+7ms\cr 
%\end{cases}
%\end{eqnarray}
%
%Case (2) 
%\begin{eqnarray}\Delta f_{rf}(t)=
%\begin{cases}
%\frac{10^3}{7\cdot 3.5}Hz/ms \cdot (t-t_0) &t_0+0<t\le t_0+3.5ms\cr  \frac{10^3}{7}Hz-{\frac{10^3}{7\cdot 3.5}Hz/ms}\cdot {(t-t_0-3.5ms)} &t_0+3.5ms<t\le t_0+7ms \cr 
%\end{cases}
%\end{eqnarray}
%
%Case (1) 
%\begin{eqnarray}\Delta f_{rf}(t)=
%\frac{10^3}{14}Hz \cdot (1-cos(\frac{2\pi}{7} rad/ms\cdot (t-t_0))) &t_0+0<t\le t_0+7ms\cr  
%\end{eqnarray}
%
%Case (2) 
%\begin{eqnarray}\Delta f_{rf}(t)= \frac{20}{21}\cdot
%\begin{cases}
%30Hz/ms^2 \cdot (t-t_0)^2 &t_0+0<t\le t_0+1ms\cr  
%30Hz + 60Hz/ms\cdot (t-t_0 -1ms) &t_0+1ms<t\le t_0+2.5ms\cr 
%30Hz/ms^2 \cdot [5ms^2-(t-t_0-3.5ms)^2] &t_0+2.5ms<t\le t_0+4.5ms\cr  
%30Hz + 60Hz/ms\cdot [6ms-(t-t_0)] &t_0+4.5ms<t\le t_0+6ms\cr  
%30Hz/ms^2 \cdot [7ms^2-(t-t_0)]^2 &t_0+6ms<t\le t_0+7ms\cr  
%\end{cases}
%\end{eqnarray}
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{4case.png}
   \caption{Examples of rf frequency modulation.}
   \label{4case}
\end{figure}

Case (1) 
\begin{eqnarray}
\label{case_1}
\Delta f_{rf}(t)=
\frac{1}{2T}  [1-cos(\frac{2\pi}{T}(t-t_0))] &t_0+0<t\le t_0+T\cr  
\end{eqnarray}

Case (2) 
\begin{eqnarray}\Delta f_{rf}(t)= 
\begin{cases}
\frac{9}{T^3}(t-t_0)^2 &t_0+0<t\le t_0+\frac{T}{6}\cr  
\frac{1}{4T} +\frac{3}{T^2}(t-t_0 -\frac{T}{6}) &t_0+\frac{T}{6}<t\le t_0+\frac{2T}{6}\cr 
\frac{1}{T}-\frac{9}{T^3}(t-t_0-\frac{T}{2})^2 &t_0+\frac{2T}{6}<t\le t_0+\frac{4T}{6}\cr  
\frac{3}{4T} -\frac{3}{T^2}(t-t_0 -\frac{4T}{6})  &t_0+\frac{4T}{6}<t\le t_0+\frac{5T}{6}\cr  
\frac{9}{T^3}(t-t_0-T)^2 &t_0+\frac{5T}{6}<t\le t_0+T\cr  
\end{cases}
\end{eqnarray}

Case (3) 
\begin{eqnarray}\Delta f_{rf}(t)= 
\begin{cases}
\frac{8}{T^3}(t-t_0)^2&t_0+0<t\le t_0+\frac{T}{4}\cr  
\frac{1}{T}-\frac{8}{T^3}[(t-t_0)-\frac{T}{2}]^2	&t_0+\frac{T}{4}<t\le t_0+\frac{3T}{4}\cr 
\frac{8}{T^3}[T-(t-t_0)]^2	&t_0+\frac{4T}{4}<t\le t_0+T\cr  

\end{cases}
\end{eqnarray}


Fig.~\ref{1st_derivation} and Fig.~\ref{2nd_derivation} show the first and second derivative of three rf frequency modulations.
%, which are smaller than the maximum time derivative of rf frequency during the acceleration ramp 64Hz/ms for the adiabaticity consideration. The acceleration ramp is an adiabatical process.
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{1st_derivation.png}
   \caption{First derivative of three cases.}
   \label{1st_derivation}
\end{figure}
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{2nd_derivation.png}
   \caption{Second derivative of three cases.}
   \label{2nd_derivation}
\end{figure}

Fig.~\ref{phase_shift_four_case} shows the corresponding phase shift modulation of three cases. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{phase_shift_four_case.png}
   \caption{Phase shift modulation of three cases.}
   \label{phase_shift_four_case}
\end{figure}

\subsubsection{Longitudinal Dynamic Analysis}
In this section, the average radial excursion, the relative momentum shift, the synchronous phase, the bucket size and the adiabaticity of three rf frequency modulations are analyzed. 
\begin{itemize}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\item Orbit length displacement

The orbit length displacement is calculated for the three cases by eq.~(\ref{eq:phaseR}). Fig.~\ref{radial} shows the calculation result. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{radial.png}
   \caption{Maximum orbit length displacement of three cases.}
   \label{radial}
\end{figure}

\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Maximum orbit length displacement of three cases}
\label{radial excursion}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
      &Case (1) & Case (2)&Case (3) \\ \hline
       \tabincell{c}{Maximum orbit length displacement} &$4.18\cdot 10^{-6}$ &$4.18\cdot 10^{-6}$ &$4.18\cdot 10^{-6}$\\ \hline
			%Time & \SI{3.5}{\ms} & \SI{3.5}{\ms} & \SI{3.5}{\ms}\\ \hline
    \end{tabular}
\end{center}
\end{table}

As shown in Tab. \ref{radial excursion} the maximum orbit length displacement is $4.18\cdot 10^{-6}$ for all three cases, which is within the acceptable range in Tab. ~\ref{dynamic_param}. Hence, all cases are applicable. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\item Relative momentum shift

The relative momentum shift is calculated for three cases by eq.~\ref{eq:phaseP11}. Fig.~\ref{moment} shows the calculation result. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{moment.png}
   \caption{Relative momentum shift of three cases.}
   \label{moment}
\end{figure}
\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Maximum relative momentum shift of three cases}
\label{momentum excursion}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
      &Case (1) & Case (2)&Case (3) \\ \hline
       \tabincell{c}{Maximum relative momentum shift} & $1.40\cdot 10^{-4}$ & $1.40\cdot 10^{-4}$ &$1.40\cdot 10^{-4}$\\ \hline
			%Time 		& \SI{3.5}{\ms} & \SI{3.5}{\ms} & \SI{3.5}{\ms}\\ \hline
    \end{tabular}
\end{center}
\end{table}

As shown in Tab. \ref{momentum excursion} the maximum relative momentum shift is $1.40\cdot 10^{-4}$ for all three cases, which is within the acceptable range in Tab. ~\ref{dynamic_param}. Hence, all cases are applicable. 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\item Synchronous phase

The rf frequency modulations make the synchronous phase deviate from the nominal value $0$. Fig.~\ref{synch_phase} shows the changes in the synchronous phase $\phi_s$(t). It is calculated by substituting values into eq.~\ref{deriva_voltage}. For three cases, the synchronous phase $\Delta \phi_s(t)$ during the modulations are continuous without any phase jumps and smaller than $\pm6^\circ$. Hence, all cases are applicable.
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{synch_phase.png}
   \caption{Changes in synchronous phase of three cases.}
   \label{synch_phase}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5
\item Bucket size

The bucket area factor \gls{symb:bucket_size} varies during rf frequency modulations. Before the modulations, the synchronous phase $\phi_s$=$0$ and  $\alpha_b(0^\circ) = 1$. By substituting the changes in synchronous phase into eq.~\ref{eq:buckt_area_factor11}, we get the ratio of bucket areas of a running bucket to the stationary bucket for three cases, see Fig.~\ref{bucket_size}.

\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{bucket_size.png}
   \caption{Ratio of bucket areas of a running bucket to the stationary bucket of three cases.}
   \label{bucket_size}
\end{figure}

Tab. ~\ref{bucket size} shows the minimum bucket area factor for three cases. For case (1) and (2), the bucket area factor is larger than 86$\%$, which is larger than that of the case (3). Hence, case (1) and (2) are preferred compared with the case (3). 
\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Minimum bucket area factor of three cases}
\label{bucket size}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
      &Case (1) & Case (2)&Case (3) \\ \hline
       \tabincell{c}{Minimum bucket area factor} & 86.0$\%$ & 86.5$\%$ & 82.5$\%$\\ \hline
			%Time 		& \SI{1.750}{\ms} and \SI{5.250}{\ms} &\tabincell{c}{\SI{1.167}{\ms}-\SI{2.333}{\ms}, \\ \SI{4.667}{\ms}-\SI{5.833}{\ms}}  & \SI{1.750}{\ms} and \SI{5.250}{\ms}\\ \hline
    \end{tabular}
\end{center}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5
\item Adiabaticity

By substituting the values of $\phi_s(t)$, $\dot{\phi_s(t)}$ and $\omega_{s}$ into eq.~\ref{eq:derivation}, we get the adiabaticity parameter $\varepsilon$ for three cases, see Fig.~\ref{adiabaticity2}. 

Tab. ~\ref{adiabaticity_param} shows the maximum adiabaticity parameter for three cases. For case (1), the maximum of $\varepsilon$ is 0.000030. For case (2), the maximum of $\varepsilon$ occurs at $1/6T$, $2/6T$, $4/6T$ and $5/6T$, when the change rate of the synchronous phase $\dot{\phi_s(t)}$ has a maximum, shown in Fig.~\ref{synch_phase}. For case (3), the maximum of $\varepsilon$ occurs at $1/4T$ and $3/4T$, when the change rate of the synchronous phase $\dot{\phi_s(t)}$ has a maximum. For all three cases, the adiabaticity parameter has the order of magnitude $10^{-4}$. The calculation of the criteria of the adiabaticity is beyond the scope of this dissertation. 

\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{adiabaticity2.png}
   \caption{Adiabaticity parameter of three cases.}
   \label{adiabaticity2}
\end{figure}
\end{itemize}

\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Maximum adiabaticity of three cases}
\label{adiabaticity_param}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
      &Case (1) & Case (2)&Case (3) \\ \hline
       \tabincell{c}{Maximum adiabaticity} & $5.30\cdot10^{-5}$ & $5.90\cdot10^{-5}$ & $6.30\cdot10^{-5}$\\ \hline
			%Time 		& \tabincell{c}{\SI{0.875}{\ms}, \SI{2.625}{\ms}\\ \SI{4.250}{\ms} and \SI{6.125}{\ms} }&\tabincell{c}{\SI{1.167}{\ms}, \SI{2.333}{\ms}, \\ \SI{4.667}{\ms} and \SI{5.833}{\ms}} & \tabincell{c}{\SI{1.750}{\ms} \\and \\ \SI{5.250}{\ms}}\\ \hline
    \end{tabular}
\end{center}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Transverse Dynamics Analysis }
For the SIS18, the chromaticities $Q^`_x$ and $Q^`_y$ for the $U^\mathit{28+}$ operation are $-6.5$ and $-4.1$. Substituting the chromaticity and the maximum momentum shift (see. Tab. \ref{momentum excursion}) into eq. ~\ref{eq:chromaticity_x}, the chromatic \gls{glos:tune} shifts $\Delta Q_x$ and $\Delta Q_y$ during rf modulations for three cases can be calculated. Because case (1), case (2) and case (3) have the same maximum relative momentum shift, the chromatic tune shifts are same for the three rf frequency modulations.

\begin{equation}
\Delta Q_x = -6.5\cdot 1.40\cdot 10^{-4}=-9.10 \cdot 10^{-4}
\end{equation}
\begin{equation}
\Delta Q_y = -4.1\cdot 1.40\cdot 10^{-4}=-5.74\cdot 10^{-4} 
\end{equation}
The chromatic tune shift for three cases are negligibly small.

In a word, although all three cases meet the requirement of the parameters accompanying with the frequency adjustment, the case (1) of a sinusoidal modulation is the best one for the beam performance because of the smaller adiabaticity.  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Beam Dynamics of the Frequency Beating Method for $U^\mathit{28+}$} 
In the case of the frequency beating method, we guarantee the extraction and injection energy always match, which means that the momentum of the synchronous particle is not affected by the frequency detuning. Hence, the frequency detuning has no influence on the chromaticity tune shift.

\subsubsection{Longitudinal Dynamics Analysis}
 
For the frequency beating method, the rf frequency detuning is done at the SIS18 rf flattop. The SIS18 $U^\mathit{28+}$ acceptable displacement of the orbit length is $\pm2.4\cdot 10^{-4}$, see Tab. ~\ref{dynamic_param1}. Hence, the tolerable rf frequency change for $U^{28+}$ at the extraction energy \SI{200}{MeV/u} is calculated from eq. ~\ref{eq:eq4}.
%\begin{equation}
%\frac{\Delta{B}}{B}=-\frac{1}{\alpha_p}\frac{\Delta{L}}{L} = \pm  8 \cdot 10^{-3}
%%\gls{symb:radius} = \pm 2.4 \cdot 10^{-4}
%\end{equation}

\begin{equation}
\frac{\Delta{f}_\mathit{rf}}{f_\mathit{rf}} = -\frac{\Delta L}{L}= \mp 2.4 \cdot 10^{-4}
%\gls{symb:freq} = \pm 2.4 \cdot 10^{-4}
\end{equation}
where the maximum rf frequency detuning approximates to \SI{377}{Hz} for the cavity rf frequency of \SI{1.57}{MHz} of $U^{28+}$.
% Fig.~\ref{sis18_ramp} shows the rf frequency detuning during the rf ramp. In the simulation, the rf frequency is detuned at \SI{0.2756}{s} with \SI{6.08}{Hz/us}, see blue rectangle in Fig.~\ref{sis18_ramp}. For the sake of simplicity, \SI{200}{Hz} is used as the frequency detuning. The SIS18 needs approximate \SI{33}{\micro\second} to reach \SI{200}{Hz} with \SI{6.08}{Hz/us}.
%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=150mm]{sis18_ramp.png}
%   \caption{Frequency detune during the SIS18 $U^{28+}$ rf ramp.}
%   \label{sis18_ramp}
%\end{figure}

%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=150mm]{detune_ramp.jpg}
%   \caption{$U^{28+}$ rf detune during the rf ramp}
%   \label{detune_ramp}
%\end{figure}

%From eq.~\ref{eq:eq4} and eq.~\ref{eq:eq5}, we could get the corresponding radial excursion and the magnetic field change during the detune process. The maximum radial excursion is $-1.27 \cdot 10^{-4}$ and the maximum magnetic field change is $4.3 \cdot 10^{-3}$ at the end of the rf detune process.  
\subsection{Beam Dynamics of the Phase Shift Method for $H^+$} 

For the frequency adjustment of the SIS18 for the $U^\mathit{28+}$ beam, we know that the sinusoidal modulation is best for the beam stability. Now we will check whether the sinusoidal modulation is also applicable for the $H^+$ beam of the SIS18.

The criteria for the rf frequency modulation of the $H^+$ beam are
\begin{itemize}
\item[-]
The maximum rf frequency offset $\Delta f_\mathit{rf\_max}$ comes from the constraint of $\Delta p/p_\mathit{\_max}$ in Tab. ~\ref{dynamic_param1}. According to eq. ~\ref{eq:phaseP11}, $|\Delta f_\mathit{rf}| \le \SI{283}{Hz}$.
\item[-]
$|\frac{d\Delta f_{\mathit{rf}}}{dt}|$ must be continuous and smaller than \SI{1.9}{Hz/ms} to guarantee the bucket area factor larger than $80\%$. 
\item[-]
$|\frac{d^2\Delta f_{\mathit{rf}}}{dt^2}|$ must be smaller than \SI{0.2}{Hz/ms^2} to guarantee the adiabaticity smaller than $10^{-4}$.
\end{itemize}

	\subsubsection{Longitudinal Dynamics Analysis}
When the case (1), a sinusoidal modulation (same as the eq. ~\ref{case_1}) with $T=\SI{7}{ms}$, is used as the frequency modulation for the phase shift of $\pi$, we have the following parameters accompanying the modulation, see Tab. ~\ref{dynamic_param_H}. 

Case (1) 
\begin{eqnarray}
\Delta f_{rf}(t)=
\frac{1}{2T}  [1-cos(\frac{2\pi}{T}(t-t_0))] &t_0+0<t\le t_0+T\cr  
\end{eqnarray}

\begin{table}[!htb]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Parameters accompanying with a  \SI{7}{ms} sinusoidal modulation for the SIS18 $H^+$ beam}
\label{dynamic_param_H}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | c |}
    \hline
     \tabincell{c}{Relative\\momentum\\ shift} & \tabincell{c}{Maximum \\orbit length\\ displacement} &\tabincell{c}{Bucket\\size} & \tabincell{c}{Synchronous\\phase} &\tabincell{c}{Adiabaticity}  \\ \hline
       $<4.10\cdot10^{-3}$	 &$<4.09\cdot10^{-5}$ & $>0\%$ &  $\pm90.0^\circ$  & $<2500$\\ \hline
    \end{tabular}
\end{center}
\end{table}

Compared with the acceptable range of the parameters in Tab. ~\ref{dynamic_param}, the synchronous phase, the bucket size and the adiabaticity accompanying with the \SI{7}{ms} sinusoidal modulation are far beyond the acceptable range. Hence, a sinusoidal modulation with longer period must be used to guarantee these requirement. A sinusoidal modulation with $T=\SI{50}{ms}$ is used as the frequency modulation for the phase shift of $\pi$, we have the following parameters accompanying the modulation, see Tab. ~\ref{dynamic_param_H_20}. In this case, all parameters meet the requirement.

\begin{table}[!htb]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Parameters accompanying with a \SI{50}{ms} sinusoidal modulation for the SIS18 $H^+$ beam}
\label{dynamic_param_H_20}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | c |}
    \hline
     \tabincell{c}{Relative\\momentum\\ shift} & \tabincell{c}{Maximum \\orbit length\\ displacement} &\tabincell{c}{Bucket\\size}  & \tabincell{c}{Synchronous\\phase} &\tabincell{c}{Adiabaticity}  \\ \hline
       $<5.70\cdot10^{-4}$ & $<5.70\cdot10^{-6}$	& $>86\%$ &  $\pm4.2^\circ$  & $<0.80\cdot10^{-4}$\\ \hline
    \end{tabular}
\end{center}
\end{table}

For the frequency modulation of the SIS18 $H^+$ beam, a longer period sinusoidal modulation (e.g. \SI{50}{ms}) must be used for the beam performance consideration. 
 
	\subsubsection{Transverse Dynamics Analysis}

For the SIS18, the chromaticity $Q^`_x$ and $Q^`_y$ of $H^+$ is $-7.5$ and $-4.4$. Substituting the chromaticity and the maximum momentum shift (see. Tab. \ref{dynamic_param_H_20}) into eq. ~\ref{eq:chromaticity_x}. The maximum chromatic \gls{glos:tune} shift $\Delta Q_x$ and $\Delta Q_y$ during the \SI{50}{ms} sinusoidal modulation can be calculated. 

\begin{equation}
\Delta Q_x = -7.5\cdot 5.7\cdot 10^{-4}=-4.28 \cdot 10^{-3}
\end{equation}
\begin{equation}
\Delta Q_y = -4.4\cdot 5.7\cdot 10^{-4}=-2.51\cdot 10^{-3} 
\end{equation}
The chromatic tune shift to the tune for three cases are negligibly small.

\subsection{Beam Dynamics of the Frequency Beating Method for $H^+$} 
The frequency detuning has no influence on the chromaticity tune shift.

\subsubsection{Longitudinal Dynamics Analysis}

The SIS18 $H^+$ acceptable displacement of the orbit length is $\pm0.80\cdot10^{-4}$, see Tab. ~\ref{dynamic_param1}. Hence, the tolerable rf frequency change for $H^{+}$ at the extraction energy \SI{4}{GeV/u} is calculated from eq. ~\ref{eq:eq4}.
%\begin{equation}
%\frac{\Delta{B}}{B}=-\frac{1}{\alpha_p}\frac{\Delta{L}}{L} = \pm  8 \cdot 10^{-3}
%%\gls{symb:radius} = \pm 2.4 \cdot 10^{-4}
%\end{equation}
%From eq. ~\ref{eq:eq4}, the tolerable rf frequency change for $H^+$ at the extraction energy \SI{4}{GeV/u} is
\begin{equation}
\frac{\Delta{f}_\mathit{rf}}{f_\mathit{rf}} = -\frac{\Delta L}{L}= \mp 0.80 \cdot 10^{-4}
\end{equation}
where the maximum rf frequency detuning approximates to \SI{109}{Hz} for the cavity rf frequency of \SI{1.36}{MHz} of the $H^+$ beam.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{GMT Systematic Investigation}
\label{real_timing}
The B2B transfer system makes use of certain aspects of the GMT system to implement the data collection, merging and redistribution. The main task of the data merging is to calculate the start of the synchronization window, which is used for the selection of the bucket indication signal marker for the kicker trigger. The data collection and redistribution make use of the WR network, so the test and measurement of the WR network for the B2B transfer is important. In addition, the B2B transfer system has high timing requirement, therefore the flowcharts of the system and the corresponding time constraints are also presented in this section.

\subsection{Calculation of the Start of the Synchronization Window}
All calculations for the B2B transfer are based on the phase deviation measurement by the PAM module. With the help of the phase extrapolation by the PAP module and the timestamp for the extrapolated phase by the B2B source and target SCUs, the fine time point corresponding to the correct phase alignment between two synchronization frequencies is calculated, see Chap. ~\ref{concept}. This fine time point is called the ``\gls{glos:best_align}`` and denoted by $t_\mathit{align}$. There are some unavoidable uncertainties~\cite{taylor_introduction_1982} in the measurements. In this dissertation, the uncertainty analysis is based on the assumption that the rf frequency produced by DDS is exactly the same as the set value. There are three random measurement uncertainties, which need to be taken into consideration.  
\begin{itemize}
\item[-]The maximum error of the PAM module is $0.1^\circ$ ~\cite{klingbeil_detailed_2013}. Therefore $0.1^\circ$ is the uncertainty of a single phase measurement made by the PAM module. The phase extrapolation of the PAP module reduces the \gls{glos:uncertainty} by averaging multiple measurement samples of the phase deviation. In this dissertation, 100 measurement samples are assumed to be used and the corresponding uncertainty of the extrapolated phase equals to $0.1^\circ/\sqrt{100} =0.01^\circ$. The more measurement samples are used for the phase extrapolation, the smaller the uncertainty of the extrapolated phase will be. For more details, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_nodate}.
\item[-]The maximum error of BuTiS clocks is \SI{100}{\ps} per kilometer ~\cite{moritz_f-cs-rf-14e_2012}. Here we assume that the uncertainty of the BuTiS clocks is \SI{100}{\ps}. The phase is extrapolated at BuTiS T0 incidents. Hence, the uncertainty of the extrapolated phase caused by the BuTiS error is \SI{100}{\ps}. 
\item[-]Because of the nanosecond deviation between the edges of a BuTiS clock and the re-synthesized clock on SCUs in the WR network, the uncertainty of the timestamp corresponding to the extrapolated phase is assumed to be \SI{1}{ns} ~\cite{kreider_receiver_2014}. $t_\mathit{align}$ is defined as the timestamp corresponding to the extrapolated phase $\psi^\mathit{X}_0$.
\end{itemize}
 
% The rf frequency manipulation (e.g. the rf frequency modulation for the phase shift and the rf frequency detuning) has the long term stability, so the uncertainty of the rf frequency manipulation is neglectable. 
Because of the propagation of the uncertainties as mentioned above, the best estimate time of alignment lies within the time range between \gls{symb:best_align}$-\delta t_\mathit{align}$ and $t_\mathit{align}+\delta t_\mathit{align}$, where \gls{symb:probable_aligh} is the time uncertainty of the phase alignment. [$t_\mathit{align}-\delta t_\mathit{align}$, $t_\mathit{align}+\delta t_\mathit{align}$] is called the ``\gls{glos:pro_align}``. In order to achieve the highly precise bunch-to-bucket injection, the length of the probable time range of alignment must be much shorter than the length of the synchronization window. In Sec. ~\ref{cal_align}, the calculation and examination of $\delta t_\mathit{align}$ for the phase shift and frequency beating methods are explained. For the correct selection of the same rising edge of the bucket indication signal marker within the synchronization window at different SCUs, the start of the synchronization window must be properly calculated. In Sec.  ~\ref{cal_start}, the calculation of the start of the synchronization window is explained. In Sec.  ~\ref{cal_accuracy}, the requirement of the accuracy of the start of the synchronization window is discussed. 
%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=150mm]{alignment.jpg}
%   \caption{The illustration of the best estimate time of alignment, the probable time range of alignment and the synchronization window.}
%   \label{alignment}
%\end{figure}

%In fact, two SIS100 revolution periods is enough for the correct bucket selection, achieving much preciser injection. The beginning of the synchronization window denotes by $WIN_{start}$. The synchronization window is within the range [$WIN_{start}$ , $WIN_{start}$  + 2 $\cdot T_{rev}^{SIS100}$]. $T_{rev}^{SIS100}$is the revolution period of SIS100, which equals to 6.359 us for U$^{28+}$ at 200Mev/u.  
\subsubsection{Uncertainty of the Phase Alignment}
\label{cal_align}

In Chap. ~\ref{concept}, we get the extrapolated phase $\psi^\mathit{X}$ at the T0 incidents (see eq. ~\ref{extra_phase}) 
\begin{equation}
\label{111}
\psi^\mathit{X}(t)=[(2\pi(f_\mathit{B2B}^{X}-f_\mathit{ref})t+\varphi^X_0) \mod 2\pi] - \pi
\end{equation}
where $t$ corresponds to the T0 incidents. Because the phase of the \gls{glos:Syn_ref_signal} at the T0 incidents is $0^\circ$, namely $2\pi\cdot f_\mathit{ref}\cdot t=0$, eq. ~\ref{111} can be deduced to 
\begin{equation}
\label{222}
\psi^\mathit{X}(t)=[(2\pi\cdot f_\mathit{B2B}^{X} \cdot t+\varphi^X_0) \mod 2\pi] - \pi
\end{equation}

From eq. ~\ref{222}, we know that the uncertainty of the extrapolated phase is composed of two parts, the uncertainty of the phase measurement $\varphi^X_0$ and the uncertainty of the BuTiS T0 incidents $t$. The uncertainty of the extrapolated phase (denoted as \gls{symb:un_h1phase100}) is calculated as 
\begin{equation} 
\delta \psi^{X}=\sqrt{(\frac {\partial \psi^{X}}{\partial \varphi^X_0}\delta  \varphi^X_0)^2+(\frac {\partial \psi^{X}}{\partial t}\delta t)^2 }
\end{equation}

The uncertainty of the extrapolated phase in the phase domain and that in the time domain are calculated as 
\begin{equation} 
\delta \psi^{X}_\mathit{0\_phase}=\sqrt{(0.01^\circ)^2+(100ps \cdot f_\mathit{B2B}^\mathit{trg} \cdot {2\pi})^2}
\label{jitter_measure_p}
\end{equation}
\begin{equation} 
\delta \psi^{X}_\mathit{0\_time}=\sqrt{(\frac{0.01^\circ}{2\pi}\cdot \frac{1}{f_\mathit{B2B}^\mathit{trg}})^2+(100ps)^2} 
\label{jitter_measure_p}
\end{equation}

The phase difference $\Delta \phi_\mathit{syn\_0}$ between two synchronization frequencies at $t_\psi^X$ is calculated as (see eq. ~\ref{phase_shift_syn}).
\begin{eqnarray}\label{phase_syn}
\Delta \phi_\mathit{syn\_0}=
\begin{cases}
(\psi^\mathit{trg}_0-\psi^\mathit{src}_0) \mod 2\pi, &f_{\mathit{bucket}}=f_{\mathit{syn}}^{trg}\cr
\frac{h_{\mathit{syn}}^{trg}}{h_{\mathit{rev}}^{trg}}(\psi^\mathit{trg}_0-\psi^\mathit{src}_0) \mod 2\pi, &f_{\mathit{bucket}}=f_{\mathit{rev}}^{trg}\cr
\end{cases}
\end{eqnarray}

%According to the propagation of uncertainties, we get the uncertainty of the phase difference between two synchronization frequencies, denoted as \gls{symb:pha_shift_uncertain}. 
%\begin{eqnarray}\label{case4}
%\begin{aligned}
%\delta \Delta \phi_\mathit{syn}=\sqrt {(\frac {\partial \Delta \phi_\mathit{syn}}{\partial \psi^\mathit{trg}_0}\delta \psi^\mathit{trg}_0)^2 + (\frac {\partial \Delta \phi_\mathit{syn}}{\partial \psi^\mathit{src}_0}\delta \psi^\mathit{src}_0)^2} =\\
%\begin{cases}
%\sqrt {(\delta \psi^\mathit{trg}_0)^2 + (\delta \psi^\mathit{src}_0)^2}, &f_{\mathit{B2B}}^{trg}=f_{\mathit{syn}}^{trg}\cr
%\frac{f_{\mathit{syn}}^{trg}}{f_{\mathit{rev}}^{trg}}\sqrt {(\delta \psi^\mathit{trg}_0)^2 + (\delta \psi^\mathit{src}_0)^2}\mod 2\pi, &f_{\mathit{B2B}}^{trg}=f_{\mathit{rev}}^{trg}\cr
%\end{cases}
%\end{aligned}
%\end{eqnarray}

Both the B2B source SCU and the B2B target SCU measure the timestamp $t_\psi^X$ for the extrapolated phase and the uncertainty of the measured timestamp (denoted as \gls{symb:uncertainty_time}) is \SI{1}{ns}.  
\begin{equation} 
\delta t_\psi^X= \SI{1}{ns}
\label{jitter_measure_t}
\end{equation}

\begin{itemize}
\item Phase shift method

For the phase shift method, the duration of the rf frequency modulation is $T$, so the best estimate time of alignment is expressed by  eq.~\ref{Phase_win} (derived from eq.~\ref{syn_win_start})

\begin{equation}
t_\mathit{align} = t_{\psi}^X + \SI{600}{us}+T \label{Phase_win}
\end{equation}

The uncertainty of the rf frequency modulation is caused by the uncertainty of the phase extrapolation and the uncertainty of the timestamp. Hence, the phase alignment is calculated as
\begin{eqnarray}
\begin{aligned}
\delta t_\mathit{align} = \sqrt {(\frac {\partial t_\mathit{align}}{\partial t_\psi^\mathit{X}} \delta t_\psi^\mathit{X})^2 +(\frac {\partial t_\mathit{align}}{\partial \psi^\mathit{src}_0} \delta\psi^\mathit{src}_0)^2+(\frac {\partial t_\mathit{align}}{\partial \psi^\mathit{trg}_0} \delta\psi^\mathit{trg}_0)^2  }\\
=\sqrt {(\delta t_{\psi}^X)^2 + 2\cdot(\delta \psi^{X}_\mathit{0\_time})^2 }\approx \SI{1}{ns}
\end{aligned}
\end{eqnarray}
For all FAIR use cases, $f_\mathit{B2B}^\mathit{trg}$ is in the \SI{100}{kHz} range, so $\delta \psi^{X}_\mathit{0\_time}$ is in the \SI{300}{ps} range. The uncertainty of the phase alignment is approximately \SI{1}{ns}, which is much smaller than $T_\mathit{w}$ and is acceptable.

\item Frequency beating method

The best estimate time of alignment is determined by the required phase difference $\Delta \phi_\mathit{adjust}$ and calculated by eq.~\ref{best_align_beating} (derived from eq.~\ref{syn_win_start1}).
\begin{equation}
t_\mathit{align}= t_\psi^\mathit{X}+\frac{\Delta \phi_\mathit{adjust}}{2\pi}\cdot\frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}+ n\cdot \frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}
\label{best_align_beating}
\end{equation}

The uncertainty of the phase alignment is calculated as
%\begin{eqnarray}
%\begin{aligned}
%\delta t_\mathit{align} =\sqrt {(\frac {\partial t_\mathit{align}}{\partial t_\psi^\mathit{X}} \delta t_\psi^\mathit{X})^2 +(\frac {\partial t_\mathit{align}}{\partial \psi^\mathit{src}_0} \delta\psi^\mathit{src}_0)^2+(\frac {\partial t_\mathit{align}}{\partial \psi^\mathit{trg}_0} \delta\psi^\mathit{trg}_0)^2  }\\
%=\sqrt {(\delta t_\psi^\mathit{X})^2 +(\frac{1}{2\pi}\frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}\frac {\partial \Delta \phi_\mathit{adjust}}{\partial \psi^\mathit{src}_0}  \delta  \psi^\mathit{src}_0)^2 +(\frac{1}{2\pi}\frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}\frac {\partial \Delta \phi_\mathit{adjust}}{\partial \psi^\mathit{trg}_0}  \delta  \psi^\mathit{trg}_0)^2}\\
%\label{beating_uncertainty}
%\end{aligned}
%\end{eqnarray}

\begin{equation}
\begin{split}
\label{beating_uncertainty}
\delta t_\mathit{align} =\sqrt {(\frac {\partial t_\mathit{align}}{\partial t_\psi^\mathit{X}} \delta t_\psi^\mathit{X})^2 +(\frac {\partial t_\mathit{align}}{\partial \psi^\mathit{src}_0} \delta\psi^\mathit{src}_0)^2+(\frac {\partial t_\mathit{align}}{\partial \psi^\mathit{trg}_0} \delta\psi^\mathit{trg}_0)^2  }\\
=\biggl\{
   (\delta t_\psi^\mathit{X})^2 +(\frac{1}{2\pi}\frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}\frac {\partial \Delta \phi_\mathit{adjust}}{\partial \psi^\mathit{src}_0}  \delta  \psi^\mathit{src}_0)^2 \\
  +
        (\frac{1}{2\pi}\frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}\frac {\partial \Delta \phi_\mathit{adjust}}{\partial \psi^\mathit{trg}_0}  \delta  \psi^\mathit{trg}_0)^2   
  \biggr\}^{\!1/2}
\end{split}
\end{equation}

The relation between $\Delta \phi_\mathit{adjust}$ and $\Delta \phi_\mathit{syn\_0}$ is explained in Chap. ~\ref{concept}, see eq. ~\ref{req_phase}. Because $\Delta \phi_\mathit{adjust}$ and $\Delta \phi_\mathit{syn\_0}$ have a linear relationship and the linear slope is $1$, $\frac {\partial \Delta \phi_\mathit{adjust}}{\partial \psi^\mathit{trg}_0}=\frac {\partial \Delta \phi_\mathit{syn\_0}}{\partial \psi^\mathit{trg}_0}$ and $\frac {\partial \Delta \phi_\mathit{adjust}}{\partial \psi^\mathit{src}_0}=\frac {\partial \Delta \phi_\mathit{syn\_0}}{\partial \psi^\mathit{src}_0}$. Based on eq. ~\ref{phase_syn}, we get the partial derivative of $\Delta \phi_\mathit{adjust}$ with respect to $\psi^\mathit{src}_0$ and $\psi^\mathit{trg}_0$.
\begin{eqnarray}\label{partial}
|\frac {\partial \Delta \phi_\mathit{adjust}}{\partial \psi^\mathit{trg}_0}| = |\frac {\partial \Delta \phi_\mathit{adjust}}{\partial \psi^\mathit{src}_0}|=
\begin{cases}
1, &f_{\mathit{bucket}}=f_{\mathit{syn}}^{trg}\cr
\frac{h_{\mathit{syn}}^{trg}}{h_{\mathit{rev}}^{trg}}, &f_{\mathit{bucket}}=f_{\mathit{rev}}^{trg}\cr
\end{cases}
\end{eqnarray}

$\delta \psi^{src}_\mathit{0\_phase}\approx\delta \psi^{trg}_\mathit{0\_phase}$ and substituting eq. ~\ref{partial} into eq.~\ref{beating_uncertainty}, we get 
\begin{eqnarray}
\delta t_\mathit{align}=
\begin{cases}
\sqrt {(\delta t_\psi^\mathit{X})^2 +2(\frac{1}{2\pi}\frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|} \delta \psi^{X}_\mathit{0\_phase})^2 }, &f_{\mathit{bucket}}=f_{\mathit{syn}}^{trg}\cr
\sqrt {(\delta t_\psi^\mathit{X})^2 +2(\frac{1}{2\pi}\frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|} \frac{h_{\mathit{syn}}^{trg}}{h_{\mathit{rev}}^{trg}}\delta \psi^{X}_\mathit{0\_phase})^2 }, &f_{\mathit{bucket}}=f_{\mathit{rev}}^{trg}\cr
\end{cases}
\end{eqnarray}

Tab. ~\ref{uncertainty} shows the uncertainty of the phase alignment for all FAIR use cases. For more details about parameters, please see Chap. ~\ref{application}.
\begin{landscape}
\begin{table}[!htb]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Uncertainty of the phase alignment of all FAIR B2B use cases}
\label{uncertainty}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | c |}
	    \hline
	\tabincell{c}{ FAIR use cases}& $f_{\mathit{B2B}}^\mathit{trg}$ & $\delta \psi^{X}_\mathit{0\_phase}$  & $|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|$ & $\delta t_\mathit{align}$ & $T_\mathit{w}$ & $\delta t_\mathit{align}/T_\mathit{w}$\\ \hline
   \tabincell{c}{$U^{28+}$ B2B transfer from the SIS18 to the SIS100}& \SI{157}{kHz} & $0.012^\circ$  &\SI{200}{Hz} & \SI{2.36}{\micro\second} & \SI{6.36}{\micro\second}& 0.37 \\ \hline
	\tabincell{c}{$H^{+}$ B2B transfer from the SIS18 to the SIS100}& \SI{272}{kHz}&$0.014^\circ$  & \SI{200}{Hz} & \SI{1.27}{\micro\second}& \SI{3.68}{\micro\second}& 0.35 \\ \hline
	\tabincell{c}{h=4 B2B transfer from the SIS18 to the ESR}&\SI{686}{kHz}& $0.027^\circ$ &  \SI{1899}{Hz} & \SI{0.12}{\micro\second}& \SI{1.46}{\micro\second} & 0.08 \\ \hline
	\tabincell{c}{h=1 B2B transfer from the SIS18 to the ESR}&\SI{988}{kHz}&$0.037^\circ$ & \SI{1368}{Hz} & \SI{0.11}{\micro\second}& \SI{1.02}{\micro\second} & 0.11\\ \hline	
	\tabincell{c}{B2B transfer from the ESR to the CRYRING}& \SI{685}{kHz} & $0.027^\circ$  & \SI{949}{Hz} &\SI{0.12}{\micro\second}& \SI{1.46}{\micro\second} &0.08 \\ \hline	
	\tabincell{c}{$H^{+}$ B2B transfer from the SIS100 to the CR\\ via the pbar target} &\SI{55}{kHz} &$0.010^\circ$ & \SI{450}{Hz} & \SI{0.09}{\micro\second}& \SI{18.23}{\micro\second}& 0.005\\ \hline	
	\tabincell{c}{RIB B2B transfer from the SIS100 to the CR \\ via the Super FRS}&\SI{102}{kHz}&$0.014^\circ$ &  \SI{108}{Hz} & \SI{0.51}{\micro\second} & \SI{9.78}{\micro\second}& 0.05\\ \hline	
	\tabincell{c}{Antiproton B2B transfer from the CR to the HESR }&\SI{101}{kHz}&$0.013^\circ$ & \SI{136}{Hz} & \SI{0.40}{\micro\second}& \SI{9.86}{\micro\second}& 0.04 \\ \hline	
	\tabincell{c}{B2B transfer from the SIS18 to the ESR \\via the FRS}&\SI{220}{kHz}&$0.018^\circ$ & \SI{4249}{Hz} & \SI{0.02}{\micro\second}& \SI{4.55}{\micro\second} &0.004 \\ \hline	
   \end{tabular}
\end{center}
\end{table} 
\end{landscape}
In conclusion, the uncertainty of the extrapolated phase plays a leading role for $\delta t_\mathit{align}$ of the frequency beating method. The uncertainty of the phase alignment for all FAIR use cases is smaller than the length of the synchronization window. However, there are several FAIR use cases, whose bunch-to-bucket injection center mismatch are significantly influenced by the uncertainty. They are the $U^{28+}$ B2B transfer from the SIS18 to the SIS100, the $H^{+}$ B2B transfer from the SIS18 to the SIS100 and the h=1 B2B transfer from the SIS18 to the ESR, whose ratio between the uncertainty of the phase alignment and the length of the synchronization window is larger than $10\%$. Even though the bunch-to-bucket injection center mismatch of these cases is deteriorated, they still meet the mismatch requirement smaller than $\pm1^\circ$. Hence, the uncertainty of the $0.01^\circ$ phase extrapolation and the uncertainty of the \SI{100}{ps} BuTiS and the uncertainty of the \SI{1}{ns} timestamp are acceptable for the FAIR B2B transfer system.

In addition, the timestamp of the bucket indication signal markers (denoted as $t_\mathit{marker}$) can be calculated by the B2B source SCU as
\begin{equation}
\label{bucket_indication}
t_\mathit{marker}=t_\psi^\mathit{X}+\frac{\pi- \psi^{trg}_0}{2\pi}\cdot \frac{1}{f_\mathit{bucket}}+ n\cdot \frac{1}{f_\mathit{bucket}}
\end{equation} 
From the Tab. ~\ref{uncertainty}, we know the uncertainty of the extrapolated phase $\delta \psi^{X}_0$ for all FAIR use cases is smaller than $0.05^\circ$. $f_\mathit{bucket}$ is in the \SI{100}{kHz} range. Hence, the uncertainty of $t_\mathit{marker}$ caused by the uncertainty of the extrapolated phase and the uncertainty of the timestamp is smaller than \SI{2}{ns}. \SI{2}{ns} is acceptable for the kicker trigger. Instead of the reproduction of the bucket indication signal, the B2B source SCU is able to calculate the timestamp corresponding to the $1^\mathit{st}$ bucket indication signal marker within the synchronization window. 
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Uncertainty of the Start of the Synchronization Window}
\label{cal_start}
The start of the synchronization window is expressed as 
\begin{equation}
t_\mathit{w}=t_\psi^\mathit{X}+\Delta t_\mathit{w}\label{syn_win_start2}
\end{equation}

with 
\begin{eqnarray}
\Delta t_\mathit{w}=
\begin{cases}
\SI{600}{\us}+T-t_\mathit{delay}\ &\textit{Phase shift method}\cr
\cr
\frac{\Delta \phi_\mathit{adjust}}{2\pi}\cdot\frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}+n\cdot \frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}-\frac{T_w}{2}-t_\mathit{delay} & \textit{Frequency beating method}\cr
\end{cases}
\end{eqnarray}
For more details, please see Chap. ~\ref{concept}.

The synchronization window is used to select the $1^\mathit{st}$ bucket indication signal marker. In reality, the relative position between the start of the synchronization window and the $1^\mathit{st}$ bucket indication signal marker is arbitrary. In order to guarantee the correct selection of the bucket indication signal marker at both the source and target accelerators, the start of the synchronization window will be rectified to half the period of the bucket indication signal before the selected marker. The rectified start is called the ``best estimate time of the start of the synchronization window``, denoted as \gls{symb:win_start_rect}. The value used for the rectification is denoted as $\Delta t_\mathit{w\_rect}$, see Fig.~\ref{accuracy_syn_win}. However, the actual start of the synchronization window is impossible to be exactly at \gls{symb:win_start_rect} because of the propagation of the uncertainty. The start of the synchronization window lies between \gls{symb:win_start_rect}$-\delta t_\mathit{w\_rect}$ and $t_\mathit{align}+\delta t_\mathit{w\_rect}$, where \gls{symb:probable_win_start} is the uncertainty of the start of the synchronization window. 
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{accuracy_syn_win.jpg}
   \caption{Illustration of the rectification for the start of the synchronization window.}
   \label{accuracy_syn_win}
\end{figure}

The rectification for the start of the synchronization window is calculated by
\begin{equation}
\Delta t_\mathit{w\_rect}=\frac{1}{2f^\mathit{trg}_\mathit{B2B}}-[(\Delta t_\mathit{w} - \frac{2\pi-\psi^\mathit{trg}_0}{2\pi}\frac{1}{f^\mathit{trg}_\mathit{B2B}}) \mod \frac{1}{f^\mathit{trg}_\mathit{B2B}}]
\end{equation}

The best estimate time of the start of the synchronization window is calculated by
\begin{equation}
t_\mathit{w\_rect}=t_\psi^\mathit{X}+\Delta t_\mathit{w}+\Delta t_\mathit{w\_rect}
\end{equation}

The uncertainty of $t_\mathit{w\_rect}$ is caused by the uncertainty of the phase extrapolation and the uncertainty of the timestamp, calculated by 
\begin{eqnarray}
\begin{aligned}
\delta t_\mathit{w\_rect} =\sqrt {(\frac {\partial t_\mathit{w\_rect}}{\partial t_\psi^\mathit{X}} \delta t_\psi^\mathit{X})^2 +(\frac {\partial t_\mathit{w\_rect}}{\partial \psi^\mathit{src}_0} \delta\psi^\mathit{src}_0)^2+(\frac {\partial t_\mathit{w\_rect}}{\partial \psi^\mathit{trg}_0} \delta\psi^\mathit{trg}_0)^2  }\\
=\sqrt {(\delta t_\psi^\mathit{X})^2 +(\frac {\partial \Delta t_\mathit{w}}{\partial \psi^\mathit{src}_0}+\frac {\partial \Delta t_\mathit{w\_rect}}{\partial \psi^\mathit{src}_0})^2 (\delta \psi^\mathit{src}_0)^2+(\frac {\partial \Delta t_\mathit{w}}{\partial \psi^\mathit{trg}_0}+\frac {\partial \Delta t_\mathit{w\_rect}}{\partial \psi^\mathit{trg}_0})^2 (\delta\psi^\mathit{trg}_0)^2 }\\
=\sqrt {(\delta t_\psi^\mathit{X})^2 + (\frac{1}{2\pi}\frac{1}{f^\mathit{trg}_\mathit{B2B}}\delta \psi^{X}_\mathit{0\_phase})^2}
\end{aligned}
\end{eqnarray}

For FAIR use cases, $f^\mathit{trg}_\mathit{B2B}$ is in the \SI{100}{kHz} range and $\delta\psi^\mathit{trg}_0$ is less than $0.05^\circ$ (see Tab. ~\ref{uncertainty}). Hence, $\delta t_\mathit{w\_rect}$ is smaller than \SI{2}{ns}. 

\subsubsection{Requirement of the Accuracy of the Start of the Synchronization Window}
\label{cal_accuracy}
%The actual start of the synchronization window is impossible to be exactly at the best estimate of the start of the synchronization window because of random uncertainty (e.g. the transition time from low to high voltage of digital IO ports) and systematic uncertainty (e.g. the FPGA process time). 
The \gls{glos:accuracy} of the start of the synchronization window is the deviation between the theoretically calculated start time and the actual observed start time on SCUs. The FAIR B2B transfer system will be used for all FAIR use cases. Therefore, we have to find the most stringent accuracy requirement. The shortest synchronization window is \SI{1.017}{\us}, which comes from h=1 B2B transfer from the SIS18 to the ESR. We keep \SI{5}{ns} before and after the bucket indication signal marker as the forbidden range, which takes account of the \SI{2}{ns} uncertainty of the bucket indication signal. In Fig.~\ref{accuracy_syn_win1}, the green region represents the safety margin for the start of the synchronization window and the red region the forbidden range. So the requirement of the accuracy of the start of the synchronization window is 

\begin{equation}
Accuracy\_requirement=\frac{\SI{1.017}{us}-\SI{5}{ns} \cdot 2}{2} \approx  \SI{500}{\ns}\label{accu}
\end{equation}

\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=120mm]{accuracy_syn_win1.jpg}
   \caption{Illustration of the accuracy of the start of the synchronization window.}
   \label{accuracy_syn_win1}
\end{figure}




%
%
%
%For SIS100, the rf phase of the revolution frequency is $\psi_{h=1}^{SIS100}$ at $t_{\psi}$. We could calculate the rf phase \gls{symb:phase_s_alignment} of the revolution frequency at the start of the probable rang of alignment, $t_\mathit{align}$-$\delta t_\mathit{align}$.
%\begin{equation}
%\begin{aligned}
%\psi_{s\_alignment}=\frac{(t_\mathit{align}-\delta t_\mathit{align}-t_{\psi}- \frac{2\pi-\psi_{h=1}^{SIS100}}{2\pi} \cdot {T_{h=1}^{SIS100}}) \mod T_{h=1}^{SIS100}}{T_{h=1}^{SIS100}}\cdot {2\pi} 
%\label{phase_after_syn}
%\end{aligned}
%\end{equation}
%
%For the calculation of the best estimate of the start of the synchronization window, there are two scenarios. \gls{symb:win_correction} is the time correction for the start of the probable time range of alignment to the best estimate of the start of the synchronization  window, see Fig.~\ref{accuracy_syn_win}.
%\begin{itemize}
%\item $\psi_{s\_alignment}\in [0^\circ,180^\circ)$, the orange rectangle in Fig.~\ref{accuracy_syn_win}
%\begin{equation}
%\begin{aligned}
%\Delta t_{win \_correct}=\frac{\psi_{s\_alignment}}{2\pi}\cdot T_{h=1}^{SIS100}+\frac{T_{h=1}^{SIS100}}{2}
%\end{aligned}
%\end{equation}
%\begin{equation}
%\begin{aligned}
%WIN_{start}= t_\mathit{align}- \delta t_\mathit{align}-\Delta t_{win \_correct}
%\end{aligned}
%\end{equation}
%
%
%\item $\psi_{s\_alignment}\in [180^\circ,2\pi)$, the blue rectangle in Fig.~\ref{accuracy_syn_win}
%
%\begin{equation}
%\begin{aligned}
%\Delta t_{win \_correct}=\frac{\psi_{s\_alignment}-180^\circ}{2\pi}\cdot T_{h=1}^{SIS100}
%\end{aligned}
%\end{equation}
%\begin{equation}
%\begin{aligned}
%WIN_{start}= t_\mathit{align}- \delta t_\mathit{align}-\Delta t_{win \_correct}
%\end{aligned}
%\end{equation}
%
%\end{itemize}
%
%The actual start of the synchronization window is impossible to be exactly at the best estimate of the start of the synchronization window because of the precision and trueness~\cite{_statistical_????}. The \gls{glos:precision} is defined as the closeness of agreement between the actual start of the synchronization window of different SCUs and the \gls{glos:trueness} as the closeness of agreement between the average actual start of the synchronization window of different SCUs and the best estimation start of the synchronization window. The precision comes from the random error, e.g. IO port \gls{TTL} signal rising oscillation. The trueness is the systematic error, e.g. FPGA process time. The \gls{glos:accuracy} is defined as the closeness of agreement between the observed start and the best estimate of the start of the synchronization window, which is the sum of the precision and trueness. The B2B transfer system will be used for many transfers for FAIR. Therefore, we have to find the most stringent accuracy requirement. The shortest revolution period of the target machine is \SI{433}{\ns}, which comes from RIB transfer from CR to HESR. We keep 10ns as a forbidden range, which means that the actual start is not allowed \SI{10}{\ns} before and after the revolution frequency marker. The green region in Fig.~\ref{accuracy_syn_win} represents the safety margin for the start of the synchronization window. So the accuracy of the start of the synchronization window must meet the requirement calculated by eq. ~\ref{accu}.
%\begin{equation}
%\begin{aligned}
%Accuracy=\pm\frac{433-10 \cdot 2}{2}\approx \pm \SI{200}{\ns}\label{accu}
%\end{aligned}
%\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Characterization of the WR Network for the B2B Transfer}
\label{wr_network}
This section is part of the results of the characterization of the WR Network of the FAIR General Machine Timing System. The scenario and test definition is done by C. Prados as part of his PhD thesis~\cite{prados_notitle_nodate}. I executed the test for the B2B scenario and discussed, evaluated and documented the results. 

In the test, the Xena's Layer 2-3 test platform \footnote{Xena's Layer 2-3 test platform\\ \url{http://xenanetworks.com/layer-2-3-test-platform/}} was used to characterize the properties of the WR network for the B2B transfer. The Xena's Layer 2-3 test platform was used to configure and generate Ethernet traffic at the data link layer and network layer and then to analyze how WR network in response. The test platform used the 4U XenaBay chassis which was equipped with an extensive range of copper and optical Gigabit Ethernet test modules. In the test, the test modules used 18 AXGE-1254 transceivers, \SI{1.25}{Gbps} single fiber bidirectional small form-factor pluggable (SFP), to connect to ports of four WR switches via single mode fibers \footnote{A G.652.B type single mode fiber is used for the 1310 and \SI{1550}{nm} wavelength region.}. The chassis and test modules were controlled via Xena Manager-2G, a free Windows GUI client, which can be used to manage test equipment and execute test remotely. Fig. ~\ref{network_B2B2} shows an overview of the Xena's Layer 2-3 test platform for the WR network.
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{network_B2B2.jpg}
   \caption{An overview of the Xena's Layer 2-3 test platform for the WR network.}
 %   \caption*{\textsl{\small{Adapted from ``Testing the WR Network of the FAIR General Machine Timing System`` by C. Prados and J. Bai, 2016, GSI Internal Document. Adapted with permission.}}}
   \label{network_B2B2}
\end{figure}

The XenaBay sends traffic streams with a unique stream ID and receives the identical traffic streams for identifying the measurement. It can be used for the following measurements.

\begin{itemize}
%    \item \gls{glos:lost_error} - the difference between the number of the sent frames and that of the received frames. In the following analysis, the frame error rate (FER) is used to assess the quality of network, which is defined as the ratio between the number of lost frames and the total number of transferred frames. Due to the transmission channel noise, interference, attenuation and etc, the optical fiber causes bit errors. If a switch receives a frame with one error bit, the complete frame will be discarded. The bit error rate (BER) is used as an approximate estimate of the bit error probability, which is defined as the ratio between the number of bit errors and the total number of transferred bits. For the calculation of the BER, please see ~\cite{prados_white_2011}. In the test, no forward error correction mechanism is used and the bit errors caused by fibers connected to the Xena receiver ports will not cause frame loss, so the relation between the FER and BER is
    \item Lost frame - the difference between the number of the sent frames and that of the received frames. In the following analysis, the frame loss rate (\gls{FLR}) is used to assess the quality of network, which is defined as the ratio between the number of lost frames and the total number of sent frames. 

    \item Misordered frame - the number of \gls{glos:misorder_error}s arriving out of sending sequence.
%	\item \gls{glos:pay_error} - the number of packets received that failed the frame check sequence
	\item Frame transfer latency - the time interval between the time of XenaBay port receiving a frame and the time of another XenaBay port sending the same frame.
%	\item \gls{glos:jitter} - the time deviation between the latency of two consecutive received frames from one Xena port to another Xena port
\end{itemize}


\subsubsection{Traffic on the WR Network} 
For the measurement reported here, the following types of traffic are considered~\cite{prados_testing_2016}. The bandwidth is defined in units of bits sent per second. 

\begin{itemize}
    \item DM Broadcast 

The DM broadcasts timing frames, control messages, downwards to all FECs. The average bandwidth for the DM broadcast is \SI{100}{Mbit/s}. The burst\footnote{A group of consecutive frames with shorter inter frame gaps than frames arriving before or after the burst of frames.} speed is 12 frames per \SI{100}{\micro\second}. The length of the DM Broadcast frame is 110 bytes.
 		\item DM Unicast 

The DM sends \SI{10}{Mbit/s} unicast timing frames to some specified FECs at the burst speed of 3 frames per \SI{300}{\micro\second}. The length of the DM Unicast frame is 110 bytes.
	\item B2B Unicast

The B2B Unicast traffic are frames sent by the B2B source SCU and received only by the DM. The maximum cycle repetition frequency for FAIR is the SIS18 $U^{28+}$ super cycle, which is \SI{2.82}{\Hz}~\cite{liebermann_sis100_2013}. The B2B source SCU sends 2 \gls{glos:timing_frame}s upwards to the DM within \SI{10}{\ms} for each cycle. The bandwidth is calculated as
\begin{equation}
\begin{split}
		bandwidth=\text{cycle repetition frequency}\cdot   \\ \text{the number of frames per cycle} \cdot \text{frame length}
\label{bandwidth}
\end{split}
\end{equation}

Hence, the bandwidth of the B2B Unicast traffic can be calculated according to eq. ~\ref{bandwidth} as $2.82\cdot2\cdot880<$ \SI{5}{kbit/s}. The burst speed is 2 frames per cycle, namely $1/\SI{2.82}{Hz}=\SI{350}{\ms}$.
	\item B2B Broadcast

The B2B Broadcast traffic are frames exchanged among B2B related SCUs. Maximum 10 B2B broadcast timing frames are sent within \SI{10}{\ms} for each cycle. Hence, the bandwidth of the B2B broadcast traffic can be calculated according to eq. ~\ref{bandwidth} as $2.82\cdot10\cdot880<$ \SI{25}{kbit/s}. The burst speed is 10 frames per \SI{350}{\ms}.

	\item Management Traffic

The average bandwidth for the management traffic is \SI{10}{Mbit/s}. It broadcasts packets with random Ethernet frame length from 64 bytes to 1518 bytes. 
\end{itemize}

According to the importance of the network traffic, the prioritization of WR network traffic is implemented based on the VLAN technology. The DM Broadcast and Unicast traffic, the control messages, is the most importance traffic, which must be delivered  deterministically and with very low loss. Hence, it is assigned to the VLAN 7 with the highest priority. Besides, the B2B Unicast traffic is also assigned to the VLAN 7, which realizes the communication between the B2B source SCU and the DM. In order to reduce the network traffic, the B2B Broadcast traffic is only broadcasted among the B2B related SCUs, therefore the B2B Broadcast traffic is assigned to the VLAN 6 with the secondary priority. Finally, the Management traffic is assigned to the VLAN 5 with the lowest priority~\cite{prados_testing_2016}.

%The test is used to measure the frame error rate, misordered frame on the WR network and the frame latency of every WR switch, in order to identify the tolerable number of WR switch layers for the B2B related traffic, including the number of WR switch layers between the B2B related SCUs and the number of WR switch layers between the B2B related SCUs and DM. 



\subsubsection{Frame Loss of the WR Network for the B2B Transfer} 

Due to the transmission channel noise, interference, attenuation and other factors, the optical fiber connections cause unavoidable bit errors. When a frame with a bit error passes a WR switch, it will be dropped by the switch. The lost frame caused by bit errors is measured by the frame error rate (\gls{FER}), which is defined as the ratio between the number of \gls{glos:lost_error}s caused by bit errors and the number of sent frames. The FER varies with the number of fiber connections. The bit error rate (\gls{BER}) is defined as the ratio between the number of bit errors and the total number of sent bits. The BER for fiber connections is calculated as~\cite{prados_white_2011} 
\begin{equation}
	BER=n\cdot10^{-12}
\end{equation}
where n is the number of the fiber connections used to establish the communication and the fiber's BER is specified by the manufactures is $10^{-12}$ \footnote{Datasheet of Draka optical fbier \\ \url{http://www.drakauc.com/ucfibre-optical-patchcords/}}. 
 
When no forward error correction mechanism is used. The relation between the FER and BER is
\begin{equation}
\label{m-n}
	FER=(BER-m\cdot10^{-12})\cdot 880=(n-m)\cdot10^{-12}\cdot 880
\end{equation}
where 880 is the length of a B2B Broadcast or B2B Unicast frame and $m$ represents the number of the fiber connections to the frame reception FECs and $n-m$ is the number of WR switch layers.  

The duration for the occurrence of one lost frame caused by a bit error is calculated as 
\begin{equation}
\label{duration}
	t=\frac{880}{FER}\cdot \frac{1}{bandwidth}
\end{equation}
 
In actual application of the B2B transfer system, there is only one frame reception FEC for the B2B Unicast traffic, namely $m=1$. For the B2B Broadcast traffic, there are total six ring accelerators (SIS18, SIS100, ESR, CR, HESR and CRYRING) and every ring needs three FECs for the data exchange, the B2B source/target SCU, the Trigger SCU and the Kicker SCU. Hence, there is one frame sending FEC and 17 frame reception FECs, namely $m=17$. Fig. ~\ref{FER_2case} shows the relation between the FER and the number of fiber connection for two traffics.   
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{FER_2case.png}
   \caption{Relation between the FER and the fiber connections for B2B Unicast and Broadcast traffics.}
	%\caption*{\textsl{\small{(No forward error correction mechanism is used.)}}}
   \label{FER_2case}
\end{figure}

%For the measurements reported in the dissertation, the lost frame, the misordered frame and the payload error frame are taken into consideration in the format of the \gls{glos:frame_error_rate} (\gls{FER}), which is defined as the percentage of frames with these three types of errors relative to the total number of transferred frames on a specified port during a studied time interval. 
%\begin{equation}
%FER=\frac{lost \;frame+misordered \;frame+payload \;error\; frame}{total \;number\; of \;transferred\; frames}
%\end{equation}

\subsubsection{WR Network Test Setup}
In order to test the WR Network in the context of the B2B transfer, the following setup based on the Xena's Layer 2-3 test platform was developed in the framework of this thesis. Four WR switches were connected to the port 1 to 18 of the XenaBay chassis. Taking the network traffic requirements listed above into consideration, all ports of four WR switches were assigned to three VLANs, VLAN 5, VLAN 6 and VLAN 7. The DM Broadcast frames were sent by the XenaBay port 1 and received by ports 2 - 6 through the $1^{st}$ WR switch and received by ports 7 - 10 through the $1^{st}$ and $2^{nd}$ WR switches and received by ports 11 - 14 through the $1^{st}$, $2^{nd}$ and $3^{rd}$ WR switches and received by ports 15 - 18 ports through four WR switches. The DM Unicast frames were sent by the port 3 and received by the port 18 through four WR switches. The B2B Broadcast frames were sent by the port 16 and received by ports 15, 17 and 18 through the $4^{th}$ WR switch and received by ports 11 - 14 through the $4^{th}$ and $3^{rd}$ WR switches and received by ports 7 - 10 through the $4^{th}$, $3^{rd}$ and $2^{nd}$ WR switches and received by ports 1 - 6 through four WR switches. The B2B Unicast frames were sent by the port 17 and received by the port 1 through four WR switches. The Management traffic were produced by 7 XenaBay ports and received by all ports, see Fig.~\ref{GSI_use_case.jpg}.  Tab. ~\ref{test_setup_network} shows the traffic characteristic produced by XenaBay ports in details. 
%More test configuration, please see ``Testing the WR Network of the FAIR General Machine Timing System`` ~\cite{prados_testing_2016}.
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{GSI_use_case.pdf}
   \caption{Connection between WR switches and the XenaBay of the test setup.}
    \caption*{\textsl{\small{Adapted from ``Testing the WR Network of the FAIR General Machine Timing System`` by C. Prados and J. Bai, 2016, GSI Internal Document. Adapted with permission.}}}
   \label{GSI_use_case.jpg}
\end{figure}

\renewcommand{\multirowsetup}{\centering} 
\begin{table}[!htb]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Traffic produced by the XenaBay ports of the test setup}
    \caption*{\textsl{\small{Adapted from ``Testing the WR Network of the FAIR General Machine Timing System`` by C. Prados and J. Bai, 2016, GSI Internal Document. Adapted with permission.}}}
\label{test_setup_network}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | c | c | }
    \hline
	  \rowcolor[gray]{0.5}
     \tabincell{c}{Switch} & \tabincell{c}{Xena \\ Port} & \tabincell{c}{Traffic} & \tabincell{c}{Ethernet \\frame size}&\tabincell{c}{ VLAN} &\tabincell{c}{Priority} &\tabincell{c}{Usage}\\ \hline
       \multirow{6}*{{\tabincell{c}{WR \\switch \\ 1}}}& Port 1 & \SI{100}{Mbit/s} &110 bytes & 7 & 7 & DM Broadcast \\ \cline{2-7}
		 &Port 2 &  &  &  &  &\\ \cline{2-7}
		 &Port 3 &\SI{10}{Mbit/s} &110 bytes & 7 & 7 & DM Unicast \\ \cline{2-7}
   		 &Port 4 &  &  &  & & \\ \cline{2-7}
		 &Port 5 &  &  &  & & \\ \cline{2-7}
		 &Port 6 & \SI{1}{Mbit/s} &64 - 1518 bytes & 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \hline
    \multirow{4}*{{\tabincell{c}{WR \\switch \\ 2}}}& Port 7 & \SI{2}{Mbit/s} &64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \cline{2-7}
	& Port 8 &  &  &  & &\\ \cline{2-7}
	& Port 9 &  &  &  & &\\ \cline{2-7}
   & Port 10 & \SI{1}{Mbit/s} &64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \hline
	\multirow{4}*{{\tabincell{c}{WR \\switch \\ 3}}}& Port 11 &  &  &  &  &\\ \cline{2-7}
	& Port 12 &  &  &  & & \\ \cline{2-7}
   & Port 13 & \SI{2}{Mbit/s} &64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \cline{2-7}
	& Port 14 & \SI{1}{Mbit/s} &64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \hline
	\multirow{4}*{{\tabincell{c}{WR \\switch \\ 4}}}& Port 15 & \SI{1}{Mbit/s} &64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \cline{2-7}
   & Port 16 & \SI{25}{kbit/s} &110 bytes & 6 & 6 & B2B Broadcast \\ \cline{2-7}
	& Port 17 & \SI{5}{kbit/s} &110 bytes & 7 & 7 & B2B Unicast \\ \cline{2-7}
	& Port 18 & \SI{2}{Mbit/s} &64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \hline
    
    \end{tabular}
\end{center}
\end{table}

Firstly, the lost frame, misordered frame and the \gls{glos:latency} on each frame transfer path of the WR network for the B2B Broadcast and B2B Unicast traffic were measured. Secondly, the FLR was calculated based on the number of lost frames and the total number of sent frames. Then the FLR and misordered frame measurement results were used to evaluate whether the WR switch with the latest hardware and firmware\footnote{WR Hardware PCB: 3.30, FPGA:LX240T; WR Firmware: v4.2; compiled at Aug 28 2015 15:05:21} was qualified. A qualified WR switch should cause null misordered frame and should have a FLR which is smaller than or equal to the calculated FER of the network. The FER is decided by the number of fiber connections \textit{n} and the number of the frame reception FECs \textit{m}, see eq. ~\ref{m-n}. In the test setup, the XenaBay ports are used as FECs. We have $m=1$, $n=5$ for the B2B Unicast traffic and $m=17$, $n=21$ for the B2B Broadcast traffic, so the corresponding FER for two traffic is same by coincidence, which equals to $0.35\cdot10^{-8}$. According to eq. ~\ref{duration}, one frame is lost approximately every one and half years for the \SI{5}{kbit/s} B2B Unicast traffic and one frame is lost approximately every four months for the \SI{25}{kbit/s} B2B Unicast traffic of the test setup.    

Together with the tolerable FER, the measurement result of the maximum frame transfer latency was used to identify the tolerable number of WR switch layers for the B2B related traffic, including the number of WR switch layers between the B2B related SCUs and the number of WR switch layers between the B2B related SCUs and DM. 


\subsubsection{Measurements}
The test setup was running for 45 days in order to investigate: 
\begin{itemize}
    \item Lost frame of the B2B Unicast traffic

The frame loss of the B2B Unicast traffic has been measured from the port 17 to the port 1 via four WR switches. The B2B Unicast traffic had no lost frame when approximate $2.2\cdot 10^{7}$ frames were sent. Besides, there was no misordered frame. If frames get lost, the B2B source SCU will send an extra frame to the DM to indicate the error. The DM will arrange the corresponding schedule.

    \item Lost frame of the B2B Broadcast traffic

 

%There are two lost frames individually from the port 16 to the port 11, 12, 17 and 18 and their individual FER is $1.78\cdot 10^{-8}$. Fig. ~\ref{packet_loss} shows the FER for B2B Broadcast traffic.

The number of lost frames of the B2B Broadcast traffic have been measured separately from the port 16 to other ports. There were two lost frames individually from the port 16 to the port 17 and 18 via the $4^{th}$ WR switch when approximate $1.1\cdot 10^{8}$ frames were sent by the port 16, so the $4^{th}$ WR switch caused 4 lost frames. There were two lost frames individually from the port 16 to the port 11 and 12 via the $4^{th}$ and $3^{rd}$ WR switches, so the $3^{rd}$ WR switch caused 4 lost frames. Hence, the FLR of the test was $7.12\cdot 10^{-8}$. For the B2B Broadcast frames, there was no misordered frame. If frames get lost, the B2B source SCU will send an extra frame to the DM to indicate the error. The DM will arrange the corresponding schedule.


%The FER of the B2B Broadcast frames is $7.1\cdot 10^{-8}$. 
%\begin{figure}[H]
%   \centering   
%   \includegraphics*[width=150mm]{packet_loss.png}
%   \caption{Frame error rate for B2B Broadcast traffic.}
%   \label{packet_loss}
%\end{figure}

%Compared with the FER requirements in Tab. ~\ref{requirement_network}, the B2B Unicast traffic meets the requirement and the B2B Broadcast traffic does not meet the requirement. 
%In the 45 days test, the FER of the B2B Broadcast is $7.1\cdot 10^{-8}$ and the FER of the B2B Unicast is 0.
    \item Maximum frame transfer latency for the B2B Unicast frames

For the B2B Unicast frames, the maximum frame transfer latency of \SI{23}{\us} from the port 17 to the port 1 through four WR switches has been measured, see Fig. ~\ref{Max_latency_jitter_unicast}. 

%		\begin{itemize}
%    		\item[-] Average latency and jitter
%
%For the B2B Unicast frames, the 4 WR switch network has approximate \SI{11}{\us} average latency and \SI{0}{\us} average jitter. 
%
%\begin{figure}[H]
%   \centering   
%   \includegraphics*[width=150mm]{Avg_latency_jitter_unicast.png}
%   \caption{The average latency and jitter for B2B Unicast frames.}
%   \label{Avg_latency_jitter_unicast}
%\end{figure}

\begin{figure}[H]
   \centering   
   \includegraphics*[width=110mm]{Max_latency_jitter_unicast.png}
   \caption{Maximum frame transfer latency for B2B Unicast frames.}
   \label{Max_latency_jitter_unicast}
\end{figure}

    \item Maximum frame transfer latency of the B2B Broadcast frames

For the B2B Broadcast frames, the frame transfer latencies of the stream from the port 16 to ports 15, 17 and 18 via the $4^{th}$ WR switch have been measured, namely the frame transfer latencies through one WR switch. The frame transfer latencies of the stream from the port 16 to ports 11 - 14 via the $4^{th}$ and $3^{rd}$ WR switches have been measured, namely the frame transfer latencies through two WR switches. The frame transfer latencies of the stream from the port 16 to ports 7 - 10 via $4^{th}$, $3^{rd}$ and $2^{nd}$ WR switches have been measured, namely the frame transfer latencies through three WR switches. The frame transfer latencies of the stream from the port 16 to ports 1 - 6 via four WR switches have been measured, namely the frame transfer latencies through four WR switches. Fig. ~\ref{Max_latency_jitter} shows the measurement result.
  
%		\begin{itemize}
%    		\item[-] Average latency and jitter
%
%Fig. ~\ref{average_latency_jitter} shows the test result for the average latency and jitter for the B2B Broadcast frames. Tab. \ref{avg latency jitter} shows the average latency and jitter of different WR switch layers. They meet the requirements of the B2B transfer, see Tab. ~\ref{requirement_network}. 
%\begin{figure}[H]
%   \centering   
%   \includegraphics*[width=150mm]{average_latency_jitter.png}
%   \caption{The average latency and jitter for B2B Broadcast frames.}
%   \label{average_latency_jitter}
%\end{figure}
%\begin{table}[H]
%\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
%\caption{The average latency and jitter of the B2B Broadcast frames}
%\label{avg latency jitter}
%\begin{center}
%    \begin{tabular}{ | c | c | c | c | c | c | }
%    \hline
%     & \tabincell{c}{WR switch\\4}  & \tabincell{c}{WR switch\\4, 3} &\tabincell{c}{WR switch\\4, 3, 2} &\tabincell{c}{WR switch\\4, 3, 2, 1} \\ \hline
%       \tabincell{c}{Avg \\ latency} & \SI{6}{\us} & \SI{8}{\us} & \SI{11}{\us} & \SI{14}{\us}\\ \hline
%		\tabincell{c}{Avg \\ jitter} & \SI{0}{\ns} & \SI{0}{\ns} & \SI{0}{\ns} & \SI{0}{\ns}\\ \hline
%    \end{tabular}
%\end{center}
%\end{table}



\begin{figure}[H]
   \centering   
   \includegraphics*[width=130mm]{Max_latency_jitter.png}
   \caption{Maximum frame transfer latency for B2B Broadcast frames.}
   \label{Max_latency_jitter}
\end{figure}
The more WR switches frames pass through, the longer frame transfer latency will be. The maximum frame transfer latency and the number of switches have a nonlinear relationship, because there is a very low possibility for one frame to pass through more than two switches with the maximum transfer latency for each switch. Tab. \ref{max latency jitter} lists the maximum frame transfer latency of the B2B Broadcast frames for different number of WR switch layers. 
\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The maximum frame transfer latency of the B2B Broadcast frames for different number of WR switch layers}
\label{max latency jitter}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
     \tabincell{c}{Number of \\WR switch layers} & \tabincell{c}{One \\WR switch}  & \tabincell{c}{Two \\WR switches} &\tabincell{c}{Three \\WR switches} &\tabincell{c}{Four \\WR switches} \\ \hline
       \tabincell{c}{Maximum frame \\transfer latency} & \SI{28}{\us} & \SI{34}{\us} & \SI{37}{\us} & \SI{41}{\us}\\ \hline
	%	\tabincell{c}{Max \\ jitter} & \SI{25}{\us} & \SI{25}{\us} & \SI{27}{\us} & \SI{30}{\us}\\ \hline
    \end{tabular}
\end{center}
\end{table}

From the test result, a maximum frame transfer latency of \SI{28}{\us} for every WR switch is used for the worst situation.


\end{itemize}

\subsubsection{Measurements Result}

According to the 45 days test, we get the following measurement result. 

\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The 45 days test result of the WR network for the B2B transfer}
\label{result}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
     \tabincell{c}{} & lost frame &\tabincell{c}{FLR} & \tabincell{c}{misordered\\ frame} &\tabincell{c}{maximum frame \\transfer latency} \\ \hline
       \tabincell{c}{B2B Broadcast} & $8/45\_days$ & $7.1\cdot10^{-8}/45\_days$ & $0/45\_days$ & \SI{28}{\us}/switch \\ \hline
		\tabincell{c}{B2B Unicast} 	 & $0/45\_days$ & $0/45\_days$ & $0/45\_days$ & \tabincell{c}{\SI{23}{\us}/4\_switches}\\ \hline
    \end{tabular}
\end{center}
\end{table}

\subsubsection{Result Discussion}


%In the test, n equals to 5 for the B2B Unicast traffic and n equals to 21 for the B2B Broadcast. The corresponding FER is $0.35\cdot10^{-8}$ (see Fig. ~\ref{FER_2case}). 
According to the 45 days test result, the FLR of the B2B Broadcast traffic is $7.12\cdot10^{-8}$, which is larger than the FER of the fiber connection $0.35\cdot10^{-8}$, so the WR switch with the latest hardware and firmware doesn't meet the requirement. The firmware of the WR switch is still under development by CERN.

%Although the FLR of the B2B Unicast traffic is 0, we can not conclude that the FLR of the B2B Unicast traffic is smaller than the FER of the fiber connection, because the FER causes one possible lost frame every two months. A long term test should be done for the verification. 
%The FER will cause maximum 2.5 B2B Unicast lost frames per year and maximum 12.5 B2B Broadcast lost frames per year, when no forward error correction mechanism is used. 

%There is no misordered frame in the 45 days test. The misordered frame should not happen, no matter how long the test runs.

For the B2B transfer system, the upper bound latency of the frames on the WR network is \SI{500}{\us}. The latency measured in this test does not include the SCU sending and receiving time, which is around \SI{100}{\us}. According to the test result, the maximum B2B Broadcast frame transfer latency for each WR switch layer is \SI{28}{\micro\second} and the maximum B2B Unicast frame transfer latency for four WR switch layers is  \SI{23}{\micro\second}. The latency of the WR network is decided by the number of WR switch layers and the length of the optical fiber. The propagation of light through the core of an optical fiber is roughly about \SI{200}{\meter/\us}~\cite{noauthor_calculating_2012} and the longest distance in the FAIR campus is around \SI{2}{\kilo\meter}, so the latency of a \SI{2}{\kilo\meter} optical fiber is about \SI{10}{\us}. The number of WR switch layers plays a more important role in the latency. 

From the perspective of the transfer latency, the tolerable number of WR switch layers between the B2B related \gls{SCU}s is 
		\begin{equation}
		\begin{aligned}
			\frac{\SI{500}{\us}-\SI{10}{\us}-\SI{100}{\us}}{\SI{28}{\us/switch}}>13
		\label {num_switch_b}
		\end{aligned}
		\end{equation}

From the perspective of the latency, the tolerable number of WR switch layers between the B2B related \gls{SCU}s and DM is
		\begin{equation}
		\begin{aligned}
			\frac{\SI{500}{\us}-\SI{10}{\us}-\SI{100}{\us}}{\SI{23}{\us/4\_switches}}\cdot 4 > 67
		\label {num_switch_b}
		\end{aligned}
		\end{equation}

However, the more WR switch layers, the more fiber connections and the higher corresponding FER. When no forward error correction mechanism is used, the tolerable number of WR switch layers for the B2B related traffic depends on the tolerable FER and the transfer latency, see Tab. ~\ref{tolerable_num}. The tolerable FER of the B2B transfer system is one lost frame per month. In this case, the tolerable number of WR switches layers is determined by the transfer latency, namely a maximum of 67 WR switches can be used between the B2B related SCUs and DM and a maximum of 13 WR switches can be used between the B2B related SCUs. If one lost frame is acceptable every two months, the tolerable number of WR switches layers is determined by the FER, namely a maximum of 38 and 8 WR switches can be used for the B2B Unicast and Broadcast traffic. If one lost frame is acceptable every 8 months, 9 and 2 WR switches can be used for two traffic. In this case, the forward error correction mechanisms need to be used, if more WR switches need to be used. e.g. the FER can be reduced to the order of magnitude $10^{-15}$ when specific forward error correction mechanisms are implemented in the WR network ~\cite{prados_white_2011} and the number of WR switch layers is then determined by the transfer latency. 
\begin{table}[!htb]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The tolerable number of WR switch layers for the B2B related traffic}
\label{tolerable_num}
\begin{center}
    \begin{tabular}{ | c |c | c | c | c | c | c | c |}
    \hline
                   & \multicolumn{2}{|c|}{Requirement from FER} & \multicolumn{2}{|c|}{Requirement from latency} \\ \hline
    one lost frame	& B2B Unicast & B2B Broadcast & B2B Unicast & B2B Broadcast \\ \hline
	 per month		&  \cellcolor{gray}76		&  \cellcolor{gray}15            & 67          & 13            \\ \hline 
	  \multicolumn{5}{|c|}{No forward error correction mechanism is implemented}  \\ \hline 
	 every 2 months	& 38	 & 8   & \cellcolor{gray}67 & \cellcolor{gray}13            \\ \hline 
	 every 4 months	& 19 	 & 4   & \cellcolor{gray}67 & \cellcolor{gray}13            \\ \hline 
	 every 8 months	& 9 	 & 2   & \cellcolor{gray}67 & \cellcolor{gray}13            \\ \hline 
	 every 18 months& 4 	 & 1   & \cellcolor{gray}67 & \cellcolor{gray}13            \\ \hline 
	  \multicolumn{5}{|c|}{Forward error correction mechanisms are implemented}  \\ \hline 
	 every 8 months	& \cellcolor{gray}9 	 & \cellcolor{gray}2   & 67 & 13            \\ \hline 
	 every 18 months& \cellcolor{gray}4 	 & \cellcolor{gray}1   & 67 & 13            \\ \hline 
    \end{tabular}
\end{center}
\end{table}

% 
%In the actual operation of the B2B transfer, the DM will be informed by the B2B source SCU in the format of the timing event TGM\_B2B\_ERROR, when the B2B Broadcast frame is lost. For more details, please see Sec. ~\ref{sec_firmware}.


\subsubsection{Conclusion of the Network Measurements}
The tolerable number of WR switch layers depends not only on the upper bound transfer latency, but also the tolerable FER of the B2B transfer system. The tolerable FER of the B2B transfer system for FAIR has been determined to lose one frame every four month (a preliminary assumption). 

If no forward error correction mechanism is used for the B2B network, the number of WR switch layers is mainly decided by the tolerable FER. In case of only one lost frame every four months, then a maximum of 19 WR switches can be used between the B2B related SCUs and DM and a maximum of 4 WR switches can be used between the B2B related SCUs.


If specific forward error correction mechanisms are implemented in the B2B network and the FER is $10^{-15}$ ~\cite{prados_white_2011}, the number of WR switch layers is mainly decided by the tolerable transfer latency. Hence, the tolerable number of WR switch layers is 67 between the B2B related \gls{SCU}s and DM and the tolerable number of WR switch layers is 13 between the B2B related \gls{SCU}s.    
%\subsubsection{Requirements of B2B Traffic on the WR Network}
%The requirements for the B2B Broadcast and Unicast traffic are summarized in Tab.~\ref{requirement_network}. 
%If some forward error correction mechanisms are used for the B2B traffic on the WR network, the FER can be reduced to $10^{-15}$. The calculation of the FER based on the specific forward error correction mechanisms is explained in ~\cite{prados_white_2011}.
%The requirement of the FER for the B2B Broadcast ($FER_\mathit{req\_Broadcast}$)/B2B Unicast ($FER_\mathit{req\_Unicast}$) traffic is defined as the percentage of maximum one frame error occurrence relative to the total number of B2B Broadcast/B2B Unicast transferred frames over a year. 
%\begin{equation}
%	FER_\mathit{req\_Broadcast}=\frac{1}{2.82\cdot4\cdot10\cdot3.15\cdot10^7\cdot17}=1.6\cdot10^{-11}
%\end{equation}
%\begin{equation}
%	FER_\mathit{req\_Unicast}=\frac{1}{2.82\cdot4\cdot2\cdot3.15\cdot10^7}=1.4\cdot10^{-9}
%\end{equation}

%\begin{table}[!htb]
%\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
%\caption{The requirements of the B2B transfer on the WR network}
%	\caption*{\textsl{\small{(No forward error correction mechanism is used.)}}}
%\label{requirement_network}
%\begin{center}
%    \begin{tabular}{ | c | c | c | c | c |}
%    \hline
%     \tabincell{c}{} & \tabincell{c}{tolerable \\BER}&  \tabincell{c}{tolerable\\ FER}  &  \tabincell{c}{tolerable\\ misordered frame} & \tabincell{c}{upper bound latency \\of WR network}  \\ \hline
%       \tabincell{c}{B2B Broadcast} & $2.1\cdot10^{-11}$ &  $3.5\cdot10^{-9}$ &0 &\SI{500}{\us}  \\ \hline
%		\tabincell{c}{B2B Unicast} & $5\cdot10^{-12}$ & $3.5\cdot10^{-9}$ & 0 & \SI{500}{\us} \\ \hline
%    \end{tabular}
%\end{center}
%\end{table}

%
%		Here we calculate the tolerable layer of the WR switch between the B2B source SCU and the DM.
%		\begin{equation}
%		\begin{aligned}
%			\frac{\SI{500}{\us}-\SI{10}{\us}}{\SI{60}{\us/switch}}> 8
%		\label {num_switch_b}
%		\end{aligned}
%		\end{equation}
%\end{itemize}

\subsection{Flowchart of the system for SCUs}
\label{sec_firmware}
The B2B source, B2B target and Trigger SCUs control different flowcharts. In the following, the flowcharts of different SCUs are explained. An overview of the connections of the B2B related modules used for the data exchange is presented in Chap. ~\ref{concept}, see Fig. ~\ref{data_flow}.
%%%%%%%%%%%%%%%%%%%%%%%%
\begin{itemize}
\item The flowchart for the B2B source SCU
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{flow_chart_src.jpg}
   \caption{Flowchart of the B2B source SCU.}
   \caption*{\textsl{\small{``Step`` is represented as ``S`` in the figure.  }}}
   \label{flow_chart_src}
\end{figure}

Fig. ~\ref{flow_chart_src} shows the flowchart of the B2B source SCU. The B2B source SCU, the B2B transfer master, is responsible for the data collection, data calculation, date redistribution and status check. The flowchart controls the following logical steps according to Fig. ~\ref{flow_chart_src}.

 	\begin{itemize}
		\item[-]Step 1. The program waits for the CMD\_START\_B2B timing frame.
% 		\item[-]Step 2. When it receives the timing frame CMD_START\_B2B, it collects the predicted phase and checks whether it is within a proper range of $0$ to $2\pi$. If not, it sends a timing frame TGM\_B2B\_ERROR to the WR network and goes back to the step 1, which indicates the data error.
 		\item[-]Step 2. When it receives the timing frame CMD\_START\_B2B, the program reads the extrapolated phase and the phase deviation slope from the PAP module, as well as the corresponding timestamp.
		\item[-]Step 3. The program waits for the TGM\_PHASE\_TIME timing frame from the B2B target SCU, which contains the extrapolated phase, the corresponding timestamp and the slope of the phase deviation.
		\item[-]Step 4. When the program receives the timing frame TGM\_PHASE\_TIME within a specified timeout interval, it checks whether the timestamp corresponding to the extrapolated phase of the target synchrotron equals to that of the source synchrotron. When they are equal, the program calculates the synchronization window, the phase shift/jump value and the phase correction value. When the program doesn't receive the timing frame TGM\_PHASE\_TIME within a specified timeout interval or two timestamp are not equal, it sends a timing frame TGM\_B2B\_ERROR to the WR network and goes back to the step 1, the TGM\_B2B\_ERROR indicates the error to the DM.  
		\item[-]Step 5. The program sends the timing frames TGM\_SYNCH\_WIN and TGM\_PHASE\_CORRECTION to the WR network. The TGM\_SYNCH\_WIN indicates the start of the synchronization window and the TGM\_PHASE\_CORRECTION is used for the Trigger SCUs for the reproduction of the bucket indication signal.
		\item[-]Step 6. The program gives the phase shift value to corresponding module.
		\item[-]Step 7. The program waits for the timing frame TGM\_KICKER\_TRIGGER\_TIME\_S from the source Trigger SCU and the timing frame TGM\_KICKER\_TRIGGER\_TIME\_T from the target Trigger SCU, which contains the extraction/injection kicker trigger and firing timestamp. When it does not receive the timing frames within a specified timeout interval, it sends a timing frame TGM\_B2B\_ERROR to the WR network and goes back to the step 1, which indicates the timeout error of the frame.
		\item[-]Step 8. When the program receives the timing frames mentioned in the step 7 within a specified timeout interval, it checks the B2B transfer status and sends the TGM\_B2B\_STATUS to the WR network and goes to the step 1. The B2B transfer is successful, if all of the following checks are correct. Otherwise the B2B transfer is failure. 
\begin{itemize}
	\item Trigger time $<$ firing time of the extraction kicker of the source ring

	\item Trigger time $<$ firing time of the injection kicker of the target ring

	%\item Firing time of the extraction kicker $<$ firing time of the injection kicker
\end{itemize}
 

	\end{itemize}
%%%%%%%%%%%%%%%%%%%%
\item The flowchart for the B2B target SCU
\begin{figure}[H]
   \centering   
   \includegraphics*[width=70mm]{flow_chart_trg.jpg}
   \caption{Flowchart of the B2B target SCU.}
	\caption*{\textsl{\small{``Step`` is represented as ``S`` in the figure. }}}
   \label{flow_chart_trg}
\end{figure}
Fig. ~\ref{flow_chart_trg} shows the flowchart of the B2B target SCU. The flowchart controls the following logical steps according to Fig. ~\ref{flow_chart_trg}.
 	\begin{itemize}
		\item[-]Step 1. The program waits for the CMD\_START\_B2B timing frame.
 		\item[-]Step 2. When it receives the timing frame CMD\_START\_B2B, the program reads the extrapolated phase and the phase deviation slope from the PAP module, as well as the corresponding timestamp.
		\item[-]Step 3. The program sends the TGM\_PHASE\_TIME timing frame to the B2B source SCU and goes back to the step 1.
	\end{itemize}
%%%%%%%%%%%%%%%%%%%%%
\item The flowchart for the Trigger SCU
\begin{figure}[H]
   \centering   
   \includegraphics*[width=120mm]{flow_chart_trigger.jpg}
   \caption{Flowchart of the B2B Trigger SCU.}
	\caption*{\textsl{\small{``Step`` is represented as ``S`` in the figure.}}}
   \label{flow_chart_trigger}
\end{figure}
Fig. ~\ref{flow_chart_trigger} shows the flowchart of the source Trigger SCU. For the target Trigger SCU, the logical steps are same only with the timing frame TGM\_KICKER\_TRIGGER\_TIME\_T. The flowchart controls the following logical steps according to Fig. ~\ref{flow_chart_trigger}.
 	\begin{itemize}
		\item[-]Step 1. The program waits for the CMD\_START\_B2B timing frame. 
		\item[-]Step 2. The program waits for the TGM\_PHASE\_CORRECTION timing frame. When it does not receive the timing frames within a specified timeout interval, it goes back to the step 1.
		\item[-]Step 3. The program gives the phase correction value to the corresponding PCM.
 		\item[-]Step 4. The program waits for the timing frame CMD\_SYNCH\_WIN to indicate the synchronization window for the kicker trigger. When it does not receive the timing frames within a specified timeout interval, it goes back to the step 1.
		\item[-]Step 5. After the beam extraction, the program collects the trigger and firing timestamp. 
		\item[-]Step 6. The program sends the TGM\_KICKER\_TRIGGER\_TIME\_S timing frame to the B2B source SCU and goes back to the step 1.
	\end{itemize}

\end{itemize}
%%%%%%%%%%%%%%%%%%%%%%
\subsection{Time Constraints}
\label{sec:time_constraint}
For the FAIR B2B transfer system, the time constraints are very important and strict. Because beam feedback loops are switched off before the B2B transfer, the beam may be stable only for a short period of time. For most FAIR use cases, the upper bound B2B transfer time is \SI{10}{\ms}. 

Fig. ~\ref{time_constraint} shows the time constraint of the system. The CMD\_START\_B2B is executed at \gls{symb:t_b2b}. The PAP module needs \SI{500}{\us} for the phase extrapolation, so the B2B source and target SCUs collect the extrapolated phase and the slope from the PAP module at $t_\mathit{B2B} + \SI{500}{\us}$. The upper bound latency of the timing frame TGM\_PHASE\_TIME transfer on the WR network from the B2B target SCU to the B2B source SCU is \SI{500}{\us}, so the B2B source SCU receives the timing frame TGM\_PHASE\_TIME at around $t_\mathit{B2B} + \SI{500}{\us} + \SI{500}{\us} = t_\mathit{B2B} + \SI{1}{\ms}$. After that, the B2B source SCU needs about \SI{100}{\us} for the calculation, the sending of the timing frames TGM\_SYNCH\_WIN and TGM\_PHASE\_CORRECTION and the data transfer to the corresponding modules. The timing frames TGM\_SYNCH\_WIN and TGM\_PHASE\_CORRECTION are sent by the B2B source SCU at around $t_\mathit{B2B} + \SI{1}{\ms} + \SI{100}{\us} = t_\mathit{B2B} + \SI{1.1}{\ms}$. The upper bound latency of the timing frame transfer on the WR network from the B2B source SCU to the Trigger SCUs is \SI{500}{\us}, so the Trigger SCUs receive the TGM\_PHASE\_CORRECTION and CMD\_SYNCH\_WIN at around $t_\mathit{B2B} + \SI{1.1}{\ms} + \SI{500}{\us} = t_\mathit{B2B} + \SI{1.6}{\ms}$. The start of the synchronization window must be later than $t_\mathit{B2B} + \SI{1.1}{\ms} + 2\cdot\SI{500}{\us} = t_\mathit{B2B} + \SI{2.1}{\ms}$. Two upper bound latency of the WR network are caused by the timing frame TGM\_SYNCH\_WIN transfer from the B2B source SCU back to the DM and by the timing frame CMD\_SYNCH\_WIN transfer further from the DM to the BI devices. After bunches are transferred into buckets, there is no hard real time requirement for the Trigger SCU to collect the trigger and firing timestamps and to send the timing frame TGM\_KICKER\_TRIGGER\_TIME\_S, so \SI{1}{\ms} is used for the source Trigger SCU to do this task and the source Trigger SCU sends the TGM\_KICKER\_TRIGGER\_TIME\_S at around $t_\mathit{B2B} + \SI{10}{\ms} + \SI{1}{\ms} = t_\mathit{B2B} + \SI{11}{\ms}$. The same time constraints is also for the target Trigger SCU. The B2B source SCU receives the TGM\_KICKER\_TRIGGER\_TIME\_S and TGM\_KICKER\_TRIGGER\_TIME\_T from the WR network at around $t_\mathit{B2B} + \SI{11}{\ms} + \SI{500}{\us} = t_\mathit{B2B} + \SI{11.5}{\ms}$. The B2B source SCU uses \SI{100}{\us} to check the B2B transfer status and sends the TGM\_B2B\_STATUS at around $t_\mathit{B2B} + \SI{11.5}{\ms} + \SI{100}{\us} = t_\mathit{B2B} + \SI{11.6}{\ms}$. The BI devices receives the timing frame TGM\_B2B\_STATUS at around $t_\mathit{B2B} + \SI{11.6}{\ms} + 2\cdot\SI{500}{\us} = t_\mathit{B2B} + \SI{12.6}{\ms}$. $2\cdot\SI{500}{\us}$ is two upper bound latency of the WR network, which is caused by the timing frame TGM\_B2B\_STATUS transfer from the B2B source SCU back to the DM and further from the DM to the BI devices.

%For the B2B transfer system, the time constraints are very important and strict. Fig. ~\ref{time_constraint} shows the time constraint of the system. The CMD\_START\_B2B is executed at \gls{symb:t_b2b}. The rf phase extrapolation needs \SI{500}{\us}, so the B2B source and target SCUs collect the phase data at $t_\mathit{B2B}$ + \SI{500}{\us} and need about \SI{450}{\ns} for the data collection. The B2B source SCU receives the timing frame TGM\_PHASE\_TIME at around $t_\mathit{B2B}$ + \SI{500}{\us} + \SI{450}{\ns} + \SI{500}{\us} $\approx$ $t_\mathit{B2B}$ + \SI{1}{\ms}. The second \SI{500}{\us} is the upper bound latency of the WR network. After that, the B2B source SCU needs about \SI{100}{\us} for the calculation, the sending of the timing frame TGM\_SYNCH\_WIN and TGM\_PHASE\_CORRECTION and data transferring to the corresponding module. TGM\_SYNCH\_WIN is sent at around $t_\mathit{B2B}$ + \SI{1}{\ms} + \SI{100}{\us} $\approx$ $t_\mathit{B2B}$ + \SI{1.1}{\ms}. The Trigger SCU receives TGM\_PHASE\_CORRECTION and TGM\_SYNCH\_WIN at around $t_\mathit{B2B}$ + \SI{1.1}{\ms} + \SI{500}{\us} $\approx$ $t_\mathit{B2B}$ + \SI{1.6}{\ms}. The \SI{500}{\us} is the latency of the WR network. The start of the synchronization window must be later than $t_\mathit{B2B}$ + \SI{1.1}{\ms} + 2$\cdot$\SI{500}{\us} $\approx$ $t_\mathit{B2B}$ + \SI{2.1}{\ms}, because the TGM\_SYNCH\_WIN must be transferred back to the DM and the DM transfers it further to the beam instrumentation devices via WR network. The upward to DM transfer needs maximum \SI{500}{\us} and the transfer from the DM to BI needs another \SI{500}{\us}.  The upper bound B2B transfer time is \SI{10}{\ms}, which is decided by the duration of the stable beam. There is no hard real time for the collection of the trigger and firing timestamps and timing frame TGM\_KICKER\_TIME\_S sending, we give \SI{1}{\ms} for the source Trigger SCU to do this task and the source Trigger SCU sends TGM\_KICKER\_TIME\_S at around $t_\mathit{B2B}$ + \SI{10}{\ms} + \SI{1}{\ms} $\approx$ $t_\mathit{B2B}$ + \SI{11}{\ms}. The same time constraints is also for the target Trigger SCU. The B2B source SCU receives TGM\_KICKER\_TIME\_S and TGM\_KICKER\_TIME\_T at around $t_\mathit{B2B}$ + \SI{11}{\ms} + \SI{500}{\us} $\approx$ $t_\mathit{B2B}$ + \SI{11.5}{\ms}. The \SI{500}{\us} is the latency of the WR network. The B2B source SCU sends TGM\_B2B\_STATUS at around $t_\mathit{B2B}$ + \SI{11.5}{\ms} + \SI{100}{\us} $\approx$ $t_\mathit{B2B}$ + \SI{11.6}{\ms}. The BI devices receives the timing frame TGM\_B2B\_STATUS at around $t_\mathit{B2B}$ + \SI{11.6}{\ms} + 2$\cdot$\SI{500}{\us} $\approx$ $t_\mathit{B2B}$ + \SI{12.6}{\ms}.

\begin{landscape}
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=210mm]{flow_chart_time.jpg}
   \caption{Time constraints of the B2B transfer system.}
   \caption*{\textsl{\small{The sent and received timing frame pairs have the same color. (not drawn to accurate timescale) }}}
   \label{time_constraint}
\end{figure}
\end{landscape}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Kicker Systematic Investigation}
\label{real_kicker}
The SIS18 extraction kicker consists of nine kicker magnets. In the existing topology, five kicker magnets are evenly distributed in the $1^{st}$ tank and the other four kicker magnets are evenly distributed in a $2^{nd}$ tank. The investigation is based on the assumption that the kicker magnets in one tank are controlled by a common kicker control electronics, which receives a trigger signal from a common TD module. The nine kicker magnets can also be individually controlled by their own kicker control electronics and TD module. The kicker magnets in a common tank are triggered by trigger signals with a local delay compensation for the electronics, the length of the energy transmission cable for instance. Fig. ~\ref{SIS18_kicker} shows the schematic diagram of the controls and pulse electronics of the kicker magnets in the SIS18 $2^{nd}$ tank. 
%kicker.pptx
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{SIS18_kicker.jpg}
   \caption{The schematic diagram of the controls and pulse electronics of the extraction kicker magnets in the SIS18 $2^{nd}$ tank.}
   \label{SIS18_kicker}
\end{figure}

The SIS100 injection kicker consists of six kicker magnets, which are evenly distributed in a common tank. For the B2B transfer, the kicker rise time, denoted by \gls{symb:kicker_rise}, must fit within the bunch gap, e.g. the bunch gap is 25$\%$ of the cavity rf period ~\cite{blell_injection_2014, liebermann_sis100_2013}. The bunch gap is denoted by \gls{symb:G}.  All the analysis in this section dose not take the jitter of the kicker trigger signal into consideration (approximately \SI{1}{ns}). 
%and ignores the transfer delay difference on the circuit connection and the digital signal for each kicker magnet  (the speed of an electrical signal in coaxial cable is about 2/3 of the speed of light, namely approximate \SI{20}{cm/ns}). 

For ion beams over the whole range of stable isotopes, whether the extraction kicker magnets in a common SIS18 tank can be triggered simultaneously will be discussed. Besides, whether the kicker magnets in the SIS18 $2^{nd}$ tank can be simultaneously triggered a fixed delay after the simultaneous triggering of the kicker magnets in the SIS18 $1^{st}$ tank will also be discussed. For the SIS100 injection kicker, whether all kicker magnets can be triggered simultaneously will be investigated. 


\subsection{Simultaneous Trigger for Extraction Kicker Magnets in a Common SIS18 Tank}
Two bunches from SIS18 will be transferred into two SIS100 rf buckets in each B2B transfer. The SIS18 extraction kicker must reach the kicker flat-top during the bunch gap. For the instantaneous trigger, all kicker magnets in a tank are triggered only if the tail of the circulating bunch passes the rightmost kicker magnet of the tank, see Fig.~\ref{kicker_SIS181}. The ``kicker passing time`` is defined as the time needed for the tail of a bunch to pass from the leftmost magnet to the rightmost kicker magnet. The rise time of the kicker magnet $t_\mathit{rise}$ is approximately \SI{90}{ns} ~\cite{blell_f-ds-ie-03e_2014}. The width of each kicker magnet is \SI{0.25}{m} and the distance between two kicker magnets is \SI{0.09}{m}. The distance between the two tanks is \SI{19.17}{m} ~\cite{ros_sis18_2008}. \gls{symb:1st_tank} represents the distance from the leftmost to the rightmost kicker magnet in the $1^{st}$ tank, which equals to $\SI{1.61}{m}= 5 \cdot \SI{0.25}{m} + 4 \cdot \SI{0.09}{m}$. \gls{symb:2nd_tank} represents  the distance from the leftmost to the rightmost kicker magnet in the $2^{nd}$ tank, which equals to $\SI{1.27}{m}= 4 \cdot \SI{0.25}{m} + 3 \cdot \SI{0.09}{m}$. If the sum of the kicker passing time and rise time is shorter than the bunch gap, all kicker magnets can be triggered simultaneously. 
\begin{equation}
\label{simul_kicker}
		\frac{d_\mathit{tankXL-tankXR}}{\beta c}+t_\mathit{rise}<t_\mathit{gap}
\end{equation}
%where $d_\mathit{tankXL-tankXR}$ represents the distance from the leftmost to the rightmost of the tank $X$.

Three ion beams, $H^+, U^{28+}$ and $U^{73+}$, are used to check the instantaneous trigger of kicker magnets in a common tank, because these ion species have the most stringent requirements. Tab. ~\ref{kicker_SIS18} shows the kicker passing time, the rise time and the bunch gap for $H^+$, $U^{28+}$ and $U^{73+}$ beams. 

\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{kicker_SIS18.jpg}
   \caption{SIS18 extraction kicker.}
	\caption*{\textsl{\small{Yellow ellipses represent circulating bunches in SIS18 and the head of the bunch is at the right side.}}}
   \label{kicker_SIS181}
\end{figure}

\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Calculated parameters related to the simultaneous trigger of the SIS18 extraction kicker magnets in a common tank}
\label{kicker_SIS18}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | c | c |}
    \hline
    Beam & $\beta$ &  \tabincell{c}{$\frac{d_\mathit{tank1L-tank1R}}{\beta c}$}&  \tabincell{c}{$\frac{d_\mathit{tank2L-tank2R}}{\beta c}$} & \tabincell{c}{$t_\mathit{rise}$}& \tabincell{c}{$\frac{d_\mathit{tank1L-tank1R}}{\beta c}$\\+\\$t_\mathit{rise}$}& \tabincell{c}{$\frac{d_\mathit{tank2L-tank2R}}{\beta c}$\\+\\$t_\mathit{rise}$}  & \tabincell{c}{$t_\mathit{gap}$}\\ \hline

\multicolumn{8}{|c|}{$t_\mathit{gap}=25\%/f_\mathit{rf}^\mathit{SIS18}$ }	 \\ \hline
    $H^+$     & 0.982 & \SI{5}{ns}  & \SI{4}{ns}	&  $\SI{90}{ns}$ & \SI{95}{ns} & \SI{94}{ns}	& \SI{184}{ns}  \\ \hline
    $U^{28+}$  & 0.568 & \SI{9}{ns} & \SI{7}{ns}	&  $\SI{90}{ns}$ & \SI{99}{ns} & \SI{97}{ns} & \SI{159}{ns}  \\ \hline
    $U^{73+}$ & 0.872 & \SI{6}{ns} 	& \SI{5}{ns}    &  $\SI{90}{ns}$ & \SI{96}{ns} & \SI{95}{ns}& \SI{104}{ns} \\ \hline
\multicolumn{8}{|c|}{$t_\mathit{gap}=20\%/f_\mathit{rf}^\mathit{SIS18}$ }	 \\ \hline
    $H^+$     & 0.982 & \SI{5}{ns}  & \SI{4}{ns}	&  $\SI{90}{ns}$ & \SI{95}{ns} & \SI{94}{ns} 	& \SI{126}{ns}  \\ \hline
    $U^{28+}$  & 0.568 & \SI{9}{ns} & \SI{7}{ns}	&  $\SI{90}{ns}$ & \SI{99}{ns} & \SI{97}{ns}  	& \SI{157}{ns}  \\ \hline
    $U^{73+}$ & 0.872 & \SI{6}{ns} 	 & \SI{5}{ns}   &  $\SI{90}{ns}$ & \SI{96}{ns} & \SI{95}{ns}	& \SI{83}{ns} \\ \hline
    \end{tabular}
\end{center}
\end{table}

Tab. ~\ref{kicker_SIS18} shows that the sum of the kicker passing time and rise time of both tanks is always shorter than the bunch gap when the bunch gap is $25\%$ of the cavity rf period. Hence, the kicker magnets in the SIS18 $1^{st}$ and $2^{nd}$ tanks can be triggered simultaneously with the $25\%$ bunch gap. When the bunch gap is $20\%$ of the cavity rf period, the $U^\mathit{73+}$ bunch gap is even shorter than the kicker rise time, the kicker magnets can neither be triggered simultaneously, nor one after another. Hence, the $20\%$ bunch gap is not applicable for the SIS18 $U^\mathit{73+}$ extraction.


\subsection{A Fixed Trigger Delay between Extraction Kicker Magnets in the SIS18 $1^{st}$ and $2^{nd}$ Tanks}

Fig.~\ref{kicker_18_1} shows a possible triggering delay between kicker magnets in the two tanks. The bunch is firstly kicked by kicker magnets in the $1^{st}$ tank and than kicked by the kicker magnets in the $2^{nd}$ tanks to the transfer line. The yellow and red ellipse represents the position of the bunches, when the kicker magnets in the $1^{st}$ and $2^{nd}$ tank are triggered. The number in the ellipse is used to tell different bunches. The head of the bunch is at the right side. The bunch 2 is firstly kicked. The width of each kicker magnet is \SI{0.22}{m} and the distance between two magnets is \SI{0.23}{m}. \gls{symb:d} denotes the distance between two tanks, which equals to \SI{19.17}{m}. \gls{symb:L} denotes the distance from the leftmost to the rightmost kicker magnets, which equals to \SI{22.05}{m} = $d_\mathit{tank1R-tank2L} + 9\cdot \SI{0.25}{m} + 7\cdot \SI{0.09}{m}$. \gls{symb:D} denotes the distance between the rightmost of the $1^{st}$ tank to the rightmost of the $2^{nd}$ tank, which equals to \SI{20.44}{m} = $d_\mathit{tank1R-tank2L} + 4\cdot \SI{0.25}{m} + 3\cdot \SI{0.09}{m}$. The kicker magnets in the $1^{st}$ tank are triggered simultaneously when the tail of the bunch 1 passes by the $1^{st}$ tank completely. The kicker magnets in the $2^{nd}$ tank are triggered simultaneously when the tail of the bunch 1 passes by the $2^{nd}$ tank completely. The delay for the trigger two tanks in this scenario is $d_\mathit{tank1R-tank2R}/\beta c$. 
%kicker.pptx
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{kicker_18_1.jpg}
   \caption{A possible triggering delay between extraction kicker magnets in the SIS18 two tanks.}
%	\caption*{\textsl{\small{ }}}
   \label{kicker_18_1}
\end{figure}

\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{kicker_18_2.jpg}
   \caption{Maximum triggering delay between extraction kicker magnets in the SIS18 two tanks.}
   \label{kicker_18_2}
\end{figure}
Fig.~\ref{kicker_18_2} shows the scenario of the maximum triggering delay between kicker magnets in the two tanks. The kicker magnets in the $1^{st}$ tank are triggered simultaneously when the tail of the bunch 1 passes by the $1^{st}$ tank completely. The kicker magnets in the $2^{nd}$ tank are simultaneously triggered \SI{90}{ns} before the head of the bunch 2 passes by it. The delay equals to $t_\mathit{gap}+d_\mathit{tank1R-tank2L}/\beta c-\SI{90}{ns}$.
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{kicker_18_3.jpg}
   \caption{The minimum triggering delay between extraction kicker magnets in two SIS18 tanks.}
   \label{kicker_18_3}
\end{figure}
Fig.~\ref{kicker_18_3} shows the scenario of the minimum triggering delay. The kicker magnets in the $1^{st}$ tank are simultaneously triggered \SI{90}{ns} before the head of the bunch 2 passes by it. The kicker magnets in the $2^{nd}$ tanks are simultaneously triggered when the bunch 1 passes by the $2^{nd}$ tank. The delay is $d_\mathit{tank1L-tank2R}/$\gls{symb:b}\gls{symb:c}$-(t_\mathit{gap}-\SI{90}{ns})$.

 %The constant firing delay is determined primarily by the boundary delay range from $H^+, U^{28+}$ and $U^{73+}$ beams, the delay range for other heavy ion species beams must be contained in these boundary range.  
Tab. ~\ref{kicker_delay} shows the maximum and minimum triggering delays for three ion beams. 
\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The triggering delay for the extraction kicker magnets in the two SIS18 tanks}
\label{kicker_delay}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | }
    \hline
    Beam & $\beta$ &  \tabincell{c}{$t_\mathit{gap}$ } & \tabincell{c}{minimum delay \\ $\frac{d_\mathit{tank1L-tank2R}}{\beta c}$-($t_\mathit{gap}$-\SI{90}{ns})} & \tabincell{c}{maximum delay \\ $t_\mathit{gap}$+($\frac{d_\mathit{tank1R-tank2L}}{\beta c}$-\SI{90}{ns})}\\ \hline
\multicolumn{5}{|c|}{$t_\mathit{gap}=25\%/f_\mathit{rf}^\mathit{SIS18}$ }	 \\ \hline
    $H^+$ 		& 0.982 	& \SI{184}{ns}	& \SI{0}{ns} 	& \SI{163}{ns}  \\ \hline
    $U^{28+}$ 	&0.568 	&  \SI{159}{ns} & \SI{61}{ns} 	& \SI{189}{ns} \\ \hline
    $U^{73+}$ 	& 0.872 	&  \SI{104}{ns} & \SI{70}{ns}   & \SI{92}{ns}\\ \hline
%\multicolumn{5}{|c|}{$t_\mathit{gap}=20\%/f_\mathit{rf}^\mathit{SIS18}$ }	 \\ \hline
%    $H^+$ 		& 0.982 	& \SI{147}{ns}	& \SI{18}{ns} 	& \SI{126}{ns}  \\ \hline
%    $U^{28+}$ 	&0.568 	&  \SI{127}{ns} & \SI{93}{ns} 	& \SI{157}{ns} \\ \hline
%    $U^{73+}$ 	& 0.872 	&  \SI{83}{ns} &\multicolumn{2}{|c|}{Not operational due to $t_\mathit{gap}<$\SI{90}{ns}}\\ \hline
    \end{tabular}
\end{center}
%\begin{center}
%    \begin{tabular}{ | c | c | c | c | c | c | }
%    \hline
%    Beam & $\beta$ &  \tabincell{c}{bunch gap \\ $t_\mathit{gap}$ } & \tabincell{c}{minimum delay \\ $\frac{d_\mathit{tank1L-tank2R}}{\beta c}$-($t_\mathit{gap}$-\SI{90}{ns})} & \tabincell{c}{possible delay \\ $\frac{d_\mathit{tank1R-tank2R}}{\beta c}$} & \tabincell{c}{maximum delay \\ $t_\mathit{gap}$+($\frac{d_\mathit{tank1R-tank2L}}{\beta c}$-\SI{90}{ns})}\\ \hline
%    $H^+$ 		& 0.982 	& \SI{184}{ns}	& \SI{0}{ns} 	& \SI{69}{ns} & \SI{163}{ns}  \\ \hline
%    $U^{28+}$ 	&0.568 	&  \SI{159}{ns} & \SI{61}{ns} 	&\SI{120}{ns} & \SI{189}{ns} \\ \hline
%    $U^{73+}$ 	& 0.872 	&  \SI{104}{ns} & \SI{70}{ns} 	& \SI{78}{ns} & \SI{92}{ns}\\ \hline
%    \end{tabular}
%\end{center}
\end{table}
According to the result, a constant triggering delay is available for the triggering of the extraction kicker magnets in the two SIS18 tanks for all ion beams when the bunch gap is $25\%$ of the cavity rf period, e.g. \SI{80}{ns}.  

\subsection{Simultaneous Trigger for SIS100 Injection Kicker Magnets}
The SIS100 injection kicker must reach to the kicker flat-top during the bunch gap. For the instantaneous trigger, all kicker magnets are triggered only if the tail of the circulating bunch passes the rightmost kicker magnet, see Fig.~\ref{kicker_SIS1001}. The rise time of the kicker magnet $t_\mathit{rise}$ is \SI{130}{ns} ~\cite{blell_f-ds-ie-03e_2014}. The distance from the leftmost to the rightmost kicker magnet \gls{symb:SIS100_tank} is $\SI{3.79}{m}= 6 \cdot \SI{0.22}{m} + 5 \cdot \SI{0.23}{m}$. If the sum of the kicker passing time and rise time is shorter than the bunch gap, all kicker magnets can be triggered simultaneously, see eq. ~\ref{simul_kicker}. Tab. ~\ref{kicker_SIS100} shows the kicker passing time, the rise time and the bunch gap for $H^+$, $U^{28+} and$ $U^{73+}$ beams. 

\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{kicker_SIS100.jpg}
   \caption{SIS100 injection kicker.}
	\caption*{\textsl{\small{Yellow ellipses represent circulating bunches in SIS100 and red ones bunches to be injected. The head of the bunch is at the right side.}}}
   \label{kicker_SIS1001}
\end{figure}

\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{Calculated parameters related to the simultaneous trigger of the SIS100 injection kicker magnets}
\label{kicker_SIS100}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c  |}
    \hline
    Beam & $\beta$ &  \tabincell{c}{$\frac{d_\mathit{tankL-tankR}}{\beta c}$} & \tabincell{c}{$t_\mathit{rise}$}& \tabincell{c}{$\frac{d_\mathit{tankL-tankR}}{\beta c}+t_\mathit{rise}$} & \tabincell{c}{$t_\mathit{gap}$}\\ \hline

\multicolumn{6}{|c|}{$t_\mathit{gap}=25\%/f_\mathit{rf}^\mathit{SIS100}$ }	 \\ \hline
    $H^+$     & 0.982 & \SI{13}{ns}  	&  $\SI{130}{ns}$ & \SI{133}{ns} 	& \SI{184}{ns}  \\ \hline
    $U^{28+}$  & 0.568 & \SI{22}{ns} 	&  $\SI{130}{ns}$ & \SI{152}{ns}  	& \SI{159}{ns}  \\ \hline
    $U^{73+}$ & 0.872 & \SI{15}{ns} 	&  $\SI{130}{ns}$ & \SI{145}{ns}	& \SI{104}{ns} \\ \hline
\multicolumn{6}{|c|}{$t_\mathit{gap}=35\%/f_\mathit{rf}^\mathit{SIS100}$ }	 \\ \hline
    $H^+$     & 0.982 & \SI{13}{ns}  	&  $\SI{130}{ns}$ & \SI{133}{ns} 	& \SI{258}{ns}  \\ \hline
    $U^{28+}$  & 0.568 & \SI{22}{ns} 	&  $\SI{130}{ns}$ & \SI{152}{ns}  	& \SI{223}{ns}  \\ \hline
    $U^{73+}$ & 0.872 & \SI{15}{ns} 	&  $\SI{130}{ns}$ & \SI{145}{ns}	& \SI{146}{ns} \\ \hline
    \end{tabular}
\end{center}
\end{table}

Tab. ~\ref{kicker_SIS100} shows that the bunch gap of $U^\mathit{73+}$ is even shorter than the kicker rise time, when the bunch gap is $25\%$ of the cavity rf period. In this case, the kicker magnets can neither be triggered simultaneously, nor one after another. Hence, the $25\%$ bunch gap is not applicable for the SIS100 $U^\mathit{73+}$ injection. The SIS100 kicker magnets can be triggered simultaneously when bunches are longitudinally compressed, e.g. the bunch gap is $35\%$ of the cavity rf period. 

In conclusion, the $U^\mathit{73+}$ beam has the most stringent requirement according to the above analysis. $U^\mathit{73+}$ bunches have to be longitudinally compressed to approximately $65\%$ of the cavity rf period for the application of the SIS18 extraction kickers with the \SI{90}{ns} rise time and the application of SIS100 injection kickers with the \SI{130}{ns} rise time. When the bunch gap is $35\%$ of the cavity rf period, the extraction and injection kicker magnets in a common tank can be triggered simultaneously and the extraction kicker magnets in the SIS18 $2^{nd}$ tank can be triggered a fixed delay after the trigger of the kicker magnets in the SIS18  $1^{st}$ tank for ion beams over the whole range of stable isotopes.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{A Test Setup for Timing Aspects}
\label{real_test}

From a functional perspective, the test setup simulates that the B2B source SCU collects data from the B2B target SCU, the B2B source SCU calculates the start of the synchronization window and the B2B source SCU distributes the start of the synchronization window to the Trigger SCU. In addition, the test setup is used to check the firmware of the B2B related SCUs to verify that the firmware running on the soft CPU, LM32\footnote{LatticeMico32 is a 32-bit microprocessor soft core from Lattice Semiconductor optimized for field-programmable gate arrays (\gls{FPGA}s).}, meets the time constraints of the B2B transfer system.  In Sec. ~\ref{sec:test_timing} the test setup will be introduced. The comparison between the test setup and the final setup will be presented in Sec. ~\ref{sec:test_diff}. The procedure and the flowchart of the firmware will be explained in Sec. ~\ref{sec:proc}. Sec. ~\ref{sec:function_result} shows the functional test result and the measurement of the firmware running time. The measurement result will be discussed in Sec. ~\ref{result_dis}.  

\subsection{Test Setup}
\label{sec:test_timing}
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{schematic_setup.jpg}
   \caption{Schematic of the test setup.}
   \label{setup}
\end{figure}
Fig.~\ref{setup} shows the schematic of the test setup. In this test setup, two SRS MODEL DS345 Synthesized Function Generators\footnote{The DS345 Synthesized Function Generator is a full-featured \SI{30}{\MHz} synthesized function generator that uses an innovative Direct Digital Synthesis architecture. It generates many standard waveforms with excellent frequency resolution (1 $\mu$Hz) and has versatile modulation capabilities including AM, FM, Burst, PM and frequency sweeps.} (short: DS345) were used to simulate the rf systems of the SIS18 and SIS100. The two DS345s needed to be synchronized to a common reference clock. For simplicity, the DS345 of the SIS100 used a \SI{10}{\MHz} clock from the DS345 of the SIS18 as an external reference clock. The B2B source SCU, the B2B target SCU and the Trigger SCU were connected to a WR switch via single mode fibers\footnote{A G.652.B type single mode fiber is used for the 1310 and \SI{1550}{nm} wavelength region.}, which connected to the WR network. There was a SCU slave in the B2B source SCU, which simulated the PAP and PCM modules. A personal computer (\gls{PC}) was connected to the WR network, which was a Linux PC installed with the FEC tools \footnote{FEC tools include the etherbone tools, the saftlib tools and the Linux drivers. \\ \url{https://www-acc.gsi.de/wiki/Timing/TimingSystemHowConfigureEnvironment}}, the Altera's Quartus II software and the packETH software. The SCUs were connected to the PC via the Altera USB-Blaster Joint Test Action Group (JTAG) programmer. The PC was used to simulate the DM to produce the B2B start timing frame CMD\_START\_B2B. Besides, the PC monitored the status of the firmware in all SCUs and measured the running time of the firmware by the SignalTap II Logic Analyzer\footnote{The SignalTap II Logic Analyzer is a system-level debugging tool that captures and displays signals in circuits designed for implementation in Alteras FPGAs.} feature within the Quartus II software . An oscilloscope was connected to the Trigger SCU. Fig.~\ref{testsetup_text} shows the front view of the test setup. 
%testsetup.odg
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=90mm]{testsetup_text.jpg}
   \caption{Front view of the test setup.}
   \label{testsetup_text}
\end{figure}

\subsection{Comparison between the Test Setup and the Final Setup}
\label{sec:test_diff}
Fig.~\ref{finial_schematic} shows the schematic of the final setup. Compared with the test setup, two DS345s will be replaced by the FAIR LLRF system. In addition, the B2B source/target SCU, the Trigger SCU and the Kicker SCU with their own slaves will be equipped at every ring. The SCU slaves will be connected to the LLRF system by the optical direct link\footnote{The optical direct link is a multi-mode fiber with the bandwidth of \SI{40}{Mbit/s} up to \SI{100}{m}. It is used in the \SI{650}{nm} wavelength region.}. The SCUs on the source ring will be connected to one WR switch and the SCUs on the target ring will be connected to another WR switch, both WR switches will be connected to the WR network. The PC will be replaced by the DM. The maximum number of the WR switch layers among the B2B related SCUs and the DM must comply with the analysis result of the WR network for the B2B transfer in Sec. ~\ref{wr_network}. For more details about the data communication among the B2B related SCUs and their slaves, please see Chap. ~\ref{concept}.   

\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=120mm]{finial_schematic.jpg}
   \caption{Schematic of the final setup.}

   \label{finial_schematic}
\end{figure} 

\subsection{Procedure}
\label{sec:proc}
The test procedure which has be developed in the framework of this thesis is divided into several essential steps that include the different hardware systems described above.
%\begin{table}[H]
%\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
%\caption{Parameters related to the simultaneous trigger of the SIS100 injection kicker magnets}
%\label{kicker_SIS100}
%\begin{center}
%    \begin{tabular}{ | c |}
%    \hline
%    B2B source SCU \\ \hline
%	 \tabincell{c}{1. Login\\
%					  2. Use the saftlib \footnote{\url{https://www-acc.gsi.de/wiki/Timing/TimingSystemDocumentsSaftlib}} library function ``saft-ecpu-ctl`` to configure the ECA queue \footnote{\url{https://www-acc.gsi.de/wiki/Timing/TimingSystemHowTriggerLM32FromEca}} of the B2B source SCU to storage B2B frames CMD\_START\_B2B and TGM\_PHASE\_TIME. \\
%					 3. Use the saftlib library function ``saft-io-ctl`` to configure one IO port as an input for the TTL signals of the SIS18 DS345. \\
%					 4. Load the firmware to the LM32.\\
%					 5. Use saftlibe library function ``saft-io-ctl`` to monitor the input and output frames of the B2B source SCU. }
%	  \\ \hline
%    \end{tabular}
%\end{center}
%\end{table}
\begin{enumerate}
  \item Configure the B2B source SCU
  \begin{enumerate}
    \item Login the B2B source SCU.
%		\begin{lstlisting}[language = java,mathescape]
%			 ssh root@scu_name.acc.gsi.de
%		\end{lstlisting}
    \item Use the saftlib library\footnote{The saftlib library is simple application programming interface for timing.\\  \url{https://www-acc.gsi.de/wiki/Timing/TimingSystemDocumentsSaftlib}}  function to configure the Event-Condition-Action (ECA) queue \footnote{The ECA queue is used to storage filtered timing events, which are used for the SCU Soft CPU, LM32. \\ \url{https://www-acc.gsi.de/wiki/Timing/TimingSystemHowTriggerLM32FromEca}} of the B2B source SCU to storage the B2B frames CMD\_START\_B2B and TGM\_PHASE\_TIME.
%		\begin{lstlisting}[language = java,mathescape]
%			saft-ecpu-ctl baseboard -c CMD_B2B_START 32 0 0
%			saft-ecpu-ctl baseboard -c TGM_PHASE_TIME 32 0 0
%		\end{lstlisting}
	\item Use the saftlib library function to configure one IO port as an input for the TTL signal of the SIS18 DS345.
%		\begin{lstlisting}[language = java,mathescape]
%			 saft-io-ctl baseboard port_name -o 0
%		\end{lstlisting}
	\item Load the B2B source SCU firmware to the LM32.
%		\begin{lstlisting}[language = java,mathescape]
%			 lm32-ctl
%			 load firmware_name.elf
%		\end{lstlisting}
%	\item Use saftlibe library function ``saft-io-ctl`` to monitor the input and output frames of the B2B source SCU.
	 \end{enumerate}
  \item Configure the B2B target SCU
    \begin{enumerate}
    \item Login the B2B target SCU.
    \item Use the saftlib library function to configure the ECA queue of the B2B target SCU to storage the B2B frame CMD\_START\_B2B.
	\item Use the saftlib library function to configure one IO port as an input for the TTL signal of the SIS100 DS345.
	\item Load the B2B target SCU firmware to the LM32.
%	\item Use saftlibe library function ``saft-io-ctl`` to monitor the input and output frames of the B2B target SCU.
    \end{enumerate}
  \item Configure the Trigger SCU
    \begin{enumerate}
    \item Login the Trigger SCU.
	\item Use the saftlib library function to configure one IO port as an output. 
	\item Use the saftlib library function to configure ECA ~\cite{terpstra_timing_2013} to produce a TTL signal at the output port, when the frame TGM\_SYNCH\_WIN is executed. 
	\item Load the Trigger SCU firmware to the LM32.
%	\item Use saftlibe library function ``saft-io-ctl`` to monitor the input and output frames of the Trigger SCU.
    \end{enumerate}
	\item Use the packETH to generate the frame CMD\_START\_B2B.
\end{enumerate}


%\item After receiving CMD\_START\_B2B, both the firmware of the B2B source and target SCUs collect the timestamp of the rising edge of the TTL signals of the SIS18 and the SIS100 DS345s. 
%\item The firmware of the B2B source SCU reads the phase value from the SCU slave, which works as the PAP module. 
%\item The firmware of the B2B target SCU transfers the frame TGM\_PHASE\_TIME containing the phase and the corresponding timestamp to the B2B source SCU.
%\item After receiving the data, the firmware of the B2B source SCU calculates the synchronization window and the phase correction value.
%\item The firmware of the B2B source SCU sends the frame TGM\_SYNCH\_WIN containing the start timestamp of the synchronization window to the WR network.
%\item The firmware of the B2B source SCU writes the phase correction value to the SCU slave, which works as the SR module.
%\item After receiving the frame, the firmware of the Trigger SCU produces a TTL signal indicating the start of the synchronization window. 

More details of the configuration are shown in Appendix ~\ref{appendix_conf}. The flowchart of the firmware of the B2B source SCU and that of the B2B target SCU and that of the Trigger SCU are shown in Fig. ~\ref{test_flwochart}, Fig. ~\ref{test_flwochart1} and Fig. ~\ref{test_flwochart2}. The project is kept in the git repository \footnote{The B2B transfer system git repository \\ \url{https://github.com/GSI-CS-CO/bel_projects/tree/lm32_B2B_merge}}. The firmware of the test setup realizes partial function of the flowcharts described in Sec. ~\ref{sec_firmware}.
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{test_flwochart_src.png}
   \caption{Flowchart of the firmware of the B2B source SCU for the test setup.}
   \label{test_flwochart}
\end{figure}
\begin{figure}[H]
   \centering   
   \includegraphics*[width=120mm]{test_flwochart_trg.png}
   \caption{Flowchart of the firmware of the B2B target SCU for the test setup.}
   \label{test_flwochart1}
\end{figure}
\begin{figure}[H]
   \centering   
   \includegraphics*[width=120mm]{test_flwochart_trigger.png}
   \caption{Flowchart of the firmware of the Trigger SCU for the test setup.}
   \label{test_flwochart2}
\end{figure}


\subsection{Functional Test Result}
\label{sec:function_result}
The test made use of the parameters from the FAIR use case of the $U^{28+}$ B2B transfer from the SIS18 to the SIS100 and the frequency beating method. After the frequency detune, the SIS18 rf cavity frequency is \SI{1.572200}{\MHz} and the SIS100 rf cavity frequency is \SI{1.572000}{\MHz}. Hence, the SIS18 DS345 produced \SI{1.572200}{\MHz} TTL signal for the B2B source SCU and the SIS100 DS345 produced \SI{1.572000}{\MHz} TTL signal for the B2B target SCU. These two frequencies were given to the firmware of the B2B source SCU. The console of the PC showed the print information of the firmware on the B2B source, B2B target and Trigger SCUs. All print timestamps are in the format of Greenwich Mean Time (GMT). 
%SIS18 	phase measurement signal 1.572200MHz
%SIS100 phase measurement signal 1.572000MHz 
%SIS18 	period of phase measurement signal 636051(ps)
%SIS100 period of phase measurement signal 636132(ps)
%Waiting time for synchronization: 4.622818 ms
%The number of the period of SIS18 phase measurement signal for the synchronization: 7268
%Beating frequency: 200 Hz 
\begin{lstlisting}[language={[ANSI]C}, keywordstyle=\color{blue!70}, commentstyle=\color{red!50!green!50!blue!50}, frame=shadowbox, rulesepcolor=\color{red!20!green!20!blue!20}]

U28+ B2B transfer from SIS18 to SIS100 => B2B source SCU
=============================================

Receive CMD\_START\_B2B from WR network
Timestamp the rising edge of TTL signal from the SIS18 DS345 
GMT Thu, Jan 8, 1970, 21:07:27.445405856

Receive TGM_PHASE_TIME from WR network
Timestamp of the rising edge of TTL signal of the SIS100 DS345 
GMT Thu, Jan 8, 1970, 21:07:27.445364560

Start of the synchronization window: GMT Thu, Jan 8, 1970, 21:07:27.450028674

Send TGM_SYNCH_WIN to WR network
\end{lstlisting}

\begin{lstlisting}[language={[ANSI]C}, keywordstyle=\color{blue!70}, commentstyle=\color{red!50!green!50!blue!50}, frame=shadowbox, rulesepcolor=\color{red!20!green!20!blue!20}]

U28+ B2B transfer from SIS18 to SIS100 => B2B target SCU
=============================================

Receive CMD\_START\_B2B from WR network
Timestamp the rising edge of TTL signal from the SIS100 DS345 
GMT: Thu, Jan 8, 1970, 21:07:27.445364560

Send TGM_PHASE_TIME to WR network
\end{lstlisting}

\begin{lstlisting}[language={[ANSI]C}, keywordstyle=\color{blue!70}, commentstyle=\color{red!50!green!50!blue!50}, frame=shadowbox, rulesepcolor=\color{red!20!green!20!blue!20}]

U28+ B2B transfer from SIS18 to SIS100 => Trigger SCU
=============================================

Receive TGM_SYNCH_WIN from WR network
Start of the synchronization window: GMT 1970-01-08 21:07:27.450028674
\end{lstlisting}

Besides, the TTL signal indicating the start of the synchronization window was observed on the oscilloscope. According to the test result, the test setup realized the functionality of the data collection, data calculation and data redistribution for the FAIR B2B transfer system.


During the test, the SignalTap II Logic Analyzer was used to measure the needed time for the tasks of the firmware. Tab. ~\ref{execution_time} shows the measured running time of different tasks of the B2B source SCU firmware. The LM32 is connected to other intellectual property cores by the System-on-Chip bus \footnote{The system-on-Chip bus is intended to let the parts of an integrated circuit communicate with each other. e.g. the Wishbone bus is used for the FAIR standard FEC.}. The test result was based on the precondition that the related System-on-Chip bus was not occupied by any other applications, when the firmware was running.

\begin{table}[!htb]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The running time of the tasks of the B2B source SCU firmware}
\label{execution_time}
\begin{center}
    \begin{tabular}{ | c |c | c | c | c | c | c | c |}
    \hline
     Task & \tabincell{c}{Average \\running time} & \tabincell{c}{Worst-case
\\running time}  \\ \hline

      \tabincell{c}{The LM32 uses polling to check the reception \\of the CMD\_START\_B2B after the ECA\\ queue stores the CMD\_START\_B2B} & \SI{336}{\ns} & \SI{336}{\ns}\\ \hline
      The LM32 reads from/writes to the SCU slave & \SI{450}{\ns} & \SI{450}{\ns}\\ \hline
\tabincell{c}{The LM32 uses polling to check the reception \\of the TGM\_PHASE\_TIME after the ECA\\ queue stores the TGM\_PHASE\_TIME}& \SI{336}{\ns} & \SI{336}{\ns}\\ \hline
      \tabincell{c}{The LM32 reads the phase and timestamp \\contained in the TGM\_PHASE\_TIME} & \SI{2.7}{\us} & \SI{2.7}{\us}\\ \hline
     \tabincell{c}{The LM32 calculates the\\ start of the synchronization window} & \SI{12.6}{\us}& \SI{12.8}{\us} \\ \hline
     The LM32 calculates the phase correction value & \SI{2.0}{\us}& \SI{2.2}{\us} \\ \hline
     \tabincell{c}{The LM32 sends the TGM\_SYNCH\_WIN \\to the WR network} & \SI{3.2}{\us} & \SI{3.2}{\us}\\ \hline

    \end{tabular}
\end{center}
\end{table}

\subsection{Measurement Result Discussion}
\label{result_dis}

The measurement result was used to evaluate whether the firmware running on the soft CPU, LM32, of the SCU meets the time constraint of the B2B transfer system or not.

After the ECA queue stores the frame CMD\_START\_B2B, the firmware of the B2B source SCU needs maximal \SI{800}{\ns} (\SI{336}{\ns}+\SI{450}{\ns}) to inform the PAP module to start the phase extrapolation. Compared with \SI{500}{\us} phase extrapolation duration,  \SI{800}{\ns} is negligible. \SI{500}{\us} after the execution of the CMD\_START\_B2B, the firmware reads the extrapolated phase from the PAP module \SI{800}{\ns} after the BuTiS T0 incident, \SI{800}{\ns} is much shorter than \SI{10}{\us} (the BuTiS T0 period), which guarantees the correct extrapolated phases are read at both the B2B source and target SCUs. 

After the ECA queue stores the frame TGM\_PHASE\_TIME, the firmware of the B2B source SCU needs maximal \SI{3.1}{\us} (\SI{336}{\ns}+\SI{2.7}{\us}) to get the phase and timestamp. The calculation time is maximal \SI{15}{\us} (\SI{12.8}{\us}+\SI{2.2}{\us}) and the sending time of the TGM\_SYNCH\_WIN is \SI{3.2}{\us}. The sum of these running time is approximately \SI{22}{\us}, which is negligible compared with \SI{10}{\ms}.

After the ECA queue stores the TGM\_PHASE\_CORRECTION, the Trigger SCU needs maximal \SI{3.6}{\us} (\SI{336}{\ns}+\SI{2.7}{\us}+\SI{450}{\ns}) to transfer the phase correction value to the PCM. \SI{3.6}{\us} is shorter than \SI{10}{\us}, which guarantees the trigger of the phase correction at the correct BuTiS T0 incident.

In conclusion, the test setup proved the systematic functionality, the data collection, calculation and distribution. Besides, it proved that the firmware on LM32 meets the time constraints of the B2B transfer system, when the firmware is running and the related System-on-Chip bus is not occupied by any other applications. 



%Compared with the test setup, there are some difference of the final scenario~\cite{bai_concept_2016}.
%\begin{itemize}
%\item
%The B2B source and target SCUs will consist of the PAP, PSM, PCM and SR modules as SCU slaves. 
%\item
%The Trigger SCU will consist of PCM, SR and TD modules as SCU slaves. 
%\item 
%The B2B source and target SCUs will get the extrapolated phase from the PAP modules instead of the timestamp from the DS345. 
%\item 
%The B2B source SCU will transfer the required phase shift to the PSM for the phase shift method and the phase correction to the Trigger SCUs.
%\item 
%The Trigger SCU will consider not only the synchronization window, but also the kicker delay compensation from the SM, as well as the bucket indication signal and signals from the MPS.
%\end{itemize}



%After both B2B source and target programs receive the CMD\_START\_B2B frame, they trigger another unit connected to the System-on-Chip\footnote{A system-on-chip is an integrated circuit that integrates all components of a computer or other electronic system into a single chip.} (SoC) bus to get the timestamp of the next zero crossing point of the DS345 sine waves, which is simulated as an equivalent to the predicted phase. The timestamp got by the B2B source SCU is Thu, Jan 8, 1970, 21:07:27 0.445405856 second and the timestamp got by the B2B target SCU is Thu, Jan 8, 1970, 21:07:27 0.445364560 second, see Line 10 and 14 of the test result of the B2B source SCU. The time difference between two timestamps is \SI{41.296}{\us}. The frequency difference between SIS18 and SIS100 phase measurement signals is \SI{200}{Hz}. It means that there are 200 more periods of the SIS18 phase measurement signal within one second compared with the SIS100 phase measurement signal. Every \SI{5}{ms} (1/\SI{200}{Hz}) SIS18 phase measurement signal has one period more than that of SIS100. The time is calculated by eq. ~\ref {syn_time}, indicating the alignment of the zero crossing of two DS345 sine waves of SIS18 and SIS100. The time is named as ``synchronization time``, denoted by $\Delta t$.

%\begin{equation}
%\begin{aligned}
%\frac{T^{SIS18}_{h=2}}{1/(f^{SIS18}_{h=2}-f^{SIS100}_{h=10})}=\frac{41.296us\mod T^{SIS100}_{h=10}}{\Delta t}
%\label {syn_time}
%\end{aligned}
%\end{equation}
%
%\begin{equation}
%\Delta t = \SI{4.622818}{\ms}
%\end{equation}
%
%The number of the SIS18 phase measurement signal periods for the synchronization is calculated as
%\begin{equation}
%\frac{\Delta t}{T^{SIS18}_{h=2}}=7268
%\end{equation}
%we could get that the beating time \gls{symb:d_t} is \SI{4.622818}{\ms} and the number of the SIS18 phase measurement signal periods for the synchronization is 7268 for the test.

%After both B2B source and target programs receive the $CMD\_START\_B2B$ frame, they trigger another unit connected to the System-on-Chip\footnote{A system-on-chip is an integrated circuit that integrates all components of a computer or other electronic system into a single chip.}  (SoC) bus to get the timestamp of the next zero crossing point of the DS345 sine waves, which is simulated as an equivalent to the predicted phase. The triggers of the B2B source and target SCUs are not simultaneous, namely the B2B source and target SCU do not get the timestamp of the adjacent zero crossing points of two RF simulated sine signals, see Line 10 and 14 of the test result of the B2B source SCU. All timestamp are shown in the format of Greenwich Mean Time (GMT). The timestamp got by the B2B source SCU is Thu, Jan 8, 1970, 21:07:27 0.445405856 second and the timestamp got by the B2B target SCU is Thu, Jan 8, 1970, 21:07:27 0.445364560 second. The time difference between two timestamps is \SI{41.296}{\us}. There are two reasons for the asynchronous triggers.
%
%\begin{itemize}
%	\item
%The SoC bus might be granted to other program and B2B program must wait until it is free.
%	\item
%The behaviour of the user friendly messages of the LM32 programs causes the non real time of the programs.
%\end{itemize}
%
%The difference between timestamps of the adjacent zero crossing points, 592ns, is the remainder resulting from 41.296us dividing SIS18 revolution period \SI{636051}{\ps}. Based on eq. ~\ref{syn_time} and eq. ~\ref{syn_num}, 
%\begin{equation}
%\begin{aligned}
%\frac{T^{SIS18}_{h=2}}{5ms}=\frac{592ns}{\Delta t}
%\label {syn_time}
%\end{aligned}
%\end{equation}
%
%\begin{equation}
%\begin{aligned}
%\frac{\Delta t}{T^{SIS18}_{h=1}}=3634
%\label {syn_num}
%\end{aligned}
%\end{equation}
%we could get that the beating time \gls{symb:d_t} is \SI{4.622818}{\ms} and the number of the SIS18 revolution period is 3634 for the test. 
%
%For the real application of the B2B transfer system, in order to guarantee the time constraints of the B2B programs, see Fig. ~\ref{time_constraint}, the B2B source, target and Trigger SCUs run only their corresponding B2B program. The SoC bus is occupied only by the B2B program. Besides, the programs running on LM32 are forbidden to print out any user friendly messages.



%%%%%%%%%%%Uncertainty 
%For both the phase shift and frequency beating methods, the calculation is based on the extrapolated phase of the rf signal locally. Here the $U^{28+}$ B2B transfer from the SIS18 to the SIS100 is taken as an example, two synchronization frequencies are $f_{\mathit{syn}}^{SIS18}=f_{\mathit{rf}}^{SIS18}$ and $f_{\mathit{syn}}^{SIS100}=f_{\mathit{rf}}^{SIS100}$ and two phase measurement signals are $f_{\mathit{B2B}}^{SIS18}=1/5f_{\mathit{rev}}^{SIS18}$ and $f_{\mathit{B2B}}^{SIS100}=f_{\mathit{rev}}^{SIS100}$ (more details about $f_{\mathit{syn}}^{X}$ and $f_\mathit{B2B}^{X}$, please see Chap. ~\ref{background} and Chap. ~\ref{concept}.). The PAP module extrapolates the phase $\psi^{SIS100}$ for $f_{\mathit{B2B}}^{SIS100}$ and $\psi^{SIS18}$ for $f_{\mathit{B2B}}^{SIS18}$ at $t_{\psi}^\mathit{SIS18}=t_{\psi}^\mathit{SIS100}$. The phase difference between two synchronization frequencies is
%\begin{equation}
%\Delta \phi_\mathit{syn}=\frac{f_{\mathit{syn}}^{SIS100}}{f_{\mathit{rev}}^{SIS100}}(\psi^\mathit{SIS100}-\psi^\mathit{SIS18}) \mod 2\pi =10 \cdot(\psi^\mathit{SIS100}-\psi^\mathit{SIS18}) \mod 2\pi
%\label{phase_diff_18to100}
%\end{equation}

%Fig.~\ref{Calculation_symble} illustrates some basic definition of symbols for the calculation. 
%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=150mm]{Calculation_symble.jpg}
%   \caption{The illustration of symbols for the calculation.}
%   \label{Calculation_symble}
%\end{figure}
%$\phi_{h=2}^{SIS18}$and $\phi_{h=10}^{SIS100}$ are individual rf phase of SIS18 and SIS100 phase measurement signals at $t_{\psi}$. The relationship between \gls{symb:h2phase18}, \gls{symb:h10phase100} and $\psi_{h=1/5}^{SIS18}$, $\psi_{h=1}^{SIS100}$ are given by eq.~\ref{SIS18_phase} and eq.~\ref{SIS100_phase}. 

%\begin{equation}
%\phi_{h=2}^{SIS18} =  \frac {\frac{\psi_{h=1/5}^{SIS18}}{2\pi}\cdot {T_{h=1/5}^{SIS18}} \mod {T_{h=2}^{SIS18}}}{T_{h=2}^{SIS18}}\cdot {2\pi} \label{SIS18_phase}
%\end{equation}
%\begin{equation}
%\phi_{h=10}^{SIS100} =  \frac {\frac{\psi_{h=1}^{SIS100}}{2\pi}\cdot {T_{h=1}^{SIS100}} \mod {T_{h=10}^{SIS100}}}{T_{h=10}^{SIS100}}\cdot {2\pi} \label{SIS100_phase}
%\end{equation}
%substituting $T_{h=2}^{SIS18}\cdot 10=T_{h=1/5}^{SIS18}$, $T_{h=10}^{SIS100}\cdot 10=T_{h=1}^{SIS100}$ into eq.\ref{SIS18_phase} and eq.\ref{SIS100_phase} yields
% \begin{equation}
%\phi_{h=2}^{SIS18} =  \frac {\frac{\psi_{h=1/5}^{SIS18}\cdot 10}{2\pi}\cdot {T_{h=2}^{SIS18}} \mod {T_{h=2}^{SIS18}}}{T_{h=2}^{SIS18}}\cdot {2\pi} \label{SIS18_phase1}
%\end{equation}
%\begin{equation}
%\phi_{h=10}^{SIS100} =  \frac {\frac{\psi_{h=1}^{SIS100}\cdot 10}{2\pi}\cdot {T_{h=10}^{SIS100}} \mod {T_{h=10}^{SIS100}}}{T_{h=10}^{SIS100}}\cdot {2\pi} \label{SIS100_phase1}
%\end{equation}
%
%Here we explain the inevitable uncertainty of the phase extrapolation and rf frequency modulation. 
%\begin{itemize}
%\item Uncertainty of the phase extrapolation
%
%
% 
%Based on eq.~\ref{phase_diff_18to100} and eq.~\ref{jitter_measure_p}, the uncertainty of the phase difference between the SIS18 and SIS100 synchronization frequencies is
%\begin{equation}
%\Delta \phi_\mathit{syn}\approx10 \cdot[0.006^\circ-(-0.006^\circ)] \mod 2\pi\approx 0.12^\circ
%\end{equation}

%\begin{equation}
%\begin{aligned}
%\delta \phi_{h=2}^{SIS18} = \sqrt {(\frac{\partial \phi_{h=2}^{SIS18}}{\partial \psi_{h=2}^{SIS18}} \delta \psi_{h=2}^{SIS18})^2}=\sqrt {(10 \cdot \delta \psi_{h=2}^{SIS18})^2}=0.06^\circ
%\label{phi_jitter1}
%\end{aligned}
%\end{equation}
%\begin{equation}
%\delta \phi_{h=10}^{SIS100} = \sqrt {(\frac{\partial \phi_{h=10}^{SIS100}}{\partial \psi_{h=1}^{SIS100}} \delta \psi_{h=10}^{SIS100})^2}=\sqrt {(10 \cdot \delta \psi_{h=10}^{SIS100})^2}=0.06^\circ
%\label{phi_jitter2}
%\end{equation}

%\item Uncertainty of the rf frequency modulation
%
%For the rf frequency modulation, the uncertainty is $0.2^\circ$ at \SI{5.4}{MHz} ~\cite{laier_funktional-spezifikation_2011}. We calculate the uncertainty in the time domain, see eq.~\ref{freq_jitter_t}.
%\begin{equation}
%\delta \Delta f_\mathit{rf} =\delta \Delta f_\mathit{syn}= \frac{0.2^\circ}{2\pi} \cdot {\frac{1}{5.4MHz}}\approx 100ps
%\label{freq_jitter_t}
%\end{equation}
%
%The precision of the rf frequency is 0.05Hz. 
%\begin{equation}
%\delta \Delta f = 0.05Hz
%\label{freq_jitter_f}
%\end{equation}


%
%\end{itemize}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Different relation between $\phi_{h=2}^{SIS18}$ and $\phi_{h=10}^{SIS100}$ requires different phase adjustment for SIS18. Fig.~\ref{phase_shift} illustrates all scenarios of their relation and the required phase adjustment for each scenario. We would like to introduce a phase shift of up to $\pm \pi$. The blue and red line represents the phase of SIS100 and SIS18 phase measurement signal. The clockwise arrow from the SIS18 to SIS100 rf phase represents the negative phase adjustment for SIS18 and the anticlockwise represents the positive phase adjustment. The required phase adjustment of SIS18 is denoted by $\Delta \phi_{shift}$.
%
%
%\begin{itemize}
%    \item Scenario (a): $\phi_{h=10}^{SIS100}\in [0,90^\circ)$, see Fig.~\ref{frequency_beating} (a).
%
%	\begin{itemize}
%		\item $\phi_{h=10}^{SIS100}< \phi_{h=2}^{SIS18}< \phi_{h=10}^{SIS100} +180^\circ$, which denotes by the yellow semicircle in Fig.~\ref{frequency_beating} (a). The phase adjustment is
%    \begin{equation}
%			\Delta \phi_{shift}=-(\phi_{h=2}^{SIS18} - \phi_{h=10}^{SIS100})
%    \end{equation}
%    		\item $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100}$ or  $\phi_{h=2}^{SIS18} >\phi_{h=10}^{SIS100} +180^\circ$, which denotes by the white semicircle in Fig.~\ref{frequency_beating} (a). The phase adjustment is
%    \begin{equation}
%			\Delta \phi_{shift}= 2\pi - \phi_{h=2}^{SIS18} + \phi_{h=10}^{SIS100}
%    \end{equation}
%	\end{itemize}
%\begin{figure}[H]
%   \centering   
%   \includegraphics*[width=130mm]{phase_shift_synch_window_cal.jpg}
%   \caption{Scenarios for the phase shift method.}
%   \label{phase_shift}
%\end{figure}
%    \item Scenario (b): $\phi_{h=10}^{SIS100}\in [90,180^\circ)$, see Fig.~\ref{frequency_beating} (b). 
%
%	\begin{itemize}
%		\item $\phi_{h=10}^{SIS100}< \phi_{h=2}^{SIS18}< \phi_{h=10}^{SIS100} +180^\circ$, which denotes by the yellow semicircle in Fig.~\ref{frequency_beating} (b). The phase adjustment is
%	    \begin{equation}		
%\Delta \phi_{shift}=-(\phi_{h=2}^{SIS18} - \phi_{h=10}^{SIS100})
%    \end{equation}
%    		\item $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100}$ or  $\phi_{h=2}^{SIS18} >\phi_{h=10}^{SIS100} +180^\circ$, which denotes by the white semicircle in Fig.~\ref{frequency_beating} (b).  The phase adjustment is
%    \begin{equation}			
%\Delta \phi_{shift}=2\pi - \phi_{h=2}^{SIS18} + \phi_{h=10}^{SIS100}
%    \end{equation}
%	\end{itemize}
%    \item Scenario (c): $\phi_{h=10}^{SIS100}\in [180,270^\circ)$, see Fig.~\ref{frequency_beating} (c). The phase adjustment is
%
%	\begin{itemize}
%		\item $\phi_{h=2}^{SIS18} > \phi_{h=10}^{SIS100}$ or  $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100} +180^\circ - 2\pi $, which denotes by the yellow semicircle in Fig.~\ref{frequency_beating} (c). The phase adjustment is
%    \begin{equation}			
%\Delta \phi_{shift}=-(2\pi - \phi_{h=10}^{SIS100}+ \phi_{h=2}^{SIS18})
%    \end{equation}
%    		\item $\phi_{h=10}^{SIS100}-180^\circ < \phi_{h=2}^{SIS18}< \phi_{h=10}^{SIS100}$, which denotes by the white semicircle in Fig.~\ref{frequency_beating} (c). The phase adjustment is
%    \begin{equation}			
%\Delta \phi_{shift}=\phi_{h=10}^{SIS100}-\phi_{h=2}^{SIS18}
%    \end{equation}
%	\end{itemize}
%    \item Scenario (d): $\phi_{h=10}^{SIS100}\in [270,2\pi)$, see Fig.~\ref{frequency_beating} (d).
%
%	\begin{itemize}
%		\item $\phi_{h=10}^{SIS100}-180^\circ < \phi_{h=2}^{SIS18}< \phi_{h=10}^{SIS100}$, which denotes by the yellow semicircle in Fig.~\ref{frequency_beating} (d). The phase adjustment is 
%	    \begin{equation}	
%\Delta \phi_{shift}=\phi_{h=10}^{SIS100}-\phi_{h=2}^{SIS18}	
%    \end{equation}
%    		\item $\phi_{h=2}^{SIS18} > \phi_{h=10}^{SIS100}$ or  $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100} +180^\circ - 2\pi $ , which denotes by the white semicircle in Fig.~\ref{frequency_beating} (d). 
%    \begin{equation}			
%\Delta \phi_{shift}=-(2\pi - \phi_{h=10}^{SIS100}+ \phi_{h=2}^{SIS18})
%    \end{equation}
%	\end{itemize}
%\end{itemize}


%\begin{aligned}
%\delta t_\mathit{align} =\sqrt {(\frac {\partial t_\mathit{align}}{\partial t_{\psi}^X}\delta t_{\psi}^X)^2 + (\frac {\partial t_\mathit{align}}{\partial T}\delta T)^2} \\
% =\sqrt {(\delta t_{\psi}^X)^2+T^2} \approx \sqrt { 100ps^2+100ps^2}\approx 140ps \label{Phase_uncertainty}
%\end{aligned}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Fig.~\ref{frequency_beating} illustrates two scenarios for the frequency beating method. With the frequency beating method, SIS18 can only achieve positive phase adjustment, which is denoted by \gls{symb:phase_just_frequency_beating}. E.q.~\ref{sync_time} shows the best estimate time of alignment for the phase adjustment of $\Delta \phi_{adjustment}$.
%\begin{equation}
%	 t_\mathit{align} = t_{\psi}+\frac {\Delta \phi_{adjustment}}{{2\pi} \cdot {\Delta f}} \label {sync_time}
%   \end{equation}
%where \gls{symb:beating_freq} is the beating frequency.
%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=90mm]{frequency_beating_synch_window_cal.jpg}
%   \caption{Two scenarios for the frequency beating method.}
%   \label{frequency_beating}
%\end{figure}
%
%According to the relation between $\phi_{h=2}^{SIS18}$ and $\phi_{h=10}^{SIS100}$, there are two scenarios, see Fig.~\ref{frequency_beating}.
%\begin{itemize}
%    \item Scenario (a): $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100}$
%	\begin{equation}
%	 \Delta \phi_{adjustment} = \phi_{h=10}^{SIS100} - \phi_{h=2}^{SIS18}\label {great}
%   \end{equation}
%   Replacing $\Delta \phi_{adjustment}$ in eq.~\ref{sync_time} with eq.~\ref{great}, we have
%	\begin{equation}
%	 t_\mathit{align} =t_{\psi} +\frac {\phi_{h=10}^{SIS100} - \phi_{h=2}^{SIS18}}{{2\pi} \cdot {\Delta f}} \label {beating_win_1}
%   \end{equation}
%     \item  Scenario (b): $\phi_{h=2}^{SIS18} \ge \phi_{h=10}^{SIS100}$
%	\begin{equation}
%	 \Delta \phi_{adjustment} = 2\pi - (\phi_{h=2}^{SIS18}-\phi_{h=10}^{SIS100}) \label {less}
%   \end{equation}
%  Replacing $\Delta \phi_{adjustment}$ in eq.~\ref{sync_time} with eq.~\ref{less}, we have
%
%	\begin{equation}
%	 t_\mathit{align} =t_{\psi} +\frac {2\pi - (\phi_{h=2}^{SIS18}-\phi_{h=10}^{SIS100})}{{2\pi} \cdot {\Delta f}} \label {beating_win_2}
%   \end{equation}
%\end{itemize}
%Based on these two scenarios, we could deduce the formula for the best estimate time of alignment. 
%	\begin{equation}
%	 t_\mathit{align} =t_{\psi} +\frac {{\Delta n} \cdot {2\pi} - (\phi_{h=2}^{SIS18}-\phi_{h=10}^{SIS100})}{{2\pi} \cdot {\Delta f}} \label {beating_win_2}
%   \end{equation}
%where $\bigtriangleup{n}$ equals 0 when  $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100}$ and equals 1 when  $\phi_{h=2}^{SIS18} \ge \phi_{h=10}^{SIS100}$.


%\begin{equation}
%\begin{aligned}
%\delta t_\mathit{align} =\sqrt {(\frac {\partial t_\mathit{align}}{\partial \phi_{h=2}^{SIS18}}\delta \phi_{h=2}^{SIS18})^2 + (\frac {\partial t_\mathit{align}}{\partial \phi_{h=10}^{SIS100}}\delta \phi_{h=10}^{SIS100})^2+(\frac {\partial t_\mathit{align}}{\partial \Delta f}\delta \Delta f)^2} \\
% =\sqrt {(\frac{-1}{{2\pi} \cdot {\Delta f}}\delta \phi_{h=2}^{SIS18})^2+(\frac{1}{{2\pi} \cdot {\Delta f}}\delta \phi_{h=10}^{SIS100})^2+(-\frac{{\Delta n} \cdot {2\pi} - (\phi_{h=2}^{SIS18}-\phi_{h=10}^{SIS100})}{{2\pi} \cdot {\Delta f}^2}\delta \Delta f)^2} \\
%\le \sqrt {(\frac{-1}{{2\pi} \cdot {200}}0.06^\circ)^2+(\frac{1}{{2\pi} \cdot {200}}0.06^\circ)^2+0}\\
%\approx 1.178us \label{beating_uncertainty}
%\end{aligned}
%\end{equation}
