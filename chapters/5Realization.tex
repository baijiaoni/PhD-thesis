!!!!!!!!!!!!!!!!please stop here. This chapter needs to be reworked, including the corresponding abbreviation.

This chapter concentrates on the realization and systematic investigation of the \gls{B2B} transfer system. In Sec. 6.1, both the phase shift and frequency beating synchronization methods are analyzed from the beam dynamic viewpoint. The WR network is investigated for the B2B transfer and the calculation of the synchronization window are presented in Sec. 6.2. The B2B transfer system for FAIR focuses first of all on SIS18 to SIS100 transfer, so the trigger possibility of the SIS18 extraction and SIS100 injection kicker is systematically investigated in Sec. 6.3. Besides, the test setup from the timing aspect is built in Sec. 6.4. 

\section{Investigation of two synchronization methods for $U^{28+}$ B2B transfer from SIS18 to SIS100 from the beam dynamics viewpoint }
This section analyzes the phase shift and frequency beating methods from the beam-dynamics viewpoint for the synchronization of SIS18 with SIS100. In this chapter, the circumference of SIS18 and SIS100 are denoted by $C^{SIS18}$ and $C^{SIS100}$, the revolution frequency by $f_{h=1}^{SIS18}$ and $f_{h=1}^{SIS100}$ and the rf frequency by $f_{h=2}^{SIS18}$ and $f_{h=10}^{SIS100}$. Since SIS18 and SIS100 harmonic number are 2 and 10, the relationship between the revolution and rf frequencies are $f_{h=2}^{SIS18}=2f_{h=1}^{SIS18}$ and $f_{h=10}^{SIS100}=10f_{h=1}^{SIS100}$. Since $C^{SIS100}$ is five times as long as $C^{SIS18}$, we could get the relation  $f_{h=1}^{SIS18}$=5$f_{h=1}^{SIS100}$ and $f_{h=10}^{SIS100}$=$f_{h=2}^{SIS18}$.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Phase shift method}
To achieve a required phase shift, the \gls{RF} frequency is modulated away from the nominal value for a period of time and modulated back ~\cite{ezura_beam-dynamics_2008}. Let $\Delta \phi_\mathit{shift}$ be the phase shift to be achieved and \gls{symb:freq_modulation} the RF frequency variation to accomplish it; then,
\begin{equation}
\Delta \phi_{shift}= 2\pi \int_{t_0}^{t_0+T} \Delta f_{rf}(t)dt \label{phase_integration}
\end{equation}
where $T$ is the period of frequency modulation and $t_0$ is the time at which the modulation begins. To make the frequency modulation effective, the stabilization system, beam-phase feedback loop, must be frozen before the modulation begins. 

The following four examples of frequency modulation are analyzed. Case (1) trapezoid modulation, Case (2) triangular modulation, Case (3) sinusoidal modulation and Case (4) parabolic modulation. Here I assume the phase shift must be achieved within 7ms. These frequency modulations are shown in Fig.~\ref{4case}. All the four modulations give the same phase shift, $\Delta \phi_{shift}=\pi$, which is proved by substituting each form of $\Delta f_{rf}(t)$ into eq.~\ref{phase_integration} and performing integration. 

%Case (1)
%\begin{eqnarray}\label{case1}
%\Delta f(t)=
%\begin{cases}
%50(t-t_1), &t_1< t\le t_1+2ms\cr
%100, &t_1+2ms < t \le t_1+5ms \cr
%-50(t-t_1) + 7\cdot 50, &t_1+5ms < t\le t_1+7ms
%\end{cases}
%\end{eqnarray}
%
%Case (2)
%\begin{eqnarray}\label{case2}
%\Delta f(t)=
%\begin{cases}
%\frac {500}{3.5 \cdot 3.5}(t-t_1), &t_1< t\le t_1+3.5ms\cr
%-\frac {500}{3.5 \cdot 3.5}(t-t_1) +7
%\cdot \frac {500}{3.5 \cdot 3.5}, &t_1+3.5ms < t \le t_1+7ms 
%\end{cases}
%\end{eqnarray}
%
%Case (3)
%\begin{eqnarray}\label{case3}
%\Delta f(t)=
%\frac {1000}{7 \cdot 2} (1-cos(\frac{2\pi}{7}\cdot (t-t_1)), &t_1 < t\le t_1+7ms
%\end{eqnarray}
%
%Case (4)
%\begin{eqnarray}\label{case4}
%\Delta f(t)=
%\begin{cases}
%30(t-t_1)^2, &t_1< t\le t_1+1ms\cr
%30+ 60((t-t_1)-1), &t_1+1ms< t\le t_1+2.5ms\cr
%30(5-((t-t_1)-3.5)^2), &t_1+2.5ms< t\le t_1+4.5ms\cr
%
%30+60(6-(t-t_1)), &t_1+4.5ms< t\le t_1+6ms\cr
%30(7-(t-t_1))^2, &t_1+6ms< t\le t_1+7ms
%\end{cases}
%\end{eqnarray}

Case (1) 
\begin{eqnarray}\Delta f_{rf}(t)=
\begin{cases}
50Hz/ms \cdot (t-t_0) &t_0+0<t\le t_0+2ms\cr  100Hz &t_0+2<t\le t_0+5ms \cr 100Hz-50Hz/ms \cdot (t-t_0) &t_0+5ms<t\le t_0+7ms\cr 
\end{cases}
\end{eqnarray}

Case (2) 
\begin{eqnarray}\Delta f_{rf}(t)=
\begin{cases}
\frac{10^3}{7\cdot 3.5}Hz/ms \cdot (t-t_0) &t_0+0<t\le t_0+3.5ms\cr  \frac{10^3}{7}Hz-{\frac{10^3}{7\cdot 3.5}Hz/ms}\cdot {(t-t_0-3.5ms)} &t_0+3.5ms<t\le t_0+7ms \cr 
\end{cases}
\end{eqnarray}

Case (3) 
\begin{eqnarray}\Delta f_{rf}(t)=
\frac{10^3}{14}Hz \cdot (1-cos(\frac{2\pi}{7} rad/ms\cdot (t-t_0))) &t_0+0<t\le t_0+7ms\cr  
\end{eqnarray}

Case (4) 
\begin{eqnarray}\Delta f_{rf}(t)= \frac{20}{21}\cdot
\begin{cases}
30Hz/ms^2 \cdot (t-t_0)^2 &t_0+0<t\le t_0+1ms\cr  
30Hz + 60Hz/ms\cdot (t-t_0 -1ms) &t_0+1ms<t\le t_0+2.5ms\cr 
30Hz/ms^2 \cdot [5ms^2-(t-t_0-3.5ms)^2] &t_0+2.5ms<t\le t_0+4.5ms\cr  
30Hz + 60Hz/ms\cdot [6ms-(t-t_0)] &t_0+4.5ms<t\le t_0+6ms\cr  
30Hz/ms^2 \cdot [7ms^2-(t-t_0)]^2 &t_0+6ms<t\le t_0+7ms\cr  
\end{cases}
\end{eqnarray}

\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{4case.png}
   \caption{Examples of RF frequency modulation.}
   \label{4case}
\end{figure}
Fig.~\ref{1st_derivation} shows the time derivation of four rf frequency modulations, which are smaller than the maximum time derivative of rf frequency during the acceleration ramp 64Hz/ms for the adiabaticity consideration. The acceleration ramp is an adiabatical process.
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{1st_derivation.png}
   \caption{Time derivation of four modulations}
   \label{1st_derivation}
\end{figure}

Fig.~\ref{phase_shift_four_case} shows the corresponding phase shift modulation of four cases. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{phase_shift_four_case.png}
   \caption{The phase shift modulation of four cases}
   \label{phase_shift_four_case}
\end{figure}

\subsubsection{Longitudinal dynamic analysis for the simulation}
In this section, the average radial excursion, the relative momentum shift, synchronous phase, bucket size and adiabaticity of four rf frequency modulations are analyzed. 
\begin{itemize}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\item Average radial excursion

The average radial excursion is calculated for the four cases of rf frequency modulations by eq.~(\ref{eq:phaseR}). Fig.~\ref{radial} shows the calculation result ~\cite{bai12_first_2014}. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{Radial.png}
   \caption{Average radial excursions of four cases.}
   \label{radial}
\end{figure}

\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The maximum average radial excursion of four cases}
\label{radial excursion}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
      &Case (1) & Case (2)&Case (3)&Case (4) \\ \hline
       \tabincell{c}{Max avg radial \\excursion} & $2.93\cdot10^{-6}$ & $ 4.17\cdot10^{-6}$ &$4.18\cdot 10^{-6}$ &$4.38\cdot 10^{-6}$\\ \hline
			Time 											 & flat                & \SI{3.5}{\ms} & \SI{3.5}{\ms} & \SI{3.5}{\ms}\\ \hline
    \end{tabular}
\end{center}
\end{table}
Tab. \ref{radial excursion} shows the maximum average radial excursion and the time for four cases. The maximum tolerable radial excursion of SIS18 is $\pm 2.4\cdot10^{-4}$. For all cases, the average radial excursion is within the acceptable range. Hence, all cases are applicable. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\item Relative momentum shift

The relative momentum shift is calculated for the four cases of rf frequency modulations by eq.~(\ref{eq:phaseP}). Fig.~\ref{moment} shows the calculation result. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{moment.png}
   \caption{Relative momentum shift of four cases.}
   \label{moment}
\end{figure}
\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The maximum relative momentum shift of four cases}
\label{momentum excursion}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
      &Case (1) & Case (2)&Case (3)&Case (4) \\ \hline
       \tabincell{c}{Max relative \\momentum shift} & $9.83\cdot 10^{-5}$ & $1.38 \cdot10^{-4}$&$1.40\cdot 10^{-4}$ & $1.48\cdot 10^{-4}$\\ \hline
			Time 											 & flat                & \SI{3.5}{\ms} & \SI{3.5}{\ms} & \SI{3.5}{\ms}\\ \hline
    \end{tabular}
\end{center}
\end{table}
Tab. \ref{momentum excursion} shows the maximum relative momentum shift and the time for four cases. The maximum tolerable relative momentum shift of SIS18 is $\pm 0.008$. For all cases, the maximum relative momentum shift is within the acceptable range. Hence, all cases are applicable. 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\item Synchronous phase

The rf frequency modulations make the synchronous phase deviate from the nominal value $0^\circ$. Fig.~\ref{synch_phase} shows the changes in the synchronous phase, $\Delta \phi_s$(t). It is calculated by substituting values into eq.~\ref{eq:delta_phase}. For case (1), the phase jumps in $\Delta \phi_s$ appear at the start and end of the frequency modulation, and at two points where the slope of modulation changes from upward to flat and from flat to downward. For case (2), the phase jumps in $\Delta \phi_s(t)$ appear at the start and end of the frequency modulation, and at the midpoint where the slope of modulation changes from upward to downward. For case (3) and (4), the  synchronous phase $\Delta \phi_s(t)$ during the modulations are continuous. The phase jumps endanger the beam stability. Hence, only case (3) and (4) are applicable.
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{synch_phase.png}
   \caption{Changes in synchronous phase of four cases}
   \label{synch_phase}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5
\item Bucket size

The bucket area factor \gls{symb:bucket_size} varies during rf frequency modulations. Before the modulations, the synchronous phase $\phi_s$=$0^\circ$ and  $\alpha_b(0^\circ) = 1$. By substituting the changes in synchronous phase into eq.~(\ref{factor}), we get the ratio of bucket areas of a running bucket to the stationary bucket for four cases, see Fig.~(\ref{bucket_size}).
\begin{equation}
\alpha_b (\phi_s) \approx \frac{1-sin \phi_s}{1+sin \phi_s}\label{factor}
\end{equation}

\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{bucket_size.png}
   \caption{Ratio of bucket areas of a running bucket to the stationary bucket of four cases}
   \label{bucket_size}
\end{figure}
Tab. \ref{bucket size} shows the bucket area factor for four cases. For all cases, the running bucket area factor is larger than 85$\%$. Hence, all cases are applicable. 
\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The minimum bucket area factor of four cases}
\label{bucket size}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
      &Case (1) & Case (2)&Case (3)&Case (4) \\ \hline
       \tabincell{c}{Min bucket \\area factor} & 88$\%$ & 90$\%$ & 86$\%$ & 86$\%$\\ \hline
    \end{tabular}
\end{center}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5
\item Adiabaticity

By substituting the values of $d\Delta \phi_s(t)/dt$ obtained from Fig.~\ref{synch_phase} and the other appropriate values into eq.~\ref{eq:derivation}, we can calculate the adiabaticity parameter, $\varepsilon$, for the case (3) and (4), see Fig.~\ref{adiabaticity2}.  Because $d\Delta \phi_s(t)$ changes discontinuously for case (1) and (2), this abrupt change gives rise to a coherent bunch oscillation at a synchrotron frequency, resulting in emittance dilution. So the rf frequency modulations of case (1) and (2) are not applicable.

For case (4), the maximum of $\varepsilon$, 0.000059, occurs at 1ms, 2.5ms, 4.5ms and 6ms. From Fig.~\ref{synch_phase}, we could see the change of the synchronous phase $d\Delta \phi_s(t)/dt$ at these time points is big but smoothly. For case (3), the maximum of $\varepsilon$ is 0.000030. So the frequency modulation is adiabatical for case (3) and (4).


\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{adiabaticity2.png}
   \caption{Adiabaticity parameter estimation of case (3) and (4)}
   \label{adiabaticity2}
\end{figure}
\end{itemize}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Transverse dynamics analysis for the simulation}
For SIS18, the chromaticity \gls{symb:chromaticity_x} and \gls{symb:chromaticity_y} is 4.17 and 3.4. Substituting chromaticity and maximum momentum shift (see. Tab. \ref{momentum excursion}) into eq. ~\ref{eq:chromaticity}. The chromatic \gls{glos:tune} shift \gls{symb:c_chromaticity_x} and \gls{symb:c_chromaticity_y} during rf modulations for four cases can be calculated. 

Case (1) 
\begin{equation}
\Delta Q_x = 4.17 \cdot 9.83 \cdot 10^{-5}=4.10 \cdot 10^{-4}
\end{equation}
\begin{equation}
\Delta Q_y = 3.4 \cdot 9.83 \cdot 10^{-5}=3.34 \cdot 10^{-4} 
\end{equation}

Case (2)
\begin{equation}
\Delta Q_x = 4.17 \cdot 1.38 \cdot 10^{-4}=5.75 \cdot 10^{-4}
\end{equation}
\begin{equation}
\Delta Q_y = 3.4 \cdot 1.38 \cdot 10^{-4}=4.69 \cdot 10^{-4} 
\end{equation}

Case (3)
\begin{equation}
\Delta Q_x = 4.17 \cdot 1.40 \cdot 10^{-4}=5.84 \cdot 10^{-4}
\end{equation}
\begin{equation}
\Delta Q_y = 3.4 \cdot 1.40 \cdot 10^{-4}=4.76 \cdot 10^{-4} 
\end{equation}

Case (4) 
\begin{equation}
\Delta Q_x = 4.17 \cdot 1.48 \cdot 10^{-4}=6.17 \cdot 10^{-4}
\end{equation}
\begin{equation}
\Delta Q_y = 3.4 \cdot 1.48 \cdot 10^{-4}=5.03 \cdot 10^{-4} 
\end{equation}

The chromatic tune shift for four cases are significantly small, which could be negligible.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Frequency beating method}
In the case of the frequency beating method, we guarantee the extraction and injection energy always match, which means that the momentum is not affected by the frequency detune, namely $\Delta p = 0$, So the frequency beating method has no influence on the transverse dynamics.

\subsubsection{Longitudinal dynamics analysis of the frequency beating for SIS18}
For the frequency beating method, the rf frequency de-tune is done accompanying with
the RF ramp. Accepting to decenter the orbit by 8mm ~\cite{liebermann_fair_2013} for the SIS18 
\begin{equation}
\frac{\Delta{R}}{R} = \pm 2.4 \cdot 10^{-4}
%\gls{symb:radius} = \pm 2.4 \cdot 10^{-4}
\end{equation}
From eq. ~\ref{eq:eq4} and and eq. ~\ref{eq:eq5}, the RF frequency and the magnetic field change at the $U^{28+}$ extraction energy 200MeV/u  $\gamma_t$= 5.8) are
\begin{equation}
\frac{\Delta{f}}{f} = \pm 2.4 \cdot 10^{-4}
%\gls{symb:freq} = \pm 2.4 \cdot 10^{-4}
\end{equation}

\begin{equation}
\frac{\Delta{B}}{B}=\frac{\Delta{f}}{f}{\gamma_t}^2 = \pm 8.1 \cdot 10^{-3}
%\gls{symb:magnetic}=\frac{\Delta{f}}{f}{\gamma_t}^2 = \pm 8.1 \cdot 10^{-3}
\end{equation}

where the maximum RF frequency de-tune is approximate to 370 Hz at 1.57 MHz for the $U^{ 28+}$. Fig.~\ref{sis18_ramp} shows the rf frequency derivation during the rf ramp. In the simulation, it is assumed that the rf frequency is detuned at 0.2756s with $6.08 \cdot 10^{6}$Hz/s, see blue rectangle in Fig.~\ref{sis18_ramp}. For the sake of simplicity, 200 Hz is used as the rf frequency detune. SIS18 needs approximate 33us to reach 200 Hz with $6.08 \cdot 10^{6}$Hz/s.
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{sis18_ramp.png}
   \caption{RF frequency derivation of the $U^{28+}$ rf ramp}
   \label{sis18_ramp}
\end{figure}

%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=160mm]{detune_ramp.jpg}
%   \caption{$U^{28+}$ rf detune during the rf ramp}
%   \label{detune_ramp}
%\end{figure}

From eq.~\ref{eq:eq4} and eq.~\ref{eq:eq5}, we could get the corresponding radial excursion and the magnetic field change during the detune process. The maximum radial excursion is $-1.27 \cdot 10^{-4}$ at 33us of the rf detune process. The maximum magnetic field change is $4.3 \cdot 10^{-3}$ at 33us of the rf detune process.
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{GMT systematic investigation for the B2B transfer system}
The B2B transfer system makes use of certain aspects of the GMT system to realize the data collection, merging and redistribution. The main task of the data merging is the calculation of the synchronization window, within which the bunch could be injected into the correct bucket with the bunch to bucket center mismatch smaller than the upper bound. The data collection and redistribution make use of the WR network, so the measurement of the WR network latency is necessary. 

\subsection{Calculation of the synchronization window}
According to the phase difference between two synchrotrons, the fine time for the alignment of two Reference RF Signals for both the phase shift and frequency beating methods can be calculated. This time is called ``\gls{glos:best_align}`` and denoted by $t_{best}$, see Fig. ~\ref{alignment}. Because of the \gls{glos:uncertainty} ~\cite{taylor_introduction_1982} of the phase advance prediction and rf frequency modulation, the fine alignment lies between \gls{symb:best_align} - $\delta t_{best}$ and $t_{best}$ + $\delta t_{best}$, where \gls{symb:probable_aligh} is the uncertainty of the alignment. [$t_{best}$ - $\delta t_{best}$, $t_{best}$ + $\delta t_{best}$] is called ``\gls{glos:pro_align}``. In Sec. 6.2.1.1 and Sec. 6.2.1.2, the calculation of the best estimation of alignment and the probable range of alignment for the phase shift and frequency beating method will be explained. The probable range of alignment is within the synchronization window. For the correct selection of the same revolution frequency marker at different SCUs, the start of the synchronization  window must be properly calculated. In Sec. 6.2.1.3, the calculation of the synchronization window will be explained. 
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{alignment.jpg}
   \caption{The illustration of the best estimate of alignment, the probable range of alignment and the synchronization window}
   \label{alignment}
\end{figure}

%In fact, two SIS100 revolution periods is enough for the correct bucket selection, achieving much preciser injection. The beginning of the synchronization window denotes by $WIN_{start}$. The synchronization window is within the range [$WIN_{start}$ , $WIN_{start}$  + 2 $\cdot T_{rev}^{SIS100}$]. $T_{rev}^{SIS100}$is the revolution period of SIS100, which equals to 6.359 us for U$^{28+}$ at 200Mev/u.  

For both the phase shift and frequency beating method, the calculation is based on the predicted phase of the rf signal locally. For example of the $U^{28+}$ B2B transfer from SIS18 to SIS100, the PAP module extrapolates the rf phase \gls{symb:h1phase100} for SIS100 rf \gls{symb:harmonic}=1 (157kHz) signal and \gls{symb:h15phase18} for SIS18 rf h=1/5 (157kHz) signal at \gls{symb:prediction_time} ~\cite{ferrand_system_2015}. The more time is spent for the phase advance prediction, the better the predicted phase will be. Fig.~\ref{Calculation_symble} illustrates some basic definition of symbols for the calculation. 
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{Calculation_symble.jpg}
   \caption{The illustration of symbols for the calculation}
   \label{Calculation_symble}
\end{figure}
$\phi_{h=2}^{SIS18}$and $\phi_{h=10}^{SIS100}$ are individual rf phase of SIS18 and SIS100 Reference RF Signals at $t_{\psi}$. The relationship between \gls{symb:h2phase18}, \gls{symb:h10phase100} and $\psi_{h=1/5}^{SIS18}$, $\psi_{h=1}^{SIS100}$ are given by eq.~\ref{SIS18_phase} and eq.~\ref{SIS100_phase}. 

\begin{equation}
\phi_{h=2}^{SIS18} =  \frac {\frac{\psi_{h=1/5}^{SIS18}}{360^\circ}\cdot {T_{h=1/5}^{SIS18}} \mod {T_{h=2}^{SIS18}}}{T_{h=2}^{SIS18}}\cdot {360^\circ} \label{SIS18_phase}
\end{equation}
\begin{equation}
\phi_{h=10}^{SIS100} =  \frac {\frac{\psi_{h=1}^{SIS100}}{360^\circ}\cdot {T_{h=1}^{SIS100}} \mod {T_{h=10}^{SIS100}}}{T_{h=10}^{SIS100}}\cdot {360^\circ} \label{SIS100_phase}
\end{equation}
substituting $T_{h=2}^{SIS18}\cdot 10=T_{h=1/5}^{SIS18}$, $T_{h=10}^{SIS100}\cdot 10=T_{h=1}^{SIS100}$ into eq.\ref{SIS18_phase} and eq.\ref{SIS100_phase} yields
 \begin{equation}
\phi_{h=2}^{SIS18} =  \frac {\frac{\psi_{h=1/5}^{SIS18}\cdot 10}{360^\circ}\cdot {T_{h=2}^{SIS18}} \mod {T_{h=2}^{SIS18}}}{T_{h=2}^{SIS18}}\cdot {360^\circ} \label{SIS18_phase1}
\end{equation}
\begin{equation}
\phi_{h=10}^{SIS100} =  \frac {\frac{\psi_{h=1}^{SIS100}\cdot 10}{360^\circ}\cdot {T_{h=10}^{SIS100}} \mod {T_{h=10}^{SIS100}}}{T_{h=10}^{SIS100}}\cdot {360^\circ} \label{SIS100_phase1}
\end{equation}

Here we explain the inevitable uncertainty of the phase advance prediction and rf frequency modulation. 
\begin{itemize}
\item Uncertainty of the predicted phase advance

If the phase prediction time is 500us, the uncertainty of the predicted phase advance \gls{symb:uncertainty_time} is 100ps ~\cite{ferrand_development_????}. We calculate the uncertainty of the predicted phase advance, \gls{symb:un_h1phase100} and \gls{symb:un_h15phase18}, from the time to phase domain. 
\begin{equation} 
\delta t_\psi= 100ps
\label{jitter_measure_t}
\end{equation}
\begin{equation} 
\delta \psi_{h=1/5}^{SIS18}=\delta\psi_{h=1}^{SIS100}=
\frac {100ps}{1/157kHz} \cdot {360^{\circ}}\approx 0.006^\circ
\label{jitter_measure_p}
\end{equation}
 
Based on the eq.~\ref{jitter_measure_p}, eq.~\ref{SIS18_phase1} and eq.~\ref{SIS100_phase1}, the uncertainty of the phase at the Reference RF Signal of SIS18 and SIS100,
\gls{symb:un_h10phase100} and \gls{symb:un_h2phase18}, is calculated. 

\begin{equation}
\begin{aligned}
\delta \phi_{h=2}^{SIS18} = \sqrt {(\frac{\partial \phi_{h=2}^{SIS18}}{\partial \psi_{h=2}^{SIS18}} \delta \psi_{h=2}^{SIS18})^2}=\sqrt {(10 \cdot \delta \psi_{h=2}^{SIS18})^2}=0.06^\circ
\label{phi_jitter1}
\end{aligned}
\end{equation}
\begin{equation}
\delta \phi_{h=10}^{SIS100} = \sqrt {(\frac{\partial \phi_{h=10}^{SIS100}}{\partial \psi_{h=1}^{SIS100}} \delta \psi_{h=10}^{SIS100})^2}=\sqrt {(10 \cdot \delta \psi_{h=10}^{SIS100})^2}=0.06^\circ
\label{phi_jitter2}
\end{equation}

\item Uncertainty of the rf frequency modulation

For the rf frequency modulation, the uncertainty is $0.2^\circ$ at 5.4MHz ~\cite{laier_funktional-spezifikation_2011}. We calculate the uncertainty in time domain, see eq.~\ref{freq_jitter_t}.
\begin{equation}
\delta \Delta f_{(t)} = \frac{0.2^\circ}{360^\circ} \cdot {\frac{1}{5.4MHz}}=100ps
\label{freq_jitter_t}
\end{equation}
%
%The precision of the rf frequency is 0.05Hz. 
%\begin{equation}
%\delta \Delta f = 0.05Hz
%\label{freq_jitter_f}
%\end{equation}



\end{itemize}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{The best estimate of alignment and the probable range of alignment for the phase shift method}
Different relation between $\phi_{h=2}^{SIS18}$ and $\phi_{h=10}^{SIS100}$ requires different phase adjustment for SIS18. Fig.~\ref{phase_shift} illustrates all scenarios of their relation and the required phase adjustment for each scenario. We would like to introduce a phase shift of up to $\pm 180^\circ$. The blue and red line represents the phase of SIS100 and SIS18 Reference RF Signal. The clockwise arrow from the SIS18 to SIS100 rf phase represents the negative phase adjustment for SIS18 and the anticlockwise represents the positive phase adjustment. The required phase adjustment of SIS18 is denoted by $\Delta \phi_{shift}$.


\begin{itemize}
    \item Scenario (a): $\phi_{h=10}^{SIS100}\in [0,90^\circ)$, see Fig.~\ref{frequency_beating} (a).

	\begin{itemize}
		\item $\phi_{h=10}^{SIS100}< \phi_{h=2}^{SIS18}< \phi_{h=10}^{SIS100} +180^\circ$, which denotes by the yellow semicircle in Fig.~\ref{frequency_beating} (a). The phase adjustment is
    \begin{equation}
			\Delta \phi_{shift}=-(\phi_{h=2}^{SIS18} - \phi_{h=10}^{SIS100})
    \end{equation}
    		\item $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100}$ or  $\phi_{h=2}^{SIS18} >\phi_{h=10}^{SIS100} +180^\circ$, which denotes by the white semicircle in Fig.~\ref{frequency_beating} (a). The phase adjustment is
    \begin{equation}
			\Delta \phi_{shift}= 360^\circ - \phi_{h=2}^{SIS18} + \phi_{h=10}^{SIS100}
    \end{equation}
	\end{itemize}
\begin{figure}[H]
   \centering   
   \includegraphics*[width=130mm]{phase_shift_synch_window_cal.jpg}
   \caption{Scenarios for the phase shift method}
   \label{phase_shift}
\end{figure}
    \item Scenario (b): $\phi_{h=10}^{SIS100}\in [90,180^\circ)$, see Fig.~\ref{frequency_beating} (b). 

	\begin{itemize}
		\item $\phi_{h=10}^{SIS100}< \phi_{h=2}^{SIS18}< \phi_{h=10}^{SIS100} +180^\circ$, which denotes by the yellow semicircle in Fig.~\ref{frequency_beating} (b). The phase adjustment is
	    \begin{equation}		
\Delta \phi_{shift}=-(\phi_{h=2}^{SIS18} - \phi_{h=10}^{SIS100})
    \end{equation}
    		\item $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100}$ or  $\phi_{h=2}^{SIS18} >\phi_{h=10}^{SIS100} +180^\circ$, which denotes by the white semicircle in Fig.~\ref{frequency_beating} (b).  The phase adjustment is
    \begin{equation}			
\Delta \phi_{shift}=360^\circ - \phi_{h=2}^{SIS18} + \phi_{h=10}^{SIS100}
    \end{equation}
	\end{itemize}
    \item Scenario (c): $\phi_{h=10}^{SIS100}\in [180,270^\circ)$, see Fig.~\ref{frequency_beating} (c). The phase adjustment is

	\begin{itemize}
		\item $\phi_{h=2}^{SIS18} > \phi_{h=10}^{SIS100}$ or  $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100} +180^\circ - 360^\circ $, which denotes by the yellow semicircle in Fig.~\ref{frequency_beating} (c). The phase adjustment is
    \begin{equation}			
\Delta \phi_{shift}=-(360^\circ - \phi_{h=10}^{SIS100}+ \phi_{h=2}^{SIS18})
    \end{equation}
    		\item $\phi_{h=10}^{SIS100}-180^\circ < \phi_{h=2}^{SIS18}< \phi_{h=10}^{SIS100}$, which denotes by the white semicircle in Fig.~\ref{frequency_beating} (c). The phase adjustment is
    \begin{equation}			
\Delta \phi_{shift}=\phi_{h=10}^{SIS100}-\phi_{h=2}^{SIS18}
    \end{equation}
	\end{itemize}
    \item Scenario (d): $\phi_{h=10}^{SIS100}\in [270,360^\circ)$, see Fig.~\ref{frequency_beating} (d).

	\begin{itemize}
		\item $\phi_{h=10}^{SIS100}-180^\circ < \phi_{h=2}^{SIS18}< \phi_{h=10}^{SIS100}$, which denotes by the yellow semicircle in Fig.~\ref{frequency_beating} (d). The phase adjustment is 
	    \begin{equation}	
\Delta \phi_{shift}=\phi_{h=10}^{SIS100}-\phi_{h=2}^{SIS18}	
    \end{equation}
    		\item $\phi_{h=2}^{SIS18} > \phi_{h=10}^{SIS100}$ or  $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100} +180^\circ - 360^\circ $ , which denotes by the white semicircle in Fig.~\ref{frequency_beating} (d). 
    \begin{equation}			
\Delta \phi_{shift}=-(360^\circ - \phi_{h=10}^{SIS100}+ \phi_{h=2}^{SIS18})
    \end{equation}
	\end{itemize}
\end{itemize}

The phase adjustment is achieved by the phase shift method within the upper bound time, \gls{symb:upper_Ttime}. For the $U^{28+}$ B2B transfer from SIS18 to SIS100, we assume that $T_{phase\_ shift}^{upper\_ bound}$ equals to 7ms, which means that the phase shift $\Delta \phi_{shift}$ is achieved within 7ms. So the best estimate of alignment is expressed by 

\begin{equation}
t_{best} = t_{\psi} + T_{phase\_ shift}^{upper\_ bound} \label{Phase_win}
\end{equation}
The uncertainty in the phase prediction $\delta t_{\psi}$ is 100ps, see eq.~\ref{jitter_measure_t}. The phase shift uncertainty $\delta \Delta \phi_{phase}$ is casued by the rf frequency modulation, whose jitter is 100ps, see eq.~\ref{freq_jitter_t}. The phase shift uncertainty equals to the uncertainty in the phase shift upper bound time, \gls{symb:un_upper_time_phase_shift} = 100ps. Both cause an uncertainty in the best estimate of alignment $t_{best}$.
\begin{equation}
\begin{aligned}
\delta t_{best} =\sqrt {(\frac {\partial t_{best}}{\partial t_{\psi}}\delta t_{\psi})^2 + (\frac {\partial t_{best}}{\partial T_{phase\_ shift}^{upper\_ bound}}\delta T_{phase\_ shift}^{upper\_ bound})^2} \\
 =\sqrt {(\delta t_{\psi})^2+(T_{phase\_ shift}^{upper\_ bound})^2} =\sqrt { 100ps^2+100ps^2}\approx 140ps \label{Phase_uncertainty}
\end{aligned}
\end{equation}

The uncertainty of the alignment for the phase shift method is about 140ps. So the proper range of alignment is [$t_{best}$-140ps, $t_{best}$+140ps] for $U^{28+}$ B2B transfer from SIS18 to SIS100.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{The best estimate of alignment and the probable range of alignment for the frequency beating method}
Fig.~\ref{frequency_beating} illustrates two scenarios for the frequency beating method. With the frequency beating method, SIS18 can only achieve positive phase adjustment, which is denoted by \gls{symb:phase_just_frequency_beating}. E.q.~\ref{sync_time} shows the best estimate of alignment for the phase adjustment of $\Delta \phi_{adjustment}$.
\begin{equation}
	 t_{best} = t_{\psi}+\frac {\Delta \phi_{adjustment}}{{360^\circ} \cdot {\Delta f}} \label {sync_time}
   \end{equation}
where \gls{symb:beating_freq} is the beating frequency.
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=90mm]{frequency_beating_synch_window_cal.jpg}
   \caption{Two scenarios for the frequency beating method}
   \label{frequency_beating}
\end{figure}

According to the relation between $\phi_{h=2}^{SIS18}$ and $\phi_{h=10}^{SIS100}$, there are two scenarios, see Fig.~\ref{frequency_beating}.
\begin{itemize}
    \item Scenario (a): $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100}$
	\begin{equation}
	 \Delta \phi_{adjustment} = \phi_{h=10}^{SIS100} - \phi_{h=2}^{SIS18}\label {great}
   \end{equation}
   Replacing $\Delta \phi_{adjustment}$ in eq.~\ref{sync_time} with eq.~\ref{great}, we have
	\begin{equation}
	 t_{best} =t_{\psi} +\frac {\phi_{h=10}^{SIS100} - \phi_{h=2}^{SIS18}}{{360^\circ} \cdot {\Delta f}} \label {beating_win_1}
   \end{equation}
     \item  Scenario (b): $\phi_{h=2}^{SIS18} \ge \phi_{h=10}^{SIS100}$
	\begin{equation}
	 \Delta \phi_{adjustment} = 360^\circ - (\phi_{h=2}^{SIS18}-\phi_{h=10}^{SIS100}) \label {less}
   \end{equation}
  Replacing $\Delta \phi_{adjustment}$ in eq.~\ref{sync_time} with eq.~\ref{less}, we have

	\begin{equation}
	 t_{best} =t_{\psi} +\frac {360^\circ - (\phi_{h=2}^{SIS18}-\phi_{h=10}^{SIS100})}{{360^\circ} \cdot {\Delta f}} \label {beating_win_2}
   \end{equation}
\end{itemize}
Based on these two scenarios, we could deduce the formula for the best estimate of alignment. 
	\begin{equation}
	 t_{best} =t_{\psi} +\frac {{\Delta n} \cdot {360^\circ} - (\phi_{h=2}^{SIS18}-\phi_{h=10}^{SIS100})}{{360^\circ} \cdot {\Delta f}} \label {beating_win_2}
   \end{equation}
where $\bigtriangleup{n}$ equals 0 when  $\phi_{h=2}^{SIS18} < \phi_{h=10}^{SIS100}$ and equals 1 when  $\phi_{h=2}^{SIS18} \ge \phi_{h=10}^{SIS100}$.

The uncertainty of the alignment is the result of the \gls{glos:error_pro} of uncertainties of the phase prediction and rf frequency detune, see eq.~\ref{beating_uncertainty}. Because the rf frequency detune has the long term stability, $\int\delta \Delta f$=0, the uncertainty caused by rf frequency detune is 0. The uncertainty of the phase prediction $\phi_{h=2}^{SIS18}$ and $\phi_{h=10}^{SIS100}$ is $0.06^\circ$, see eq.~\ref{phi_jitter1} and eq.~\ref{phi_jitter2}. $\Delta$f is 200Hz. The maximum ${\Delta n} \cdot {2\pi} - (\phi_{h=2}^{SIS18}-\phi_{h=10}^{SIS100})$ is $2\pi$.
\begin{equation}
\begin{aligned}
\delta t_{best} =\sqrt {(\frac {\partial t_{best}}{\partial \phi_{h=2}^{SIS18}}\delta \phi_{h=2}^{SIS18})^2 + (\frac {\partial t_{best}}{\partial \phi_{h=10}^{SIS100}}\delta \phi_{h=10}^{SIS100})^2+(\frac {\partial t_{best}}{\partial \Delta f}\delta \Delta f)^2} \\
 =\sqrt {(\frac{-1}{{2\pi} \cdot {\Delta f}}\delta \phi_{h=2}^{SIS18})^2+(\frac{1}{{2\pi} \cdot {\Delta f}}\delta \phi_{h=10}^{SIS100})^2+(-\frac{{\Delta n} \cdot {2\pi} - (\phi_{h=2}^{SIS18}-\phi_{h=10}^{SIS100})}{{2\pi} \cdot {\Delta f}^2}\delta \Delta f)^2} \\
\le \sqrt {(\frac{-1}{{2\pi} \cdot {200}}0.06^\circ)^2+(\frac{1}{{2\pi} \cdot {200}}0.06^\circ)^2+0}\\
\approx 1.178us \label{beating_uncertainty}
\end{aligned}
\end{equation}
From eq.~\ref{beating_uncertainty} we could get the uncertainty of the alignment is 1.178us, so the probable range of alignment is [$t_{best} – 1.178us, t_{best}+ 1.178us$].
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Calculation the synchronization window and its accuracy}
In the last section, we get the probable range of alignment, within which the two Reference Rf Signals could be aligned with each other. The synchronization window is used to select the revolution frequency marker for the extraction and injection kicker firing, which is closest to the probable range of alignment, See Fig.~\ref{accuracy_syn_win}. For the selection, the length of the synchronization window must be a least one SIS100 revolution period. The best estimate of the start of the synchronization window is exactly half revolution period before the selected revolution frequency marker. The blue and orange rectangles represent two scenarios of the probable range of alignment. In Fig.~\ref{accuracy_syn_win}, the 2nd revolution frequency marker is the closest one to the probable range of alignment. The best estimate of the start of the synchronization window aligns with the negative zero crossing point of the revolution marker signal.

\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{accuracy_syn_win.jpg}
   \caption{The illustration of the synchronization window and its accuracy}
   \label{accuracy_syn_win}
\end{figure}

For SIS100, the rf phase of the revolution frequency is $\psi_{h=1}^{SIS100}$ at $t_{\psi}$. We could calculate the rf phase \gls{symb:phase_s_alignment} of the revolution frequency at the start of the probable rang of alignment, $t_{best}$-$\delta t_{best}$.
\begin{equation}
\begin{aligned}
\psi_{s\_alignment}=\frac{(t_{best}-\delta t_{best}-t_{\psi}- \frac{360^\circ-\psi_{h=1}^{SIS100}}{360^\circ} \cdot {T_{h=1}^{SIS100}}) \mod T_{h=1}^{SIS100}}{T_{h=1}^{SIS100}}\cdot {360^\circ} 
\label{phase_after_syn}
\end{aligned}
\end{equation}

For the calculation of the best estimate of the start of the synchronization window, there are two scenarios. \gls{symb:win_correction} is the time correction for the start of the probable range of alignment to the best estimate of the start of the synchronization  window, see Fig.~\ref{accuracy_syn_win}.
\begin{itemize}
\item $\psi_{s\_alignment}\in [0^\circ,180^\circ)$, the orange rectangle in Fig.~\ref{accuracy_syn_win}
\begin{equation}
\begin{aligned}
\Delta t_{win \_correct}=\frac{\psi_{s\_alignment}}{360^\circ}\cdot T_{h=1}^{SIS100}+\frac{T_{h=1}^{SIS100}}{2}
\end{aligned}
\end{equation}
\begin{equation}
\begin{aligned}
WIN_{start}= t_{best}- \delta t_{best}-\Delta t_{win \_correct}
\end{aligned}
\end{equation}


\item $\psi_{s\_alignment}\in [180^\circ,360^\circ)$, the blue rectangle in Fig.~\ref{accuracy_syn_win}

\begin{equation}
\begin{aligned}
\Delta t_{win \_correct}=\frac{\psi_{s\_alignment}-180^\circ}{360^\circ}\cdot T_{h=1}^{SIS100}
\end{aligned}
\end{equation}
\begin{equation}
\begin{aligned}
WIN_{start}= t_{best}- \delta t_{best}-\Delta t_{win \_correct}
\end{aligned}
\end{equation}

\end{itemize}

The actual start of the synchronization window is impossible to be exactly at the best estimate of the start of the synchronization window because of the precision and trueness~\cite{_statistical_????}. The \gls{glos:precision} is defined as the closeness of agreement between the actual start of the synchronization window of different SCUs and the \gls{glos:trueness} as the closeness of agreement between the average actual start of the synchronization window of different SCUs and the best estimation start of the synchronization window. The precision comes from the random error, e.g. IO port \gls{TTL} signal rising oscillation. The trueness is the systematic error, e.g. FPGA process time. The \gls{glos:accuracy} is defined as the closeness of agreement between the observed start and the best estimate of the start of the synchronization window, which is the sum of the precision and trueness. The B2B transfer system will be used for many transfers for FAIR. Therefore, we have to find the most stringent accuracy requirement. The shortest revolution period of the target machine is \SI{433}{\ns}, which comes from RIB transfer from CR to HESR. We keep 10ns as a forbidden range, which means that the actual start is not allowed \SI{10}{\ns} before and after the revolution frequency marker. The green region in Fig.~\ref{accuracy_syn_win} represents the safety margin for the start of the synchronization window. So the accuracy of the start of the synchronization window must meet the requirement calculated by eq. ~\ref{accu}.
\begin{equation}
\begin{aligned}
Accuracy=\pm\frac{433-10 \cdot 2}{2}\approx \pm \SI{200}{\ns}\label{accu}
\end{aligned}
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Characterization of the WR network for the B2B transfer}
Within this dissertation, a network analyzed by Xena is used to characterize the properties of the WR network, which are relevant to B2B transfer. The WR network measurement is achieved by the Xena traffic generator\footnote{\url{http://xenanetworks.com/layer-2-3-platform/}}, which offers a new class of professional Layer 2-3 Gigabit Ethernet test platform. It is used to measure the \gls{glos:frame_loss_rate}\footnote{The ratio of the number of the lost frames to the number of the theoretic received frames of a tested port.}, \gls{glos:latency}\footnote{The time interval between the time of Xena port receiving frame and the time of another Xena port sending frame.} and \gls{glos:jitter}\footnote{The absolute value of the difference between the latency of two consecutive received frames belonging to the same stream from one Xena port to another Xena port. \newline\url{http://www.xenanetworks.com/wp-content/uploads/Measuring_Frame_latency_Variation.pdf}} for the WR network. For the measurement, Xena traffic generator sends the traffic streams with a unique stream ID for identifying latency, jitter and packet loss. For the measurements, the following types of traffic are considered ~\cite{prados_testing_2016}.

\begin{itemize}
    \item DM Broadcast 

DM forwards broadcast timing frames\footnote{\url{https://www-acc.gsi.de/wiki/Timing/TimingSystemEvent}} with 110 bytes ethernet frame length downwards to all FECs. The average bandwidth for the DM broadcast is \SI{100}{Mbit/s}. The burst\footnote{A group of consecutive frames with shorter interframe gaps than frames arriving before or after the burst of frames.} speed is 12 packets per \SI{100}{\micro\second}.
 		\item DM Unicast 

DM sends 10Mbit/s unicast timing frames with 110 bytes ethernet frame length to some specified FECs at the burst speed of 3 packets per \SI{300}{\micro\second}.
	\item B2B Unicast

The source B2B SCU sends the \gls{glos:timing_frame} with 110 bytes ethernet frame length upwards to the DM. For the B2B transfer upper bound time \SI{10}{\ms} of each supercycle, 2 unicast timing frames are send to the DM. The maximum repetition frequency is of the $U^{28+}$ supercycle, \SI{2.82}{\Hz}. For the estimation of the upper bound bandwidth, we use 3Hz/s as the maximum repetition frequency.  So the bandwidth is \SI{3}{\Hz/\second} $\cdot$ \SI{2}{packets/supercycle} $\cdot$ \SI{110}{byte} $\cdot$ \SI{8}{bit} $\approx$ \SI{5.5}{kbit/s}. 
	\item B2B Broadcast

Maximum 10 B2B broadcast timing frames with 110 ethernet frame length are sent within \SI{10}{\ms}. So the bandwidth is \SI{3}{\Hz/\second} $\cdot$ \SI{10}{packets/supercycle} $\cdot$ \SI{110}{byte} $\cdot$ \SI{8}{bit} $\approx$ \SI{26.5}{kbit/s}.

	\item Management Traffic

The average bandwidth for the management traffic is \SI{10}{Mbit/s}. It broadcasts packets with random ethernet frame length from 64 bytes to 1518 bytes. 
\end{itemize}

The requirements for the B2B Broadcast and Unicast traffic are summarized in Tab.~\ref{requirement} ~\cite{prados_testing_2016}.
\begin{table}[!htb]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The B2B transfer requirements for the WR network}
\label{requirement_network}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
     \tabincell{c}{} & \tabincell{c}{Frame \\ Loss Rate} & \tabincell{c}{Upper bound latency \\ of WR network} &\tabincell{c}{ Upper bound latency\\ per WR switch layer} \\ \hline
       \tabincell{c}{B2B \\ Broadcast} & $10^{-12}$ & \SI{500}{\us} & \SI{30}{\us} \\ \hline
		\tabincell{c}{B2B \\ Unicast} & $10^{-12}$ & \SI{500}{\us} & \SI{30}{\us}\\ \hline
    \end{tabular}
\end{center}
\end{table}

For the WR network for FAIR, three VLANs with different priorities are applied according to the importance of the traffic. 

\subsubsection{WR network test setup}

\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{GSI_use_case.png}
   \caption{The WR network test setup}
   \label{GSI_use_case.jpg}
\end{figure}
Based on the mentioned traffic, the measurement setup is built, see Fig.~\ref{GSI_use_case.jpg} ~\cite{prados_testing_2016}. Four WR switches are connected to the port 1 to 18 of the Xena traffic generator. All ports of four WR switches are assigned to three VLANs, VLAN 5, VLAN 6 and VLAN 7. Tab. ~\ref{test_setup_network} shows the bandwidth, VLAN, VLAN priority and usage of the traffic of each Xena port in details. The test is running for 14 hours.
\renewcommand{\multirowsetup}{\centering} 
\begin{table}[!htb]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The connection between the traffic generator and WR switches}
\label{test_setup_network}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
	  \rowcolor[gray]{0.5}
     \tabincell{c}{Switch} & \tabincell{c}{Xena \\ Port} & \tabincell{c}{Traffic} &\tabincell{c}{ VLAN} &\tabincell{c}{Priority} &\tabincell{c}{Usage}\\ \hline
       \multirow{6}*{{\tabincell{c}{WR switch \\ 1}}}& Port 1 & \SI{100}{Mbit/s} 110bytes & 7 & 7 & DM Broadcast \\ \cline{2-6}
		 &Port 2 & Rx traffic &  &  &  \\ \cline{2-6}
		 &Port 3 &\SI{10}{Mbit/s} 110bytes & 7 & 7 & DM Unicast \\ \cline{2-6}
   		 &Port 4 & Rx traffic &  &  &  \\ \cline{2-6}
		 &Port 5 & Rx traffic &  &  &  \\ \cline{2-6}
		 &Port 6 & \SI{1}{Mbit/s} 64 - 1518 bytes & 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \hline
    \multirow{4}*{{\tabincell{c}{WR switch \\ 2}}}& Port 7 & \SI{2}{Mbit/s} 64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \cline{2-6}
	& Port 8 & Rx traffic &  &  & \\ \cline{2-6}
	& Port 9 & Rx traffic &  &  & \\ \cline{2-6}
   & Port 10 & \SI{1}{Mbit/s} 64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \hline
	\multirow{4}*{{\tabincell{c}{WR switch \\ 3}}}& Port 11 & Rx traffic &  &  & \\ \cline{2-6}
	& Port 12 & Rx traffic &  &  & \\ \cline{2-6}
   & Port 13 & \SI{2}{Mbit/s} 64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \cline{2-6}
	& Port 14 & \SI{1}{Mbit/s} 64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \hline
	\multirow{4}*{{\tabincell{c}{WR switch \\ 4}}}& Port 15 & \SI{1}{Mbit/s} 64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \cline{2-6}
   & Port 16 & \SI{26.5}{kbit/s} 110bytes & 6 & 6 & B2B Broadcast \\ \cline{2-6}
	& Port 17 & \SI{5.5}{kbit/s} 110bytes & 7 & 7 & B2B Unicast \\ \cline{2-6}
	& Port 18 & \SI{2}{Mbit/s} 64 - 1518 bytes& 5 & 5 &  \tabincell{c}{Management \\ Broadcast} \\ \hline
    
    \end{tabular}
\end{center}
\end{table}

\subsubsection{Frame loss rate test result for B2B frames}

The frame loss rate of the stream from port 17 to port 1 is measured for the B2B Unicast frames. The frame loss rate of the stream from port 16 to other ports is measured for the B2B Broadcast frame. Fig. ~\ref{packet_loss}~\cite{prados_testing_2016} shows the test result for both traffics. For the B2B Broadcast frames, the frame loss rate of each port is \SI{0}{\percent}. For the B2B Unicast frames, the frame loss rate of port 1 is \SI{0}{\percent}. So there is no B2B frame loss of the test WR network. 

\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{packet_loss.png}
   \caption{The frame loss rate for B2B Broadcast and B2B Unicast frames}
   \label{packet_loss}
\end{figure}



\subsubsection{Latency and jitter test result for B2B frames}

The latency and jitter of the stream from port 16 to other ports are measured.

\begin{itemize}
    \item Latency and jitter for B2B Broadcast frames
		\begin{itemize}
    		\item[-] Average Latency and jitter

Fig. ~\ref{average_latency_jitter}~\cite{prados_testing_2016} shows the test result for the average latency and jitter for the B2B Broadcast frames. Tab. \ref{avg latency jitter} shows the average latency and jitter of different WR switch layers. They meet the requirements of the B2B transfer. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{average_latency_jitter.png}
   \caption{The average latency and jitter for B2B Broadcast frames}
   \label{average_latency_jitter}
\end{figure}
\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The average latency and jitter of the B2B Broadcast frames}
\label{avg latency jitter}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
     & \tabincell{c}{WR switch\\4}  & \tabincell{c}{WR switch\\4, 3} &\tabincell{c}{WR switch\\4, 3, 2} &\tabincell{c}{WR switch\\4, 3, 2, 1} \\ \hline
       \tabincell{c}{Avg \\ latency} & \SI{6}{\us} & \SI{8}{\us} & \SI{11}{\us} & \SI{14}{\us}\\ \hline
		\tabincell{c}{Avg \\ jitter} & \SI{0}{\ns} & \SI{0}{\ns} & \SI{0}{\ns} & \SI{0}{\ns}\\ \hline
    \end{tabular}
\end{center}
\end{table}


			\item[-] Maximum Latency and jitter

Fig. ~\ref{Max_latency_jitter}~\cite{prados_testing_2016} shows the test result for the maximum latency and jitter for the B2B Broadcast frames. Tab. \ref{max latency jitter} shows the maximum latency and jitter of different WR switch layers. They meet the requirements of the B2B transfer.

\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{Max_latency_jitter.png}
   \caption{The maximum latency and jitter for B2B Broadcast frames}
   \label{Max_latency_jitter}
\end{figure}
\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The maximum latency and jitter of the B2B Broadcast frames}
\label{max latency jitter}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
     & \tabincell{c}{WR switch\\4}  & \tabincell{c}{WR switch\\4, 3} &\tabincell{c}{WR switch\\4, 3, 2} &\tabincell{c}{WR switch\\4, 3, 2, 1} \\ \hline
       \tabincell{c}{Max \\ latency} & \SI{28}{\us} & \SI{34}{\us} & \SI{37}{\us} & \SI{41}{\us}\\ \hline
		\tabincell{c}{Max \\ jitter} & \SI{25}{\us} & \SI{25}{\us} & \SI{27}{\us} & \SI{30}{\us}\\ \hline
    \end{tabular}
\end{center}
\end{table}

		\end{itemize}
    \item Latency and jitter for B2B Unicast frames

For the B2B unicast frames, the latency and jitter of the stream from port 16 to port 1 are measured. 

		\begin{itemize}
    		\item[-] Average Latency and jitter

For the B2B Unicast frames, 4 WR switch network has approximate \SI{11}{\us} average latency and \SI{0}{\us} average jitter. 

\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{Avg_latency_jitter_unicast.png}
   \caption{The average latency and jitter for B2B Unicast frames}
   \label{Avg_latency_jitter_unicast}
\end{figure}

			\item[-] Maximum Latency and jitter

For the B2B unicast frames, 4 WR switch network has approximate \SI{23}{\us} maximum latency and \SI{13}{\us} maximum jitter.

\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{Max_latency_jitter_unicast.png}
   \caption{The maximum latency and jitter for B2B Unicast frames}
   \label{Max_latency_jitter_unicast}
\end{figure}

		\end{itemize}
\end{itemize}

More test configuration and results, please see ``Testing the WR Network of the FAIR General Machine Timing System``.

\subsubsection{Result and conclusion}

Tab. ~\ref{result} shows the result of the test. The frame loss rate and latency meet the requirements of the B2B Broadcast and B2B Unicast traffic. 

\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The result of the WR network test for the B2B transfer}
\label{result}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | }
    \hline
     \tabincell{c}{} & \tabincell{c}{Frame \\ Loss Rate} & \tabincell{c}{Average \\Latency }&\tabincell{c}{Maximum \\Latency}& \tabincell{c}{Average \\Jitter}&\tabincell{c}{Maximum \\Jitter } \\ \hline
       \tabincell{c}{B2B \\ Broadcast} &  \SI{0}{\percent} & \SI{6}{\us}/switch & \SI{28}{\us}/switch &  \SI{0}{\us}/switch & \SI{25}{\us}/switch\\ \hline
		\tabincell{c}{B2B \\ Unicast} 	 & \SI{0}{\percent} & \tabincell{c}{\SI{11}{\us}/4switch \\ \SI{3}{\us}/switch}& \tabincell{c}{\SI{23}{\us}/4switch\\\SI{6}{\us}/switch}&  \tabincell{c}{\SI{0}{\us}/4switch\\\SI{0}{\us}/switch} & \tabincell{c}{\SI{13}{\us}/4switch\\\SI{4}{\us}/switch}\\ \hline
    \end{tabular}
\end{center}
\end{table}

For the B2B transfer system, the upper bound latency of the frames in the B2B Broadcast and B2B Unicast traffic is \SI{500}{\us}, see Tab.\ref{requirement_network}. The latency of the WR network is decided by the layers of WR switches and the length of the optical fiber. The latency of the optical fiber is about \SI{204}{\meter/\us}~\cite{_calculating_2012} and the longest distance in the FAIR campus is around \SI{2}{\kilo\meter}, so the latency of a \SI{2}{\kilo\meter} optical fiber is about \SI{10}{\us}. The layers of WR switches play a more important role in the latency. 

\begin{itemize}
    \item B2B Broadcast

		Here we calculate the layer of the WR switch between the B2B source \gls{SCU} and B2B target SCU, between B2B source SCU 			and source trigger SCU and between B2B source SCU and target trigger SCU.  
		\begin{equation}
		\begin{aligned}
			\frac{\SI{500}{\us}-\SI{10}{\us}}{\SI{28}{\us/switch}}\approx 17
		\label {num_switch_b}
		\end{aligned}
		\end{equation}
	\item B2B Unicast

		Here we calculate the layer of the WR switch between the B2B source SCU and DM.
		\begin{equation}
		\begin{aligned}
			\frac{\SI{500}{\us}-\SI{10}{\us}}{\SI{6}{\us/switch}}\approx 81
		\label {num_switch_b}
		\end{aligned}
		\end{equation}
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Kicker systematic investigation for the B2B transfer system}
The SIS18 extraction kicker consists of 9 kicker units. In the existing topology, 5 kicker units are installed in the 1st crate and the other 4 units are in the 2nd crate. The width of each kicker unit is 0.25m and the distance between two kicker units is 0.09m. The distance between two crates is 19.167m. SIS100 injection kicker consists of 6 kicker units, which are equally located. The width of each kicker unit is 0.22m and the distance between two units is 0.23m. For the B2B transfer, the rise time of SIS18 extraction kicker and SIS100 injection kicker unit are 90ns and 1/20 of the revolution period. The rise time of these kickers must fit within the bunch gap, 25$\%$ of rf reference period ~\cite{udo_injection_2014, liebermann_sis100_2013}. The bunch gap is denoted by \gls{symb:G}. All the analysis in this section dose not consider the jitter of the kicker trigger signal. Here we are discussing about the following possibilities. 
\begin{itemize}
    \item For SIS18, whether the kicker units in the 2nd crate could be fired a fixed delay after the firing of the kicker units in the 1st crate for ion beams over the whole range of stable isotopes. 
    \item For SIS100, whether the kicker units could be fired instantaneously. 
\end{itemize} 

\subsection{SIS18 extraction kicker units}
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{kicker.jpg}
   \caption{Three scenarios for the delay of SIS18 extraction kicker}
   \label{kicker}
\end{figure}
Here we take three ion beams, $H^+, U^{28}$ and $U^{73+}$, to check the possibility, because the boundary ion species have the most stringent requirements. Fig.~\ref{kicker} shows three scenarios of the firing delay between two crates. Beam is firstly kicked by kicker units in the 1st crate and than kicked by the units in the 2nd crate to the transfer line. The yellow and red ellipse represents the position of the bunches, when the kicker units in the 1st and 2nd crate are fired. The number in the ellipse is used to tell different bunches. The head of the bunch is at the right side. The bunch 2 is firstly kicked. Here we assume that the kicker units in the same crate are triggered instantaneous. d denotes the distance between two crates. \gls{symb:L} denotes the distance from the leftmost to the rightmost kicker unit. \gls{symb:D} denotes the sum distance of \gls{symb:d} and the 2nd crate. d equals to 19.167 meter. L equals to 22.047m = d + 9$\cdot 0.25m + 7\cdot$ 0.09m. D equals to 20.437m = d + 4$\cdot 0.25m + 3\cdot$ 0.09m.

Fig.~\ref{kicker} (a) is the easiest scenario. The kicker units in the 1st crate are fired when the tail of the bunch 1 passes by the 1st crate completely. The kicker units in the 2nd crate are fired when the tail of the bunch 1 passes by the 2nd crate completely. The delay for the firing two crates in this scenario is D/$\beta$c. 

Fig.~\ref{kicker} (b) shows the scenario of the maximum delay between the firing of two crates. The kicker units in the 1st crate are fired when the tail of the bunch 1 passes by the 1st crate completely. The kicker units in the 2nd crate are fired 90ns before the head of the bunch 2 passes by it. The delay equals to G+d/$\beta$c-90ns.

Fig.~\ref{kicker} (c) shows the scenario of the minimum delay. The kicker units in the 1st crate are fired 90ns before the head of the bunch 2 passes by it. The kicker units in the 2nd crate are fired when the bunch 1 passes by the 2nd crate. The delay is L/\gls{symb:b}\gls{symb:c}-G+90ns.



Tab. ~\ref{kicker_delay} shows delay for three scenarios and related parameters. The fixed delay is determined primarily by the boundary delay range from $H^+, U^{28}$ and $U^{73+}$ beams, the delay range for other heavy ion species beams must be contained in these boundary range. According to the result, a fixed delay is available for firing kicker units in two crate for different beams. e.g. 80ns.   
\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The delay for firing two crates of SIS18 extraction kicker}
\label{kicker_delay}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | c | }
    \hline
    Beam & $\beta$ &  \tabincell{c}{time\\ L/$\beta$c } &\tabincell{c}{bunch gap \\ G } & \tabincell{c}{minimum delay \\ L/$\beta$c-G+90ns} & \tabincell{c}{delay \\ D/$\beta$c} & \tabincell{c}{maximum delay \\ G+d/$\beta$c-90ns}\\ \hline
    $H^+$ & 0.982 &75ns &  184ns & 0ns & 69ns & 163ns  \\ \hline
    $U^{28+}$ &0.568 & 130ns &  159ns & 61ns &120ns & 189ns \\ \hline
    $U^{73+}$ & 0.872 & 84ns & 104ns & 70ns & 78ns & 92ns \\ \hline
    \end{tabular}
\end{center}
\end{table}

\subsection{SIS100 injection kicker units}
Two bunches from SIS18 will be continuously injected into two RF buckets after the other in SIS100. See Fig.~\ref{kicker_SIS100}. The yellow ellipse represents the circulating bunch in SIS100 and the red one represents the bunch to be injected. The head of the bunch is at the left side. The preparation of the SIS100 injection kicker must be done during the bunch gap and it must be established for at least one SIS18 revolution period. For the instantaneous firing, all kicker units are fired only if the tail of the circulating bunch passes the leftmost kicker unit. The kicker pass time is the time needed for the tail of a bunch to pass from the rightmost unit to the leftmost kicker unit. The rise time of the kicker unit is 1/20 of the revolution period ~\cite{udo_injection_2014}. Therefor the preparation time is the sum of the kicker pass time and rise time. The distance from the rightmost to the leftmost kicker unit is 3.79m, 6$\cdot 0.22m + 5\cdot $0.23m. If the preparation time is shorter than bunch gap, all kicker units could be fired instantaneous. Tab. ~\ref{kicker_SIS100} shows the preparation time for $H^+, U^{28} and U^{73+}$ beams and their bunch gap. The preparation time is much shorter than the bunch gap. So the kicker units could be fired instantaneous. 

\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{kicker_SIS100.jpg}
   \caption{SIS100 injection kicker}
   \label{kicker_SIS100}
\end{figure}

\begin{table}[H]
\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
\caption{The delay for firing SIS00 injection kicker}
\label{kicker_SIS100}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c  |}
    \hline
    Beam & $\beta$ &  \tabincell{c}{kicker pass\\ time L/$\beta$c} & \tabincell{c}{Rise time \\ 1/20$\cdot T_{rev}^{SIS100}$}& \tabincell{c}{Preparation time \\ L/$\beta$c+1/20$\cdot T_{rev}^{SIS100}$} & \tabincell{c}{bunch gap \\ 2.25$\cdot T_{rev}^{SIS100}$}\\ \hline
    $H^+$     & 0.982 & 3ns  &  184ns & 187ns & 828ns   \\ \hline
    $U^{28+}$  & 0.568 & 22ns &  318ns   & 333ns  & 1431ns  \\ \hline
    $U^{73+}$ & 0.872 & 15ns &   207ns & 222ns &  932ns \\ \hline
    \end{tabular}
\end{center}
\end{table}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Test setup for the data collection, merging and redistribution of the B2B transfer system}

In this section, the test setup for the B2B transfer system is described, focusing only on the timing aspects.  

\subsection{Test functional requirement}
The test setup achieves the following functional requirement.
\begin{itemize}
\item[-] After receiving CMD\_B2B\_START, both the B2B source and target SCUs collect predicted phase equivalent data locally. The equivalence is a timestamp for the zero crossing point of the simulated Reference RF Signal of SIS18 and SIS100. 
\item[-] The B2B target SCU transfers the frame containing the timestamp to the B2B source SCU.
\item[-] After receiving the data, the B2B source SCU calculates the synchronization window.
\item[-] The B2B source SCU sends the frame containing the beginning of the synchronization window to the WR network.
\item[-] After receiving the frame, the trigger SCU produces TTL output indicating the start of the synchronization window. 
\end{itemize}

\subsection{Test setup}

\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{schematic_setup.jpg}
   \caption{Schematic of the test setup}
   \label{setup}
\end{figure}

Fig.~\ref{setup} shows the schematic of the test setup. In this test setup, two MODEL DS345 Synthesized Function Generators\footnote{\url{http://www.thinksrs.com/downloads/PDFs/Manuals/DS345m.pdf}} are used, which are with the frequency accuracy of \SI{+-5}{ppm} of the selected frequency to simulate Reference RF Signals of SIS18 and SIS100. DS345 of SIS18 uses an internal \SI{10}{\MHz} clock as an external reference clock for DS345 of SIS100. The B2B source SCU, B2B target SCU and trigger SCU are connected to the same WR switch, which connects to the timing network. A \gls{PC}\footnote{A Linux personal computer is installed with the standard TR tools and library. \newline\url{https://www-acc.gsi.de/wiki/Timing/TimingSystemNodesCurrentRelease}} is used as a DM to produce the B2B start timing frame. Besides, it monitors the status of the  B2B transfer programs in all SCUs. The oscilloscope is used to monitor the alignment of the two simulated Reference RF Signals within the synchronization window provided by the trigger SCU.   

Fig.~\ref{testsetup_text} shows the front and back view of the test setup. DS345 of SIS18 produces the sine wave of \SI{1.572200}{\MHz} frequency for the oscilloscope and DS345 of SIS100 produces the sine wave of \SI{1.572000}{\MHz} for the oscilloscope, which are achieved by the LEMO cables, see green line in Fig.~\ref{testsetup_text}. DS345 produces the TTL signal for the B2B source SCU, whose rising edge is synchronized to the positive zero crossing of the sine wave of \SI{1.572200}{\MHz} frequency and DS345 of SIS100 produces the TTL signal for the B2B target SCU, whose rising edge is synchronized to the sine wave of \SI{1.572000}{\MHz}, which are achieved by the LEMO cables, see red line in Fig.~\ref{testsetup_text}. So the beating frequency is \SI{200}{\Hz} and the synchronization period is \SI{5}{\ms}. The B2B source, target and trigger SCUs are connected to the WR switch, which are achieved by the optical fiber, see yellow line. The WR switch is connected to the PC and the WR network. The output of the synchronization window from the B2B trigger SCU is connected to the oscilloscope, which is achieved by the LEMO cable, see green line. 

\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{testsetup_text.jpg}
   \caption{The front and back view of the test setup}
   \label{testsetup_text}
\end{figure}

Compared with the final scenario, there are some difference of the test setup.
\begin{itemize}
\item
The SIS18 and SIS100 DS345 will be replaced by the PAP modules, which are installed in the B2B source and target SCUs as SCU slaves. 
\item 
All devices are installed in different racks. The SIS18 source SCU and B2B trigger SCU of the extraction kicker are installed in SIS18 and the SIS18 target SCU and B2B trigger SCU of the injection kicker are installed in SIS100. The connection is done via the WR network. 
\item 
The B2B source SCU has several other SCU slaves, e.g. Phase Shift Module (PSM) for the phase shift. 
\item 
The B2B trigger SCU considers not only the synchronization window, but also the kicker delay compensation from the SM. Besides, it has several SCU slaves, which coordinate the correct B2B extraction and injection kicker with other systems, e.g. MPS.
\end{itemize}

\subsection{The firmware of the B2B transfer system}

The B2B source, B2B target and trigger SCUs have different firmware running on their soft \gls{CPU}, LM32\footnote{LatticeMico32 is a 32-bit microprocessor soft core from Lattice Semiconductor optimized for field-programmable gate arrays (\gls{FPGA}s).}. The firmware are activated by the  B2B start timing frame, $CMD\_START\_B2B$, which indicates the source and target synchrotrons of the B2B transfer. 
%%%%%%%%%%%%%%%%%%%%%%%%
\begin{itemize}
\item Firmware for the B2B source SCU
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{flow_chart_src.jpg}
   \caption{Flow chart of the firmware for B2B source SCU.}{Flow chart of the firmware for B2B source SCU. ``Step`` is represented as ``S`` in the figure.}
   \label{flow_chart_src}
\end{figure}

The firmware for the B2B source SCU is the core program of the B2B transfer system. See Fig. ~\ref{flow_chart_src}. 

 	\begin{itemize}
		\item[-]Step 1. The program waits for the CMD\_START\_B2B timing frame.
% 		\item[-]Step 2. When it receives the timing frame CMD\_START\_B2B, it collects the predicted phase and checks whether it is within a proper range of $0^\circ$ to $360^\circ$. If not, it sends a timing frame TGM\_B2B\_ERROR to the WR network and goes back to the step 1, which indicates the data error.
 		\item[-]Step 2. When it receives the timing frame CMD\_START\_B2B, it reads the extrapolated phase, the corresponding timestamp and the phase advance slope from the PAP module.
		\item[-]Step 3. It waits for the TGM\_PHASE\_TIME timing frame from the B2B target SCU, which contains the extrapolated phase, the corresponding timestamp and the slope of the phase advance.
		\item[-]Step 4. When it receives the timing frame TGM\_PHASE\_TIME within a specified timeout interval, it calculates the synchronization window, the phase shift/jump value and the phase correction value. Or it sends a timing frame TGM\_B2B\_ERROR to the WR network and goes back to the step 1, which indicates the timeout error of the frame. Besides, it checks whether the phase correction is in the range of $0^\circ$ to $360^\circ$ , the required phase shift in the range of $-180^\circ$ to $180^\circ$ and the start of the synchronization window not in the forbidden range. If at least one of them is not correct, it sends a timing frame TGM\_B2B\_ERROR to the WR network and goes back to the step 1, which indicates the calculation error. 
		\item[-]Step 5. It sends the timing frame TGM\_SYNCH\_WIN and TGM\_PHASE \_CORRECTION to the WR network. TGM\_SYNCH\_WIN indicates the start of the synchronization window and TGM\_PHASE\_CORRECTION is used for the trigger SCUs for the reproduction of the bucket label signal.
		\item[-]Step 6. It gives the phase correction and phase shift/jump values to corresponding modules.
		\item[-]Step 7. It waits for the timing frame TGM\_KICKER\_TIME\_S from the source trigger SCU and TGM\_KICKER\_TIME\_T from the target trigger SCU, which contains the extraction/injection kicker trigger and firing timestamp. When it does not receive the timing frames within a specified timeout interval, it sends a timing frame TGM\_B2B\_ERROR to the WR network and goes back to the step 1, which indicates the timeout error of the frame.
		\item[-]Step 8. When it receives the timing frames mentioned in the step 7 within a specified timeout interval, it checks the B2B transfer status and sends TGM\_B2B\_STATUS to the WR network and goes to the step 1. The B2B transfer is successful, if all of the following checks are correct. Or the B2B transfer is failure. 
\begin{itemize}
	\item Trigger time $<$ firing time of the extraction kicker of the source synchrotron

	\item Trigger time $<$ firing time of the injection kicker of the target synchrotron

	\item Firing time of the extraction kicker $<$ firing time of the injection kicker
\end{itemize}
 

	\end{itemize}
%%%%%%%%%%%%%%%%%%%%
\item Firmware for the B2B target SCU
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{flow_chart_trg.jpg}
   \caption{Flow chart of the firmware for B2B target SCU.}{Flow chart of the firmware for B2B target SCU. ``Step`` is represented as ``S`` in the figure.}
   \label{flow_chart_trg}
\end{figure}
Fig. ~\ref{flow_chart_trg} (a) shows the flow chart of the program of the B2B target SCU.
 	\begin{itemize}
		\item[-]Step 1. The program waits for the CMD\_START\_B2B timing frame.
 		\item[-]Step 2. When it receives the timing frame CMD\_START\_B2B, it collects the predicted phase.
		\item[-]Step 3. It sends the TGM\_PHASE\_TIME timing frame to the B2B source SCU and goes back to the step 1.
	\end{itemize}
%%%%%%%%%%%%%%%%%%%%%
\item Firmware for the trigger SCU

Fig. ~\ref{flow_chart_trg} (b) shows the flow chart of the program of the source trigger SCU. For the target trigger SCU, the flow chat is same only with the different name of the timing frame TGM\_KICKER\_TIME\_T.
 	\begin{itemize}
		\item[-]Step 1. The program waits for the CMD\_START\_B2B timing frame.
		\item[-]Step 2. The program waits for the TGM\_PHASE\_CORRECTION timing frame.
		\item[-]Step 3. The program gives the phase correction value to the corresponding module for the bucket label signal reproduction.
 		\item[-]Step 4. When it receives the timing frame CMD\_START\_B2B, it waits for the timing frame TGM\_SYNCH\_WIN to indicate the synchronization window for the kicker trigger.
		\item[-]Step 5. After the beam extraction, it collects the trigger and firing timestamp. 
		\item[-]Step 6. It sends the TGM\_KICKER\_TIME\_S timing frame to the B2B source SCU and goes back to the step 1.
	\end{itemize}

\end{itemize}
%%%%%%%%%%%%%%%%%%%%%%
\subsection{The time constraints of the B2B transfer system}
For the B2B transfer system, the time constraints are very important and strict. Fig. ~\ref{time_constraint} shows the time constraint of the system. The $CMD\_START\_B2B$ is executed at \gls{symb:t_b2b}. The RF phase prediction needs \SI{500}{\us}, so the B2B source and target SCUs collect the phase data at $t_{B2B}$ + \SI{500}{\us} and need about \SI{450}{\ns} for the data collection. The B2B source SCU receives the timing frame TGM\_PHASE\_TIME at around $t_{B2B}$ + \SI{500}{\us} + \SI{450}{\ns} + \SI{500}{\us} $\approx$ $t_{B2B}$ + \SI{1}{\ms}. The second \SI{500}{\us} is the upper bound latency of the WR network. After that, the B2B source SCU needs about \SI{100}{\us} for the calculation, the sending of the timing frame TGM\_SYNCH\_WIN and TGM\_PHASE\_CORRECTION and data transferring to the corresponding module. TGM\_SYNCH\_WIN is sent at around $t_{B2B}$ + \SI{1}{\ms} + \SI{100}{\us} $\approx$ $t_{B2B}$ + \SI{1.1}{\ms}. The trigger SCU receives TGM\_PHASE\_CORRECTION and TGM\_SYNCH\_WIN at around $t_{B2B}$ + \SI{1.1}{\ms} + \SI{500}{\us} $\approx$ $t_{B2B}$ + \SI{1.6}{\ms}. The \SI{500}{\us} is the latency of the WR network. The start of the synchronization window must be later than $t_{B2B}$ + \SI{1.1}{\ms} + 2$\cdot$\SI{500}{\us} $\approx$ $t_{B2B}$ + \SI{2.1}{\ms}, because the TGM\_SYNCH\_WIN must be transferred back to the DM and the DM transfers it further to the beam instrumentation devices via WR network. The upward to DM transfer needs maximum \SI{500}{\us} and the transfer from the DM to BI needs another \SI{500}{\us}.  The upper bound B2B transfer time is \SI{10}{\ms}, which is decided by the duration of the stable beam. There is no hard real time for the collection of the trigger and firing timestamps and timing frame TGM\_KICKER\_TIME\_S sending, we give \SI{1}{\ms} for the source trigger SCU to do this task and the source trigger SCU sends TGM\_KICKER\_TIME\_S at around $t_{B2B}$ + \SI{10}{\ms} + \SI{1}{\ms} $\approx$ $t_{B2B}$ + \SI{11}{\ms}. The same time constraints is also for the target trigger SCU. The B2B source SCU receives TGM\_KICKER\_TIME\_S and TGM\_KICKER\_TIME\_T at around $t_{B2B}$ + \SI{11}{\ms} + \SI{500}{\us} $\approx$ $t_{B2B}$ + \SI{11.5}{\ms}. The \SI{500}{\us} is the latency of the WR network. The B2B source SCU sends TGM\_B2B\_STATUS at around $t_{B2B}$ + \SI{11.5}{\ms} + \SI{100}{\us} $\approx$ $t_{B2B}$ + \SI{11.6}{\ms}. The BI devices receives the timing frame TGM\_B2B\_STATUS at around $t_{B2B}$ + \SI{11.6}{\ms} + 2$\cdot$\SI{500}{\us} $\approx$ $t_{B2B}$ + \SI{12.6}{\ms}.

\begin{landscape}
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=240mm]{flow_chart_time.jpg}
   \caption{The time constraints of the B2B transfer system.}{The sent and received timing frame pairs have the same color. The test setup realizes the steps in the blue rectangle. (not drawn to accurate timescale) }
   \label{time_constraint}
\end{figure}
\end{landscape}

\subsection{Test result}
Because some modules of the B2B transfer system are still under the development, the test setup realizes parts of the whole function, mainly concentrated on the data collection from two simulated Reference RF signals, the calculation of the synchronization window and the distribution of the start of the synchronization window. The steps with the blue rectangle in Fig.~\ref{time_constraint} are realized in this test setup. The test result of the B2B programs on B2B source, B2B target and trigger SCUs are shown as follows. 

\begin{lstlisting}[language={[ANSI]C}, keywordstyle=\color{blue!70}, commentstyle=\color{red!50!green!50!blue!50}, frame=shadowbox, rulesepcolor=\color{red!20!green!20!blue!20}]

U28+ B2B transfer from SIS18 to SIS100 => Source B2B SCU
=============================================
SIS18: Frequency of the Reference RF Signal = 1.572200MHz
SIS100: Frequency of the Reference RF Signal = 1.572000MHz 
SIS18: Period of the Reference RF Signal = 636051(ps)
SIS100: Period of the Reference RF Signal = 636132(ps)

>>>>>>>>>>>>>>>>>>>>>>>>> Receive CMD_START_B2B from WR network
Timestamp of the Reference RF Signal from SIS18 (accuracy to 1ns)
GMT: Thu, Jan 8, 1970, 21:07:27.445405856

>>>>>>>>>>>>>>>>>>>>>>>>> Receive TGM_PHASE_TIME from WR network
Timestamp of the Reference RF Signal from SIS100 (accuracy to 1ns)
GMT: Thu, Jan 8, 1970, 21:07:27.445364560

Beating time: 5 (ms)
Synchronization time: 4.622818 (ms)
The number of the SIS18 revolution for the synchronization: 3634
Start of the synchronization window: GMT: Thu, Jan 8, 1970, 21:07:27.450028674

<<<<<<<<<<<<<<<<<<<<<<<<< Send TGM_SYNCH_WIN to WR network
\end{lstlisting}

\begin{lstlisting}[language={[ANSI]C}, keywordstyle=\color{blue!70}, commentstyle=\color{red!50!green!50!blue!50}, frame=shadowbox, rulesepcolor=\color{red!20!green!20!blue!20}]

U28+ B2B transfer from SIS18 to SIS100 => Target B2B SCU
=============================================
>>>>>>>>>>>>>>>>>>>>>>>>> Receive CMD_START_B2B from WR network
Timestamp of the Reference RF Signal from SIS100 (accuracy to 1ns)
GMT: Thu, Jan 8, 1970, 21:07:27.445364560

<<<<<<<<<<<<<<<<<<<<<<<<< Send TGM_PHASE_TIME to WR network
\end{lstlisting}

\begin{lstlisting}[language={[ANSI]C}, keywordstyle=\color{blue!70}, commentstyle=\color{red!50!green!50!blue!50}, frame=shadowbox, rulesepcolor=\color{red!20!green!20!blue!20}]

U28+ B2B transfer from SIS18 to SIS100 => Trigger SCU
=============================================
Waiting for timing frames...
>>>>>>>>>>>>>>>>>>>>>>>>> Receive TGM_SYNCH_WIN from WR network
Event execution timestamp: GMT 1970-01-08 21:07:27.450028674
\end{lstlisting}

After both B2B source and target programs receive the $CMD\_START\_B2B$ frame, they trigger another unit connected to the System-on-Chip\footnote{A system-on-chip is an integrated circuit that integrates all components of a computer or other electronic system into a single chip.}  (SoC) bus to get the timestamp of the next zero crossing point of the DS345 sine waves, which is simulated as an equivalent to the predicted phase. All timestamp are shown in the format of Greenwich Mean Time (GMT). The timestamp got by the B2B source SCU is Thu, Jan 8, 1970, 21:07:27 0.445405856 second and the timestamp got by the B2B target SCU is Thu, Jan 8, 1970, 21:07:27 0.445364560 second, see Line 10 and 14 of the test result of the B2B source SCU. The time difference between two timestamps is \SI{41.296}{\us}. The frequency difference between SIS18 and SIS100 Reference RF Signals is \SI{200}{Hz}. It means that there are 200 more periods of the SIS18 Reference RF Signal within one second compared with the SIS100 Reference RF Signal. Every \SI{5}{ms} (1/\SI{200}{Hz}) SIS18 Reference RF Signal has one period more than that of SIS100. The time is calculated by eq. ~\ref {syn_time}, indicating the alignment of the zero crossing of two DS345 sine waves of SIS18 and SIS100. The time is named as ``synchronization time``, denoted by $\Delta t$.

\begin{equation}
\begin{aligned}
\frac{T^{SIS18}_{h=2}}{1/(f^{SIS18}_{h=2}-f^{SIS100}_{h=10})}=\frac{41.296us\mod T^{SIS100}_{h=10}}{\Delta t}
\label {syn_time}
\end{aligned}
\end{equation}

\begin{equation}
\Delta t = \SI{4.622818}{\ms}
\end{equation}

The number of the SIS18 Reference RF Signal periods for the synchronization is calculated as
\begin{equation}
\frac{\Delta t}{T^{SIS18}_{h=2}}=7268
\end{equation}
we could get that the beating time \gls{symb:d_t} is \SI{4.622818}{\ms} and the number of the SIS18 Reference RF Signal periods for the synchronization is 7268 for the test.

%After both B2B source and target programs receive the $CMD\_START\_B2B$ frame, they trigger another unit connected to the System-on-Chip\footnote{A system-on-chip is an integrated circuit that integrates all components of a computer or other electronic system into a single chip.}  (SoC) bus to get the timestamp of the next zero crossing point of the DS345 sine waves, which is simulated as an equivalent to the predicted phase. The triggers of the B2B source and target SCUs are not simultaneous, namely the B2B source and target SCU do not get the timestamp of the adjacent zero crossing points of two RF simulated sine signals, see Line 10 and 14 of the test result of the B2B source SCU. All timestamp are shown in the format of Greenwich Mean Time (GMT). The timestamp got by the B2B source SCU is Thu, Jan 8, 1970, 21:07:27 0.445405856 second and the timestamp got by the B2B target SCU is Thu, Jan 8, 1970, 21:07:27 0.445364560 second. The time difference between two timestamps is \SI{41.296}{\us}. There are two reasons for the asynchronous triggers.
%
%\begin{itemize}
%	\item
%The SoC bus might be granted to other program and B2B program must wait until it is free.
%	\item
%The behaviour of the user friendly messages of the LM32 programs causes the non real time of the programs.
%\end{itemize}
%
%The difference between timestamps of the adjacent zero crossing points, 592ns, is the remainder resulting from 41.296us dividing SIS18 revolution period \SI{636051}{\ps}. Based on eq. ~\ref{syn_time} and eq. ~\ref{syn_num}, 
%\begin{equation}
%\begin{aligned}
%\frac{T^{SIS18}_{h=2}}{5ms}=\frac{592ns}{\Delta t}
%\label {syn_time}
%\end{aligned}
%\end{equation}
%
%\begin{equation}
%\begin{aligned}
%\frac{\Delta t}{T^{SIS18}_{h=1}}=3634
%\label {syn_num}
%\end{aligned}
%\end{equation}
%we could get that the beating time \gls{symb:d_t} is \SI{4.622818}{\ms} and the number of the SIS18 revolution period is 3634 for the test. 
%
%For the real application of the B2B transfer system, in order to guarantee the time constraints of the B2B programs, see Fig. ~\ref{time_constraint}, the B2B source, target and trigger SCUs run only their corresponding B2B program. The SoC bus is occupied only by the B2B program. Besides, the programs running on LM32 are forbidden to print out any user friendly messages.



