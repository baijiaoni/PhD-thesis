
For the FAIR accelerator complex, synchronization of the B2B transfer will be realized by the FAIR control system and the Low-Level RF (LLRF) system. For the synchronization of LLRF system, the General Machine Timing (\gls{GMT}) system is complemented and linked to the Bunchphase Timing System (BuTiS). Machine Protection System (MPS) protects SIS100 and subsequent accelerators or experiments from damage. Hence, the B2B transfer system for FAIR coordinates with the MPS system. 
\section{FAIR Control System}
The \gls{FAIR} control system takes advantage of collaborations with CERN in using framework solutions like Front-End System Architecture (\gls{FESA})~\cite{hoffmann_fesafront-end_2008}, LHC Software Architecture (\gls{LSA}), White Rabbit (\gls{WR}) ~\cite{huhmann_fair_2013}. It consists of the equipment layer, middle layer and application layer. The equipment layer consists of equipment interfaces, GMT and software representations of the equipment FESA. The middle layer provides service functionality both to the equipment layer and the application layer through the IP control system network. LSA is used for the Settings Management (SM). The application layer combines the applications for operators as \gls{GUI} applications or command line tools. The application layer and the middle layer only request what the FAIR accelerator complex should do and transmit set values to the equipment layer. Before an accelerator cycle is started, the setting properties of FESA are pre-supplied by LSA from \gls{SM} for all scheduled beams with specific settings accordingly. At run time, FESA real time software actions are triggered by timing message, the actual beam specific data is then selected based on information carried by the timing message and send to the equipment ~\cite{huhmann_fair_2013}. 

\subsection{Bunch Phase Timing System}
Bunch Phase Timing System (BuTiS) serves as a campus-wide clocks distribution system with sub nanosecond resolution and stability over distances of several hundred meters while maintaining \SI{100}{ps} per km timing stability ~\cite{moritz_butisdevelopment_2006}. Two BuTiS reference clocks \SI{100}{kHz} P0 pulse and \SI{10}{MHz} S1 phase reference signal are generated centrally in the BuTiS center. A star-shaped optical fiber BuTiS distribution system transfers these two reference clocks to the BuTiS local reference synthesizer all over the FAIR campus. The optical signal transmission delay between the BuTiS center and the different BuTiS local reference synthesizer is measured by a measurement setup in the BuTiS center. This measurement information is used to correct the phases of the signals generated in each BuTiS local reference synthesizer for the delay compensation. So at each BuTiS reference synthesizer, two delay compensated clock signals, \SI{200}{MHz} C2 sine and \SI{100}{kHz} T0 ident clocks, are generated from \SI{100}{kHz} P0 and \SI{10}{MHz} S1 reference clocks ~\cite{moritz_butisdevelopment_2006, zipfel_recent_2011}. The main task of BuTiS is the supply of the reference clock signals for \gls{glos:Rrf} rf systems, see Sec. ~\ref{sec:LLRF}.

\subsection{General Machine Timing System}
The GMT system is contained in the equipment layer. It synchronizes all Front End Controllers (\gls{FEC}) with nanosecond accuracy over the whole FAIR campus and distributes timing messages to all FECs and controls all FECs to execute real-time actions at a designated time ~\cite{beck_new_2012}. The GMT system is a time based system. The GMT consists of the Timing Master (\gls{TM}), the White Rabbit (WR) timing network and FECs. The timing master is a logical device, containing the data master (\gls{DM}), the clock master (\gls{CM}) and the management master (\gls{MM}). The data master receives a schedule for the operation of the FAIR accelerator complex from the Settings Management and provides the real-time schedule by broadcasting timing messages to the WR timing network, which will be received and executed by the corresponding equipment connected to the FECs at the designated time. The clock master is a dedicated WR switch. It is the topmost switch layer of the WR timing network and provides the grandmaster clock and timestamps which are distributed to all other FECs in the timing network. The clock master derives its clock from BuTiS \SI{200}{MHz} C2 and \SI{100}{kHz} T0 clocks and timestamps distributed are phase locked to BuTiS clocks. The GMT system could generate BuTiS T0 and C2 with any FECs and FECs are capable to timestamp BuTiS T0 clocks and positive zero-crossings of BuTiS C2. All active components including FECs and WR switches are registered to the MM. The MM monitors and manages the active components of the GMT system ~\cite{beck_general_????, beck_timing_2015}. The Scalable Control Unit (\gls{SCU}) is a new generation of the standard FEC for the FAIR control system, which provides a compact and flexible solution for controlling all types of accelerator equipment.

A timing message is sent across the WR network, so it must be contained in the Ethernet frame. An Ethernet frame including one timing message has a length of \SI{110}{byte}, which is called ``timing frame`` in this dissertation. A Virtual LAN (VLAN) \footnote{\url{https://en.wikipedia.org/wiki/Virtual_LAN}} is a group of FECs in the WR network that is logically segmented by function or application, without regard to the physical locations of the FECs. All FECs in the WR network are assigned to the DM VLAN, within which the DM forwards broadcast timing telegrams downwards to all FECs. 

%Fig. ~\ref{Timing_message} shows the format of the timing message . 
%\begin{figure}[H]
%   \centering   
%   \includegraphics*[width=150mm]{Timing_message.jpg}
%   \caption{The format of the timing message.}{~\cite{beck_timing_2015}}
%   \label{Timing_message}
%\end{figure}
%The timing message contains 
%\begin{itemize}
%	\item WB Addr (\SI{32}{bit}): Wishbone address to which on the node the data shall be written.
%	\item Payload (\SI{256}{bit})
%		\begin{itemize}
%			\item EventID (\SI{64}{bit}): Index of the schedule step.
%		\begin{itemize}
%			\item Format ID (FID) (\SI{4}{bit}): Serves to distinguish between different formats of the timing message.
%			\item Group ID (GID)(\SI{12}{bit}): Identifies a group of equipment, such as a synchrotron or a transfer line.
%			\item Event No (EVTNO) (\SI{12}{bit}): Specifies a command to be executed.
%			\item Sequence ID (SID) (\SI{12}{bit}): A sequence is analogous to the concept of a ``virtual accelerator``. 
%			\item Beam Process ID (BPID) (\SI{14}{bit}): A beam process defines a process which must not be interrupted, e.g. a acceleration ramp. 
%			\item Reserved (\SI{10}{bit})
%		\end{itemize}
%			\item Param (\SI{64}{bit}): An additional parameter with event specific meaning.
%			\item TEF (\SI{32}{bit}): Timing Extension Field containing fine delay information and other data.
%			\item Reserved (\SI{32}{bit}): 
%			\item Timestamp (\SI{64}{bit}): In units of \SI{8}{\ns} clock cycles since 1 January 1970.
%		\end{itemize}
%\end{itemize}
%A timing message is sent across the WR network, so it must be contained in the Ethernet frame. An Ethernet frame including one timing message has a length of \SI{110}{byte}, which is called the timing frame in this document.
\subsection{Settings Management}
The Settings Management (\gls{SM}) is based on a physics model for accelerator optics, parameter space and overall relations between parameters and between accelerators. It supports off-line generation of accelerator settings, sending these settings to all involved devices, and programming the schedule for the GMT system ~\cite{huhmann_fair_2013}. The core component of SM is the LSA framework. A standardized  LSA-\gls{API} allows accessing data in a common way as basis for generic client applications for all accelerators. Using the LSA-API, applications can coherently modify settings ~\cite{huhmann_fair_2013}. E.g. the LSA generates timing constraints (e.g. ramp curve) as well as the equipment's data settings (e.g. the current) for all devices derived from physics parameters (e.g. beam energy). For FAIR, LSA is extended to model the overall schedule of all accelerators. Beams are described as ``Beam Production Chains`` to allow a description from beam source to beam target for settings organization and data correlation.


\subsection{FESA}
The \gls{FESA}\footnote{\url{https://www-acc.gsi.de/wiki/FESA/WhatIsFESA}} is a framework used to fully integrate the large amount of front-end equipment into the accelerator control system. FESA was developed by CERN and has already been implemented into the \gls{CERN} control system. Now it is developed further in collaboration with GSI for the FAIR project. For the FAIR project the necessary interaction with the FECs is realized by FESA. For a specific type of equipment, a FESA implementation accesses to the control interface of the equipment. The FESA class models the equipment as device, so the FESA output is called device class. The \gls{FEC} use FESA to implement generic and equipment specific functions in form of the device classes. FESA provides JAVA based graphical user interfaces (GUI) to design, deploy, instantiate and test the device classes. Interaction with the equipment is synchronized with the GMT system ~\cite{hoffmann_fesafront-end_2008}. 

%For time multiplexed operation of the accelerators, the FESA supports defining multiplexed properties. Before an accelerator cycle is started, the setting properties of FESA classes are pre-supplied by LSA from SM for all scheduled beams with specific settings accordingly. At run time, FESA real time software actions are triggered by timing message, the actual beam specific data is then selected based on information carried by the timing message and send to the equipment. 

\section{Low-Level RF System}
\label{sec:LLRF}
The FAIR low-level rf (\gls{LLRF}) system will be used in the existing synchrotrons SIS18 and \gls{ESR}, as well as in the FAIR synchrotrons SIS100 and SIS300 and in \gls{CR}, \gls{NESR}, and \gls{RESR}. It supports fast ramp rates and large frequency span for the acceleration of a variety of ion species, It supports different rf manipulations, including operation at different harmonic numbers, barrier bucket generation, bunch compression and longitudinal feedback. ~\cite{klingbeil_new_2011}. 

\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{ref_rf_dis.png}
   \caption{phase measurement signal distribution system}{~\cite{klingbeil_new_2011}}
   \label{ref_rf_dis}
\end{figure}
Each rf supply room has a phase measurement signal distribution system shown in Fig.~\ref{ref_rf_dis}. The phase measurement signals in different supply rooms are synchronized by BuTiS. BuTiS 200MHz C2 and 100kHz T0 clock signals are generated by BuTiS receivers in different supply rooms in phase. In Fig.~\ref{ref_rf_dis}, a number of Group Direct Digital Synthesizer (DDS) units are located in each supply room, which are synchronized by BuTiS local reference. The Group DDS signals can be routed to the different cavity systems by a Switch Matrix. All cavities in a synchrotron could be providing with the same Group DDS signal. The cavities at different harmonic numbers could be realized by using Group DDS signals with different harmonic numbers and by adjusting the harmonic number at the Cavity DDS accordingly. The Group DDS concept allows to synchronize a variety of cavities in a very flexible way ~\cite{klingbeil_new_2011}. 

All the cavities of the SIS18 are driven from one supply room. The SIS100 cavities will be gathered in five acceleration sections, each of them is driven by a dedicated supply room. 

\subsection{Local Cavity Synchronization}
All rf cavities are driven by one of phase measurement signals, which are generated in each supply room . Fig.~\ref{local_cavity_syn} shows the local cavity synchronization system, which synchronizes the local Cavity DDS unit to the phase measurement signal with a specified phase offset. The cavity gets the rf signal from a local Cavity \gls{DDS} unit, which receives rf frequency ramps from the Central Control System (\gls{CCS}). A Digital Signal Processor (\gls{DSP})-System measures the phase difference between the phase measurement signal and the gap voltage of the cavity. In the DSP system, a closed-loop control algorithm is implemented, which generates frequency corrections for the local \gls{glos:cavity_DDS} unit. This process is called local synchronization loop, which ensures that the phase of the gap voltage follows the phase of the Reference RF signal ~\cite{klingbeil_new_2011}. The path from the Group DDS 1 to Cavity 1 marked with the red line in Fig.~\ref{ref_rf_dis} is realized by the local cavity synchronization in Fig.~\ref{local_cavity_syn}. The \gls{glos:vit_DDS} is a virtual position around the ring, to which the phase measurement signal corresponds.
\begin{figure}[H]
   \centering   
   \includegraphics*[width=110mm]{local_cavity_syn.png}
   \caption{Local Cavity Synchronization}{~\cite{klingbeil_new_2011}}
   \label{local_cavity_syn}
\end{figure}
\subsection{Longitudinal Feedback System}
In order to damp coherent longitudinal dipole oscillations, the beam phase control loop is used. The phase difference between the beam signal and the phase measurement signal is fed back via an FIR filter. The beam signal is obtained by a fast current transformer or a beam position monitor. The filter output is converted in a phase-correction and forwarded to the Group DDS. The corrections are added to the phase of the  frequency ramp in the Cavity DDS, which results in a change of the phase of the gap voltage and thus a feedback to the beam ~\cite{baudrenghien_low-level_2010}. Unfortunately, the actual beam phase control loop in SIS18 is not able to damp incoherent longitudinal dipole oscillations. For SIS100, a bunch-by-bunch longitudinal feedback system will be developed. The bunch-by-bunch longitudinal feedback system generates a correction voltage in dedicated feedback cavities for a specified bunch ~\cite{gross_bunch-by-bunch_2015}. 

\section{Machine Protection System}
A \gls{MPS} protects current accelerator and subsequent accelerators or experiments from damage or unacceptable failure, e.g. the beam position is out of tolerance, the rf cavity failure and so on. Thereby, the individual equipment is assumed self-protecting, which could triggers accelerator safety critical actions, such as an emergency beam dump \footnote{A beam dump is a device designed to absorb the beam.}, a shutdown of magnets or a beam injection inhibit. In case of relevant equipment failures or other inappropriate equipment states, a MPS signal is generated from this equipment ~\cite{mandakovic_fair_????}. The FAIR B2B transfer must coordinate with the SIS100 emergency dump signal and the beam injection inhibit signal from the MPS. 

The SIS100 emergency dump signal indicates that the beam should be transferred to the emergency dump as soon as possible. If the beam injection inhibit signal is off, the B2B transfer extraction and injection kickers are allowed to be fired. If the beam injection inhibit signal is on, the injection and extraction kickers will be blocked for firing. 



%The phase difference between two RF systems of the source and target synchrotrons is achieved based on a campus distributed reference signal with picosecond precision, which is synchronized with BuTiS C2 and T0. This campus distributed reference signal is called ``synchronization reference signal`` in this dissertation. The phase advance between the synchronization reference signal $\psi_{ref}$ and the RF system $\psi$ is measured and extrapolated at the source and target synchrotrons, see eq. ~\ref{diff1} and eq. ~\ref{diff2}. The extrapolation is synchronized to BuTiS C2 and T0. 
%\begin{equation}
%\Delta \varphi1= \psi1-\psi_{ref} \label{diff1}
%\end{equation}
%\begin{equation}
%\Delta \varphi2= \psi2-\psi_{ref} \label{diff2}
%\end{equation}
%The extrapolated phase advance of one synchrotron is transferred to another synchrotron. The difference between the extrapolated phase advance of the source synchrotron and that of the target synchrotron is the phase difference between two RF systems $\psi1-\psi2$, see eq. ~\ref{diff3}.
%\begin{equation}
%\psi1-\psi2=\Delta \varphi1-\Delta \varphi2 \label{diff3}
%\end{equation}
%The existing B2B transfer system for CERN measures the phase difference between two ring accelerators by the direct cable transfer of the rf signal of one synchrotron to another synchrotron ~\cite{ferrand_synchronization_2015}. The phase measurement between the two rf systems of the B2B transfer system for FAIR is more stable, which is less influenced by the external environment, e.g. temperature influence on the direct cable connection. It does not constraint by the distance between two ring accelerators.



  

%\section{$U^{28+}$ beam from SIS18 to SIS100}
%
%In this document, we use $U^{28+}$ B2B transfer from SIS18 to SIS100 as an example. So the supercycle of $U^{28+}$ beam of SIS18 and stacking of $U^{28+}$ beam of SIS100 are introduced in this section. 
%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=150mm]{SIS18-100-U28.jpg}
%   \caption{$U^{28+}$ beam from SIS18 to SIS100}
%   \label{SIS18-100-U28}
%\end{figure}
%
%In Fig.~\ref{ref_rf_dis}, SIS100 is operated at harmonic number 10, it holds 10 buckets in total, indicated by the row of ellipses in the lower part of the figure. SIS18 is operated at harmonic number 2. The beam is accumulated using four consecutive injections of two bunches each from SIS18 into different buckets. These four consecutive cycles are called super cycle. When the injection from SIS18 is completed, 8 neighbour buckets in SIS100 are filled. The bucket pattern is defined as the rules of the bucket filling. After that the complete beam of SIS100 is compressed in a single bunch at harmonic number 2.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\bibliography{main}
%\bibliographystyle{plain}


