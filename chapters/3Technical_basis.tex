
For the FAIR accelerator complex, synchronization of the B2B transfer will be realized by the FAIR control system and the Low-Level RF (LLRF) system. For the synchronization of LLRF system, the General Machine Timing (\gls{GMT}) system is complemented and linked to the Bunchphase Timing System (BuTiS). Machine Protection System (MPS) protects SIS100 and subsequent accelerators or experiments from damage. Hence, the B2B transfer system for FAIR coordinates with the MPS system. 
\section{FAIR control system}
The \gls{FAIR} control system takes advantage of collaborations with CERN in using framework solutions like Front-End System Architecture (\gls{FESA})~\cite{hoffmann_fesafront-end_2008}, LHC Software Architecture (\gls{LSA}), White Rabbit (\gls{WR}) ~\cite{huhmann_fair_2013}. It consists of the equipment layer, middle layer and application layer. The equipment layer consists of equipment interfaces, GMT and software representations of the equipment FESA. The middle layer provides service functionality both to the equipment layer and the application layer through the IP control system network. LSA is used for the Settings Management (SM). The application layer combines the applications for operators as \gls{GUI} applications or command line tools. The application layer and the middle layer only request what the FAIR accelerator complex should do and transmit set values to the equipment layer. The \gls{SM} supplies the schedule for the GMT by LSA ~\cite{huhmann_fair_2013, beck_new_2012}.

\subsection{BuTiS}
Bunch Phase Timing System (BuTiS) serves as a campus-wide clocks distribution system with sub nanosecond resolution and stability over distances of several hundred meters while maintaining \SI{100}{ps} per km timing stability ~\cite{moritz_butisdevelopment_2006}. Two BuTiS reference clocks \SI{100}{kHz} P0 pulse and \SI{10}{MHz} S1 phase reference signal are generated centrally in the BuTiS center. A star-shaped optical fiber BuTiS distribution system transfers these two reference clocks to the BuTiS local reference synthesizer all over the FAIR campus. The optical signal transmission delay between the BuTiS center and the different BuTiS local reference synthesizer is measured by a measurement setup in the BuTiS center. This measurement information is used to correct the phases of the signals generated in each BuTiS local reference synthesizer for the delay compensation. So at each BuTiS reference synthesizer, two delay compensated clock signals, \SI{200}{MHz} C2 sine and \SI{100}{kHz} T0 ident clocks, are generated from \SI{100}{kHz} P0 and \SI{10}{MHz} S1 reference clocks ~\cite{moritz_butisdevelopment_2006, zipfel_recent_2011}. The main task of BuTiS is the supply of the reference clock signals for \gls{glos:Rrf} RF systems, see Sec. ~\ref{sec:LLRF} .

\subsection{GMT}
The GMT system is contained in the equipment layer. It does not only synchronize all timing nodes with nanosecond accuracy over the whole FAIR campus, but also distributes timing messages to all timing nodes and controls all timing nodes to execute real-time actions at a designated time ~\cite{beck_new_2012}. The GMT system is a time based system. The GMT consists of the Timing Master (\gls{TM}), the White Rabbit (WR) timing network and timing nodes. The timing master is a logical device, containing the data master (\gls{DM}), the clock master (\gls{CM}) and the management master (\gls{MM}). The data master receives a schedule for the operation of the FAIR accelerator complex from the Settings Management and provides the real-time schedule by broadcasting timing messages to the WR timing network, which will be received and executed by the corresponding timing node at the designated time. The clock master is a dedicated WR switch. It is the topmost switch layer of the WR timing network and provides the grandmaster clock and timestamps which are distributed to all other timing nodes in the timing network. The clock master derives its clock from BuTiS \SI{200}{MHz} C2 and \SI{100}{kHz} T0 clocks and timestamps distributed are phase locked to BuTiS clocks. The GMT system could generate BuTiS T0 and C2 with any timing nodes and timing nodes are capable to timestamp clock edges. All active components including timing nodes and WR switches are registered to the MM. The MM monitors and manages the active components of the GMT system ~\cite{beck_general_????, beck_timing_2015}.

A timing message is sent across the WR network, so it must be contained in the Ethernet frame. An Ethernet frame including one timing message has a length of \SI{110}{byte}, which is called ``timing frame`` in this dissertation. A Virtual LAN (VLAN) \footnote{\url{https://en.wikipedia.org/wiki/Virtual_LAN}} is a group of FECs in the WR network that is logically segmented by function or application, without regard to the physical locations of the FECs. All FECs in the WR network are assigned to the DM VLAN, within which the DM forwards broadcast timing telegrams downwards to all FECs. 

%Fig. ~\ref{Timing_message} shows the format of the timing message . 
%\begin{figure}[H]
%   \centering   
%   \includegraphics*[width=160mm]{Timing_message.jpg}
%   \caption{The format of the timing message.}{~\cite{beck_timing_2015}}
%   \label{Timing_message}
%\end{figure}
%The timing message contains 
%\begin{itemize}
%	\item WB Addr (\SI{32}{bit}): Wishbone address to which on the node the data shall be written.
%	\item Payload (\SI{256}{bit})
%		\begin{itemize}
%			\item EventID (\SI{64}{bit}): Index of the schedule step.
%		\begin{itemize}
%			\item Format ID (FID) (\SI{4}{bit}): Serves to distinguish between different formats of the timing message.
%			\item Group ID (GID)(\SI{12}{bit}): Identifies a group of equipment, such as a synchrotron or a transfer line.
%			\item Event No (EVTNO) (\SI{12}{bit}): Specifies a command to be executed.
%			\item Sequence ID (SID) (\SI{12}{bit}): A sequence is analogous to the concept of a ``virtual accelerator``. 
%			\item Beam Process ID (BPID) (\SI{14}{bit}): A beam process defines a process which must not be interrupted, e.g. a acceleration ramp. 
%			\item Reserved (\SI{10}{bit})
%		\end{itemize}
%			\item Param (\SI{64}{bit}): An additional parameter with event specific meaning.
%			\item TEF (\SI{32}{bit}): Timing Extension Field containing fine delay information and other data.
%			\item Reserved (\SI{32}{bit}): 
%			\item Timestamp (\SI{64}{bit}): In units of \SI{8}{\ns} clock cycles since 1 January 1970.
%		\end{itemize}
%\end{itemize}
%A timing message is sent across the WR network, so it must be contained in the Ethernet frame. An Ethernet frame including one timing message has a length of \SI{110}{byte}, which is called the timing frame in this document.
\subsection{Settings Management}
The Settings Management (\gls{SM}) is based on a physics model for accelerator optics, parameter space and overall relations between parameters and between accelerators. It supports off-line generation of accelerator settings, sending these settings to all involved devices, and programming the schedule for the GMT system ~\cite{huhmann_fair_2013}. The core component of SM is the LSA framework. A standardized  LSA-\gls{API} allows accessing data in a common way as basis for generic client applications for all accelerators. Using the LSA-API, applications can coherently modify settings ~\cite{huhmann_fair_2013}. E.g. the LSA generates timing constraints (e.g. ramp curve) as well as the equipment's data settings (e.g. the current) for all devices derived from physics parameters (e.g. beam energy). For FAIR, LSA is extended to model the overall schedule of all accelerators. Beams are described as ``Beam Production Chains`` to allow a description from beam source to beam target for settings organization and data correlation.


\subsection{FESA}
The \gls{FESA}\footnote{\url{https://www-acc.gsi.de/wiki/FESA/WhatIsFESA}} is a framework used to fully integrate the large amount of front-end equipments into the accelerator control system. FESA was developed by CERN and has already been implemented into the \gls{CERN} control system. Now it is developed further in collaboration with GSI for the FAIR project. For the FAIR project the necessary interaction with the timing nodes is realized by FESA. For a specific type of equipments, a FESA implementation accesses to the control interface of the equipments. The FESA class models the equipment as device, so the FESA output is called device class. The \gls{FEC} use FESA to implement generic and equipment specific functions in form of the device classes. FESA provides JAVA based graphical user interfaces (GUI) to design, deploy, instantiate and test the device classes. Interaction with the equipment is also synchronized with the GMT system ~\cite{hoffmann_fesafront-end_2008}. 

For time multiplexed operation of the accelerators, the FESA supports defining multiplexed properties. Before an accelerator schedule is started, the setting properties of FESA classes are pre-supplied by LSA from SM for all scheduled beams with specific settings accordingly. At runtime, FESA real time software actions are triggered by timing message, the actual beam specific data is then selected based on information carried by the timing message and send to the equipment. 

\section{LLRF system}
\label{sec:LLRF}
The FAIR low-level rf (\gls{LLRF}) system will be used in the existing synchrotrons SIS18 and \gls{ESR}, as well as in the FAIR synchrotrons SIS100 and SIS300 and in \gls{CR}, \gls{NESR}, and \gls{RESR}. It supports fast ramp rates and large frequency span for the acceleration of a variety of ion species, It supports different RF manipulations, including operation at different harmonic numbers, barrier bucket generation, bunch compression and longitudinal feedback. ~\cite{klingbeil_new_2011}. 

\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{ref_rf_dis.png}
   \caption{Reference RF Signal distribution system}{~\cite{klingbeil_new_2011}}
   \label{ref_rf_dis}
\end{figure}
Each RF supply room has a Reference RF Signal distribution system shown in Fig.~\ref{ref_rf_dis}. The Reference RF Signals in different supply rooms are synchronized by BuTiS. BuTiS 200MHz C2 and 100kHz T0 clock signals are generated by BuTiS receivers in different supply rooms in phase. In Fig.~\ref{ref_rf_dis}, a number of Group Direct Digital Synthesizer (DDS) units are located in each supply room, which are synchronized by BuTiS local reference. The Group DDS signals can be routed to the different cavity systems by a Switch Matrix. All cavities in a synchrotron could be providing with the same Group DDS signal. The cavities at different harmonic numbers could be realized by using Group DDS signals with different harmonic numbers and by adjusting the harmonic number at the Cavity DDS accordingly. The Group DDS concept allows to synchronize a variety of cavities in a very flexible way ~\cite{klingbeil_new_2011}. 

All the cavities of the SIS18 are driven from one supply room. The SIS100 cavities will be gathered in five acceleration sections, each of them is driven by a dedicated supply room. 

\subsection{Local cavity synchronization}
RF cavities are driven by one of Reference RF Signals, which are generated in each supply room . Fig.~\ref{local_cavity_syn} shows the local cavity synchronization system, which synchronizes the local Cavity DDS unit to the Reference RF Signal with a specified phase offset. The cavity gets the RF signal from a local Cavity \gls{DDS} unit, which receives RF Frequency Ramps from the Central Control System (\gls{CCS}). A Digital Signal Processor (\gls{DSP})-System measures the phase difference between the Reference RF Signal and the gap voltage of the cavity. In the DSP system, a closed-loop control algorithm is implemented, which generates frequency corrections for the local \gls{glos:cavity_DDS} unit. This process is called local synchronization loop, which ensures that the phase of the gap voltage follows the phase of the Reference RF signal ~\cite{klingbeil_new_2011}. The path from the Group DDS 1 to Cavity 1 marked with the red line in Fig.~\ref{ref_rf_dis} is realized by the local cavity synchronization in Fig.~\ref{local_cavity_syn}. The \gls{glos:vit_DDS} is a virtual position around the ring, to which the Reference RF Signal corresponds.
\begin{figure}[H]
   \centering   
   \includegraphics*[width=110mm]{local_cavity_syn.png}
   \caption{Local Cavity Synchronization}{~\cite{klingbeil_new_2011}}
   \label{local_cavity_syn}
\end{figure}
\subsection{Longitudinal feedback system}
In order to damp coherent longitudinal dipole oscillations, the beam phase control loop is used. The phase difference between the beam signal and the Reference RF Signal is fed back via an FIR filter. The beam signal is obtained by a fast current transformer or a beam position monitor. The filter output is converted in a phase-correction and forwarded to the Group DDS. The corrections are added to the phase of the  frequency ramp in the Cavity DDS, which results in a change of the phase of the gap voltage and thus a feedback to the beam ~\cite{baudrenghien_low-level_2010}. Unfortunately, the actual beam phase control loop in SIS18 is not able to damp incoherent longitudinal dipole oscillations. For SIS100, a bunch-by-bunch longitudinal feedback system will be developed. The bunch-by-bunch longitudinal feedback system generates a correction voltage in dedicated feedback cavities for a specified bunch ~\cite{gross_bunch-by-bunch_2015}. 

\section{\gls{MPS} system}
A MPS protects current accelerator and subsequent accelerators or experiments from damage or unacceptable failure, e.g. the beam position is out of tolerance, the rf cavity failure and so on. Thereby, the individual equipment is assumed self-protecting, which could triggers accelerator safety critical actions, such as an emergency beam dump \footnote{A beam dump is a device designed to absorb the beam.}, a shutdown of magnets or a beam injection inhibit. In case of relevant equipment failures or other inappropriate equipment states, a MPS signal is generated from this equipment ~\cite{mandakovic_fair_????}. The FAIR B2B transfer must coordinate with the SIS100 emergency dump signal and the beam injection inhibit signal from the MPS. 

The SIS100 emergency dump signal indicates that the beam should be transferred to the emergency dump as soon as possible. If the beam injection inhibit signal is off, the B2B transfer extraction and injection kickers are allowed to be fired. If the beam injection inhibit signal is on, the injection and extraction kickers will be blocked for firing. 


\section{Comparison between the FAIR B2B transfer system and the current B2B transfer with the GSI control system}


% (~\cite{ferrand_synchronization_2015, ezura_beam-dynamics_2008})

% GSI old timing system
The existing GSI control system realizes the B2B transfer from the SIS18 to the ESR and from the ESR back to the SIS18. It is an event based system, that event execution will start immediately at the event receipt. Events are directly sent from a ``Pulszentrale``, who makes the schedule. Each accelerator has its own Pulszentrale, e.g. the ESR is equipped with the ESR-Pulszentrale and the SIS18 with the SIS-Pulszentrale. All devices are connected to distributed Equipment Controllers (EC) via field bus. ES is responsible for the receipt of the event and produces the pulse for the devices ~\cite{kainberger_pzs_2003, krause_re-engineering_2001}. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{GSI_control_system.jpg}
   \caption{The current realization of the bunch-to-bucket transfer between the SIS18 and the ESR with GSI control system.}
   \label{GSI_control_system}
\end{figure}
Fig. ~\ref{GSI_control_system} illustrates the current realization of the B2B transfer from the SIS18 to the ESR with the GSI control system. The SIS18 needs longer time for the preparation, e.g. the beam injection and the beam acceleration, before the extraction than that of the ESR before the injection, so the ESR is earlier fully prepared for the transfer. The preparation process is represented as red rectangle in Fig. ~\ref{GSI_control_system}. When the SIS18 is fully prepared with bunches to be transferred, the ready signal from the ESR-Pulszentrale and the SIS-Pulszentrale are forwarded into a logic $\textit{AND}$ gate. When both SIS18 and ESR are prepared, namely the output of the logic $\textit{AND}$ gate is high, the extraction kicker charge event is sent from the SIS-Pulszentrale and the injection kicker charge event from the ESR-Pulszentrale. The charge process of kicker is represented as yellow rectangle in Fig. ~\ref{GSI_control_system}. When two kickers are fully charged, the ready signal of the extraction and injection kickers from the ESR-Pulszentrale and the SIS-Pulszentrale are forwarded into the second logic $\textit{AND}$ gate, as well as the ``phase synchronization signal`` from the RF system. The phase synchronization signal indicates the alignment of the zero-crossing of the Reference RF Signals from Group DDS of the SIS18 and the ESR. The output of the second $\textit{AND}$ gate is an indication signal, starting the delay compensation of the time-of-flight and all propagation delays on the SIS18 cavity rf signal for the correct phase match between the SIS18 and ESR rf systems, denoted as ``delay for phase match`` in Fig. ~\ref{GSI_control_system}. ESR uses the injection orbit instead of the design orbit, so the circumference ratio between the SIS18 and the ESR is close to an integer, $C^{\mathit{SIS18}}/C^{\mathit{ESR}}=2-0.003$, the SIS18 has four bunches, $h^{\mathit{SIS18}}=4$ and ESR has two buckets, $h^{\mathit{ESR}}=2$, so $f^{\mathit{SIS18}}_{\mathit{rf}}/f^{\mathit{ESR}}_{\mathit{rf}}=4/(4-0.006)$. The phase difference between rf systems of the SIS18 and the ESR varies at the speed of the beating frequency $\Delta f=\SI{1898}{Hz}$, see Chap. ~\ref{application}. The required phase difference $\Delta\phi$ happens the delay for the required phase match $\Delta t$ after the indication signal, see eq. ~\ref{time_delay_beating}. 
\begin{equation}
\frac{1/\Delta f}{360^\circ} = \frac{\Delta t}{\Delta \phi}\label{time_delay_beating}
\end{equation}

When the delay for the required phase match is expired, trigger pulses are produced by the timing generator for both the SIS18 extraction and ESR injection kicker control electronics. Every kicker control electronics adds a separate delay to trigger pulses, denoted as ``extraction kicker delay`` and ``injection kicker delay`` in Fig. ~\ref{GSI_control_system}. the delay for the required phase match, extraction kicker delay and injection kicker delay are configurable by operators. The precision of the ignition signal from the kicker control electronics is \SI{1}{ns}. 

The existing B2B transfer with the GSI control system only supports the B2B transfer with the frequency beating method. It dose not support B2B transfer with the phase shift method. Parameters (e.g. the delay for the required phase match, the extraction kicker delay and the injection kicker delay) must be properly configured and adjusted by operators. The phase synchronization signal is delay compensated, but the transfer of the signal to the second $\textit{AND}$ gate is not delay compensated and with the jitter of \SI{1}{us}, resulting a default bunch-to-bucket injection center mismatch of $\pm 0.68^\circ$. Besides, it does not support buckets filling by multiple batches, e.g. eight out of ten SIS100 buckets are filled by four SIS18 batches, each of them has two bunches.

Compared with the current B2B transfer with the GSI control system, the FAIR B2B transfer system has many advantages. It supports both the phase shift and frequency beating methods. For the B2B transfer from the SIS18 to the ESR, it is with a smaller bunch-to-bucket injection center mismatch (see Chap. ~\ref{application}). The FAIR B2B transfer system is based on the GMT system, which is a time based system. All timing nodes of the GMT system are time synchronized with nano second accuracy, which achieves the smaller bunch-to-bucket injection center mismatch. Besides, the FAIR B2B transfer system is more flexible. It supports several B2B transfers running at the same time, e.g. the B2B transfer from the SIS18 to the SIS100 and B2B transfer from the ESR to the CRYRING. It is capable to transfer different species beam from one \gls{glos:machine_cycle} to another without the operator's configuration. It is capable to transfer the beam between two synchrotrons via a \gls{FRS}, Pbar or Super FRS. It can achieve various complex bucket pattern. What is more, the FAIR B2B transfer system coordinates with the MPS system, which protects SIS100/SIS300 from unacceptable failure or situation. 

%The phase difference between two RF systems of the source and target synchrotrons is achieved based on a campus distributed reference signal with picosecond precision, which is synchronized with BuTiS C2 and T0. This campus distributed reference signal is called ``Synchronization Reference Signal`` in this dissertation. The phase advance between the Synchronization Reference Signal $\psi_{ref}$ and the RF system $\psi$ is measured and extrapolated at the source and target synchrotrons, see eq. ~\ref{diff1} and eq. ~\ref{diff2}. The extrapolation is synchronized to BuTiS C2 and T0. 
%\begin{equation}
%\Delta \varphi1= \psi1-\psi_{ref} \label{diff1}
%\end{equation}
%\begin{equation}
%\Delta \varphi2= \psi2-\psi_{ref} \label{diff2}
%\end{equation}
%The extrapolated phase advance of one synchrotron is transferred to another synchrotron. The difference between the extrapolated phase advance of the source synchrotron and that of the target synchrotron is the phase difference between two RF systems $\psi1-\psi2$, see eq. ~\ref{diff3}.
%\begin{equation}
%\psi1-\psi2=\Delta \varphi1-\Delta \varphi2 \label{diff3}
%\end{equation}
%The existing B2B transfer system for CERN measures the phase difference between two synchrotrons by the direct cable transfer of the rf signal of one synchrotron to another synchrotron ~\cite{ferrand_synchronization_2015}. The phase measurement between two rf systems of the B2B transfer system for FAIR is more stable, which is less influenced by the external environment, e.g. temperature influence on the direct cable connection. It does not constraint by the distance between two synchrotrons.



  

%\section{$U^{28+}$ beam from SIS18 to SIS100}
%
%In this document, we use $U^{28+}$ B2B transfer from SIS18 to SIS100 as an example. So the supercycle of $U^{28+}$ beam of SIS18 and stacking of $U^{28+}$ beam of SIS100 are introduced in this section. 
%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=160mm]{SIS18-100-U28.jpg}
%   \caption{$U^{28+}$ beam from SIS18 to SIS100}
%   \label{SIS18-100-U28}
%\end{figure}
%
%In Fig.~\ref{ref_rf_dis}, SIS100 is operated at harmonic number 10, it holds 10 buckets in total, indicated by the row of ellipses in the lower part of the figure. SIS18 is operated at harmonic number 2. The beam is accumulated using four consecutive injections of two bunches each from SIS18 into different buckets. These four consecutive cycles are called super cycle. When the injection from SIS18 is completed, 8 neighbour buckets in SIS100 are filled. The bucket pattern is defined as the rules of the bucket filling. After that the complete beam of SIS100 is compressed in a single bunch at harmonic number 2.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\bibliography{main}
%\bibliographystyle{plain}


