

In this Chapter, the basic idea of the FAIR B2B transfer system is presented in Sec. 4.1. The standard procedure of the system is defined and described in Sec. 4.2. Sec. 4.3 illustrates how the basic functionality of the system are realized. In Sec. 4.4, the data flow of the system is described. In Sec. 4.5 the FAIR B2B transfer system is compared with the current B2B transfer. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5%%%%
\section{Basic Idea} 
The basic idea of the B2B transfer is simple. First of all, two rf systems of the source and target synchrotrons must be correct phase aligned. Secondly, the trigger for the extraction and injection kickers must be synchronized with beam. In the end, the actual beam injection point must be indicated, which qualifies the beam instrumentation (\gls{BI}) to measure the properties and the behavior of the beam directly after the injection. 

% .


\subsection{Phase Alignment}
The phase alignment is one of the most important prerequisites for the B2B transfer. It guarantees that extracted bunches will hit the dedicated empty buckets at the correct time. The phase alignment is based on the synchronization frequencies, see Sec. ~\ref{match}. When two rf systems have an identical cavity rf frequency or slightly different cavity rf frequencies, two cavity rf frequencies are chosen as the synchronization frequencies. When two rf systems have hugely different cavity rf frequencies, two synchronization frequencies are an integral multiple of the same or slightly different derived rf frequencies, which are a division of the revolution frequencies. For more details about the calculation of the synchronization frequencies, see Sec. ~\ref{match}. If two synchronization frequencies of two rf systems are same, the phase difference between two rf systems is constant. The phase difference can be adjusted by the phase shift method or the frequency beating method with the frequency detuning on one (or both) rf system. If two synchronization frequencies of two rf systems are slight different, the phase difference is adjusted automatically because of the beating frequency. %The beating frequency must not be too small in order to satisfy the constraint of the maximum synchronization time, but also not too large to guarantee the precision of the phase alignment. 

% .

Before the basic steps for the achievement of the phase alignment, some basic concepts and their symbols are introduced, see Fig.~\ref{ext_inj_kicker}.

\begin{itemize}
\item[-] The bucket delay \gls{symb:bucket_pattern}, which specifies a certain bucket to be injected by delaying a certain number of the rf period to a marker.
\item[-] The Time-Of-Flight (\gls{TOF}) between two synchrotrons \gls{symb:two_TOF}. 
\item[-] The Time-Of-Flight between the virtual rf cavity and the extraction/injection kicker, \gls{symb:tsrc} and \gls{symb:ttrg}. 
\item[-] The sum of the kicker preparation time, the rise time and the propagation delay of the kicker trigger signal in the cable of an extraction kicker and that of an injection kicker, \gls{symb:ext_pre} and \gls{symb:inj_pre}.
\end{itemize}
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{syc_ext_inj.jpg}
   \caption{The illustration of the B2B transfer from the SIS18 to the SIS100.}
	\caption*{\textsl{\small{The blue dot represents a bunch, red ones buckets.}}}
   \label{ext_inj_kicker}
\end{figure}
Fig.~\ref{ext_inj_kicker} illustrates the B2B transfer from the SIS18 to the SIS100. The SIS18 $U^{28+}$ super cycle consists of four SIS18 cycles. Each cycle produces two $U^{28+}$ bunches. From the SIS18, four batches, each of two bunches, are injected into eight out of ten buckets of the SIS100. The SIS18 $H^{+}$ super cycle consists of four SIS18 cycles. Each cycle produces one $H^{+}$ bunch. From the SIS18, four batches, each of one bunch, are injected into four out of ten buckets of the SIS100 ~\cite{liebermann_fair_2013, liebermann_sis100_2013}. The SIS18 and SIS100 revolution frequency markers (black bars on the first time axis and bars on the second/third time axis in Fig.~\ref{ext_inj_kicker}) indicate the time when a bunch or the first bucket ($\sharp1$) pass by the virtual rf cavity. The extraction and injection kicker trigger have a delay with respect to the first bars of the SIS100 revolution frequency marker at the SIS18 and at the SIS100. This delay is called the ``extraction/injection kicker delay compensation``. The mentioned four instances of time are related to the second bars of the SIS100 revolution frequency marker. \gls{symb:period_rev} represents the revolution period of the synchrotron X, e.g. the SIS18 revolution period is $T_{\mathit{rev}}^{\mathit{SIS18}}$. \gls{symb:period_rf} represents the period of the cavity rf frequency of the synchrotron X, e.g. the SIS18 rf period of the cavity rf frequency is $T_{\mathit{rf}}^{\mathit{SIS18}}$. After the rf phase alignment, the time difference between the SIS18 and SIS100 synchronization frequency (denoted as \gls{symb:diff_sync}) for the $U^{28+}$ and $H^{+}$ odd bucket injection is
\begin{equation}
	t_{\mathit{diff\_sync}}=(t_{\mathit{v\_ext}}+t_{\mathit{TOF}}+t_{\mathit{v\_inj}}) \mod 1/f_\mathit{syn}^\mathit{trg}
\end{equation}
For the $H^{+}$ even bucket injection \gls{symb:diff_sync} is
\begin{equation}
t_{\mathit{diff\_sync}}=(t_{\mathit{v\_ext}}+t_{\mathit{TOF}}+t_{\mathit{v\_inj}}- T_{\mathit{rf}}^{\mathit{SIS100}}) \mod 1/f_\mathit{syn}^\mathit{trg} 
\end{equation}
The phase alignment for the odd or even bucket injection is informed by the ``extra phase shift`` from the SM. For more details about the use cases of the B2B transfer from the SIS18 to the SIS100, please see Sec. \ref{sec:cir_no_int} and Sec. \ref{sec:cir_no_int1}. For more details about the parameters of the B2B transfer system from the SM, please see Appendix ~\ref{parameter_SM}.  
%Fig.~\ref{ext_inj_kicker} takes $U^{28+}$ B2B transfer from the SIS18 to the SIS100 as an example. the SIS18 operates with harmonic number of 2 (h = 2), forming two bunches. From the SIS18, 4 batches, each of 2 bunches, are transferred into continuous 8 out of 10 the SIS100 buckets ~\cite{liebermann_fair_2013, liebermann_sis100_2013}. The harmonic number of the SIS100 is 10. 

For the phase alignment, the steps below must be carried out. 
\begin{enumerate}
\item The measurement of the phase of the rf system and the corresponding timestamp in each synchrotron.
\item The exchange of the measured phase and the timestamp.
\item The phase comparison between two rf systems.
\item The adjustment of the phase on one (or both) rf system, when the phase shift method is used. 
\item The calculation of the time duration for the required phase alignment of two rf systems.
\end{enumerate}

\subsection{Trigger of Extraction and Injection Kickers}
\label{sec:compensation}
For the proper B2B transfer, not only the relative position of bunches and buckets, but also the firing of the extraction and injection kickers must be precisely controlled. The extraction kicker must kick the bunch exactly the time-of-flight earlier before a specific bucket passes the injection kicker and the transition of the magnetic field must be carried out during the bunch gap. For the calculation of the trigger time for the extraction and injection kickers, the following steps must be processed. 
%The kicker time contains the rise time, the flat-top and the fall time, see Sec. ~\ref{sec:kicker}. 
\begin{enumerate}
\item The kicker firing requires the bunch-to-bucket injection center phase mismatch within a upper bound, which defines a ``coarse synchronization``.
\item The bucket label requires the kicker firing based on a bucket indication signal for the first bucket (e.g. the SIS100 revolution frequency markers in Fig. ~\ref{ext_inj_kicker}) plus a
fixed delay (the extraction/injection kicker delay compensation), for more details please see Sec. ~\ref{sec:bucket_label}. With the help of the bucket label, bunches are injected into correct buckets. This process is called the ``fine synchronization``.
\end{enumerate}

\subsubsection{Bucket Indication Signal}
The bucket indication signal of the phase shift method or the frequency beating method indicates the passing time of the first bucket of the target synchrotron, when the first bucket is correct or periodical phase aligned with a bunch of the source synchrotron for the bunch-to-bucket injection. For FAIR use cases, we have $f_\mathit{syn}^{X}=Y\cdot f_\mathit{rev}^{X}/m$ and either $m/Y$ or $Y/m$ must be an integer, see Sec. ~\ref{match}. There exist either that the revolution period is the integer times of the period of the synchronization frequency or that the period of the synchronization frequency is the integer times of the revolution period. The first bucket of the target synchrotron is indicated by $f_{\mathit{rev}}^{trg}$. The correct or periodical phase alignment of the rf system of the target synchrotron with the rf system of the source synchrotron is indicated by $f_{\mathit{syn}}^{trg}$. Hence, the bucket indication signal (denoted as ``\gls{symb:bucket_freq}``) is either with the revolution frequency or the synchronization frequency of the target synchrotron. It depends on the relation between the revolution frequency and the synchronization frequency of the target synchrotron. When the synchronization frequency of the target synchrotron is greater than or equal to the revolution frequency of the target synchrotron, namely the period of the synchronization frequency is equal to or less than the revolution period, the period of the synchronization frequency is not long enough to include all buckets. In this case, the frequency of the bucket indication signal equals to the revolution frequency of the target synchrotron and the length of the synchronization window equals to one revolution period. On the contrary, the the frequency of the bucket indication signal equals to the synchronization frequency of the target synchrotron and the length of the synchronization window equals to the period of the synchronization frequency. The frequency of the bucket indication signal is expressed as
\begin{eqnarray}
\label{bucket_ind}
f_\mathit{bucket}=
\begin{cases}
f_\mathit{rev}^\mathit{trg} &f_{\mathit{syn}}^{trg}\ge f_{\mathit{rev}}^{trg}\cr

f_\mathit{syn}^\mathit{trg}
&f_{\mathit{syn}}^{trg}<f_{\mathit{rev}}^{trg}
\end{cases}
\end{eqnarray}

The corresponding length of the synchronization window is expressed as
\begin{eqnarray}
T_\mathit{w}=\frac{1}{f_\mathit{bucket}}
\begin{cases}
T_\mathit{rev}^\mathit{trg} &f_{\mathit{syn}}^{trg}\ge f_{\mathit{rev}}^{trg}\cr

T_\mathit{syn}^\mathit{trg}
&f_{\mathit{syn}}^{trg}<f_{\mathit{rev}}^{trg}
\end{cases}
\end{eqnarray}


Fig. ~\ref{bucket_label_occurrence} shows one example when the frequency of the bucket indication signal equals to the revolution frequency of the target synchrotron. Fig. ~\ref{bucket_label_occurrence1} shows one example when the frequency of the bucket indication signal equals to the synchronization frequency of the target synchrotron. 
%bucket_label_signal_choose.docx
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{bucket_label_occurrence.jpg}
   \caption{The frequency of the bucket indication signal equals to the revolution frequency of the target synchrotron.}
	\caption*{\textsl{\small{Red dots represent buckets of the target synchrotron and blue ones represent bunches of the source synchrotron. This example is the FAIR use case of the $H^+$ B2B transfer from the SIS18 to the SIS100. The correct phase alignment of two rf systems is assumed with $\Delta\phi_\mathit{syn}=0^\circ$ and only the buckets with the odd number (e.g. $\sharp1$, $\sharp3$ ) are to be filled in this example.}}}
   \label{bucket_label_occurrence}
\end{figure}

\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{bucket_label_occurrence1.jpg}
   \caption{The frequency of the bucket indication signal equals to the synchronization frequency of the target synchrotron.}
	\caption*{\textsl{\small{Red dots represent buckets of the target synchrotron and blue ones represent bunches of the source synchrotron. This example is the FAIR use case of the B2B transfer from the CR to the HESR. }}}
   \label{bucket_label_occurrence1}
\end{figure}



\subsubsection{Extraction and Injection Kicker Delay Compensation}
The calculation of the extraction and injection kicker delay compensation is explained in this section.
%The kicker magnet must have zero magnetic field when bunches pass by it and the kicker magnet only can be switched on during bunch gaps. Bunch gaps depend on the cavity rf frequency, the bucket pattern and the bunch length. 

\begin{itemize}
\item Extraction kick

In order to inject into specific buckets, the extraction kicker delay compensation for the first bar of the SIS100 revolution frequency marker is $T_{\mathit{rev}}^{\mathit{SIS100}} + t_{\mathit{bucket}}$, see Fig.~\ref{ext_inj_kicker}. For example, when two $U^{28+}$ bunches of the SIS18 are to be injected into buckets $\sharp3$ and $\sharp4$ of the SIS100, $t_{\mathit{bucket}} =1 \cdot T_{\mathit{rev}}^{\mathit{SIS18}}$. The extraction kicker must be fired $t_{\mathit{v\_inj}}+t_{\mathit{TOF}}+t_{\mathit{ext}}$ earlier as the bucket passes the virtual rf cavity, so the extraction kicker delay compensation is $T_{\mathit{rev}}^{\mathit{SIS100}} + t_{\mathit{bucket}} - (t_{\mathit{TOF}} + t_{\mathit{v\_inj}} + t_{\mathit{ext}})$. 

\item Injection kick

With the consideration of the \gls{glos:bucket_pattern}, the injection kicker delay compensation for the first bar of the SIS100 revolution frequency marker is $T_{\mathit{rev}}^{\mathit{SIS100}} + t_{\mathit{bucket}}$, see Fig.~\ref{ext_inj_kicker}. The injection kicker must be fired $t_{\mathit{v\_inj}}+t_{\mathit{inj}}$ time earlier as the bucket passes the virtual rf cavity, so the injection kicker delay compensation is $T_{\mathit{rev}}^{\mathit{SIS100}} + t_{\mathit{bucket}} - (t_{\mathit{v\_inj}} + t_{\mathit{inj}})$.
\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5%%%%
\section{Basic Procedure}
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{2method.jpg}
   \caption{The procedure for the B2B transfer within one acceleration cycle.}
	\caption*{\textsl{\small{As illustrated here the procedure with the frequency beating method (blue, top) and that with the phase shift method (green, bottom).}}}
   \label{2method}
\end{figure}
Fig.~\ref{2method} illustrates the basic procedure of the B2B transfer with two different synchronization scenarios. The yellow region shows the synchronization window. The purple region shows the valid time for the emergency kicker. %The emergency kickers can be triggered at any time during the acceleration cycle by the MPS.  


The B2B transfer process basically needs to follow the six steps ~\cite{bai_bunch_2015}:
\begin{enumerate}
\item The DM announces the B2B transfer and requests the switch off of the beam feedback loops on the rf system, when required.
\item Two synchrotrons measure the rf phase locally.
\item The source synchrotron receives the measured rf phase from the target synchrotron.
\item The source synchrotron does the B2B related calculation.
\begin{enumerate}
\item[-] The source synchrotron calculates the synchronization window and sends it to the target synchrotron and to the DM. 

The source synchrotron generally accomplishes the phase alignment in case of the phase shift method. A particular case is the empty target synchrotron. The phase alignment can be achieved very fast and simple by the phase jump at the target synchrotron. Although the synchronization window is theoretically infinite for the phase shift method, bunches should be transferred as soon as the phase shift is done, in order to guarantee the stability of the beam. For both synchronization methods, the synchronization window has a certain length.

\item[-] Besides, the \gls{glos:bucket_label} is reproduced at the source synchrotron for the indication of the $1^\mathit{st}$ bucket.
\end{enumerate}
\item The trigger signals with the delay compensation are generated for the kickers.
\item The kicker electronic fire the kickers. The extraction and injection kicker trigger and firing timestamp are sent to the source synchrotron for the B2B status check. The actual beam injection timestamp and the B2B transfer status are send from the source synchrotron to the DM and the DM sends them further to the BI.

\end{enumerate}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\section{Description of the $U^{28+}$ B2B process from the SIS18 to the SIS100 with the phase shift method}
%
%Here the $U^{28+}$ at \SI{200}{meV/\atomicmassunit} B2B transfer from the SIS18 to the SIS100 will be described in detail. 
%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=150mm]{18to100Phase.png}
%   \caption{The B2B transfer inside one the SIS18 $U^{28+}$ Super Cycle with the phase shift method.}
%   \label{18to100Phase}
%\end{figure}
%Fig.~\ref{18to100Phase} shows one the SIS18 $U^{28+}$ super cycle. It consists of four the SIS18 cycles. Each cycle produces two bunches. From the SIS18, four cycles of the $U^{28+}$, each of two bunches, are injected into eight out of ten buckets of the SIS100. In each the SIS18 cycle, the beam is accelerated to the top energy after injection. At the rf flattop, the synchronization is implemented with the phase shift method by modulating rf frequency. 
%The ratio of the SIS100 circumference to the SIS18 circumference is 5. The harmonic number for the SIS100 is 10 and for the SIS18 is 2. At the flattop, the rf cavity rf frequency of the SIS18 is \SI{1.572}{MHz} as that of the SIS100, so the phase difference between two rf signals is almost constant. To perform the B2B transfer, this phase difference must be corrected to compensate for the required phase difference by phase shift. The frequency ramp at the start and end of the SIS18 frequency modulation must be performed adiabatically. Here we use a parabola rf frequency modulation, more details please see Sec. 5.1.1.  Then the time for a phase shift of  $\pi$ is \SI{7}{\ms}.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\section{Description of the $U^{28+}$ B2B process from the SIS18 to the SIS100 with the frequency beating method}
%For the frequency beating method of the $U^{28+}$ at \SI{200}{meV/\atomicmassunit} B2B transfer from the SIS18 to the SIS100, we assume to detune \SI{200}{Hz} for the SIS18 rf signal during the acceleration ramp. The beating frequency is \SI{200}{Hz} and the synchronization period is \SI{5}{\ms}.
%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=150mm]{18to100freq.png}
%   \caption{The B2B transfer inside one the SIS18 $U^{28+}$ Super Cycle with the frequency beating method.}
%   \label{18to100freq}
%\end{figure}
%Fig.~\ref{18to100freq} illustrates the standard synchronization process with the frequency beating method. In order to guarantee that eight sequential buckets will be filled by eight bunches, the synchronization window should be at least twice as long as the SIS100 revolution period. The accuracy within the synchronization window is better than $0.5^\circ$. 
%
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Realization}
This section describes the realization of the FAIR B2B transfer system based on the FAIR control system and LLRF system introduced in Chap. ~\ref{technical}.

The phase alignment is based on the phase difference between two synchronization frequencies. Because it is not preferable to have a direct connection between two synchrotrons around such a big FAIR campus for a direct phase measurement based on the existing technical basis, a shared reference sinusoidal signal (which is called “\gls{glos:Syn_ref_signal}” and denoted as \gls{symb:syn_ref}) derived from BuTiS is used for the indirect phase difference measurement. The synchronization reference signal has the same frequency and is in phase in different supply rooms. The phase measurement of each rf system is based on the frequency beating between the synchronization frequency and the \gls{glos:Syn_ref_signal}, achieved by measuring the phase deviation between these two frequencies. The phase advance is extrapolated based on the measured phase deviations. The phase difference is calculated by the subtraction of the extrapolated phase advance of the target synchrotron from the extrapolated phase advance of the source synchrotron. 

For the reproduction of the bucket indication signal at the source synchrotron, the phase deviation between the bucket indication signal and the \gls{glos:Syn_ref_signal} is measured and then the phase advance is extrapolated at the target synchrotron. For the target synchrotron, the extrapolated phase advance between the bucket indication signal and the \gls{glos:Syn_ref_signal} is either equal to or related to that between the synchronization frequency and the \gls{glos:Syn_ref_signal}, so one phase deviation measurement and the corresponding phase advance extrapolation are sufficient for both the phase alignment and the reproduction of the bucket indication signal, reducing the data transfer of the system and the transfer delay on the WR network. Besides, every phase deviation measurement and the phase advance extrapolation process needs \SI{500}{us}, so one phase deviation measurement and the corresponding phase advance extrapolation is preferred due to the time constraints (see Chap. ~\ref{realization}).

Because the phase of the high harmonic frequency can be deduced from the phase of the low harmonic frequency, the frequency for the phase deviation measurement of the target synchrotron is chosen the smaller one of the synchronization frequency and the frequency of the bucket indication signal. The frequency for the phase deviation measurement is called ``phase measurement signal`` and denoted as \gls{symb:B2B_ref}. From the equation of the frequency of the bucket indication signal, see eq. ~\ref{bucket_ind}, we know that $f_\mathit{bucket}$ is always the smaller one. Hence, the frequency of the phase measurement signal of the target synchrotron is
\begin{eqnarray}
f_{\mathit{B2B}}^{trg}=f_{\mathit{bucket}}
\begin{cases}
f_{\mathit{syn}}^{trg} &f_{\mathit{bucket}}=f_{\mathit{syn}}^{trg}\cr

f_{\mathit{rev}}^{trg} &f_{\mathit{bucket}}=f_{\mathit{rev}}^{trg}
\end{cases}
\end{eqnarray}

The measurement of the phase deviation is based on the frequency beating between the phase measurement signal and the \gls{glos:Syn_ref_signal}, so the frequencies of these two signals must be slightly different for the phase measurement and prediction. The phase extrapolation requires at least two samples for every beating period, so the maximum beating frequency is approximately \SI{150}{kHz}. There must be a proper phase measurement signal corresponding to $f_{\mathit{B2B}}^{trg}$ at the source synchrotron.
\begin{eqnarray}
f_{\mathit{B2B}}^{src}=
\begin{cases}
f_{\mathit{syn}}^{src} &f_{\mathit{bucket}}=f_{\mathit{syn}}^{trg}\cr

\frac{h_{\mathit{rev}}^{trg}}{h_{\mathit{syn}}^{trg}}f_{\mathit{syn}}^{src} &f_{\mathit{bucket}}=f_{\mathit{rev}}^{trg}
\end{cases}
\end{eqnarray}

The \gls{glos:Syn_ref_signal} has a fixed frequency and is always in phase in different supply rooms. It is a sinusoidal wave, whose frequency is a multiple of BuTiS T0 \SI{100}{kHz} and whose positive zero-crossings are always aligned with the first positive zero-crossings of C2 clocks after T0 edges (which is called the ``\gls{glos:T0_incidents}``) ~\cite{ferrand_system_2014, ferrand_system_2015}. Thus, the synchronization reference signal is synchronous in different supply rooms by definition. The frequency of the synchronization reference signal \gls{symb:syn_ref} is determined by $f_{\mathit{B2B}}^{X}$ and calculated as

\begin{equation}
\label{round}
	f_\mathit{ref}=\textit{round} (f_\mathit{B2B}^{X}/\SI{100}{kHz})\cdot \SI{100}{kHz}
\end{equation}

The function \textit{round} rounds $f_\mathit{B2B}^{X}/\SI{100}{kHz}$ up or down to an integer value, which is closest to $f_\mathit{B2B}^{X}/\SI{100}{kHz}$. e.g. $f_\mathit{B2B}^{SIS100}=f_\mathit{rev}^{SIS100}=\SI{157.254}{kHz}$, $f_\mathit{B2B}^{SIS100}/\SI{100}{kHz}=1.57$, so $\textit{round} (f_\mathit{B2B}^{SIS100}/\SI{100}{kHz})=2$ and $f_\mathit{ref}=\SI{200}{kHz}$. This is the FAIR use case of the $U^{28+}$ B2B transfer from the SIS18 to the SIS100, more details, please see Chap. ~\ref{application}. When $|f_\mathit{B2B}^{X}/\SI{100}{kHz}|<1$, $f_\mathit{ref}=\SI{100}{kHz}$.  For the detailed realization of the synchronization reference signal, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_????}.

 
%Fig.~\ref{Topology} shows the topology of the B2B transfer system ~\cite{bai_bunch_2015, bai_concept_2016}.
%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=150mm]{Topology.jpg}
%   \caption{The topology of the B2B transfer system}
%   \label{Topology}
%\end{figure}
%
%The B2B transfer system includes four main SCUs.
%\begin{enumerate}
%\item REF SCU provides the phase measurement signals for a group of cavities in one synchrotron. 
%\item COPY SCU is used for the phase measurement.
%\item B2B SCU
%\item Trigger SCU provides trigger for the kickers in each synchrotron.
%\end{enumerate}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Phase measurement %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Phase Measurement and corresponding Timestamp of each Rf System}
The rf frequencies in the source and target synchrotron need to be stable and constant during the B2B transfer process. The phase measurement of each rf system follows the principles as shown below.

\begin{enumerate}
\item The measurement of the actual phase values.
\item The extrapolated phase values into the future based on the measured phase values.
\item The timestamp for the extrapolated phase values.
\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 \subsubsection{Measurement of Actual Phase Values of each Rf System}
The phase measurement of each rf system is achieved by measuring the phase deviation between the phase measurement signal and the \gls{glos:Syn_ref_signal} of a synchrotron. The phase deviation (denoted by \gls{symb:phase_diff}) has a linear relationship with time, whose range is from $-\pi$ to $+180^\circ$. 
\begin{equation}
\Delta \varphi^X(t)= [(k^\mathit{X}t+\Delta \varphi^X_0) \mod 2\pi] - \pi
%\Delta \varphi^X(nT_\mathit{sample})= k^\mathit{X}nT_\mathit{sample}+\Delta \varphi^X_0
\end{equation}
where $k^\mathit{X}$ is the slope of the phase deviation and $\Delta \varphi^X_0$ the initial value of the phase deviation.
%The phase measurement signal of the target synchrotron has the same frequency as the bucket indication signal. Due to two scenarios of the frequency of the bucket indication signal, there are two scenarios of the frequencies of the phase measurement signals. 



\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{phase_prediction.jpg}
   \caption{The realization of the phase deviation measurement at one synchrotron}
   \label{phase_prediction}
\end{figure}

Fig.~\ref{phase_prediction} shows the phase measurement of the rf system at a dedicated synchrotron. The red sinusoidal wave represents the synchronization reference signal (e.g \SI{200}{kHz}) in a supply room and the black wave the phase measurement signal (e.g. \SI{157.254}{kHz}) from the \gls{glos:group_DDS}. The phase deviation between the phase measurement signal and the synchronization reference signal is measured by the Phase Advance Measurement (\gls{PAM}) module at the source synchrotrons and at the target synchrotron. The phase deviation measurement is performed synchronously to an internal clock, which is represented by the blue dots. This measurement is asynchronously to the BuTiS reference clock. The measured phase deviation can be expressed as
\begin{equation}
\Delta \varphi^X(nT_\mathit{sample\_PAM})=[( k^\mathit{X}\cdot nT_\mathit{sample\_PAM}+\Delta \varphi^X_0) \mod 2\pi ]-\pi
\end{equation}
where \gls{symb:sample_period_PAM} is the measurement sampling period of the phase deviation by the PAM module.

For more details about the implementation and realization of the PAM module, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_????}. 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Phase extrapolate %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Phase Extrapolation of each Rf System}
The phase deviation can be extrapolated due to the linear relationship between time and the phase deviation. 

Based on a series of the measured samples of the phase deviation, the phase deviation at the T0 incidents (denoted by \gls{symb:phase_diff_T0} and called the ``extrapolated phase advance``) are extrapolated at the source and target synchrotrons by the Phase Advance Prediction (\gls{PAP}) Module.
\begin{equation}
\psi^\mathit{X}(n)=\Delta \varphi^X(nT_\mathit{sample\_PAP})
\end{equation}
where \gls{symb:sample_period_PAP} is the extrapolation sampling period of the phase extrapolation by the PAP module, $T_\mathit{sample\_PAP}=1/\SI{100}{kHz}$.

The extrapolated phase advance, $\psi^\mathit{src}$ and $\psi^\mathit{trg}$ at the source and target synchrotron, is represented by red diamonds in Fig.~\ref{phase_prediction1}. Because the phase advance is extrapolated at the T0 incidents and the synchronization reference signal is zero phase aligned with the \gls{glos:T0_incidents}, $\psi^\mathit{src}$ and $\psi^\mathit{trg}$ are the phase of the phase measurement signals at the virtual rf cavities of two synchrotrons at the T0 incidents (represented as black dots in Fig.~\ref{phase_prediction1}). For more details about the implementation and realization of the PAP module, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_????}.   
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{phase_prediction1.jpg}
   \caption{The realization of the phase advance extrapolation at one synchrotron}
   \label{phase_prediction1}
\end{figure}
 %%%%%%%%%%%%%%%%%%%%%%Rf phase difference synchronous to the absolute time stamping%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Timestamp of Extrapolated Phase}
The extrapolated phase advance is synchronized with T0 incidents by the PAP module, but it is not synchronized with the absolute time. This is one of the tasks of the multi-purpose B2B source and target SCUs ~\cite{beck_new_2012, thieme_scu_2013}, which are located in the source and target synchrotrons. The PAP module is a SCU slave \footnote{\url{https://en.wikipedia.org/wiki/Master/slave_(technology)}}, respectively integrated into the B2B source SCU and B2B target SCU, see Fig.~\ref{PAP}. Both the B2B source and target SCUs could get the timestamp of the T0 incidents. 
 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{PAP.png}
   \caption{Integration of the Phase Advance Prediction Module into the B2B source SCU}
   \label{PAP}
\end{figure}

Fig.~\ref{phase_diff_syn_time} illustrates the synchronization of the extrapolated phase to the timestamp. The DM broadcasts the timing frame of \verb|CMD_B2B_START| to the WR network. This timing frame will be received by the \gls{glos:B2B_s_SCU} and the \gls{glos:B2B_t_SCU}. The B2B source and target SCUs start the B2B process at a designated time (represented as the pink dot in Fig.~\ref{phase_diff_syn_time}). The timestamp of the start is an integer multiple of \SI{10}{\us}, the period of the T0 incident. They need maximum \SI{1}{\us} to inform the PAP modules to start the phase advance extrapolation respectively. The PAP modules needs approximately \SI{500}{\us} for the phase extrapolation and updates the extrapolated phase value every T0 incident. After \SI{500}{\us}, the B2B source and target SCUs need another maximum \SI{1}{\us} to receive the extrapolated phase \gls{symb:phase_diff_time0} (represented as the red diamond in Fig.~\ref{phase_diff_syn_time}) from the PAP modules, as well as the slope of the phase deviation \gls{symb:slope}. They also timestamp the T0 incidents \gls{symb:time_phase_diff_T0} which corresponds to the extrapolated phase. The B2B source SCU obtains $\psi^\mathit{src}_0$, $t_\psi^\mathit{src}$ and $k^\mathit{src}$ at the source synchrotron and the B2B target SCU obtains $\psi^\mathit{trg}_0$, $t_\psi^\mathit{trg}$ and $k^\mathit{trg}$ at the target synchrotron. In fact, $t_\psi^\mathit{src}=t_\psi^\mathit{trg}$.
 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{phase_diff_syn_time.jpg}
   \caption{The synchronization of the extrapolated phase to the timestamp in one synchrotron}
   \label{phase_diff_syn_time}
\end{figure}

Because the phase deviation of the phase measurement signal complies with the linear relation with time, the evolution of the phase deviation between the phase measurement signal and the synchronization reference signal can be calculated for any T0 incidents, see eq. ~\ref{advance_phase}, which will be used for the phase correction of the bucket indication signal in sec. ~\ref{sec:bucket_label}.
\begin{equation}
\label{advance_phase}
\Delta \varphi^\mathit{X}(t_\mathit{\psi}^\mathit{X}+nT_\mathit{sample\_PAP})=[(\psi^\mathit{X}_0+k^\mathit{X}\cdot nT_\mathit{sample\_PAP}) \mod 2\pi] - \pi
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Exchage data %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Exchange of Measured Data}

For the B2B transfer, there is a ``\gls{glos:B2B_master}``, which is responsible for the data collection of two synchrotrons, the data calculation, the data redistribution and the B2B transfer status check. The data of the source and target synchrotron must be transferred to the B2B transfer master via the deterministic WR network in the format of the timing frame.
 
For the simplicity, the B2B source SCU works as the B2B transfer master, so the extrapolated phase $\psi^\mathit{trg}_0$, the corresponding timestamp $t_\psi^\mathit{trg}$ and the phase deviation slope $k^\mathit{trg}$ are transferred by the B2B target SCU to the B2B source SCU via the WR network. The transfer of the data is achieved by the \gls{glos:timing_frame} \verb|TGM_PHASE_TIME|. The B2B transfer involves a certain amount of timing frames. For more details about the B2B timing frames, please see Appendix A. The timing frames are not sent via the DM in order to reduce the traffic of the WR network and reduce the timing frame transfer delay on the WR network ~\cite{bai_concept_2016}, so a specified VLAN, B2B \gls{VLAN}, is defined for the B2B timing frames. All SCUs for the B2B transfer are assigned to the B2B VLAN. Fig.~\ref{network_B2B} illustrates an example of the transfer path of the B2B timing frames in the WR network. The frames are transferred along the path with orange color instead of the path with blue color. The test for the transfer delay of the B2B timing frames on the WR network is explained in Chap. ~\ref{realization}.
 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{network_B2B.jpg}
   \caption{One example of the transfer path of the B2B timing frames in the WR network}
   \label{network_B2B}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% rf synchronization %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Rf Synchronization}
The FAIR B2B transfer system is available for both the phase shift and frequency beating methods, see Sec. \ref{two_sync_methods}. The rf synchronization of two synchrotrons is based on the phase difference between two synchronization frequencies of two rf systems $\Delta \phi_\mathit{syn}$. $\Delta \phi_\mathit{syn}$ is calculated from the measurement of the phase difference between the phase measurement signals of two rf systems. 
\begin{eqnarray}
\Delta \phi_\mathit{syn}=
\begin{cases}
(\psi^\mathit{trg}_0-\psi^\mathit{src}_0) \mod 2\pi
&f_{\mathit{bucket}}=f_{\mathit{syn}}^{trg}\cr

\frac{h_{\mathit{syn}}^{trg}}{h_{\mathit{rev}}^{trg}}(\psi^\mathit{trg}_0-\psi^\mathit{src}_0) \mod 2\pi
&f_{\mathit{bucket}}=f_{\mathit{rev}}^{trg}
\end{cases}
\end{eqnarray}

$\Delta \phi_\mathit{syn}$ is within the range between $0$ and $2\pi$. The SM provides the target time difference between the synchronization frequencies of two rf systems $t_{\mathit{diff\_sync}}$, which considers the delay compensation for TOF, all propagation and the extra phase shift. The B2B source SCU calculates the required phase shift (denoted as \gls{symb:pha_shift_shift}) based on $t_{\mathit{diff\_sync}}$ and $\Delta \phi_\mathit{syn}$. %If the SIS100 odd buckets need to be injected by one SIS18 $H^+$ bunch, the extra phase shift equals to $0$, If the SIS100 even buckets need to be injected by one SIS18 $H^+$ bunch, the extra phase shift equals to $\pi$. 

With the phase shift method, a frequency modulation with a fixed duration is applied to the Group DDS with the synchronization frequency of one (or both) rf system. The rf frequency modulation achieves the phase shift of $\Delta \phi_\mathit{shift}$. With the frequency beating method, the phase difference varies at the rate of the synchronization frequency difference between two rf systems. Two rf systems are synchronized when the phase difference between two synchronization frequencies equals to $\Delta \phi_\mathit{shift}$. 

\subsubsection{Rf Synchronization with Phase Shift Method}

%\begin{equation}
%\Delta \phi_{shift}= 2\pi \int_{t_0}^{t_0+T} \Delta f_{rf}(t)dt \label{phase}
%\end{equation}
%The required phase shift is determined by the frequency offset \gls{symb:freq_modulation} and the duration of the frequency modulation $T$.
%Eq.~\ref{phase1} gives the relation between the required phase shift and the frequency modulation. The phase shift must be executed adiabatically, see Sec. \ref{two_sync_methods}.
For the rf synchronization, the maximum required phase shift of the synchronization frequency is $2\pi$. In order to accomplish the phase alignment as fast as possible, the phase shift will be conducted backward or forward. Therefore a phase shift of up to $\pm \pi$ will be considered for the Group DDS with regard to the synchronization frequency $f_\mathit{syn}^X$. The required phase shift is calculated as
\begin{eqnarray}\Delta \phi_\mathit{shift}=
\begin{cases} 
%4\pi+ \Delta \phi_\mathit{shift\_raw} & -4\pi<\Delta \phi_\mathit{shift\_raw}\le-3\pi \cr

%2\pi+ \Delta \phi_\mathit{shift\_raw} & -3\pi<\Delta \phi_\mathit{shift\_raw}\le-\pi \cr

\Delta \phi_\mathit{shift\_raw} & 0<\Delta \phi_\mathit{shift\_raw}\le\pi \cr

\Delta \phi_\mathit{shift\_raw} -2\pi &  \pi<\Delta \phi_\mathit{shift\_raw}\le2\pi 

%(\Delta \phi_\mathit{shift\_raw} \mod 2\pi) -2\pi &  3\pi<\Delta \phi_\mathit{shift\_raw}\le4\pi 

\label{phase_shift_eq}
\end{cases}
\end{eqnarray}
where \gls{symb:raw_shift_shift} represents the raw value of the required phase shift for the synchronization frequency, which is within the range between $0$ and $2\pi$.
 \begin{equation}
\Delta \phi_\mathit{shift\_raw}= (\Delta \phi_\mathit{syn}-t_{\mathit{diff\_sync}}  \cdot f_\mathit{syn}^\mathit{trg}\cdot 2\pi) \mod 2\pi 
\end{equation}

The required phase shift is implemented to the Group DDS with the revolution frequency, so the required phase shift on the revolution frequency (denoted as \gls{symb:imp_shift_shift}) is 
\begin{eqnarray}\Delta \phi_\mathit{shift\_imp}=
\begin{cases} 
\Delta \phi_\mathit{shift\_raw}' & 0<\Delta \phi_\mathit{shift\_raw}'\le\pi \cr

\Delta \phi_\mathit{shift\_raw}' -2\pi &  \pi<\Delta \phi_\mathit{shift\_raw}'\le2\pi 
\end{cases}
\end{eqnarray}
where \gls{symb:raw1_shift_shift} represents the raw value of the required phase shift for the revolution frequency, which is within the range between $0$ and $2\pi$.
 \begin{equation}
\Delta \phi_\mathit{shift\_raw}'= \frac{h_{\mathit{rev}}^{trg}}{h_{\mathit{syn}}^{trg}}(\Delta \phi_\mathit{syn}-t_{\mathit{diff\_sync}}  \cdot f_\mathit{syn}^\mathit{trg}\cdot 2\pi) \mod 2\pi 
\end{equation}

A normalized frequency modulation profile \gls{symb:phase_shift_normalized} for $\pi$ can be precalculated, which guarantees the adiabaticity. The actual frequency modulation profile \gls{symb:phase_shift_actual} is decided by \gls{symb:phase_shift_normalized} and \gls{symb:pha_shift_shift}, see eq.~\ref{actual_profile}. 
\begin{equation}
\frac{\Delta \phi_\mathit{shift}}{180^\circ}= \frac{f_{\mathit{actual}}}{f_{\mathit{normalized}}} \label{actual_profile}
\end{equation}

Fig.~\ref{normalized_profile} shows an example of a normalized and several actual frequency  modulation profiles and the corresponding phase shift profiles. The magenta profile is the normalized profile $f_{normalized}$ with the phase shift of $\pi$. The blue one is $1/2 f_{\mathit{normalized}}$ with the phase shift of $90^\circ$ and the green one is $1/3 f_{\mathit{normalized}}$ with $60^\circ$. 

\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{normalized_profile.png}
   \caption{The normalized frequency and phase modulation profile and the actual profiles}
   \label{normalized_profile}
\end{figure}  

Fig.~\ref{PSM} shows the integration of the Phase Shift Module (PSM) into the B2B source SCU. The B2B source SCU sends the required phase shift to the \gls{PSM}, which controls the phase shift of the phase measurement signal of Group DDS by means of either the frequency modulation (Fig.~\ref{normalized_profile} (a)) or the phase modulation (Fig.~\ref{normalized_profile} (b)). The required phase shift is distributed by the LLRF system to all the Group DDS of the synchrotron. The Group DDS signals are routed to different cavity systems by a Switch Matrix to realize the phase shift of all cavities on the synchrotron. For more details about the implementation and realization of the PSM module, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_????}.
  \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{PSM.png}
   \caption{Integration of the Phase Shift Module into the B2B source SCU}
   \label{PSM}
\end{figure}                     

A particular case of the B2B synchronization occurs, when the target synchrotron is empty, i.e. it does not capture any bunch yet, the phase shift can be done for the target synchrotron without adiabatical consideration (e.g. the phase jump is possible). In this case, the B2B source SCU sends the timing frame \verb|TGM_PHASE_JUMP| to the B2B target SCU, which contains the required phase shift. After the B2B target SCU receives the timing frame, it sends the value to the PSM for the phase jump of the Group DDS with the synchronization frequency of the target synchrotron.

\subsubsection{Rf Synchronization with Frequency Beating Method}

The frequency beating method can achieve only positive phase adjustment, so $\Delta \phi_\mathit{shift}$ is from $0$ to $2\pi$ and equals to $\Delta \phi_\mathit{shift\_raw}$, namely
%\begin{eqnarray}\Delta \phi_\mathit{shift}=
%\begin{cases} 
%4\pi+ \Delta \phi_\mathit{shift\_raw} & -4\pi<\Delta \phi_\mathit{shift\_raw}\le -2\pi \cr
%
%2\pi+ \Delta \phi_\mathit{shift\_raw} & -2\pi<\Delta \phi_\mathit{shift\_raw}\le0 \cr
%
%\Delta \phi_\mathit{shift\_raw} & 0<\Delta \phi_\mathit{shift\_raw}\le 2\pi \cr
%
%%\Delta \phi_\mathit{shift\_raw} \mod 2\pi &  2\pi<\Delta \phi_\mathit{shift\_raw}\le4\pi \cr
%
%\end{cases}
%\end{eqnarray}

\begin{equation}
\Delta \phi_\mathit{shift}=\Delta \phi_\mathit{shift\_raw} 
\end{equation}

The correct phase alignment is achieved by the frequency beating automatically and the proper wait. The circumference ratio between many pair of machines in FAIR is not an integer, the synchronization frequencies of two synchrotrons begin beating automatically. For the pairs with an integral circumference ratio, the synchronization frequency of the source synchrotron has to be detuned. The Group DDS produces the detuned phase measurement signal provided by the SM. 



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Calculation%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Coarse Synchronization}
% For each beam production chain, the B2B related SCUs will be configured by FESA.

The \gls{glos:coarse_syn} is achieved by the synchronization window with a certain length. Within this window, bunches are transferred into buckets with the center mismatch smaller than the upper bound. The length of the synchronization window \gls{symb:syn_win_length} is one period of the bucket indication signal. For the phase shift method, the bunch-to-bucket injection center mismatch within the synchronization window is $0$. For the frequency beating method, the maximum bunch-to-bucket injection center mismatch $\Delta \phi_\mathit{rf}$ within the synchronization window is calculated by eq. ~\ref{b2b_center_1}. For more details, please see Sec. ~\ref{subsec:beating}.
\begin{equation}
\Delta \phi_\mathit{rf}=\pm \frac{1}{2}\cdot 2\pi|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|\cdot T_\mathit{w} \cdot \frac{h_{\mathit{rf}}^\mathit{trg}}{h_{\mathit{syn}}^\mathit{trg}}
\label{b2b_center_1}
\end{equation}

%The B2B source SCU is capable of receiving the values~\footnote{The delay compensation for the TOF and the kicker preparation time, the cavity rf frequencies of the source and target synchrotrons, the extra phase shift value for the even buckets injection and the upper bound time for the phase shift of the source synchrotron} from the SM by FESA classes via the accelerator network. 
The B2B source SCU obtains the delay compensation for the TOF, all propagation delays, the kicker preparation time and the bucket delay (denoted as \gls{symb:delay_com}) from the SM. It calculates the start of the synchronization window (denoted as \gls{symb:win_start}), taking the delay compensation into consideration. 

 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{network_B2B1.jpg}
   \caption{The transfer delay of the start of the synchronization window on the WR network.}
   \label{network_B2B1}
\end{figure}
Fig. ~\ref{network_B2B1} shows the transfer delay of the start of the synchronization window on the WR network. \gls{symb:win_start} is first of all transfered from the B2B source SCU to the DM (the orange transfer path) by the timing frame \verb|TGM_SYNCH_WIN|. Then \gls{symb:win_start} is repackaged by the DM into a new timing frame \verb|CMD_SYNCH_WIN| and \verb|CMD_SYNCH_WIN| is transferred from the DM to the source and target Trigger SCUs  (the green transfer path with \textcircled{2}), as well as the BI (the green transfer path with \textcircled{1}) for the indication of the beam. The Trigger SCUs are used to produce the kicker trigger signals. The start of the synchronization window must be late enough to guarantee that the BI receives \verb|CMD_SYNCH_WIN| and is activated before the start of the synchronization window. The start of the synchronization window must be at least \SI{1.6}{\ms} later than $t_\psi^\mathit{X}$. The time duration of \SI{1.6}{\ms} is the sum of the \SI{500}{\us} upper bound transfer delay of \verb|TGM_PHASE_TIME| (the blue transfer path), that of \verb|TGM_SYNCH_WIN| (the orange transfer path), that of \verb|CMD_SYNCH_WIN| (the green transfer path) on the WR network and \SI{100}{\us} calculation time of the B2B source SCU. For more details of the time constraints, please see Chap. ~\ref{realization}.

For the phase shift method, the rf frequency modulation has a fixed duration $T$. The start of the synchronization window for the phase shift method is calculated as
\begin{equation}
t_\mathit{w}=t_\psi^\mathit{X}+\SI{500}{\us}+\SI{100}{\us}+T-t_\mathit{delay}\label{syn_win_start}
\end{equation}
where \SI{500}{\us} is the upper bound transfer delay of \verb|TGM_PHASE_TIME| on the WR network (the blue transfer path) and \SI{100}{\us} the calculation time of the B2B source SCU. $T$ is longer than \SI{5}{\ms}, which is long enough to meet the time constraints of the BI. 

The start of the synchronization window for the frequency beating method is calculated as
\begin{equation}
t_\mathit{w}= t_\psi^\mathit{X}+\frac{\Delta \phi_\mathit{shift}}{2\pi}\cdot\frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}+n\cdot \frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}-\frac{T_w}{2}-t_\mathit{delay}\label{syn_win_start1}
\end{equation}
where the term of $n\cdot \frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}$ is used to guarantee the activation of the BI timely. $n$ is calculated by the following relation.
\begin{equation}
\frac{\Delta \phi_\mathit{shift}}{2\pi}\cdot\frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}+n\cdot \frac{1}{|f_{\mathit{syn}}^\mathit{src}-f_{\mathit{syn}}^\mathit{trg}|}-\frac{T_w}{2}-t_\mathit{delay}> \SI{1.6}{\ms}
\end{equation}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Bucket label %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Bucket Label}
\label{sec:bucket_label}
The bucket label is realized based on the bucket indication signal for the first bucket plus a fixed delay for the indication of the correct buckets to be filled. 

The evolution of the phase deviation between the phase measurement signal and the synchronization reference signal of the target synchrotron is calculated for any T0 incidents (same as eq. ~\ref{advance_phase}).
\begin{equation}
\Delta \varphi^\mathit{trg}(t_\mathit{\psi}^\mathit{trg}+nT_\mathit{sample\_PAP})=[(\psi^\mathit{trg}_0+k^\mathit{trg}\cdot nT_\mathit{sample\_PAP}) \mod 2\pi] - \pi
\end{equation}
where $\psi^\mathit{trg}_0$ is the phase advance extrapolated by the PAP module at $t_\mathit{\psi}^\mathit{trg}$ of the target synchrotron.

Therefore, the bucket indication signal can be corrected exactly in phase with the phase measurement signal of the target synchrotron by $\Delta \varphi^\mathit{trg}(t_\mathit{\psi}^\mathit{trg}+nT_\mathit{sample\_PAP})$ at the T0 incidents. The bucket indication signal is exactly a copy of the revolution frequency or the synchronization frequency of the target synchrotron, so
it is also called the ”reproduced signal”. The bucket indication signal can be reproduced campus-wide. A specific bucket is just a certain number of the cavity rf periods of the target synchrotron delay based on the bucket indication signal.


%\begin{equation}
%\psi= k^\mathit{trg}t+\psi_0\label{linear}
%\end{equation}
%Where $\psi^\mathit{trg}$ and $t_{\psi^\mathit{trg}}$ coincidence with the linear relationship, so \gls{symb:initial_phase advance}, the initial phase advance, can be calculated as $\psi^\mathit{trg}-k^\mathit{trg}t_{\psi^\mathit{trg}}$.




The FAIR B2B transfer system needs the bucket indication not only at the rf flattop, but also during the whole acceleration cycle. The bucket indication at the rf flattop is used for the normal extraction and injection and the bucket indication during the whole acceleration cycle is used for the emergency dump. For the SIS100 emergency kick, the reproduced signal has always the same frequency and is always in phase with the SIS100 revolution signal, so it is called the ''real-time reproduced signal''. The bunch gap label is realized based on the real-time reproduced signal for the first bucket plus a variable delay for the indication of the bunch gap.


 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{PCM.png}
   \caption{Integration of the Phase Correction Module into the Trigger SCU}
   \label{PCM}
\end{figure}
The bucket label is realized by the Trigger SCU, the Signal Reproduction (SR) module and the Phase Correction Module (PCM), see Fig.~\ref{PCM}. The reproduced signal is produced by SR module. The Trigger SCU is responsible for the receipt of the phase correction value from the B2B source SCU and the transfer of this value to the PCM. The PCM module is used to correct the phase of the reproduced signal. The PCM module is a SCU slave in the Trigger SCU. The SR module produces the bucket indication signal marker in the format of the TTL signal, whose rising edges are aligned with the positive zero-crossings of the rf signal of the revolution frequency or the synchronization frequency. For more details about the implementation and realization of the PCM and the SR module, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_????}. 

\subsection{Bucket Label for the normal Extraction and Injection}

For the bucket label for the normal extraction and injection, three steps are necessary. Fig.~\ref{bucket_label} shows these three steps for the reproduction of the bucket label. Here the B2B transfer from the SIS18 to the SIS100 is taken as an example.
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{bucket_label.jpg}
   \caption{The realization of the bucket label for the normal extraction and injection.}
   \label{bucket_label}
\end{figure}  
\begin{itemize}
\item[-] Step 1. Frequency correction

The \gls{SR} module produces the ''reproduced signal'' with the frequency $f_{\mathit{bucket}}$. The positive zero-crossing of the reproduced signal always indicates the start of the $1^{st}$ bucket.
\item[-] Step 2. Phase correction

The reproduced signal must do the phase correction at a specified T0 incident. The phase correction value and the phase correction timestamp are calculated by the B2B source SCU. The phase correction value is transferred by the timing frame \verb|TGM_PHASE_CORRECTION| to the \gls{glos:trigger_scu}. The timestamp of the phase correction is embodied in the execution time of \verb|TGM_PHASE_CORRECTION| at the Trigger SCU, when the phase correction value is given by the Trigger SCU to the SR module via the PCM.

%In reality, the reproduced signal can also be directly distributed from the switch matrix, which synchronizes with the phase measurement signal of the revolution frequency or the synchronization frequency of the target synchrontron in frequency and phase.

\item[-] Step 3. Bucket indication

The SM considers the bucket delay $t_{\mathit{bucket}}$ within the kicker delay compensation, see Sec. ~\ref{sec:compensation}. In Fig.~\ref{bucket_label}, the reproduced signal is with the SIS100 revolution frequency and the $3^{rd}$ and $4^{th}$ buckets of ten buckets will be filled with $t_{\mathit{bucket}}=1\cdot T_{\mathit{rev}}^{\mathit{SIS18}}$. 
\end{itemize}

\subsection{Bunch Gap Label for Emergency Extraction}

Only for the SIS100 emergency procedure, the bunch gap label is important during the whole acceleration cycle. There are two steps for the realization of the bunch gap label, see Fig.~\ref{Emergency_label}.
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{Emergency_label.jpg}
   \caption{The realization of the bunch gap for the emergency extraction.}
   \label{Emergency_label}
\end{figure} 

\begin{itemize}
\item[-] Step 1. Reproduced signal synchronized with the phase measurement signal of the revolution frequency

The real-time reproduced signal is directly distributed from the switch matrix, which synchronizes with the revolution frequency in frequency and phase.
\item[-] Step 2. Bunch gap indication

The SM considers the bunch gap $t_{\mathit{bucket}}$ within the kicker delay compensation. In Fig.~\ref{Emergency_label}, the real-time reproduced signal is with the SIS100 revolution frequency and the $9^{th}$ and $10^{th}$ buckets of ten buckets are taken as an example as the bunch gap. The $t_{\mathit{bucket}}=4\cdot T_{\mathit{rev}}^{\mathit{SIS18}}$.

\end{itemize}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Fine Synchronization of Extraction and Injection Kickers}
After the synchronization of the rf systems between two synchrotrons, the TOF, all propagation and kicker preparation delays are compensated. Now, the extraction and injection kickers must be fired at the calculated trigger time within the bunch gap before the specific bunch or bucket passes the kickers.
 
This is the task of the Trigger Decision (TD) module in the Trigger SCU. The TD receives the  synchronization window in the form of an enable signal. The \gls{glos:fine_syn} will be accomplished by the marker of the reproduced signal plus the extraction or injection kicker delay compensation from the SM. This achieves the fine synchronization of the B2B transfer. The TD transmits the kicker pulse directly to the kicker electronic.  
 
In case of fatal errors, the emergency kicker must kick the beam immediately but within the bunch gap into the emergency dump.

%After the synchronization between two rf systems, the exact TOF between two synchrotrons before a specific bucket passes the injection kicker, the extraction kicker must kick the bunch in the source synchrotron. When there are in case of the fatal error or considerabel damage, the emergency kicker must kick the beam into the emergency dump as soon as possible. This achieves the ````.
%
%The first pulse of the reproduced signal within the synchronization window is selected. The triggers for the extraction and injection kicker are produced after the selected reproduced signal with the delay of the extraction and injection kicker delay compensation. When some emergency happens, the coming bunch gap label outputs to trigger the emergency kicker.
 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{TD.png}
   \caption{Integration of the Trigger Decision module into the Trigger SCU}
   \label{TD}
\end{figure}
Fig.~\ref{TD} shows the integration of the Trigger Decision (\gls{TD}) module into the Trigger SCU.  
%The extraction/injection kicker trigger signal is produced by the TD module, which selects the first reproduced signal within the synchronization window and adds the delay of the extraction /injection kicker delay compensation to the first reproduced signal. For the emergency kick, the TD module produces the bunch gap label by the delay of the bunch gap based on the real-time reproduced signal.   

The kicker trigger is realized based on the first rising edge of the bucket indication signal marker within the synchronization window plus the kicker delay compensation. For the normal B2B extraction/injection, the synchronization window is received by the source and target Trigger SCUs from the WR network by \verb|TGM_SYNCH_WIN|. The extraction kick delay compensation is $T_{\mathit{rev}}^{\mathit{SIS100}}$ + $T_{\mathit{rev}}^{\mathit{SIS18}}$ -(\gls{symb:two_TOF} +$ t_{v\_inj}$+ \gls{symb:ext_pre}) and the injection kicker delay compensation is $T_{\mathit{rev}}^{\mathit{SIS100}}$ + $T_{\mathit{rev}}^{\mathit{SIS18}} - (t_{v\_inj}+$ \gls{symb:inj_pre}) in the example in Fig.~\ref{ext_inj_kicker}, when the bucket indication signal has the frequency of $f_{\mathit{rev}}^{\mathit{trg}}$. 

For FAIR use cases, there is always only one bucket in the target synchrotron when $f_{\mathit{bucket}}=f_{\mathit{syn}}^{\mathit{trg}}$. In this case, the bucket delay is not taken into consideration. The extraction kick delay compensation is $T_{\mathit{syn}}^{\mathit{trg}} -$(\gls{symb:two_TOF}$ + t_{v\_inj}+ $\gls{symb:ext_pre}) and the injection kicker delay compensation is $T_{\mathit{syn}}^{\mathit{trg}} - (t_{v\_inj}+ $\gls{symb:inj_pre}), see Fig.~\ref{ext_inj_kicker1}. 
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=150mm]{syc_ext_inj1.jpg}
   \caption{The illustration of the kicker delay compensation when the bucket indication signal has the frequency of $f_{\mathit{syn}}^{\mathit{trg}}$.}
   \label{ext_inj_kicker1}
\end{figure}



Both extraction and injection kick delay compensation values are preloaded from the SM to the Trigger SCU and the Trigger SCU gives these values to the TD module. When the beam injection inhibit signal from the MPS is on, the TD module will block the extraction/injection trigger.

For the SIS100 emergency kick, the extraction delay compensation is calculated by $T_{\mathit{rev}}^{\mathit{SIS100}} + t_{bucket} - (t_{v\_emg} + t_{emg})$, where \gls{symb:temg} is the time delay between the virtual rf cavity and the emergency extraction position, \gls{symb:Demg} the emergency kicker delay and $t_{bucket}$ always indicates the bunch gap. The emergency extraction delay compensation values are preloaded from the SM to the Trigger SCU and the Trigger SCU gives these values to the TD module. The kicker delay compensation is applied to the real-time reproduced signal by TD module. Only when the emergency dump signal from MPS is valid, the emergency kicker will be triggered by the TD module.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsection{Beam indication for the beam instrumentation}
%
%Two timing frames will be send from the B2B source SCU to the DM. DM sends them further to the FECs for BI.
%\begin{itemize}
%\item[-] Timing frame $TGM\_SYNCH\_WIN$
%
%This time frame indicates the start of the synchronization window for the beam instrumentation.
%
%\item[-] Timing frame $TGM\_B2B\_STATUS$
%
%The time frame $TGM\_B2B\_STATUS$ indicates the status of the B2B transfer system and the actual beam injection time. 
%\end{itemize}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% WR network %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsection{WR network}
%
%The B2B transfer involves a certain amount of frames within the WR network ~\cite{beck_white_2011}. For more details about the B2B frames, please see Appendix A. The name of the timing frames from the DM is beginning with CMD\_, the name of other telegrams is beginning with TGM\_. The B2B related frames make use of the format of the timing frame. The Format ID (\gls{FID}) of the timing frame is used to indicate the B2B transfer, the Group ID (\gls{GID}) the source and target machines and the Beam Process ID (\gls{BPID}) the B2B process steps for the B2B related SCUs. 
%
%A Virtual Local Area Network (VLAN) is a group of FECs in the WR network that is logically segmented by function or application, without regard to the physical locations of the FECs. 
%
%All FECs in the WR network are assigned to the DM VLAN, within which the DM forwards broadcast timing telegrams downwards to all FECs. The telegrams sent from the source B2B SCU upwards to the DM are unicast packets within this VLAN. E.g. TGM\_SYNCH\_WIN and TGM\_B2B\_STATUS. 
%
%
%\begin{landscape}
%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=250mm]{Telegram_network.jpg}
%   \caption{Timing frames transfer for the B2B transfer}
%   \label{Telegram_network}
%\end{figure}  
%\end{landscape}
%
%Besides, the SCUs for the B2B transfer are assigned to the B2B \gls{VLAN}. The specified VLAN for the B2B transfer could reduce the traffic of the WR network ~\cite{bai_concept_2016}. All B2B related telegrams TGM\_ except TGM\_SYNCH\_WIN and TGM\_B2B\_STATUS are broadcasted in the B2B VLAN. The broadcast packet is much safer, because it does not need to know the Internet Protocol address (\gls{IP} address) of B2B related SCUs. Besides, it increases the flexibility of the system that all SCUs for the B2B transfer could have changeable IP addresses. Fig. ~\ref{Telegram_network} shows the types of the B2B timing frames, their VLANs and the frames transfers among B2B related SCUs.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Status check %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{B2B Transfer Status Check}
The B2B transfer status must be known by the DM. The B2B source SCU, the B2B transfer master, is responsible for the status check. The B2B source SCU receives the trigger time of the extraction kicker and actual beam extraction time, \verb|TGM_KICKER_TRIGGER_TIME_S|, from the source \gls{glos:trigger_scu} via the WR network and also the trigger time of the injection kicker and actual beam injection time, \verb|TGM_KICKER_TRIGGER_TIME_T|, from the target Trigger SCU via the WR network. The actual beam extraction time is the beginning of the kicker flat-top of the last extraction kicker magnet and the actual beam injection time is the beginning of the kicker flat-top of the first injection kicker magnet. The Trigger SCU is responsible for the collection of the kicker trigger time and the beam extraction/injection time. The B2B source SCU examines the status of the B2B transfer system and transfers the status and the actual beam injection time, \verb|TGM_B2B_STATUS|, to the DM. If all components of the B2B transfer system have worked correctly, the B2B transfer process is successful. Otherwise it has failed. 

The source and target Kicker SCUs
individually get the timestamp of the beginning of the magnetic flattop of the last
extraction kicker unit and the first injection kicker unit and transfer these information
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Data Flow}
In this section, the procedure for the B2B transfer is explained from the perspective of the data flow, which follows the basic six steps in Fig.~\ref{2method}. Fig. ~\ref{data_flow} shows the data flow in the source and target synchrotrons and between two synchrotrons. The rectangle with the different color represents the basic six steps. The left part in each rectangle presents the data flow in the source synchrotron and the right part the data flow in the target synchrotron.


\begin{enumerate}
\item The DM sends the timing frame \verb|CMD_START_B2B| to the B2B source and target SCUs for the start of the B2B transfer via the WR network. Besides, it requests the switch-off of the feedback loop.

\item  After receiving \verb|CMD_START_B2B|, the B2B source and target SCUs start the PAM module to measure the phase deviation $\Delta \varphi^X$ with the help of the PAP module locally and the PAP module extrapolates the phase advance into the future. After a period of time, the B2B source and target SCUs read the extrapolated phase advance $\psi^X_0$ and the slope of the phase deviation $k^\mathit{X}$ from the PAP module locally, timestamping the $\psi^X_0$.  

\item  The B2B target SCU sends the extrapolated phase $\psi^\mathit{trg}_0$, the corresponding timestamp $t_\psi^\mathit{trg}$ and the slope $k^\mathit{trg}$ in the format of the timing frame \verb|TGM_PHASE_TIME| to the B2B source SCU in the B2B VLAN. 
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=105mm]{data_flow.jpg}
   \caption{The data flow of the B2B transfer system}
   \label{data_flow}
\end{figure}  

\item  When the B2B source SCU receives the timing frame \verb|TGM_PHASE_TIME|, it calculates the synchronization window and transfers the timestamp of the start of the window to the DM in the format of the timing frame \verb|TGM_SYNCH_WIN|, as well as to the Trigger SCUs at the source and target synchrotrons.
The B2B source SCU calculates the phase correction value and transfers it to all Trigger SCUs via the WR network in the format of the timing frame \verb|TGM_PHASE_CORRECTION|. Then the Trigger SCUs transfer the phase correction value to its \gls{PCM}. The PCM starts the phase correction of the SR module. 

Only for the phase shift method, the B2B source SCU calculates the required phase shift $\Delta \phi_\mathit{shift}$ and transfers it to the PSM. Then the PSM transfers the phase or frequency modulation profile to the Group DDS.  

\item  When the source and target Trigger SCUs receive the timing frame \verb|TGM_SYNCH_WIN|, they produce the synchronization window pulse for the TD module. With the help of the reproduced signal from the SR module, the kicker delay compensation from the Trigger SCU and the indication signals (the emergency dump signal and the beam injection inhibit signal) from the MPS, the TD module produces the normal extraction/injection trigger signals or the emergency kick trigger for the kicker.  

\item  The extraction and injection kickers or emergency kicker are fired. After that, the source Trigger SCU gets the actual beam extraction time and the timestamp of the extraction trigger signal from the TD module and transfers them to the B2B source SCU in the format of the timing frame \verb|TGM_KICKER_TRIGGER_TIME_S|. The target Trigger SCU gets the timestamp of actual beam injection time and the timestamp of the injection trigger signal from the TD module and transfers them to the B2B source SCU in the format of the timing frame \verb|TGM_KICKER_TRIGGER_TIME_T|. Then the B2B source SCU checks the B2B transfer status and transfers the status together with the beam injection time to the DM in the format of the timing frame \verb|TGM_B2B_STAUS| (represented as the red line in the rectangle of step 6 in Fig. ~\ref{data_flow}).

\end{enumerate}

\section{Comparison between FAIR B2B Transfer System and current B2B Transfer}


% (~\cite{ferrand_synchronization_2015, ezura_beam-dynamics_2008})

The existing GSI control system realizes the B2B transfer from the SIS18 to the ESR. It is an event based system, that event execution will start immediately at the event receipt. Events are directly sent from a ``timing master``, who makes the schedule. Each accelerator has its own timing master, e.g. the ESR is equipped with the ESR-timing master and the SIS18 with the SIS-timing master. All devices are connected to distributed Equipment Controllers (EC) via field bus. EC is responsible for the receipt of the event and produces the pulse for the devices ~\cite{kainberger_pzs_2003, krause_re-engineering_2001}. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{GSI_control_system.jpg}
   \caption{The current realization of the bunch-to-bucket transfer between the SIS18 and the ESR with the GSI control system.}
	\caption*{\textsl{\small{Gear sign represents the configuration from operators.}}}
   \label{GSI_control_system}
\end{figure}
Fig. ~\ref{GSI_control_system} illustrates the current realization of the B2B transfer from the SIS18 to the ESR with the GSI control system. The SIS18 needs longer time for the preparation, e.g. the beam injection and the beam acceleration, before the extraction than that of the ESR before the injection, so the ESR is earlier fully prepared for the transfer. The preparation process is represented as red rectangle in Fig. ~\ref{GSI_control_system}. When the SIS18 is fully prepared with bunches to be transferred, the ready signal from the ESR-timing master and the SIS-timing master are forwarded into a logic $\textit{AND}$ gate. When both the SIS18 and the ESR are prepared, namely the output of the logic $\textit{AND}$ gate is high, the extraction kicker charge event is sent from the SIS-timing master and the injection kicker charge event from the ESR-timing master. The charge process of kicker is represented as yellow rectangle in Fig. ~\ref{GSI_control_system}. When two kickers are fully charged, the ready signal of the extraction and injection kickers from the ESR-timing master and the SIS-timing master are forwarded into the second logic $\textit{AND}$ gate, as well as the ``phase synchronization signal`` from the rf system. The phase synchronization signal indicates the alignment of the zero-crossing of the phase measurement signals from Group DDS of the SIS18 and the ESR. The output of the second $\textit{AND}$ gate is an indication signal, starting the delay compensation of the time-of-flight and all propagation delays on the SIS18 cavity rf signal for the correct phase match between the SIS18 and ESR rf systems, denoted as ``delay for phase match`` in Fig. ~\ref{GSI_control_system}. The ESR uses the injection orbit instead of the design orbit, so the circumference ratio between the SIS18 and the ESR is close to an integer, $C^{\mathit{SIS18}}/C^{\mathit{ESR}}=2-0.003$, the SIS18 has four bunches, $h^{\mathit{SIS18}}=4$ and ESR has two buckets, $h^{\mathit{ESR}}=2$, so $f^{\mathit{SIS18}}_{\mathit{rf}}/f^{\mathit{ESR}}_{\mathit{rf}}=4/(4-0.006)$. The phase difference between rf systems of the SIS18 and the ESR varies at the speed of the beating frequency $\Delta f=|f^{\mathit{SIS18}}_{\mathit{rf}}-f^{\mathit{ESR}}_{\mathit{rf}}|=\SI{1898}{Hz}$, see Appendix. ~\ref{sec:18toESR}. The required phase difference (denoted as $\Delta\phi_\mathit{shift}$) happens $\Delta t$ after the indication signal, see eq. ~\ref{time_delay_beating}. 
\begin{equation}
\Delta t= \frac{\Delta \phi_\mathit{shift}}{2\pi}\cdot\frac{1}{\Delta f}\label{time_delay_beating}
\end{equation}

When the delay for the required phase difference is expired, trigger pulses are produced by the timing generator for both the SIS18 extraction and ESR injection kicker control electronics. Every kicker control electronics adds a separate delay to trigger pulses, denoted as ``extraction kicker delay`` and ``injection kicker delay`` in Fig. ~\ref{GSI_control_system}. The delay for the required phase match, extraction kicker delay and injection kicker delay are configurable by operators. The precision of the ignition signal from the kicker control electronics is \SI{1}{ns}. 

The existing B2B transfer with the GSI control system only supports the B2B transfer with the frequency beating method. It dose not support B2B transfer with the phase shift method. It gets the phase difference between two rf systems of the SIS18 and the ESR via the direct phase comparison by the phase synchronization module. Parameters (e.g. the delay for the required phase match, the extraction kicker delay and the injection kicker delay) must be properly configured and adjusted by operators. The phase synchronization signal is delay compensated, but the transfer of the signal to the second $\textit{AND}$ gate is not delay compensated and with the jitter of \SI{1}{\micro\second}, resulting a spread of the bunch-to-bucket injection center mismatch with the order of the magnitude $\pm 1^\circ$. Besides, it does not support buckets filling by multiple batches, e.g. eight out of ten SIS100 buckets are filled by four SIS18 batches, each of them has two bunches.

Compared with the current B2B transfer with the GSI control system, the FAIR B2B transfer system has many advantages. It supports both the phase shift and frequency beating methods. For the B2B transfer from the SIS18 to the ESR, it is with a smaller bunch-to-bucket injection center mismatch (see Chap. ~\ref{application}). The FAIR B2B transfer system is based on the GMT system, which is a time based system. All FECs of the GMT system are time synchronized with nano second accuracy, which achieves the smaller bunch-to-bucket injection center mismatch. Besides, the FAIR B2B transfer system is more flexible. It supports several B2B transfers running at the same time, e.g. the B2B transfer from the SIS18 to the SIS100 and B2B transfer from the ESR to the CRYRING. It is capable to transfer different species beam from one \gls{glos:machine_cycle} to another without the operator's configuration. It is capable to transfer the beam between two synchrotrons via a \gls{FRS}, Pbar or Super FRS. It can achieve various complex bucket pattern. What is more, the FAIR B2B transfer system coordinates with the MPS system, which protects SIS100/SIS300 from unacceptable failure or situation. 


