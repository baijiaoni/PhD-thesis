

In this Chapter, the basic idea of the FAIR B2B transfer system is presented in Sec. 4.1. The standard procedure of the system is defined and described in Sec. 4.2. Sec. 4.3 illustrates how the basic functionalities of the system are realized. In Sec. 4.4, the data flow of the system is described. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5%%%%
\section{Basic idea of the FAIR B2B transfer system} 
The basic idea of the B2B transfer is simple. First of all, two rf systems of the source and target synchrotrons must be phase aligned. Secondly, the trigger for the extraction and injection kickers must be calculated. In the end, the actual beam injection must be indicated for the beam instrumentation and diagnostics, which shows the properties and the behavior of the beam. 

% .
\subsection{Phase alignment}
The phase alignment is one of the most important prerequisites for the B2B transfer. It makes sure that there must be buckets to be filled by extracted bunches at the correct time. The phase alignment is based on the synchronization frequencies. When two rf systems have an identical cavity rf frequency or slightly different cavity rf frequencies, two cavity rf frequencies are chosen as the synchronization frequencies. When two rf systems have hugely different cavity rf frequencies, two synchronization frequencies are an integeral multiple of the same or slightly different derived rf frequencies, which are the division of the revolution frequencies. More details about the calculation of the synchronization frequencies, see Sec. ~\ref{match}. If two synchronization frequencies of two rf systems are same, the phase difference between two rf systems is constant. The phase difference can be adjusted by the phase shift method or the frequency beating method with the frequency detune on one (or both) rf system. If two synchronization frequencies of two rf systems are slight different, the phase difference is adjusted automatically because of the beating frequency. %The beating frequency must not be too small in order to satisfy the constraint of the maximum synchronization time, but also not too large to guarantee the precision of the phase alignment. 

For the phase alignment, the following idea must be followed. 
\begin{enumerate}
\item The measurement of the phase of the rf system and the corresponding timestamp in each synchrotron.
\item The exchange of the measured phase and the timestamp.
\item The phase comparison between two rf systems.
\item The adjustment of the phase on one (or both) rf system, when the phase shift method is used. 
\item The calculation of the time for the phase alignment of two rf systems.
\end{enumerate}
% .
\subsection{Calculation of the trigger time for the extraction and injection kickers}
\label{sec:compensation}
For the proper B2B transfer, not only the relative position of bunches and buckets, but also the firing of the extraction and injection kickers must be precisely controlled. The extraction kicker must kick the bunch exactly the time-of-flight between two rings before a specific bucket passes the injection kicker. For the calculation of the trigger time for the extraction and injection kickers, the following idea must be followed. 
%The kicker time contains the rise time, the flat-top and the fall time, see Sec. ~\ref{sec:kicker}. 
\begin{enumerate}
\item The kicker firing requires the B2B injection center phase mismatch in the range between $\pm 1^\circ$, which defines a ``coarse synchronization``.
\item The bucket counting requires the kicker firing based on the revolution frequency $f_{\mathit{rev}}^{\mathit{trg}}$ or the synchronization frequency $f_{\mathit{syn}}^{\mathit{trg}}$ of the target synchrotron (see Sec. ~\ref{sec:bucket_label}). With the help of the bucket counting, bunches are injected into correct buckets. This process is called the ``fine synchronization``.
\end{enumerate}

Before the detailed idea of the calculation is explained, some basic concepts and their symbols are introduced, see Fig.~\ref{ext_inj_kicker}.

\begin{itemize}
\item[-] The bucket pattern \gls{symb:bucket_pattern}.
\item[-] The Time-Of-Flight (\gls{TOF}) between two synchrotrons \gls{symb:two_TOF}. 
\item[-] The Time-Of-Flight between the virtual rf cavity and the extraction/injection kicker, \gls{symb:tsrc} and \gls{symb:ttrg}. 
\item[-] The sum of the preparation time and rise time of an extraction kicker and an injection kicker, \gls{symb:ext_pre} and \gls{symb:inj_pre}.
\end{itemize}
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{syc_ext_inj.jpg}
   \caption{The illustration of the B2B transfer from the the SIS18 to the the SIS100.}{The blue dot represents bunch, red ones buckets, red lighting bolts the extraction and injection kicker firing and gray gears the bucket pattern.}
   \label{ext_inj_kicker}
\end{figure}
Fig.~\ref{ext_inj_kicker} illustrates the B2B transfer from the the SIS18 to the the SIS100. The the SIS18 $U^{28+}$ super cycle consists of four the SIS18 cycles. Each cycle produces two $U^{28+}$ bunches. From the SIS18, four batches, each of two bunches, are injected into eight out of ten buckets of the the SIS100. The the SIS18 $H^{+}$ super cycle consists of four the SIS18 cycles. Each cycle produces one $H^{+}$ bunch. From the SIS18, four batches, each of one bunch, are injected into four out of ten buckets of the the SIS100 ~\cite{liebermann_fair_2013, liebermann_sis100_2013}. The the SIS18 and the SIS100 revolution frequency markers (black bars on the first time axis and bars on the second/third time axis in Fig.~\ref{ext_inj_kicker}) indicate the time when the first bunch or the first bucket pass by the virtual rf cavity (black bars correspond to $1^{st}$ and $\sharp1$). The extraction and injection kicker firing (red lighting bolts) have a delay with respect to the first bars of the the SIS100 revolution frequency marker at the SIS18 and the SIS100. This delay is called the extraction/injection kicker delay compensation. The mentioned four instances of time are related to the second bars of the the SIS100 revolution frequency marker. \gls{symb:period_rev} represents the revolution period of the synchrotron X, e.g. the the SIS18 revolution period is $T_{\mathit{rev}}^{\mathit{the SIS18}}$. \gls{symb:period_rf} represents the rf period of the cavity rf frequency of the synchroton X, e.g. the the SIS18 rf period of the cavity rf frequency is $T_{\mathit{rf}}^{\mathit{the SIS18}}$. After the rf phase alignment, the time difference between the the SIS18 and the SIS100 revolution frequency markers is represented by \gls{symb:diff_sync}, e.g. \gls{symb:diff_sync}=$t_{\mathit{v\_ext}}+t_{\mathit{TOF}}+t_{\mathit{v\_inj}}$ for $U^{28+}$ and $H^{+}$ odd bucket injection,  \gls{symb:diff_sync}=$t_{\mathit{v\_ext}}+t_{\mathit{TOF}}+t_{\mathit{v\_inj}}- T_{\mathit{rf}}^{\mathit{the SIS100}}$ for $H^{+}$ even bucket injection. The phase alignment for the odd or even bucket injection is informed by the ``extra phase shift`` from the SM. More details about the use cases of the B2B transfer from the the SIS18 to the the SIS100, please see Sec. \ref{sec:cir_no_int} and Sec.  \ref{sec:cir_no_int1}. The 
%Fig.~\ref{ext_inj_kicker} takes $U^{28+}$ B2B transfer from the SIS18 to the SIS100 as an example. the SIS18 operates with harmonic number of 2 (h = 2), forming two bunches. From the the SIS18, 4 batches, each of 2 bunches, are transferred into continuous 8 out of 10 the SIS100 buckets ~\cite{liebermann_fair_2013, liebermann_sis100_2013}. The harmonic number of the SIS100 is 10. 

The kicker magnet must have zero magnetic field when bunches pass by it and the kicker magnet only can be switched on during bunch gaps. Bunch gaps depend on the cavity rf frequency, the bucket pattern and the bunch length. 

\begin{itemize}
\item Extraction kick

In order to inject into specific buckets, the extraction kicker delay compensation for the first bar of the the SIS100 revolution frequency marker is $T_{\mathit{rev}}^{\mathit{the SIS100}} + t_{\mathit{bucket}}$, see the gray gear at the the SIS100 revolution frequency marker at the SIS18. For example, when two $U^{28+}$ bunches of the SIS18 are to be injected into buckets $\sharp3$ and $\sharp4$ of the SIS100, $t_{\mathit{bucket}} =1 \cdot T_{\mathit{rev}}^{\mathit{the SIS18}}$. The extraction kicker must be fired $t_{\mathit{v\_inj}}+t_{\mathit{TOF}}+t_{\mathit{ext}}$ earlier as the bucket passes the virtual rf cavity, so the extraction kicker delay compensation is $T_{\mathit{rev}}^{\mathit{the SIS100}} + t_{\mathit{bucket}} - (t_{\mathit{TOF}} + t_{\mathit{v\_inj}} + t_{\mathit{ext}})$, see the red lighting bolt at the the SIS100 revolution frequency marker at the SIS18. 

\item Injection kick

With the consideration of the \gls{glos:bucket_pattern}, the injection kicker delay compensation for the first bar of the the SIS100 revolution frequency marker is $T_{\mathit{rev}}^{\mathit{the SIS100}} + t_{\mathit{bucket}}$, see the gray gear at the the SIS100 revolution frequency marker at the SIS100. The injection kicker must be fired $t_{\mathit{v\_inj}}+t_{\mathit{inj}}$ time earlier as the bucket passes the virtual rf cavity, so the injection kicker delay compensation is $T_{\mathit{rev}}^{\mathit{the SIS100}} + t_{\mathit{bucket}} - (t_{\mathit{v\_inj}} + t_{\mathit{inj}})$, see the red lighting bolt at the the SIS100 revolution frequency marker at the SIS100.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5%%%%
\section{Basic procedure of the FAIR B2B transfer system}
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{2method.png}
   \caption{The procedure for the B2B transfer within one acceleration cycle.}{Shown are with the frequency beating method (blue, top) and with the phase shift method (green, bottom).}
   \label{2method}
\end{figure}
Fig.~\ref{2method} illustrates the basic procedure of the B2B transfer with two different synchronization scenarios. The yellow region shows the synchronization window. The purple region shows the valid time for the emergency kicker. The emergency kickers can be triggered at any time during the acceleration cycle by the MPS.  


The B2B transfer process basically needs to follow the six steps ~\cite{bai_bunch_2015}:
\begin{enumerate}
\item The DM announces the B2B transfer and requests the switch off of the beam feedback loops on the rf system, when required.
\item Two synchrotrons measure the rf phase locally.
\item The source synchrotron receives the measured rf phase from the target synchrotron.
\item The source synchrotron calculates the synchronization window and sends it to both synchrotrons and to the DM. Besides, the bucket label signal is reproduces at the source and target synchrotrons for the indication of the bucket pattern.

The source synchrotron generally accomplishes the phase alignment in case of the phase shift method. A particular case is the empty target synchrotron. The phase alignemt can be achieved very fast and simple by the phase jump at the target synchrotron. Although the synchronization window is theoretically infinite for the phase shift method, bunches should be transfered as soon as the phase shift is done, in order to guarantee the stability of the beam. For both synchronization methods, the synchronization window has a certain length.

\item The trigger signals are generated for the kickers with the delay compensation.
\item The kicker electronic fire the kickers. The actual beam injection time and the B2B transfer status are send from the source synchrotron to the DM and the DM sends them further to the beam instrumentation.

\end{enumerate}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\section{Description of the $U^{28+}$ B2B process from the SIS18 to the SIS100 with the phase shift method}
%
%Here the $U^{28+}$ at \SI{200}{meV/\atomicmassunit} B2B transfer from the SIS18 to the SIS100 will be described in detail. 
%\begin{figure}[H]
%   \centering   
%   \includegraphics*[width=160mm]{18to100Phase.png}
%   \caption{The B2B transfer inside one the SIS18 $U^{28+}$ Super Cycle with the phase shift method.}
%   \label{18to100Phase}
%\end{figure}
%Fig.~\ref{18to100Phase} shows one the SIS18 $U^{28+}$ super cycle. It consists of four the SIS18 cycles. Each cycle produces two bunches. From the SIS18, four cycles of the $U^{28+}$, each of two bunches, are injected into eight out of ten buckets of the SIS100. In each the SIS18 cycle, the beam is accelerated to the top energy after injection. At the rf flattop, the synchronization is implemented with the phase shift method by modulating rf frequency. 
%The ratio of the the SIS100 circumference to the the SIS18 circumference is 5. The harmonic number for the SIS100 is 10 and for the SIS18 is 2. At the flattop, the rf cavity rf frequency of the SIS18 is \SI{1.572}{MHz} as that of the SIS100, so the phase difference between two rf signals is almost constant. To perform the B2B transfer, this phase difference must be corrected to compensate for the required phase difference by phase shift. The frequency ramp at the start and end of the the SIS18 frequency modulation must be performed adiabatically. Here we use a parabola rf frequency modulation, more details please see Sec. 5.1.1.  Then the time for a phase shift of  $180^\circ$ is \SI{7}{\ms}.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\section{Description of the $U^{28+}$ B2B process from the SIS18 to the SIS100 with the frequency beating method}
%For the frequency beating method of the $U^{28+}$ at \SI{200}{meV/\atomicmassunit} B2B transfer from the SIS18 to the SIS100, we assume to detune \SI{200}{Hz} for the the SIS18 rf signal during the acceleration ramp. The beating frequency is \SI{200}{Hz} and the synchronization period is \SI{5}{\ms}.
%\begin{figure}[H]
%   \centering   
%   \includegraphics*[width=160mm]{18to100freq.png}
%   \caption{The B2B transfer inside one the SIS18 $U^{28+}$ Super Cycle with the frequency beating method.}
%   \label{18to100freq}
%\end{figure}
%Fig.~\ref{18to100freq} illustrates the standard synchronization process with the frequency beating method. In order to guarantee that eight sequential buckets will be filled by eight bunches, the synchronization window should be at least twice as long as the the SIS100 revolution period. The accuracy within the synchronization window is better than $0.5^\circ$. 
%
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Realization of the FAIR B2B transfer system}
This section describes the realization of the FAIR B2B transfer system based on the FAIR control system and LLRF system introduced in Chap. ~\ref{technical}.
%Fig.~\ref{Topology} shows the topology of the B2B transfer system ~\cite{bai_bunch_2015, bai_concept_2016}.
%\begin{figure}[!htb]
%   \centering   
%   \includegraphics*[width=160mm]{Topology.jpg}
%   \caption{The topology of the B2B transfer system}
%   \label{Topology}
%\end{figure}
%
%The B2B transfer system includes four main SCUs.
%\begin{enumerate}
%\item REF SCU provides the Reference RF Signals for a group of cavities in one synchrotron. 
%\item COPY SCU is used for the phase measurement.
%\item B2B SCU
%\item Trigger SCU provides trigger for the kickers in each synchrotron.
%\end{enumerate}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Phase measurement %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Phase measurement and corresponding timestamp of each rf system}
The rf frequency in the source and target synchrotron need to be stable constant during the B2B transfer process. The phase measurement of each rf system follows the principles as shown below.

\begin{enumerate}
\item The measurement of the actual phase values.
\item The extrapolation of the phase value in the future based on the measured phase values.
\item The timestamp for the extrapolated phase values.
\end{enumerate}
 \subsubsection{Measurement of actual phase values of each rf system}
The phase measurement of each rf system is achieved by measuring the phase advance between a deticated Reference RF Signal of a synchrotron and a shared reference sinusoidal signal. The phase advance has a linear relationship with time, whose range is from $-180^\circ$ to $+180^\circ$. 


A dedicated Reference RF Signal of a synchrotron has its synchronization frequency, see Sec. ~\ref{match}. A shared reference signal (which is called “\gls{glos:Syn_ref_signal}”) is used in the source and target synchrotrons in order to determine the phase difference between two rf systems. It has a fixed frequency and always in phase at two synchrotrons. It is a sinusoidal wave, whose frequency is a multiple of BuTiS T0 \SI{100}{kHz} and whose positive zero-crossings are always aligned with the first positive zero-crossings of C2 clocks after T0 edges ~\cite{ferrand_system_2014, ferrand_system_2015}. Thus, the Synchronization Reference Signal is synchronous in different supply rooms by definition. The frequency of the Synchronization Reference Signal $f_\mathit{syn}^\mathit{REF}$ is calculated by 

\begin{equation}
\label{round}
	f_\mathit{syn}^\mathit{REF}=\textit{round} (f_\mathit{syn}^{X}/\SI{100}{kHz})\cdot \SI{100}{kHz}
\end{equation}

The function \textit{round} rounds $f_\mathit{syn}^{X}/100kHz$ to an integer value, which is closest to $f_\mathit{syn}^{X}/\SI{100}{kHz}$. e.g. $f_\mathit{syn}^{X}=\SI{988.388}{kHz}$, $f_\mathit{syn}^{X}/\SI{100}{kHz}=0.988388$, so $\textit{round} (f_\mathit{syn}^{X}/\SI{100}{kHz})=10$ and $f_\mathit{syn}^\mathit{REF}=\SI{1}{MHz}$. This is the use case of h=1 B2B transfer from the the SIS18 to the the ESR, more details, please see Chap. ~\ref{application}.

\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{phase_prediction.jpg}
   \caption{The realization of the phase advance measurement at one synchrotron}
   \label{phase_prediction}
\end{figure}

Fig.~\ref{phase_prediction} shows the phase measurement of the rf system at a dedicated synchrotron. The red sinusoidal wave represents the Synchronization Reference Signals (e.g \SI{100}{kHz}) in two supply rooms and the black wave the Reference RF Signals (e.g. \SI{1000/3}{kHz}) from the \gls{glos:group_DDS}. Although the relation between the Synchronization Reference Signal and the Reference RF Signal in Fig.~\ref{phase_prediction} does not comply with eq. ~\ref{round}, the principle for the measurement of the phase advance is same and they are used for the easy understanding of the process. The phase advance \gls{symb:phase_diff_s} between the Reference RF Signal and the Synchronization Reference Signal is measured by the Phase Advance Measurement (\gls{PAM}) Module at the source synchrotrons and \gls{symb:phase_diff_t} at the target synchrotron. The phase advance measurement is performed asynchronously to an internal clock, which is represented by the blue dots. For more details about the implementation and realization of the PAM module, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_????}. 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Phase extrapolate %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Phase extrapolation of each rf system}
The phase advance can be extrapolated due to the linear relationship between time and the phase advance. Based on a series of the phase advance measurements, the phase advance at the first positve zero-crossings of C2 clocks after T0 edges \gls{symb:phase_diff_s_T0} and \gls{symb:phase_diff_t_T0} are extrapolated at the source and target synchrotrons by the Phase Advance Prediction (\gls{PAP}) Module. The extrapolated phase advance, $\psi1$ and $\psi2$ at the source and target synchrotron, is represented by red diamonds in Fig.~\ref{phase_prediction1}. Because the phase advance extrapolation is synchronized with the first positive zero-crossings of C2 clocks after T0 edges and the Synchronization Reference Signal is zero phase aligned with the first positive zero-crossings of C2 clocks after T0 edges, $\psi1$ and $\psi2$ are the phase of the Reference RF Signals of the virtual rf cavitis of two synchrotrons (represented as black dots in Fig.~\ref{phase_prediction1}). For more details about the implementation and realization of the PAP module, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_????}.   
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{phase_prediction1.jpg}
   \caption{The realization of the phase advance extrapolation at one synchrotron}
   \label{phase_prediction1}
\end{figure}
 %%%%%%%%%%%%%%%%%%%%%%Rf phase difference synchronous to the absolute time stamping%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Timestamp the extrapolated phases}
The timestamp of the first positive zero-crossings of C2 clocks after T0 edges corresponds to the extrapolated phases. 

The timing nodes, the B2B source and target SCUs ~\cite{beck_new_2012, thieme_scu_2013}, are equiped in the source and target synchrotrons. The PAP module is as a SCU slave \footnote{\url{https://en.wikipedia.org/wiki/Master/slave_(technology)}} in the B2B source and target SCU, see Fig.~\ref{PAP}. Both the B2B source and target SCUs could get the timestamp of positive zero-crossings of \gls{BuTiS} C2 clocks. 
 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=80mm]{PAP.png}
   \caption{Implementation of the Phase Advance Prediction Module in the B2B source SCU}
   \label{PAP}
\end{figure}

Fig.~\ref{phase_diff_syn_time} illustrates the synchronization of the extrapolated phase to the timestamp. The DM broadcasts the timing frame of CMD\_START\_B2B to the WR network. This timing frame will be received by the \gls{glos:B2B_s_SCU} and the \gls{glos:B2B_t_SCU}. The B2B source and target SCUs start the B2B process at the designated time, the first positive zero-crossings of C2 clock after a specified T0 edge (represented as the pink dot in Fig.~\ref{phase_diff_syn_time}). They need maximum \SI{1}{\us} to inform the PAP modules to start the phase advance extrapolation respectively. The PAP modules needs approximate \SI{500}{\us} for the phase extrapolation and updates the extrapolated phase value at the first positive zero-crossings of C2 clocks after T0 edges. After \SI{500}{\us}, the B2B source and target SCUs need another maximum \SI{1}{\us} to get the extrapolated phase $\psi$ (represented as the red diamond in Fig.~\ref{phase_diff_syn_time}) from the PAP modules and they also get the timestamp of the first positive zero-crossings of C2 clock after T0 edge $t_{\psi}$ which corresponds to the extrapolated phase, as well as the slope of the phase advance $k$. The B2B source SCU obtains $\psi1$, \gls{symb:time_phase_diff_s_T0} and $k$ at the source synchrotron and the B2B target SCU $\psi2$, \gls{symb:time_phase_diff_t_T0} and $k$ at the target synchrotron.
 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{phase_diff_syn_time.jpg}
   \caption{The synchronization of the extrapolated phase to the timestamp in one synchrotron}
   \label{phase_diff_syn_time}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Exchage data %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Exchange of the measured data}

For the B2B transfer, there is a ``B2B transfer master``, which is responsible for the data collection of two synchrotrons, the data calculation, the data redistribution and the B2B transfer status check. The data of the source and target synchrotron must be transferred to the ``B2B transfer master`` via the deterministic WR network in the format of the timing frame.
 
For the simplicity, the B2B source SCU works as the ``B2B transfer master``, so the extrapolated phase $\psi2$, the corresponding timestamp $t_{\psi2}$ and the phase advance slope \gls{symb:slope} are transferred by the B2B target SCU to the B2B source SCU via the WR network. The transfer of the data is achieved by the \gls{glos:timing_frame} TGM \_PHASE \_TIME. The B2B transfer involves a certain amount of timing frames. More details about the B2B timing frames, please see Appendix A. The timing frames are not sent via the DM in order to reduce the traffic of the WR network and reduce the timing frame transfer delay on the WR network ~\cite{bai_concept_2016}, so a specified VLAN, B2B \gls{VLAN}, is defined for the B2B timing frames. All SCUs for the B2B transfer are assigned to the B2B VLAN. Fig.~\ref{network_B2B} illustrates an example of the transfer path of the B2B timing frames in the WR network. The frames are transferred along the path with orange color instead of the path with blue color. 
 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=130mm]{network_B2B.jpg}
   \caption{One example of the transfer path of the B2B timing frames in the WR network}
   \label{network_B2B}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% rf synchronization %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Rf synchronization}
The FAIR B2B transfer system is available for both the phase shift and frequency beating methods, see Sec. \ref{two_sync_methods}. The rf synchronization of two synchrotrons can be realized based on the measurement of the phase difference between the synchronization frequencies of two rf systems. With the phase shift method, a frequency modulation with a fixed duration is applied to the synchronization frequency of one rf system. With the frequency beating method, the phase difference varies at the rate of the synchronizytion frequency difference between two rf systems. The SM provides the synchronization frequencies and the extra phase shift/the detune frequency to the B2B source SCU.
\begin{itemize}
\item Rf synchronization with the phase shift method

 
%\begin{equation}
%\Delta \phi_{shift}= 2\pi \int_{t_0}^{t_0+T} \Delta f_{rf}(t)dt \label{phase}
%\end{equation}
%The required phase shift is determined by the frequency offset \gls{symb:freq_modulation} and the duration of the frequency modulation $T$.
Eq.~\ref{phase1} gives the relation between the required phase shift and the frequency modulation. The phase shift must be executed adiabatically, see Sec. \ref{two_sync_methods}. For the rf synchronization, the maximum required phase shift of the synchronization frequency is $360^\circ$. In order to accomplish the phase alignment as fast as possible, the phase shift will be conducted backward or forward. Therefore a phase shift of up to $\pm 180^\circ$ will be implemented on the synchronization frequency for the rf frequency modulation. A normalized frequency modulation profile \gls{symb:phase_shift_normalized} for $180^\circ$ can be precalculated, which guarantees the adiabaticity. The actual frequency modulation profile \gls{symb:phase_shift_actual} is decided by the normalized frequency modulation profile and the required phase shift, see eq.~\ref{actual_profile}. The B2B source SCU calculates the required phase shift, $\Delta \phi$, according to the phase difference with the help of the extra phase shift from the SM. If the the SIS100 odd buckets need to be injected by one the SIS18 $H^+$ bunch, the extra phase shift equals to $0^\circ$, If the the SIS100 even buckets need to be injected by one the SIS18 $H^+$ bunch, the extra phase shift equals to $\pi$. 
\begin{equation}
\frac{\Delta \phi}{180^\circ}= \frac{f_{\mathit{actual}}}{f_{\mathit{normalized}}} \label{actual_profile}
\end{equation}

Fig.~\ref{normalized_profile} shows an example of a normalized and several actual frequency  modulation profiles and the corresponding phase shift profiles. The magenta profile is the normalized profile $f_{normalized}$ with the phase shift of $180^\circ$. The blue one is $1/2 f_{\mathit{normalized}}$ with the phase shift of $90^\circ$ and the green one is $1/3 f_{\mathit{normalized}}$ with $60^\circ$. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{normalized_profile.png}
   \caption{The normalized frequency and phase modulation profile and the actual profiles}
   \label{normalized_profile}
\end{figure}  

Fig.~\ref{PSM} shows the implementation of the Phase Shift Module (PSM) in the B2B source SCU. The B2B source SCU sends the required phase shift to the \gls{PSM}, which controls the phase shift of the Reference RF Signal of Group DDS by means of either the frequency modulation (Fig.~\ref{normalized_profile} (a)) or the phase modulation (Fig.~\ref{normalized_profile} (b)). The required phase shift is distributed star-shaped to all the Group DDS of the synchrontron. The Reference RF Signal is routed to the different cavity systems by a Switch Matrix to realize the phase shift of all cavities on the synchrotron. For more details about the implementation and realization of the PSM module, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_????}.
  \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=80mm]{PSM.jpg}
   \caption{Implementation of the Phase Shift Module in the B2B source SCU}
   \label{PSM}
\end{figure}                     


A particular case of the B2B synchronization occurs, when the target synchrotron is empty, i.e. it does not capture any bunch yet, the phase shift can be done for the target synchrotron without adiabatical consideration (e.g. the phase jump is possible). In this case, the B2B source SCU sends the timing frame TGM \_PHASE \_JUMP to the B2B target SCU, which contains the required phase jump. After the B2B target SCU receives the timing frame, it sends the value to the PSM for the phase jump of the Group DDS of the target synchrotron.

\item Rf synchronization with the frequency beating method

The circumference ratio between many pair of machines in FAIR is not a perfect integer, the synchronization frequencies of two synchrotrons begin beating automatically. For the pairs with the perfect integeral circumference ratio, the synchronization frequency of the source synchrotron is detuned by modifying the magnetic field and orbit during the acceleration ramp, see Sec. ~\ref{subsec:beating}. The Group DDS produces the detuned Reference RF Signal.
\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Calculation%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Coarse synchronization}
% For each beam production chain, the B2B related SCUs will be configured by FESA.

The \gls{glos:coarse_syn} is achieved by the synchronization window with a certain length. Within this window, bunches are transferred into buckets with the center mismatch smaller than the upper bound\footnote{B2B transfer from the SIS18 to the SIS100: upper bound of the bunch-to-bucket center mismatch is $\pm1^\circ$}. The length of the synchronization window \gls{symb:syn_win_length} is two rf periods of the reproduced signal for the bucket label, see Sec. \ref{sec:bucket_label}. For the phase shift method, the bunch-to-bucket injection center mismatch within the synchronization window is almost $0^\circ$. For the frequency beating method, the maximum bunch-to-bucket injection center mismatch $\Delta \phi$ with the synchronization window is calculated by 
\begin{equation}
\frac{T_{\mathit{sync\_win}}}{1/\Delta f}= \frac{\Delta \phi}{360^\circ}
\end{equation}

The B2B source SCU is capable of receiving the values~\footnote{The delay compensation for the TOF and the kicker preparation time, the cavity rf frequencies of the source and target synchrotrons, the extra phase shift value for the even buckets injection and the upper bound time for the phase shift of the source synchrotron} from the SM by FESA classes via the accelerator network. The B2B source SCU calculates the synchronization window, taking kicker delays into consideration and transfers the timestamp of the start of the synchronization window, TGM \_SYNCH \_WIN, to the DM and the source and target Trigger SCUs via the WR network. The Trigger SCUs are used to produce the kicker trigger signals. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Bucket label %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Bucket label}
\label{sec:bucket_label}
The bucket label is realized based on the indication signal for the first bucket plus a fixed delay for the indication of the correct buckets to be filled. The indication signal is either with the revolution frequency or the synchronization frequency of the target synchrotron. It is dependent on the relation between the revolution frequency and the synchronization frequency of the target synchrotron.  When $f_{\mathit{syn}}^{trg}>=f_{\mathit{rev}}^{trg}$, namely the rf period of the synchronization frequency is equal to or less than the revolution period, the  rf period of the synchronization frequency is not long enough to indicate all buckets in one revolution period. In this case, the indication signal is with the revolution frequency of the target synchrotron and the synchronization window is two times long as the revolution period, namely $T_{\mathit{sync\_win}}=2\cdot T_{\mathit{rev}}^{\mathit{trg}}$. Oppositly, the indication signal is with the synchronization frequency of the target synchrotron and the synchronization window is two times long as the rf period of the synchronization frequency, namely $T_{\mathit{sync\_win}}=2\cdot T_\mathit{syn}^{\mathit{trg}}$. $T_\mathit{syn}^X$ is denoted as the rf period of the synchronization frequency of the synchrotron $X$. Becasue the evolution of the phase advance of the Reference RF Signal of the target synchrotron $\psi$ can be calculated according to the slope of the phase advance $k$, see eq. ~\ref{linear}.  

\begin{equation}
\psi= kt+\psi_0 \label{linear}
\end{equation}
Where $\psi2$ and $t_{\psi2}$ coincidence with the linear relationship, so $\psi_0$, the initial phase advance, can be calculated as $\psi2-kt_{\psi2}$.


The indication signal can be corrected exactly in phase with the frequency of $f_{\mathit{rev}}^{trg}$ or $f_{\mathit{syn}}^{trg}$. The indication signal is exactly a copy of the revolution frequency or the synchronization frequency of the target synchrotron, so it is called ''reproduced signal'', or ``bucket label signal`` from the functional perspective. The reproduced signal coud be reproduced campus-wide. A specifc bucket is just a certain number of the cavity rf periods of the target synchrotron delay based on the reproduced signal.


The FAIR B2B transfer system needs the bucket label not only at the rf flattop, but also during the whole acceleration cycle. The bucket label at the rf flattop is used for the normal extraction and injection and the bucket label during the whole acceleration cycle is used for the emergency dump. For the the SIS100 emergency kick, the reproduced signal has always the same freqency and is always in phase with the the SIS100 revolution signal, so it is called the ''real-time reproduced signal''. The delay based on the real-time reproduced signal always indicates the bunch gap.


 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=80mm]{PCM.png}
   \caption{Implementation of the Phase Correction Module in the Trigger SCU}
   \label{PCM}
\end{figure}
The bucket label is realized by the Trigger SCU, the Signal Reproduction (SR) module and the Phase Correction Module (PCM), see Fig.~\ref{PCM}. The reproduced signal is produced by SR module. The Trigger SCU is responsible for the receipt of the phase correction value from the B2B source SCU and the transfer of this value to the PCM. The PCM module is used to correct the phase of the reproduced signal. The PCM module is as a SCU salve in the Trigger SCU. The SR module produces the bucket label signal in the format of the pulse wave, whose rising edges are aligned with the positive zero-crossings of the rf signal of the revolution frequency or the synchronization frequency. For more details about the implementation and realization of the PCM and the SR module, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_????}. 

\begin{itemize}
\item Bucket label for the normal extraction and injection

For the bucket label for the normal extraction and injection, three steps are necessary. Fig.~\ref{bucket_label} shows these three steps for the reproduction of the bucket label. Here the B2B transfer from the the SIS18 to the the SIS100 is taken as an example.
\begin{figure}[H]
   \centering   
   \includegraphics*[width=130mm]{bucket_label.jpg}
   \caption{The realization of the bucket label for the normal extraction and injection.}
   \label{bucket_label}
\end{figure}  
\begin{itemize}
\item[-] Step 1. Frequency correction

The \gls{SR} module produces the ''reproduced signal'' with the same frequency as the revolution frequency or the synchronization frequency of the target synchrotron. The positive zero-crossing of the reproduced signal always indicates the start of the 1st bucket.
\item[-] Step 2. Phase correction

The reproduced signal must do the phase correction at a specified first positive zero-crossing of C2 clock after T0 edge. The phase correction value is calculated by the B2B source SCU and transferred by the timing frame TGM \_PHASE \_CORRECTION to the \gls{glos:trigger_scu}. Then the Trigger SCU gives the phase correction value to the SR module via the PCM.

\item[-] Step 3. Bucket indication

The SM considers the bucket pattern $t_{\mathit{bucket}}$ within the kicker delay compensation, see Sec. ~\ref{sec:compensation}. In Fig.~\ref{bucket_label}, the reproduced signal is with the the SIS100 revolution frequency and the 3rd and 4th buckets of ten buckets will be filled with $t_{\mathit{bucket}}=1\cdot T_{\mathit{rev}}^{\mathit{the SIS18}}$. 
\end{itemize}

\item Bunch gap label for the emergency extraction

Only for the SIS100 emergency procedure, the bunch gap label is important during the whole acceleration cycle. There are two steps for the realization of the bunch gap label, see Fig.~\ref{Emergency_label}.
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=130mm]{Emergency_label.jpg}
   \caption{The realization of the bunch gap for the emergency extraction.}
   \label{Emergency_label}
\end{figure} 

\begin{itemize}
\item[-] Step 1. The real-time reproduced signal is directly distributed from the switch matrix, which synchronizes with the rf signal of the revolution frequency or that of the synchronization frequency of the target synchrotron in frequency and phase.
\item[-] Step 2. Bunch gap indication.

The SM considers the bunch gap $t_{\mathit{bucket}}$ within the kicker delay compensation. In Fig.~\ref{Emergency_label}, the real-time reproduced signal is with the the SIS100 revolution frequency and the 9th and 10th buckets of ten buckets are taken as an example as the bunch gap. The $t_{\mathit{bucket}}=4\cdot T_{\mathit{rev}}^{\mathit{the SIS18}}$.

\end{itemize}

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Fine synchronization of the extraction and injection kicker}
After the synchronization of the rf systems between two synchrotrons, the TOF and all propagation delays are compensated. Now, the extraction and injection kickers must be fired at the calculated trigger time within the bunch gap before the specific bunch or bucket passes the kickers.
 
This is the task of the Trigger Decision (TD) module in the Trigger SCU. The TD receives the  synchronization window in the form of an enable signal. The \gls{glos:fine_syn} will be accomplished by the pulse of the reproduced signal plus the extraction or injection kicker delay compensation from the SM. This achieves the fine synchronization of the B2B transfer. The TD transmits the kicker pulse directly to the kicker electronic.  
 
In case of fatal errors or considerable damage, the emergency kicker must kick the beam immediately but within the bunch gap into the emergency dump.



%After the synchronization between two rf systems, the exact TOF between two synchrotrons before a specific bucket passes the injection kicker, the extraction kicker must kick the bunch in the source synchrotron. When there are in case of the fatal error or considerabel damage, the emergency kicker must kick the beam into the emergency dump as soon as possible. This achieves the ````.
%
%The first pulse of the reproduced signal within the synchronization window is selected. The triggers for the extraction and injection kicker are produced after the selected reproduced signal with the delay of the extraction and injection kicker delay compensation. When some emergency happens, the coming bunch gap label outputs to trigger the emergency kicker.
 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=80mm]{TD.png}
   \caption{Implementation of the Trigger Decision module in the Trigger SCU}
   \label{TD}
\end{figure}
Fig.~\ref{TD} shows the implementataion of the Trigger Decision (TD) module in the Trigger SCU.  The TD module is responsible for the production of triggers for the kickers. 
%The extraction/injection kicker trigger signal is produced by the TD module, which selects the first reproduced signal within the synchronization window and adds the delay of the extraction /injection kicker delay compensation to the first reproduced signal. For the emergency kick, the TD module produces the bunch gap label by the delay of the bunch gap based on the real-time reproduced signal.   

For the normal B2B extraction/injection, the synchronization window is received by the source and target Trigger SCUs from the WR network by TGM \_SYNCH \_WIN. The kicker triggering is realized based on the first rising edge of the bucket label signal within the synchronization window plus the kicker delay compensation. The extraction kick delay compensation is $T_{\mathit{rev}}^{\mathit{the SIS100}}$ + $T_{\mathit{rev}}^{\mathit{the SIS18}}$ -(\gls{symb:two_TOF} +$ t_{v\_inj}$+ \gls{symb:ext_pre}) and the injection kicker delay compensation is $T_{\mathit{rev}}^{\mathit{the SIS100}}$ + $T_{\mathit{rev}}^{\mathit{the SIS18}} - (t_{v\_inj}+$ \gls{symb:inj_pre}) in the example in Fig.~\ref{ext_inj_kicker}, when the bucket label signal has the frequency of $f_{\mathit{rev}}^{\mathit{trg}}$. 

For FAIR use cases, that the bucket label signal has the frequency of $f_{\mathit{syn}}^{\mathit{trg}}$, there is always only one bucket in the target synchrotron. In this case, the bucket pattern is not taken into consideration. The kicker triggering is realized based on the first rising edge of the bucket label signal within the synchronization window plus the kicker delay compensation. The extraction kick delay compensation is $T_{\mathit{syn}}^{\mathit{trg}} -$(\gls{symb:two_TOF}$ + t_{v\_inj}+ $\gls{symb:ext_pre}) and the injection kicker delay compensation is $T_{\mathit{syn}}^{\mathit{trg}} - (t_{v\_inj}+ $\gls{symb:inj_pre}), see Fig.~\ref{ext_inj_kicker1}. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=150mm]{syc_ext_inj1.jpg}
   \caption{The illustration of the kicker delay compensation when the bucket label signal has the frequency of $f_{\mathit{syn}}^{\mathit{trg}}$.}{Red lighting bolts represent the extraction and injection kicker firing.}
   \label{ext_inj_kicker1}
\end{figure}



Both extraction and injection kick delay compensation values are preloaded from the SM to the Trigger SCU and the Trigger SCU gives these values to the TD module. When the beam injection inhibit signal from the MPS is on, the TD module will block the extraction/injeciton trigger.

For the the SIS100 emergency kick, the extraction delay compensation is calculated by $T_{\mathit{rev}}^{\mathit{the SIS100}} + t_{bucket} - (t_{v\_emg} + t_{emg})$, where \gls{symb:temg} is the time delay between the virtual rf cavity and the emergency extraction position and \gls{symb:Demg} the emergency kicker delay. The emergency extraction delay compensation values are preloaded from the SM to the Trigger SCU and the Trigger SCU gives these values to the TD module. The kicker delay compensation is applied to the real-time reproduced signal by TD module. Only when the emergency dump signal from MPS is valid, the emergency kicker will be triggered by the TD module.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsection{Beam indication for the beam instrumentation}
%
%Two timing frames will be send from the B2B source SCU to the DM. DM sends them further to the FECs for BI.
%\begin{itemize}
%\item[-] Timing frame $TGM\_SYNCH\_WIN$
%
%This time frame indicates the start of the synchronization window for the beam instrumentation.
%
%\item[-] Timing frame $TGM\_B2B\_STATUS$
%
%The time frame $TGM\_B2B\_STATUS$ indicates the status of the B2B transfer system and the actual beam injection time. 
%\end{itemize}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% WR network %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsection{WR network}
%
%The B2B transfer involves a certain amount of frames within the WR network ~\cite{beck_white_2011}. More details about the B2B frames, please see Appendix A. The name of the timing frames from the DM is beginning with CMD\_, the name of other telegrams is beginning with TGM\_. The B2B related frames make use of the format of the timing frame. The Format ID (\gls{FID}) of the timing frame is used to indicate the B2B transfer, the Group ID (\gls{GID}) the source and target machines and the Beam Process ID (\gls{BPID}) the B2B process steps for the B2B related SCUs. 
%
%A Virtual Local Area Network (VLAN) is a group of FECs in the WR network that is logically segmented by function or application, without regard to the physical locations of the FECs. 
%
%All FECs in the WR network are assigned to the DM VLAN, within which the DM forwards broadcast timing telegrams downwards to all FECs. The telegrams sent from the source B2B SCU upwards to the DM are unicast packets within this VLAN. E.g. TGM\_SYNCH\_WIN and TGM\_B2B\_STATUS. 
%
%
%\begin{landscape}
%\begin{figure}[H]
%   \centering   
%   \includegraphics*[width=250mm]{Telegram_network.jpg}
%   \caption{Timing frames transfer for the B2B transfer}
%   \label{Telegram_network}
%\end{figure}  
%\end{landscape}
%
%Besides, the SCUs for the B2B transfer are assigned to the B2B \gls{VLAN}. The specified VLAN for the B2B transfer could reduce the traffic of the WR network ~\cite{bai_concept_2016}. All B2B related telegrams TGM\_ except TGM\_SYNCH\_WIN and TGM\_B2B\_STATUS are broadcasted in the B2B VLAN. The broadcast packet is much safer, because it does not need to know the Internet Protocol address (\gls{IP} address) of B2B related SCUs. Besides, it increases the flexibility of the system that all SCUs for the B2B transfer could have changeable IP addresses. Fig. ~\ref{Telegram_network} shows the types of the B2B timing frames, their VLANs and the frames transfers among B2B related SCUs.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Status check %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{B2B transfer status check}
The B2B transfer status must be known by the DM. The B2B source SCU, the B2B transfer master, is responsible for the status check. The B2B source SCU receives the trigger time of the extraction kicker and actual beam extraction time, TGM \_KICKER \_TRIGGER \_TIME \_S, from the source \gls{glos:trigger_scu} via the WR network and also the trigger time of the injection kicker and actual beam injection time, TGM \_KICKER \_TRIGGER \_TIME \_T, from the target Trigger SCU via the WR network. The Trigger SCU collects the kicker trigger time and the beam extraction/injection time. The B2B source SCU examines the status of the B2B transfer system and transfers the status and the actual beam injection time, TGM \_B2B \_STATUS, to the DM. If all components of the B2B transfer system work correctly and the B2B transfer process is successful. Otherwise it is failed. 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Data flow of the FAIR B2B transfer system}
In this section, the procedure for the B2B transfer is explained from the perspective of the data flow, which follows the basic six steps in Fig.~\ref{2method}. Fig. ~\ref{data_flow} shows the data flow in the source and target synchrotrons and between two synchrotrons. The rectangle with the different color represents the basic six steps. The left part in each rectangle presents the data flow in the source synchrotron and the right part the data flow in the target synchrotron.


\begin{enumerate}
\item The DM sends the timing frame CMD\_START\_B2B to the B2B source and target SCUs for the start of the B2B transfer via the WR network. Besides, it requests the freez of the feedback loop.

\item  After receiving CMD\_START\_B2B, the B2B source and target SCUs start the PAM module to measure the phase advance $\Delta \varphi$ with the help of the PAP module locally and the PAP module extrapolates the phase advance in the furture. After a period of time, the B2B source and targtet SCU reads the extrapolated phase advance $\psi$ and the slope of the phase advance $k$ from the PAP module locally, timestamping the $\psi$.  

\item  The B2B target SCU sends the extrapolated phase $\psi2$, the corresponding timestamp $t_{\psi2}$ and the slope $k$ in the format of the timing frame TGM \_PHASE \_TIME to the B2B source SCU via the WR network. 
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=110mm]{data_flow.jpg}
   \caption{The data flow of the B2B transfer system}
   \label{data_flow}
\end{figure}  

\item  When the B2B source SCU receives the timing frame TGM \_PHASE \_TIME, it calculates the synchronization window and transfers the timestamp of the start of the window to the DM in the format of the timing frame TGM \_SYNCH \_WIN, as well as to the Trigger SCUs at the source and target synchrotrons.
The B2B source SCU calculates the phase correction value and transfers it to all Trigger SCUs via the WR network in the format of the timing frame TGM \_PHASE \_CORRECTION. Then the Trigger SCUs transfer the phase correction value to its \gls{PCM}. The PCM starts the phase correction of the SR module. 

Only for the phase shift method, the B2B source SCU calculates the required shifted phase $\Delta \phi$ and transfers it to the PSM. Then the PSM transfers the phase or frequency modulation profile to the Group DDS.  

\item  When the source and target Trigger SCUs receive the timing frame TGM \_SYNCH \_WIN, they produces the synchronization window pulse for the TD module. With the help of the reproduced signal from the SR module, the kicker delay compensation from the Trigger SCU and the indication signals (the emergency dump signal and the beam injection inhibit signal) from the MPS, the TD module produces the normal extraction/injection trigger signals or the emergency kick trigger for the kicker.  

\item  The extraction and injection kickers or emergency kicker are fired. After that, the source Trigger SCU gets the actual beam extraction time and the timestamp of the extraction trigger signal from the TD module and transfers them to the source B2B SCU in the format of the timing frame TGM \_KICKER \_TRIGGER \_TIME \_S. The target Trigger SCU gets the timestamp of actual beam injection time and the timestamp of the injection trigger signal from the TD module and transfers them to the source B2B SCU in the format of the timing frame TGM \_KICKER \_TRIGGER \_TIME \_T. Then the B2B source SCU checks the B2B transfer status and transfers the status together with the beam injection time to the DM in the format of the timing frame TGM \_B2B \_STAUS (represented as the red line in the rectangle of step 6 in Fig. ~\ref{data_flow}).

\end{enumerate}


