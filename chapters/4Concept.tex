

In order to realize the B2B transfer above, the standard procedure is defined and described in Sec. 4.1. We specify how the basic B2B principles mentioned in Chap.2 are realized for FAIR in Sec. 4.2. In Sec. 4.3, the data flow of the B2B transfer system is described. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5%%%%
\section{Basic principle of the B2B transfer system for FAIR} 

\begin{enumerate}
\item Phase alignment of two rf systems of the source and target synchrotrons.
\begin{enumerate}
\item Measurement of the phase of the rf system in each synchrotron locally and the corresponding timestamp.
\item Exchange of the measured data.
\item Compare phase between two rf systems.
\item Adjustment of the phase differece between two rf systems. 
\item Calculate the time for the phase match.
\end{enumerate}
\item Calculate the kick time for the extraction and injection kickers.
\begin{enumerate}
\item Kicker firing requires the bunch-to-bucket injection center phase mismatch less than $1^\circ$ - coarse synchronization.
\item Bucket counting requires kicker firing based on h=1 - fine synchronization.
\end{enumerate}
\item Beam indication for the beam instrumentation.
\end{enumerate}

% .
\subsection{Phase alignment}
If the rf frequency of one rf system is integer times of the rf frequency of the other rf system, the phase difference between two rf systems must be adjusted by the phase shift method. Or the adjustment will be done automatically because of the beating frequency.
% .
\subsection{Calculation of the kick time}
For the proper B2B transfer, the position of the bunch and bucket and the firing of the extraction and injection kicker must be precisely controlled. Before the functional modules of the B2B transfer system are explained, some basic concepts and their symbols are introduced, see Fig.~\ref{ext_inj_kicker}.

\begin{itemize}
\item[-] Bucket pattern \gls{symb:bucket_pattern}.
\item[-] Time-Of-Flight (\gls{TOF}) between two synchrotrons \gls{symb:two_TOF}. 
\item[-] Time-Of-Flight between the virtual RF cavity and the extraction/injection kicker, \gls{symb:tsrc} and \gls{symb:ttrg}. 
\item[-] Extraction and injection kicker delays, \gls{symb:ext_pre} and \gls{symb:inj_pre}.
\end{itemize}
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{syc_ext_inj.jpg}
   \caption{The illustration of B2B transfer from SIS18 to SIS100.}
   \label{ext_inj_kicker}
\end{figure}
Fig.~\ref{ext_inj_kicker} illustrates B2B transfer from SIS18 to SIS100. The SIS18 and SIS100 revolution frequency markers (black bars on the first time axis and bars on the second/third time axis in Fig.~\ref{ext_inj_kicker}) indicate the time when the first bunch or the first bucket pass by the RF virtual cavity (black bars correspond to $1^{st}$ and $\sharp1$). The extraction and injection kicker firing (red lighting bolts) have a delay with respect to the first bars of the SIS100 revolution frequency marker at SIS18 and SIS100. This delay is called extraction/injection kicker delay compensation. The mentioned four instances of time are related to the second bars of the SIS100 revolution frequency marker. \gls{symb:period_rev} represents the revolution period of the synchrotron X, e.g. $T_{rev}^{SIS18}$. \gls{symb:period_rf} represents the period of the cavity frequency of synchroton X, e.g. $T_{rf}^{SIS18}$. After the RF synchronization, the time difference between the SIS18 and SIS100 revolution frequency markers is represented by \gls{symb:diff_sync}, e.g. \gls{symb:diff_sync}=$t_{v\_ext}+t_{TOF}+t_{v\_inj}$ for $U^{28+}$ and $H^{+}$ odd bucket injection,  \gls{symb:diff_sync}=$t_{v\_ext}+t_{TOF}+t_{v\_inj}- T_{rf}^{100}$ for $H^{+}$ even bucket injection, more details about the user case from SIS18 to SIS100, please see Sec.\ref{sec:cir_no_int} and \ref{sec:cir_no_int1}. Fig.~\ref{ext_inj_kicker} takes $U^{28+}$ B2B transfer from SIS18 to SIS100 as an example. SIS18 operates with harmonic number of 2 (h = 2), forming two bunches. From the SIS18, 4 batches, each of 2 bunches, are transferred into continuous 8 out of 10 SIS100 buckets ~\cite{liebermann_fair_2013, liebermann_sis100_2013}. The harmonic number of SIS100 is 10. 

\begin{itemize}
\item Extraction kick

In order to inject into specific buckets, the extraction kicker delay compensation for the first bar of the SIS100 revolution frequency marker is $T_{rev}^{SIS100} + t_{bucket}$, see gray gear at the SIS100 revolution frequency marker at SIS18. For example, when two $U^{28+}$ bunches of SIS18 are to be injected into the bucket $\sharp3$ and $\sharp4$ of SIS100, $t_{bucket} =1 \times T_{rev}^{SIS18}$. The extraction kicker must be fired $t_{v\_inj}+t_{TOF}+t_{ext}$ earlier as the bucket passes the virtual RF cavity, so the extraction kicker delay compensation is $T_{rev}^{SIS100} + t_{bucket} - (t_{TOF} + t_{v\_inj} + t_{ext})$, see red lighting bolt at the SIS100 revolution frequency marker at SIS18. 

\item Injection kick

With the consideration of the \gls{glos:bucket_pattern}, the injection kicker delay compensation for the first bar of the SIS100 revolution frequency marker is $T_{rev}^{SIS100} + t_{bucket}$, see gray gear at the SIS100 revolution frequency marker at SIS100. The injection kicker must be fired $t_{v\_inj}+t_{inj}$ time earlier as the bucket passes the virtual RF cavity, so the injection kicker delay compensation is $T_{rev}^{SIS100} + t_{bucket} - (t_{v\_inj} + t_{inj})$, see red lighting bolt at the SIS100 revolution frequency marker at SIS100.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5%%%%
\section{Basic procedure of the B2B transfer system for FAIR}

Fig.~\ref{2method} illustrates the basic procedure of the B2B transfer with two different synchronization scenarios. The top part shows the chronological steps with the frequency beating method, while the bottom part shows the steps with the phase shift method. The emergency kickers can be triggered at any time during the acceleration cycle by the MPS. The purple region shows the valid time for the emergency kicker. The yellow region shows the synchronization window. 
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{2method.jpg}
   \caption{The procedure for the B2B transfer within one acceleration cycle.}{Shown are the frequency beating method (blue, top) and the phase shift method (green, bottom).}
   \label{2method}
\end{figure}

The B2B transfer process basically needs to follow six steps ~\cite{bai_bunch_2015}:
\begin{enumerate}
\item The DM announces the B2B transfer and requests the freez of the feedback loop (e.g. beam phase feedback loop), when required.
\item The two synchrotrons measure the rf phase locally.
\item The source synchrotron receives the measured rf phase from the target synchrotron.
\item The source synchrotron calculates the synchronization window with the kicker delay and sends it to both synchrotrons and to the DM. Besides, it reproduces the bucket marker of the target synchrotron at the source synchrotron.

For the phase shift method, the source synchrotron generally achieves the phase shift. But when the target synchrotron is empty, the phase shift is achieved by the method of the phase jump at the target synchrotron for simplicity's sake. Although the synchronization window is infinite theoretically, the B2B should be transfered as soon as the phase shift is done, in order to guarantee the stability of the beam. The duration of the synchronization window is defined as two revolution periods of the large synchrotron. 
\item The trigger signal is generated for the kickers with the delay compensation.
\item The kicker electronics fire the kickers.
\end{enumerate}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\section{Description of the $U^{28+}$ B2B process from SIS18 to SIS100 with the phase shift method}
%
%Here the $U^{28+}$ at \SI{200}{meV/\atomicmassunit} B2B transfer from SIS18 to SIS100 will be described in detail. 
%\begin{figure}[H]
%   \centering   
%   \includegraphics*[width=160mm]{18to100Phase.png}
%   \caption{The B2B transfer inside one SIS18 $U^{28+}$ Super Cycle with the phase shift method.}
%   \label{18to100Phase}
%\end{figure}
%Fig.~\ref{18to100Phase} shows one SIS18 $U^{28+}$ super cycle. It consists of four SIS18 cycles. Each cycle produces two bunches. From SIS18, four cycles of the $U^{28+}$, each of two bunches, are injected into eight out of ten buckets of SIS100. In each SIS18 cycle, the beam is accelerated to the top energy after injection. At the RF flattop, the synchronization is implemented with the phase shift method by modulating rf frequency. 
%The ratio of the SIS100 circumference to the SIS18 circumference is 5. The harmonic number for SIS100 is 10 and for SIS18 is 2. At the flattop, the RF cavity frequency of SIS18 is \SI{1.572}{MHz} as that of SIS100, so the phase difference between two RF signals is almost constant. To perform the B2B transfer, this phase difference must be corrected to compensate for the required phase difference by phase shift. The frequency ramp at the start and end of the SIS18 frequency modulation must be performed adiabatically. Here we use a parabola rf frequency modulation, more details please see Sec. 5.1.1.  Then the time for a phase shift of  $180^\circ$ is \SI{7}{\ms}.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\section{Description of the $U^{28+}$ B2B process from SIS18 to SIS100 with the frequency beating method}
%For the frequency beating method of the $U^{28+}$ at \SI{200}{meV/\atomicmassunit} B2B transfer from SIS18 to SIS100, we assume to detune \SI{200}{Hz} for the SIS18 rf signal during the acceleration ramp. The beating frequency is \SI{200}{Hz} and the synchronization period is \SI{5}{\ms}.
%\begin{figure}[H]
%   \centering   
%   \includegraphics*[width=160mm]{18to100freq.png}
%   \caption{The B2B transfer inside one SIS18 $U^{28+}$ Super Cycle with the frequency beating method.}
%   \label{18to100freq}
%\end{figure}
%Fig.~\ref{18to100freq} illustrates the standard synchronization process with the frequency beating method. In order to guarantee that eight sequential buckets will be filled by eight bunches, the synchronization window should be at least twice as long as the SIS100 revolution period. The accuracy within the synchronization window is better than $0.5^\circ$. 
%
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Realization of the basic B2B functionalities}
In this section, how the basic B2B functionalities are realized based on the FAIR control system and LLRF system is introduced.
Fig.~\ref{Topology} shows the topology of the B2B transfer system ~\cite{bai_bunch_2015, bai_concept_2016}.
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{Topology.jpg}
   \caption{The topology of the B2B transfer system}
   \label{Topology}
\end{figure}
%
%The B2B transfer system includes four main SCUs.
%\begin{enumerate}
%\item REF SCU provides the Reference RF Signals for a group of cavities in one synchrotron. 
%\item COPY SCU is used for the phase measurement.
%\item B2B SCU
%\item Trigger SCU provides trigger for the kickers in each synchrotron.
%\end{enumerate}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Phase measurement %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Phase measurement and corresponding timestamp}
Assumption: two rf systems are stable during the B2B transfer process.
\begin{enumerate}
\item Measure actual phase values
\item Extrapolate phase value in the future based on the measured values
\item Timestamp the extrapolated phase values
\end{enumerate}
 \subsubsection{Phase measurement in one rf system}
In order to get the phase difference between two RF systems, we make use of a shared reference signal at both source and target synchrotrons, which is called the \gls{glos:Syn_ref_signal}. It is with the fixed frequency and always in the same phase at two synchrotrons. It is a sine wave, whose frequency is a multiple of \SI{100}{kHz} and whose zero-crossing is aligned with the first zero-crossing of C2 clocks after T0 edges in order to ensure the synchronization of the Synchronization Reference Signal in different synchrotrons ~\cite{ferrand_system_2014, ferrand_system_2015}. 

\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{phase_prediction.jpg}
   \caption{The realization of the phase advance measurement at one synchrotron}
   \label{phase_prediction}
\end{figure}

Fig.~\ref{phase_prediction} shows the phase measurement of a RF system at a synchrotron. The red sine wave represents the Synchronization Reference Signals (e.g \SI{100}{kHz}) in two synchrotrons and the black wave the Reference RF signals (e.g. \SI{1000/3}{kHz}) from the \gls{glos:group_DDS}. The phase advance \gls{symb:phase_diff_s} between the Reference RF Signal and the Synchronization Reference Signal is measured by the Phase Advance Measurement (\gls{PAM}) Module at the source synchrotrons and \gls{symb:phase_diff_t} at the target synchrotron. The phase advance measurement is performed synchronously to an internal clock, which is represented by the blue dots. For more details about the implementation and realization of the PAM module, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_????}. 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Phase extrapolate %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Phase extrapolation in one rf system}
Based on a series of the phase advance measurements, the phase advance at first zero-crossing of C2 clocks after T0 edges \gls{symb:phase_diff_s_T0} and \gls{symb:phase_diff_t_T0} could be extrapolated in every synchrotron by the Phase Advance Prediction (\gls{PAP}) Module. The extrapolated phase advance is represented by the red diamonds in Fig.~\ref{phase_prediction1}. Because the phase advance extrapolation is synchronized with the first zero-crossing of C2 clocks after T0 edges and the Synchronization Reference Signal's phase is $0^\circ$ at these zero-crossing of C2 clocks, $\psi1$ and $\psi2$ are the phase of the Reference RF Signals. For more details about the implementation and realization of the PAP module, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR`` ~\cite{ferrand_development_????}.   
\begin{figure}[H]
   \centering   
   \includegraphics*[width=160mm]{phase_prediction1.jpg}
   \caption{The realization of the phase advance extrapolation at one synchrotron}
   \label{phase_prediction1}
\end{figure}
 %%%%%%%%%%%%%%%%%%%%%%Rf phase difference synchronous to the absolute time stamping%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Timestamp the extrapolated phase}
Principle: The timestamp of the first C2 zero crossing after T0 edges corresponds to the extrapolated phase advance.

The B2B source and target SCUs are installed in the source and target synchrotrons locally. Both B2B SCUs could get the timestamp of every BuTiS C2 zero-crossing. Fig.~\ref{phase_diff_syn_time} illustrates the synchronization of the extrapolated phase to the timestamp. DM broadcasts the timing frame of CMD\_START\_B2B to the WR network. This timing frame will be received by timing notes, \gls{glos:B2B_s_SCU} and \gls{glos:B2B_t_SCU}. The B2B source and target SCUs start the B2B process at the designated time, the first zero-crossing of C2 clock after a specified T0 edge. They need maximum \SI{1}{\us} to inform the PAP modules to start the phase advance extrapolation respectively. The PAP modules use e.g. \SI{500}{\us} for the extrapolation and updates the extrapolated phase value every first zero-crossing of C2 clocks after T0 edges. After \SI{500}{\us}, the B2B source and target SCUs need another maximum \SI{1}{\us} to get the extrapolated phase $\psi1$ (represented as the red diamond in Fig.~\ref{phase_diff_syn_time}) from the PAP modules and they also get the timestamp of the first zero-crossing of C2 clock after T0 edge $t_{\psi1}$ which corresponds to the extrapolated phase, as well as the slope of the phase advance.  
 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{phase_diff_syn_time.jpg}
   \caption{The synchronization of the extrapolated phase to the timestamp in one synchrotron}
   \label{phase_diff_syn_time}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Exchage data %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Exchange of the measured data}

There is a“B2B transfer master“, which is responsible for the data collection of two synchrotrons, calculation, redistribution
and B2B transfer status check.  
 
In order to get the phase difference between two rf systems, $\psi1$ - $\psi2$, the data must be transferred between two synchrotrons. This is done via the deterministic WR network, See Sec. ????. The extrapolated phase $\psi1$, the corresponding timestamp $t_{\psi1}$ and the phase advance slope k are transferred by the B2B target SCU (Scalable Control Unit) ~\cite{beck_new_2012, thieme_scu_2013} to the B2B source SCU at the source synchrotron via the WR network, working as the“B2B transfer master“. The transfer of the data is achieved by the \gls{glos:timing_frame} TGM\_PHASE\_TIME, please see Appendix A. The timing frame is not sent via DM in order to reduce the traffic of the WR network ~\cite{bai_concept_2016} and reduce the transfer delay. Fig.~\ref{network_B2B} illustrates an example of the transfer path of the timing frame TGM\_PHASE\_TIME in the WR network. The frame is transferred along the path with orange color instead of the path with blue color. 
 \begin{figure}[!htb]
   \centering   
   \includegraphics*[width=130mm]{network_B2B.jpg}
   \caption{The B2B timing frame in the WR network}
   \label{network_B2B}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% RF synchronization %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{RF synchronization}
The B2B transfer system for FAIR is available for both the phase shift and frequency beating methods, see Sec. \ref{two_sync_methods}.
\begin{itemize}
\item RF synchronization with the phase shift method

Eq.~\ref{phase} gives the relation between the required phase shift \gls{symb:pha_shift} and the frequency modulation. 
\begin{equation}
\Delta \phi_{shift}= 2\pi \int_{t_0}^{t_0+T} \Delta f_{rf}(t)dt \label{phase}
\end{equation}
The required phase shift is determined by the frequency offset \gls{symb:freq_modulation} and the duration of the frequency modulation T. The phase shift must be executed adiabatically in order to guarantee the bucket size and continuous synchronous phase, see Sec. \ref{two_sync_methods} at page \pageref{3_criteria}. For the RF synchronization, the maximum phase shift required of one synchrotron is one bucket length of the other synchrotron, $360^\circ$. Because the phase can be shifted backward or forward, a phase shift of up to $\pm 180^\circ$ can be implemented. A normalized frequency modulation profile \gls{symb:phase_shift_normalized} for $180^\circ$ can be precalculated, which guarantees the adiabaticity. The actual frequency modulation profile \gls{symb:phase_shift_actual} is decided by the normalized frequency modulation profile and the required phase shift, see eq.~\ref{actual_profile}. The required phase shift, \gls{symb:pha_shift}, is calculated by the B2B source SCU.
\begin{equation}
\frac{\Delta \phi_{shift}}{180^\circ}= \frac{f_{actual}}{f_{normalized}} \label{actual_profile}
\end{equation}

Fig.~\ref{normalized_profile} shows an example of a normalized and several actual frequency  modulation profiles and the corresponding phase shift profile. The magenta profile is the normalized profile $f_{normalized}$ with the phase shift of $180^\circ$. The blue one is $1/2f_{normalized}$ with the phase shift of $90^\circ$ and the green one is $1/3f_{normalized}$ with $60^\circ$. 

The B2B source SCU sends the required phase shift to the Phase Shift Module (\gls{PSM}), which controls the phase shift of the Reference RF Signal of Group DDS by means of either frequency (Fig.~\ref{normalized_profile} (a)) or phase (Fig.~\ref{normalized_profile} (b)) modulation. The Reference RF Signal is routed to the different cavity systems by a Switch Matrix to realize the phase shift of all cavities on the synchrotron. For more details about the implementation and realization of the PSM modules, please see ``Development of the LLRF system for a deterministic Bunch-to-Bucket transfer for FAIR``.
                       
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{normalized_profile.png}
   \caption{The normalized frequency and phase modulation profile and the actual profiles}
   \label{normalized_profile}
\end{figure}  

A particular case of the B2B synchronization occurs, when the target synchrotron is empty, i.e. it does not capture any bunch yet, the phase shift can be done for the target synchrotron without adiabatical consideration (e.g. Phase jump is possible). In this case, the B2B source SCU sends the timing frame TGM\_PHASE\_JUMP to the B2B target SCU, which contains the required phase jump. After the B2B target SCU receives the timing frame, it sends the value to the PSM for the phase jump of the Group DDS of the target synchrotron. 

\item RF synchronization with the frequency beating method

The ratio of the circumference between many pair of machines in FAIR is not a perfect integer, e.g. SIS18 and ESR (injection orbit), SIS100 and CR, CR and HESR. So the frequencies of two synchrotrons begin beating automatically. For the pairs with the perfect integer ratio of the circumference, e.g. SIS18 and SIS100, the rf frequency of the source synchrotron is detuned by modifying the magnetic field and radial excursion to get the frequency beating. For more details about the synchronization with the frequency beating method, please see Chap. 5.

\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Calculation%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Coarse synchronization}
% For each beam production chain, the B2B related SCUs will be configured by FESA.

The coarse synchronization is achieved by the synchronization window with a certain length. Within this window, the bunch is injected into the bucket with the center mismatch smaller than the upper bound\footnote{B2B transfer from SIS18 to SIS100: upper bound of the bunch-to-bucket center mismatch is $1^\circ$}. The length of the synchronization window \gls{symb:syn_win_length} is two times the period of the reproduced signal for the bucket label, see Sec. \ref{sec:bucket_label}. For the phase shift method, the mismatch between the bunch and bucket center within the synchronization window is almost $0^\circ$. For the frequency beating method, the maximum bunch-to-bucket center mismatch \gls{symb:mismatch} with the synchronization window is calculated by 
\begin{equation}
\frac{T_{sync\_win}}{1/\Delta f}= \frac{\Delta \theta}{360^\circ}
\end{equation}
where \gls{symb:beating_freq} is the beating frequency.
The B2B source SCU is capable of receiving the values (kicker delay for extraction kicker of the source synchrotron, kicker delay for injection kicker of the target synchrotron, $t_{TOF}$, rf frequencies of the source and target synchrotrons, the upper bound time for the phase shift of the source synchrotron) from the SM by FESA classes via the accelerator network. The B2B source SCU calculates the synchronization window, taking kicker delays into consideration and transfers the timestamp of the start of the synchronization window, TGM\_SYNCH\_WIN, to the DM and the source and target Trigger SCUs via the WR network. The Trigger SCUs are used to produce the kicker trigger signal. The TGM\_SYNCH\_WIN could also be used for the triggering of the bunch rotation of both machines (e.g. SIS100 and CR) with a specified advance. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Bucket label %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Bucket label}
\label{sec:bucket_label}
The B2B transfer system for FAIR needs the bucket label not only at the rf flattop, but also during the whole acceleration cycle. The former is used for the normal extraction and injection and the latter is used for the emergency kick of SIS100. 

\begin{itemize}
\item Bucket label for the normal extraction and injection

For the bucket label for the normal extraction and injection, three steps are necessary. Fig.~\ref{bucket_label} shows these three steps for the reproduction of the bucket label. Here we use B2B trasfer from SIS18 to SIS100 as an example.
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{bucket_label.jpg}
   \caption{The realization of the bucket label for the normal extraction and injection.}
   \label{bucket_label}
\end{figure}  
\begin{itemize}
\item[-] Step 1. Frequency correction

A signal with the same frequency as the Reference RF Signal at the flattop of the target synchrotron (e.g. RF revolution frequency of SIS100) is produced by the Signal Reproduction (\gls{SR}) module, which is called the reproduced signal. For the B2B transfer system for FAIR, the zero-crossing of the reproduced signal always indicates the start of the 1st bucket.
\item[-] Step 2. Phase correction

For the phase synchronization with the bucket, the bucket label signal must do phase correction at a specified T0 edge. The phase correction value is calculated by the B2B source SCU and transferred by the timing frame TGM\_PHASE\_CORRECTION to the \gls{glos:trigger_scu}. Than the Trigger SCU gives the phase correction value to the SR module.

\item[-] Step 3. Bucket label

The SM manages the bucket pattern with the parameter of $d_{pattern}$ on the reproduced signal. In Fig.~\ref{bucket_label}, the 3rd and 4th buckets will be filled with $d_{pattern}=1\times T_{rev}^{SIS18}$. The bucket pattern is considered in the kicker delay compensation. 
\end{itemize}

\item Bunch gap label for the emergency extraction

Only for SIS100 emergency procedure, the bunch gap label is important during the whole acceleration cycle. There are two steps for the realization of the bunch gap label, see Fig.~\ref{Emergency_label}.
\begin{figure}[!htb]
   \centering   
   \includegraphics*[width=160mm]{Emergency_label.jpg}
   \caption{The realization of the bunch gap for the emergency extraction.}
   \label{Emergency_label}
\end{figure} 

\begin{itemize}
\item[-] Step 1. The reproduced signal is directly distributed from the switch matrix, which synchronizes with the Reference RF Signal in frequency and phase.
\item[-] Step 2. Bunch gap label

The SM informs the bunch gap with the parameter of $d_{pattern}$ on the reproduced signal during the whole acceleration cycle. In Fig.~\ref{Emergency_label}, the 9th and 10th buckets services as the bunch gap. The $d_{pattern}=4\times T_{rev}^{SIS18}$ is with variable value, which is considered in the kicker delay compensation and applied to the reproduced signal on T0 edges.

\end{itemize}

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Fine synchronization of the extraction and injection kicker}
For the normal B2B extraction/injection, the synchronization window is a gating signal, which is received by the source and target Trigger SCUs from the WR network by TGM\_SYNCH\_WIN. Within this window, the first reproduced signal will be selected by the Trigger Decision (\gls{TD}) module . The extraction and injection kicker are synchronized with the bunch and bucket by the extraction and injection kicker delay compensation. If the inhibit signal of MPS is off, the kicker delay compensation must be considered for the kicker synchronization. The extraction kicker will be triggered by the extraction kick delay compensation, $T_{rev}^{SIS100}$ + $T_{rev}^{SIS18}$ -(\gls{symb:two_TOF} +$ t_{v\_inj}$+ \gls{symb:ext_pre}) and the injection kicker will be triggered by the injection kick delay compensation, $T_{rev}^{SIS100}$ + $T_{rev}^{SIS18} - (t_{v\_inj}+$ \gls{symb:inj_pre}), see Fig.~\ref{ext_inj_kicker}. Both extraction and injection kick delay compensation values are preloaded from the SM to the Trigger SCU and the Trigger SCU gives these values to the TD module. The kicker delay compensation is applied to the first selected reproduced signal by TD module. If the inhibit signal is on, the normal injection and extraction trigger signals will be blocked.

For the SIS100 emergency kick, the extraction delay compensation is calculated by $T_{rev}^{SIS100} + t_{bucket} - (t_{v\_emg} + t_{emg})$, where \gls{symb:temg} is the time delay between the virtual RF cavity and the emergency extraction position and \gls{symb:Demg} the emergency kicker delay. The emergency extraction delay compensation values are preloaded from the SM to the Trigger SCU and the Trigger SCU gives these values to the TD module. The kicker delay compensation is applied to the selected reproduced signal by TD module. Only when the emergency signal is valid, the emergency kicker will be triggered by the TD module.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Beam indication for the beam instrumentation}

Two timing frames will be send from the B2B source SCU to the DM. DM sends them further to the FECs for BI.
\begin{itemize}
\item[-] Timing frame $TGM\_SYNCH\_WIN$

This time frame indicates the start of the synchronization window for the beam instrumentation.

\item[-] Timing frame $TGM\_B2B\_STATUS$

The time frame $TGM\_B2B\_STATUS$ indicates the status of the B2B transfer system and the actual beam injection time. 
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% WR network %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{WR network}

The B2B transfer involves a certain amount of frames within the WR network ~\cite{beck_white_2011}. More details about the B2B frames, please see Appendix A. The name of the timing frames from the DM is beginning with CMD\_, the name of other telegrams is beginning with TGM\_. The B2B related frames make use of the format of the timing frame. The Format ID (\gls{FID}) of the timing frame is used to indicate the B2B transfer, the Group ID (\gls{GID}) the source and target machines and the Beam Process ID (\gls{BPID}) the B2B process steps for the B2B related SCUs. 

A Virtual Local Area Network (VLAN) is a group of FECs in the WR network that is logically segmented by function or application, without regard to the physical locations of the FECs. 

All FECs in the WR network are assigned to the DM VLAN, within which the DM forwards broadcast timing telegrams downwards to all FECs. The telegrams sent from the source B2B SCU upwards to the DM are unicast packets within this VLAN. E.g. TGM\_SYNCH\_WIN and TGM\_B2B\_STATUS. 


\begin{landscape}
\begin{figure}[H]
   \centering   
   \includegraphics*[width=250mm]{Telegram_network.jpg}
   \caption{Timing frames transfer for the B2B transfer}
   \label{Telegram_network}
\end{figure}  
\end{landscape}

Besides, the SCUs for the B2B transfer are assigned to the B2B \gls{VLAN}. The specified VLAN for the B2B transfer could reduce the traffic of the WR network ~\cite{bai_concept_2016}. All B2B related telegrams TGM\_ except TGM\_SYNCH\_WIN and TGM\_B2B\_STATUS are broadcasted in the B2B VLAN. The broadcast packet is much safer, because it does not need to know the Internet Protocol address (\gls{IP} address) of B2B related SCUs. Besides, it increases the flexibility of the system that all SCUs for the B2B transfer could have changeable IP addresses. Fig. ~\ref{Telegram_network} shows the types of the B2B timing frames, their VLANs and the frames transfers among B2B related SCUs.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Status check %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{B2B transfer status check}
The B2B source SCU shall receive the trigger time of the extraction kicker and actual beam extraction time, TGM\_KICKER\_TRIGGER\_TIME\_S, from the source \gls{glos:trigger_scu} via the WR network and also the trigger time of the injection kicker and actual beam injection time, TGM\_KICKER\_TRIGGER\_TIME\_T, from the target Trigger SCU via the WR network. The Trigger SCU is responsible for the trigger of the kicker electronics. The B2B source SCU is capable of examining the status of the B2B transfer system and transferring the status and the actual beam injection time  (TGM\_B2B\_STATUS) to the DM. If all components of the B2B transfer system work correctly and the B2B transfer process is accomplished, the status bit is `0`. Otherwise it is `1`. For this purpose, it shall do simple checking based on the extraction/injection trigger time and the actual beam extraction/injection time. E.g. Source trigger time $<$ actual beam extraction time.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Data/Signal flow of the B2B transfer system}
In this section, the procedure for the B2B transfer is explained from the viewpoint of the data/signal flow, which follows the basic six steps in Fig.~\ref{2method}. Before the synchronization, the feedback loop, e.g. beam phase feedback loop and bunch-to-bunch feedback loop, should be frozen. 

\begin{enumerate}
\item The DM sends the timing frame CMD\_START\_B2B for the B2B transfer. 

\item  The B2B source and target SCUs send the timing frame tag to the PAP module. They read the predicted phase advance and the time slope from the PAP module after a fixed delay. 

\item  The B2B target SCU sends the predicted phase advance and the time slope (TGM\_PHASE\_TIME) to the B2B source SCU via the WR network. 

\item  The B2B source SCU calculates the synchronization window and transfers the timestamp of the start of the window (TGM\_SYNCH\_WIN) to the DM, as well as the Trigger SCUs of both machines.
The B2B source SCU calculates the phase correction value and transfers it to all Trigger SCUs via the WR network. Then the Trigger SCUs transfer the phase correction value to its Phase Correction Module (\gls{PCM}). The PCM triggers the phase correction of the SR module. 
Only for the phase shift method, the B2B source SCU calculates the required shifted phase and transfers it to the PSM. Then the PSM transfers the phase or frequency modulation profile to the Group DDS.  

\item  When the source and target Trigger SCUs receive the telegram (TGM\_SYNCH\_WIN), they produces the synchronization window pulse for the TD module. With the help of the bucket label signal, inhibit signal and emergency extraction signal, the TD module will produce the extraction and injection trigger signals for the kicker electronics.  
The source Trigger SCU gets the timestamp of the extraction trigger signal and the target Trigger SCU the timestamp of the injection trigger signal.
\item  The extraction and injection kickers are fired. 
After that, the source Trigger SCU gets the actual beam extraction time and transfers it together with the timestamp of the extraction trigger signal (TGM\_KICKER\_TRIGGER\_TIME\_S) to the source B2B SCU via the WR network.
The target Kicker SCU gets the timestamp of actual beam injection time and transfers it together with the timestamp of the injection trigger signal (TGM\_KICKER\_TRIGGER\_TIME\_T) to the source B2B SCU via the WR network.

The regular extraction and injection kickers are not fired, when one of the following situation happens. 
\begin{itemize}
\item[-] The calculation (synchronization window, the phase correction and phase shift value) is not correct. 

\item[-] The telegrams are not received within a specified timeout interval. 

\item[-] The inhibit signal from the MPS is on and the emergency extraction signal from the MPS is valid. 
\end{itemize}
Besides of the basic six steps, the B2B source SCU transfers the B2B status together with the timestamp of the beam injection (TGM\_B2B\_STATUS) to the DM via the WR network. 
\end{enumerate}


